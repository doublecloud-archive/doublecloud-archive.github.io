<!DOCTYPE html><html lang="en"><head itemscope=""><script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"insights","name":"Insights"}},{"@type":"ListItem","position":2,"item":{"@id":"ClickHouse","name":"ClickHouse"}}]},{"@type":"BlogPosting","@id":"https://double.cloud/blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems/","url":"https://double.cloud/blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems/","name":"(De-)normalization &amp; how ClickHouse® dictionaries can solve typical problems","headline":"(De-)normalization &amp; how ClickHouse® dictionaries can solve typical problems","abstract":"<p>Written by&nbsp;Stefan Kaeser, DoubleCloud Solutions Architect</p>","description":"<p>Written by&nbsp;Stefan Kaeser, DoubleCloud Solutions Architect</p>","dateCreated":"2022-10-10T00:00:00Z","datePublished":"2022-10-10T00:00:00Z","dateModified":"2022-10-10T00:00:00Z","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"creator":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"publisher":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightHolder":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightYear":2025,"mainEntityOfPage":{"@type":"WebPage","@id":"https://double.cloud/blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems/"},"inLanguage":{"@type":"Language","name":"English","alternateName":"en"},"keywords":["Insights","ClickHouse"],"image":"https://double.cloud/assets/blog/default-covers/denormalization-small-cover.png","sharedContent":{"@type":"WebPage","headline":"(De-)normalization &amp; how ClickHouse® dictionaries can solve typical problems","url":"https://double.cloud/blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems/","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}}},"wordCount":"","articleBody":""}]}</script><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>(De-)normalization &amp; how ClickHouse® dictionaries can solve typical problems | DoubleCloud</title><meta name="description" content="&lt;p&gt;Written by&amp;nbsp;Stefan Kaeser, DoubleCloud Solutions Architect&lt;/p&gt;"/><link rel="canonical" href="../de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems.html"/><meta itemProp="name" content="(De-)normalization &amp; how ClickHouse® dictionaries can solve typical problems"/><meta itemProp="description" content="Written by Stefan Kaeser, DoubleCloud Solutions Architect"/><meta itemProp="image" content="https://double.cloud/assets/blog/articles/new-sharing-images/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems-sharing.png"/><meta property="og:type" content="website"/><meta property="og:url" content="https://double.cloud/blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems/"/><meta property="og:title" content="(De-)normalization &amp; how ClickHouse® dictionaries can solve typical problems"/><meta property="og:description" content="Written by Stefan Kaeser, DoubleCloud Solutions Architect"/><meta property="og:image" content="https://double.cloud/assets/blog/articles/new-sharing-images/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems-sharing.png"/><meta property="og:locale" content="en"/><meta property="og:site_name" content="DoubleCloud"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="(De-)normalization &amp; how ClickHouse® dictionaries can solve typical problems"/><meta name="twitter:description" content="Written by Stefan Kaeser, DoubleCloud Solutions Architect"/><meta name="twitter:image" content="https://double.cloud/assets/blog/articles/new-sharing-images/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems-sharing.png"/><meta name="robots" content="follow, index"/><meta property="article:published_time" content="2022-10-10T00:00:00Z"/><meta property="article:author" content=""/><meta property="article:tag" content="Insights"/><meta property="article:tag" content="ClickHouse"/><meta name="next-head-count" content="25"/><link rel="icon" href="../../../../../assets/favicon/favicon.ico" sizes="any"/><link type="image/x-icon" rel="shortcut icon" href="../../../../../assets/favicon/favicon.ico"/><link type="image/png" sizes="16x16" rel="icon" href="../../../../../assets/favicon/favicon-16x16.png"/><link type="image/png" sizes="32x32" rel="icon" href="../../../../../assets/favicon/favicon-32x32.png"/><link type="image/png" sizes="120x120" rel="icon" href="../../../../../assets/favicon/favicon-120x120.png"/><link type="image/png" sizes="192x192" rel="icon" href="../../../../../assets/favicon/favicon-192x192.png"/><link type="image/png" sizes="76x76" rel="apple-touch-icon" href="https://double.cloud/assets/favicon/favicon-76x76.png"/><link type="image/png" sizes="152x152" rel="apple-touch-icon" href="../../../../../assets/favicon/favicon-152x152.png"/><link type="image/png" sizes="180x180" rel="apple-touch-icon" href="../../../../../assets/favicon/favicon-180x180.png"/><script id="data-google-tag-manager" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" data-nonce="JUvjHaH4XkX7JEE/WCd5Kw==">
                // Define dataLayer and the gtag function.
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}

                // Default analytics_storage to 'denied'.
                window.gtag = window.gtag || gtag;

                const hasAnalyticsConsent = window?.localStorage.getItem('hasAnalyticsConsent');
                const consent =  hasAnalyticsConsent === 'true' ? 'granted' : 'denied';

                window.gtag('consent', 'default', {
                    'analytics_storage': consent,
                    'ad_storage': consent,
                    'wait_for_update': hasAnalyticsConsent === 'true' ? 0 : Infinity,
                });

                dataLayer.push({
                    'event': 'default_consent'
                });

                (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                'https://www.googletagmanager.com/gtm.js?id='+i+dl;var n=d.querySelector('[nonce]');
                n&&j.setAttribute('nonce',n.nonce||n.getAttribute('nonce'));f.parentNode.insertBefore(j,f);
                })(window,document,'script','dataLayer','GTM-5M39N8J');
            </script><script nonce="JUvjHaH4XkX7JEE/WCd5Kw==">window.__webpack_nonce__ = "JUvjHaH4XkX7JEE/WCd5Kw=="</script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="preconnect" href="https://snap.licdn.com"/><link rel="preconnect" href="https://www.google.com"/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="preload" href="../../../../../_next/static/css/a4c87e381fd61058.css" as="style"/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="stylesheet" href="../../../../../_next/static/css/a4c87e381fd61058.css" data-n-g=""/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="preload" href="../../../../../_next/static/css/2facd84af36bff2e.css" as="style"/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="stylesheet" href="../../../../../_next/static/css/2facd84af36bff2e.css" data-n-p=""/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="preload" href="../../../../../_next/static/css/c413166e8b0da734.css" as="style"/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="stylesheet" href="../../../../../_next/static/css/c413166e8b0da734.css" data-n-p=""/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="preload" href="../../../../../_next/static/css/248e88462928fa2f.css" as="style"/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="stylesheet" href="../../../../../_next/static/css/248e88462928fa2f.css" data-n-p=""/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="preload" href="../../../../../_next/static/css/eb8a627e7f585420.css" as="style"/><link nonce="JUvjHaH4XkX7JEE/WCd5Kw==" rel="stylesheet" href="../../../../../_next/static/css/eb8a627e7f585420.css" data-n-p=""/><noscript data-n-css="JUvjHaH4XkX7JEE/WCd5Kw=="></noscript><script defer="" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" nomodule="" src="../../../../../_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="../../../../../_next/static/chunks/webpack-d326a7489defa990.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/chunks/framework-cc7effedd0fd3d95.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/chunks/main-ebfff3515213fa2f.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/chunks/pages/_app-4cd98c5be1eceb26.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/chunks/f69bbb46-eed95df46583a2d8.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/chunks/030d571f-c7510aa4f8d650e7.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/chunks/193-fdb54e47dd6b7c7b.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/chunks/756-04d1c95c632019ed.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/chunks/387-27526d5e8e2a9173.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/chunks/pages/blog/posts/[...slug]-896d627301783262.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/HkxA3M0ES7gp3V0n_0ecw/_buildManifest.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script><script src="../../../../../_next/static/HkxA3M0ES7gp3V0n_0ecw/_ssgManifest.js" nonce="JUvjHaH4XkX7JEE/WCd5Kw==" defer=""></script></head><body class="dc-root g-root g-root_theme_dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5M39N8J" title="Googletagmanager" height="0" width="0" style="display:none;visibility:hidden" loading="lazy"></iframe></noscript><div id="__next" data-reactroot=""><div class="layout"><a href="https://doublecloud-archive.github.io/blog/posts/2024/10/doublecloud-final-update/"><div class="pc-Grid header-anncouncement"><div class="container-fluid "><div class="row"><div class="col"><div class="yfm yfm_constructor"><p><b>DoubleCloud has wound down operations</b> | This is&nbsp;an&nbsp;archived version of&nbsp;the site. <b>Learn more &rarr; </b></p></div></div></div></div></div></a><div class="layout__content"><div class="g-root g-root_theme_dark pc-page-constructor"><div class="pc-page-constructor__wrapper"><div class="pc-layout"><div class="pc-Grid pc-navigation pc-layout__navigation"><div class="container-fluid "><div class="row"><div class="col"><nav><div class="pc-desktop-navigation__wrapper"><div class="pc-desktop-navigation__left"><div class="link" data-link-type="router"><span class="pc-logo pc-desktop-navigation__logo"><picture><img alt="Logo icon" src="../../../../../assets/logo/dc-logo-dark.svg" class="pc-logo__icon"/></picture><span class="pc-logo__text"></span></span></div></div><div class="pc-desktop-navigation__navigation-container"><div class="pc-overflow-scroller__container"><div class="pc-overflow-scroller pc-desktop-navigation__navigation"><div class="pc-overflow-scroller__wrapper" style="left:0"><ul class="pc-desktop-navigation__links"><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Why DoubleCloud</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="group-list-content"><div class="row item-list-content"><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Performance" data-link-type="router" href="../../../../../performance-boost/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Performance</span><span class="navigation-popup-item__description">Get the best performance with the highest ROI</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Security" data-link-type="router" href="../../../../../security.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Security</span><span class="navigation-popup-item__description">Keep your data protected and maintain compliance</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="DoubleCloud vs. other solutions" data-link-type="router" href="../../../../../comparison/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">DoubleCloud vs. other solutions</span><span class="navigation-popup-item__description">Learn how DoubleCloud’s products compare to other solutions</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Customer stories" data-link-type="router" href="../../../../../resources/case-studies/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Customer stories</span><span class="navigation-popup-item__description">See our solutions in action</span></div></a></div></div><div class="group-list-content__banner"><picture><img alt="" src="../../../../../assets/doublecloud/menu-bar/menu-banner-dc-results.png.webp" class="group-list-content__image" style="width:300px;height:300px"/></picture><span class="yfm yfm_constructor"><a href='../../../../../performance-boost/index.html' target='_self'>Get more and spend less with DoubleCloud  →</a></span></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Products</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="row item-list-content"><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Managed Service for ClickHouse®" data-link-type="router" href="../../../../../services/managed-clickhouse.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-clickhouse.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Managed Service for ClickHouse®</span><span class="navigation-popup-item__description">The fastest, most resource-efficient OLAP database for real-time analytics</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Managed Service for Apache Kafka®" data-link-type="router" href="../../../../../services/managed-kafka.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-kafka.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Managed Service for Apache Kafka®</span><span class="navigation-popup-item__description">A leading data streaming technology for large-scale, data-intensive applications</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Managed Service for Apache Airflow®" data-link-type="router" href="../../../../../services/managed-airflow/index.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-airflow.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Managed Service for Apache Airflow®</span><span class="navigation-popup-item__description">Open-source tool to orchestrate and monitor workflows</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Data Transfer" data-link-type="router" href="../../../../../services/doublecloud-transfer.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-transfer.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Data Transfer</span><span class="navigation-popup-item__description">No-code ELT tool for aggregating, collecting, and migrating data</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Data Visualization" data-link-type="router" href="../../../../../services/doublecloud-visualization.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-data-vis.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Data Visualization</span><span class="navigation-popup-item__description">Free tool to create, modify, and share dashboards and charts</span></div></a></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Solutions</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="group-list-content"><div class="row item-list-content"><h4 class="item-list-content__title">By use case</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Customer-facing analytics" data-link-type="router" href="../../../../../customer-facing-analytics/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Customer-facing analytics</span><span class="navigation-popup-item__description">Provide business insights for your clients or partners</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Real-time analytics" data-link-type="router" href="../../../../../solutions/real-time-analytics/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Real-time analytics</span><span class="navigation-popup-item__description">Build a data infrastructure to collect, process, and analyze data in real time</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Observability and monitoring" data-link-type="router" href="../../../../../solutions/observability-and-monitoring/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Observability and monitoring</span><span class="navigation-popup-item__description">Analyze terabytes of your logs, events, and traces with ease</span></div></a></div></div><div class="row item-list-content"><h4 class="item-list-content__title">By industry</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="AdTech and MarTech data analytics" data-link-type="router" href="../../../../../solutions/adtech.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">AdTech and MarTech data analytics</span><span class="navigation-popup-item__description">Extract and analyze data from Meta ads, Google ads, LinkedIn ads, and others</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Analytics for mobile and gaming apps" data-link-type="router" href="../../../../../solutions/web-mobile-gaming-apps.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Analytics for mobile and gaming apps</span><span class="navigation-popup-item__description">Optimize and scale your mobile and gaming app analytics</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="EdTech data analytics" data-link-type="router" href="../../../../../solutions/edtech/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">EdTech data analytics</span><span class="navigation-popup-item__description">Improve online learning and identify new sales opportunities</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="FinTech data analytics" data-link-type="router" href="../../../../../solutions/fintech-real-time-analytics/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">FinTech data analytics</span><span class="navigation-popup-item__description">Manage and process large amounts of financial data efficiently</span></div></a></div></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control dc-dropdown-navigation-item__control_selected"><span class="dc-dropdown-navigation-item__title">Resources</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="group-list-content"><div class="row item-list-content"><h4 class="item-list-content__title">Using DoubleCloud</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="DoubleCloud API" href="../../../../../docs/en/public-api/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">DoubleCloud API</span><span class="navigation-popup-item__description">Read up on API tutorials and instructions</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Terraform" href="../../../../../docs/en/developer-resources/terraform/create-resources.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Terraform</span><span class="navigation-popup-item__description">Deploy and manage cloud resources with the infrastructure-as-code approach</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Status updates" data-link-type="router" href="https://status.double.cloud/"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Status updates</span><span class="navigation-popup-item__description">Check the current operational status of our services</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Support" data-link-type="router" href="../../../../../support/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Support</span><span class="navigation-popup-item__description">Learn more about our support tiers</span></div></a></div></div><div class="row item-list-content"><h4 class="item-list-content__title">Discover</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Webinars" data-link-type="router" href="../../../../../webinars/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Webinars</span><span class="navigation-popup-item__description">Sign up for the next webinar or watch previous ones</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover navigation-popup-item__content_selected" aria-label="Blog" data-link-type="router" href="../../../../index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Blog</span><span class="navigation-popup-item__description">Get insights from our team and the latest news</span></div></a></div></div><div class="group-list-content__banner"><picture><img alt="" src="../../../../../assets/doublecloud/menu-bar/menu-banners-dc-ebook.png.webp" class="group-list-content__image" style="width:300px;height:300px"/></picture><span class="yfm yfm_constructor"><a href='../../../../../resources/clickhouse-ebook/index.html' target='_self'>Grab your ebook  →</a></span></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Company</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="row item-list-content"><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="About DoubleCloud" data-link-type="router" href="../../../../../company/about-us.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">About DoubleCloud</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Careers" data-link-type="router" href="../../../../../company/careers.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Careers</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Contact us" data-link-type="router" href="../../../../../company/contact-us.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Contact us</span></div></a></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><a aria-label="Pricing" class="pc-navigation-item__content pc-navigation-item__content_type_link" data-link-type="router" href="../../../../../pricing.html"><div class="navigation-item"><span class="navigation-item__text">Pricing</span></div></a></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><a href="../../../../../docs/index.html" aria-label="Documentation" class="pc-navigation-item__content pc-navigation-item__content_type_link" target="_self"><div class="navigation-item"><span class="navigation-item__text">Documentation</span></div></a></li></ul></div></div></div></div><div class="pc-desktop-navigation__right"><button type="button" aria-label="Button label" class="pc-control pc-control_size_l pc-control_theme_primary pc-mobile-menu-button"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="24" class="g-icon" fill="currentColor" stroke="none" data-qa="icon-test-id" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="currentColor" fill-rule="evenodd" d="M1.25 3.25A.75.75 0 0 1 2 2.5h12A.75.75 0 0 1 14 4H2a.75.75 0 0 1-.75-.75Zm0 4.75A.75.75 0 0 1 2 7.25h12a.75.75 0 0 1 0 1.5H2A.75.75 0 0 1 1.25 8ZM2 12a.75.75 0 0 0 0 1.5h12a.75.75 0 0 0 0-1.5H2Z" clip-rule="evenodd"></path></svg></svg></button></div></div><div></div></nav></div></div></div></div><main class="pc-layout__content"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><header class="pc-header-block pc-header-block_media-view_full"><div class="pc-header-block__background pc-header-block__background_media" style="background-color:#000000"><div class="pc-Media pc-header-block__background-media" style="background-color:#000000"><div style="transform:"><div class="pc-storage-background-image pc-media-component-image__item pc-header-block__image" data-qa="background-image"><picture data-qa="background-image-image"><img fetchpriority="high" alt="" src="../../../../../assets/doublecloud/(de-)normalization_cover.jpg" class="pc-storage-background-image__img"/></picture></div></div></div></div><div class="pc-Grid"><div class="container-fluid pc-header-block__container-fluid"><div class="row pc-header-block__breadcrumbs"><div class="col"><div class="pc-header-breadcrumbs pc-header-breadcrumbs_theme_light" aria-label="You are here:"><div class="pc-header-breadcrumbs__item"><a href="../../../../index.html" class="pc-header-breadcrumbs__text">Blog</a></div><div class="pc-header-breadcrumbs__item"><a href="../../../../index.html%3Ftags=insights.html" class="pc-header-breadcrumbs__text">Insights</a></div></div></div></div><div class="row"><div class="col col-reset pc-header-block__content-wrapper"><div class="row"><div class="col pc-header-block__content pc-header-block__content_offset_default pc-header-block__content_theme_light pc-header-block__content_vertical-offset_xl"><div class="col  col-lg-8 col-md-8 col-sm-12 col-12 pc-header-block__content-inner"><h1 class="pc-header-block__title" id="g-uniq-278782"><span>(De-)normalization & how ClickHouse® dictionaries can solve typical problems</span></h1><div class="pc-header-block__description"><div class="yfm yfm_constructor yfm_constructor_theme_light"><p>Written by&nbsp;Stefan Kaeser, DoubleCloud Solutions Architect</p></div></div><div class="bc-post-info__container bc-post-info__container_theme_light"><div class="bc-post-info__item bc-post-info__item_size_s" data-qa="blog-header-meta-container-date">October 10, 2022</div><div class="bc-post-info__item bc-post-info__item_size_s" data-qa="blog-header-meta-container-reading-time"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>20 mins to read</div><div class="bc-post-info__item"><div class="bc-post-info__icon"><div class="g-popover gc-share-popover bc-post-info__share"><button class="gc-share-popover__container bc-post-info__switcher bc-post-info__switcher_theme_light" aria-expanded="false" aria-controls="g-uniq-278783" aria-describedby="g-uniq-278783"><div class="gc-share-popover__icon-container"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon gc-share-popover__icon bc-post-info__share-icon" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.798 3.16a.5.5 0 0 0 .363.842H7V9a1 1 0 0 0 2 0V4.002h1.839a.5.5 0 0 0 .363-.844L8.363.156a.5.5 0 0 0-.726 0l-2.84 3.002.001.001ZM13 7a1 1 0 0 1 2 0v6.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 13.5V7a1 1 0 0 1 2 0v6h10V7Z"></path></svg></svg></div><div class="gc-share-popover__title">Share</div></button></div></div></div></div></div></div></div></div></div></div></div></header></section><div class="pc-Grid"><div class="container-fluid "><div class="row pc-constructor-row"><div class="col"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p><em>Written by&nbsp;<a href="https://www.linkedin.com/in/stefan-k%C3%A4ser-344903119/" target="_blank">Stefan Kaeser</a>, DoubleCloud Solutions Architect</em></p>
<p>A&nbsp;few days ago I&nbsp;stumbled across a&nbsp;blog post from our friends over at&nbsp;ClickHouse&reg; about <a href="https://clickhouse.com/blog/real-world-data-noaa-climate-data" target="_blank">Exploring massive, real-world data sets: 100+ Years of&nbsp;Weather Records in&nbsp;ClickHouse</a>.</p>
<p>It&rsquo;s a&nbsp;well written blog and really shows what ClickHouse is&nbsp;capable of, regarding transforming billions of&nbsp;datapoints with low effort. They showed how to&nbsp;load data from files from external urls, how to&nbsp;use regex for formatting data, creation of&nbsp;dictionaries, etc. If&nbsp;you haven&rsquo;t already, then go&nbsp;ahead and read through their post.</p>
<p>However&hellip; there was something in&nbsp;the blog I&nbsp;couldn&rsquo;t stop thinking about:</p>
<p>Their main query for analyzing the data still took 14&nbsp;seconds after optimization, which is&nbsp;a&nbsp;really long time when you are used to&nbsp;ClickHouse and its normally sub-second responses. The second thing which makes me&nbsp;feel uncomfortable is&nbsp;the denormalized structure of&nbsp;their main table.</p>
<p>When I&nbsp;first learnt about normalization during my&nbsp;time at&nbsp;University two decades ago, denormalisation was&nbsp;bad. It&nbsp;was drummed into us&nbsp;that you should normalize as&nbsp;much as&nbsp;possible, and during that time, mainly with the usage of&nbsp;only OLTP, this was the correct choice to&nbsp;do. But times have changed and OLAP took over in&nbsp;a&nbsp;lot of&nbsp;places, and with big analytica workflows denormalisation got a&nbsp;revival and helped to&nbsp;maximize query speeds in&nbsp;a&nbsp;lot of&nbsp;cases.</p>
<p>But still there are things to&nbsp;consider when you denormalise, especially when handling huge amounts of&nbsp;data:</p>
<ul>
<li>When data changes it&nbsp;can take a&nbsp;very long time to&nbsp;update old data</li>
<li>With billions or&nbsp;trillions of&nbsp;rows, even small columns can take up&nbsp;very much space</li>
</ul></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><h2 id="how-can"><a href="../de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems.html#how-can" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">How can dictionaries help with those problems?</span></a>How can dictionaries help with those problems?</h2>
<p><em>Spoiler Alert: You can speed the query up&nbsp;from multiple seconds to&nbsp;milliseconds!</em></p>
<p>First of&nbsp;all, if&nbsp;you want to&nbsp;play around with optimizations yourself, I&nbsp;encourage you once again to&nbsp;read ClickHouses' blog post, as&nbsp;I&nbsp;won&rsquo;t repeat the filling process from them, but instead build up&nbsp;on&nbsp;it. But for those of&nbsp;you just enjoying the read without replaying it, I&rsquo;ll give you the tabledefinitions and some cardinalities. The main table which has weather data from weather stations all over the world since 1900&nbsp;looks like this:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> sensors_blog
(
    `station_id` LowCardinality(String),
    `<span class="hljs-type">date</span>` Date32,
    `tempAvg` Nullable(Int32) COMMENT <span class="hljs-string">'Average temperature (tenths of a degrees C)'</span>,
    `tempMax` Nullable(Int32) COMMENT <span class="hljs-string">'Maximum temperature (tenths of degrees C)'</span>,
    `tempMin` Nullable(Int32) COMMENT <span class="hljs-string">'Minimum temperature (tenths of degrees C)'</span>,
    `precipitation` Nullable(UInt32) COMMENT <span class="hljs-string">'Precipitation (tenths of mm)'</span>,
    `snowfall` Nullable(UInt32) COMMENT <span class="hljs-string">'Snowfall (mm)'</span>,
    `snowDepth` Nullable(UInt32) COMMENT <span class="hljs-string">'Snow depth (mm)'</span>,
    `percentDailySun` Nullable(UInt8) COMMENT <span class="hljs-string">'Daily percent of possible sunshine (percent)'</span>,
    `averageWindSpeed` Nullable(UInt32) COMMENT <span class="hljs-string">'Average daily wind speed (tenths of meters per second)'</span>,
    `maxWindSpeed` Nullable(UInt32) COMMENT <span class="hljs-string">'Peak gust wind speed (tenths of meters per second)'</span>,
    `weatherType` Nullable(Enum8(<span class="hljs-string">'Normal'</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, <span class="hljs-string">'Fog'</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, <span class="hljs-string">'Heavy Fog'</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>, <span class="hljs-string">'Thunder'</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>, <span class="hljs-string">'Small Hail'</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>, <span class="hljs-string">'Hail'</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>, <span class="hljs-string">'Glaze'</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>, <span class="hljs-string">'Dust/Ash'</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span>, <span class="hljs-string">'Smoke/Haze'</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>, 
                      <span class="hljs-string">'Blowing/Drifting Snow'</span> <span class="hljs-operator">=</span> <span class="hljs-number">9</span>, <span class="hljs-string">'Tornado'</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>, <span class="hljs-string">'High Winds'</span> <span class="hljs-operator">=</span> <span class="hljs-number">11</span>, <span class="hljs-string">'Blowing Spray'</span> <span class="hljs-operator">=</span> <span class="hljs-number">12</span>, <span class="hljs-string">'Mist'</span> <span class="hljs-operator">=</span> <span class="hljs-number">13</span>, <span class="hljs-string">'Drizzle'</span> <span class="hljs-operator">=</span> <span class="hljs-number">14</span>, <span class="hljs-string">'Freezing Drizzle'</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>, 
                      <span class="hljs-string">'Rain'</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>, <span class="hljs-string">'Freezing Rain'</span> <span class="hljs-operator">=</span> <span class="hljs-number">17</span>, <span class="hljs-string">'Snow'</span> <span class="hljs-operator">=</span> <span class="hljs-number">18</span>, <span class="hljs-string">'Unknown Precipitation'</span> <span class="hljs-operator">=</span> <span class="hljs-number">19</span>, <span class="hljs-string">'Ground Fog'</span> <span class="hljs-operator">=</span> <span class="hljs-number">21</span>, <span class="hljs-string">'Freezing Fog'</span> <span class="hljs-operator">=</span> <span class="hljs-number">22</span>)),
    `location` Point,
    `elevation` Float32,
    `name` LowCardinality(String)
) ENGINE <span class="hljs-operator">=</span> MergeTree() <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (station_id, <span class="hljs-type">date</span>);
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="9">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-9" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-9" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-9.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p>Notice I&rsquo;ve changed the name from noaa to&nbsp;sensors_blog and added some Nullables for some internal reasons. The table contains around <strong>1.08 billion</strong> rows and there are around <strong>120k</strong> unique stations within.</p>
<p>The columns location, elevation and name are all depended directly from station_id and make up&nbsp;the denormalized part, so&nbsp;let&rsquo;s look to&nbsp;see if&nbsp;it&rsquo;s worth adding them to&nbsp;the table at&nbsp;all and what it&nbsp;costs:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>
    name,
    formatReadableSize(<span class="hljs-built_in">SUM</span>(data_compressed_bytes)) <span class="hljs-keyword">AS</span> compressed,
    formatReadableSize(<span class="hljs-built_in">SUM</span>(data_uncompressed_bytes)) <span class="hljs-keyword">AS</span> uncompressed
<span class="hljs-keyword">FROM</span> system.columns
<span class="hljs-keyword">WHERE</span> (database <span class="hljs-operator">=</span> <span class="hljs-string">'weather'</span>) <span class="hljs-keyword">AND</span> (<span class="hljs-keyword">table</span> <span class="hljs-operator">=</span> <span class="hljs-string">'sensors_blog'</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> name
    <span class="hljs-keyword">WITH</span> TOTALS

┌─name─────────────┬─compressed─┬─uncompressed─┐
│ <span class="hljs-type">date</span>             │ <span class="hljs-number">2.46</span> GiB   │ <span class="hljs-number">4.01</span> GiB     │
│ snowfall         │ <span class="hljs-number">124.18</span> MiB │ <span class="hljs-number">5.01</span> GiB     │
│ tempMax          │ <span class="hljs-number">1.17</span> GiB   │ <span class="hljs-number">5.01</span> GiB     │
│ tempMin          │ <span class="hljs-number">1.17</span> GiB   │ <span class="hljs-number">5.01</span> GiB     │
│ tempAvg          │ <span class="hljs-number">279.95</span> MiB │ <span class="hljs-number">5.01</span> GiB     │
│ weatherType      │ <span class="hljs-number">40.65</span> MiB  │ <span class="hljs-number">2.00</span> GiB     │
│ snowDepth        │ <span class="hljs-number">141.74</span> MiB │ <span class="hljs-number">5.01</span> GiB     │
│ precipitation    │ <span class="hljs-number">1.11</span> GiB   │ <span class="hljs-number">5.01</span> GiB     │
│ averageWindSpeed │ <span class="hljs-number">41.31</span> MiB  │ <span class="hljs-number">5.01</span> GiB     │
│ maxWindSpeed     │ <span class="hljs-number">35.07</span> MiB  │ <span class="hljs-number">5.01</span> GiB     │
│ percentDailySun  │ <span class="hljs-number">10.28</span> MiB  │ <span class="hljs-number">2.00</span> GiB     │

│ station_id       │ <span class="hljs-number">16.63</span> MiB  │ <span class="hljs-number">1.98</span> GiB     │

│ name             │ <span class="hljs-number">20.85</span> MiB  │ <span class="hljs-number">1.99</span> GiB     │
│ location         │ <span class="hljs-number">87.51</span> MiB  │ <span class="hljs-number">16.04</span> GiB    │
│ elevation        │ <span class="hljs-number">22.52</span> MiB  │ <span class="hljs-number">4.01</span> GiB     │
└──────────────────┴────────────┴──────────────┘

Totals:
┌─name─┬─compressed─┬─uncompressed─┐
│      │ <span class="hljs-number">6.71</span> GiB   │ <span class="hljs-number">72.14</span> GiB    │
└──────┴────────────┴──────────────┘
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="16">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-16" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-16" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-16.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p>I&rsquo;ve separated the denormalized columns for better readability.</p>
<p>As&nbsp;the table is&nbsp;ordered by&nbsp;station_id, the denormalized depended columns compress extremely well, but still take up&nbsp;nearly 2% of&nbsp;the total data. Uncompressed it&rsquo;s 30% of&nbsp;the data, which will eat some of&nbsp;your cpu cycles for decompression when querying&nbsp;it. That not only takes denormalisation more space, it&nbsp;can also slow down your queries.</p>
<p>Let&rsquo;s take a&nbsp;look now at&nbsp;the main query which bothered me&nbsp;the most when I&nbsp;read the original post:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>
    tempMax <span class="hljs-operator">/</span> <span class="hljs-number">10</span> <span class="hljs-keyword">AS</span> maxTemp,
    station_id,
    <span class="hljs-type">date</span>,
    location
<span class="hljs-keyword">FROM</span> sensors_blog
<span class="hljs-keyword">WHERE</span> dictGet(country_polygons, <span class="hljs-string">'name'</span>, location) <span class="hljs-operator">=</span> <span class="hljs-string">'Portugal'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> tempMax <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">5</span>

Query id: <span class="hljs-number">2e2</span>bd273<span class="hljs-operator">-</span>f4a0<span class="hljs-number">-4268</span><span class="hljs-number">-856</span>c<span class="hljs-number">-20</span>ef5fec9f61

┌─maxTemp─┬─station_id──┬───────<span class="hljs-type">date</span>─┬─location──────────┐
│    <span class="hljs-number">45.8</span> │ PO000008549 │ <span class="hljs-number">1944</span><span class="hljs-number">-07</span><span class="hljs-number">-30</span> │ (<span class="hljs-number">-8.4167</span>,<span class="hljs-number">40.2</span>)    │
│    <span class="hljs-number">45.4</span> │ PO000008562 │ <span class="hljs-number">2003</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span> │ (<span class="hljs-number">-7.8667</span>,<span class="hljs-number">38.0167</span>) │
│    <span class="hljs-number">45.2</span> │ PO000008562 │ <span class="hljs-number">1995</span><span class="hljs-number">-07</span><span class="hljs-number">-23</span> │ (<span class="hljs-number">-7.8667</span>,<span class="hljs-number">38.0167</span>) │
│    <span class="hljs-number">44.5</span> │ POM00008558 │ <span class="hljs-number">2003</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span> │ (<span class="hljs-number">-7.9</span>,<span class="hljs-number">38.533</span>)     │
│    <span class="hljs-number">44.2</span> │ POM00008558 │ <span class="hljs-number">2022</span><span class="hljs-number">-07</span><span class="hljs-number">-13</span> │ (<span class="hljs-number">-7.9</span>,<span class="hljs-number">38.533</span>)     │
└─────────┴─────────────┴────────────┴───────────────────┘

<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">14.427</span> sec. Processed <span class="hljs-number">1.08</span> billion <span class="hljs-keyword">rows</span>, <span class="hljs-number">35.94</span> GB (<span class="hljs-number">74.61</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">2.49</span> GB<span class="hljs-operator">/</span>s.)
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="26">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-26" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-26" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-26.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p>The query tries to&nbsp;get the top five temperatures occurring in&nbsp;Portugal since the recordings began. It&rsquo;s already optimized by&nbsp;using a&nbsp;dictionary to&nbsp;look up&nbsp;the geolocations of&nbsp;Portugal, but still it&nbsp;takes nearly 15&nbsp;seconds&hellip; and for clickhouse that&rsquo;s like an&nbsp;eternity.</p>
<p>So&nbsp;can it&nbsp;be&nbsp;improved?</p>
<p>Actually it&nbsp;can, and the authors of&nbsp;the original blog already did so, as&nbsp;they found out that the first two characters of&nbsp;station_id already contained some kind of&nbsp;country code:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>
    tempMax <span class="hljs-operator">/</span> <span class="hljs-number">10</span> <span class="hljs-keyword">AS</span> maxTemp,
    station_id,
    <span class="hljs-type">date</span>,
    location
<span class="hljs-keyword">FROM</span> sensors_blog
<span class="hljs-keyword">WHERE</span> <span class="hljs-built_in">substring</span>(station_id,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> <span class="hljs-string">'PO'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> tempMax <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">5</span>

┌─maxTemp─┬─station_id──┬───────<span class="hljs-type">date</span>─┬─location──────────┐
│    <span class="hljs-number">45.8</span> │ PO000008549 │ <span class="hljs-number">1944</span><span class="hljs-number">-07</span><span class="hljs-number">-30</span> │ (<span class="hljs-number">-8.4167</span>,<span class="hljs-number">40.2</span>)    │
│    <span class="hljs-number">45.4</span> │ PO000008562 │ <span class="hljs-number">2003</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span> │ (<span class="hljs-number">-7.8667</span>,<span class="hljs-number">38.0167</span>) │
│    <span class="hljs-number">45.2</span> │ PO000008562 │ <span class="hljs-number">1995</span><span class="hljs-number">-07</span><span class="hljs-number">-23</span> │ (<span class="hljs-number">-7.8667</span>,<span class="hljs-number">38.0167</span>) │
│    <span class="hljs-number">44.5</span> │ POM00008558 │ <span class="hljs-number">2003</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span> │ (<span class="hljs-number">-7.9</span>,<span class="hljs-number">38.533</span>)     │
│    <span class="hljs-number">44.2</span> │ POM00008558 │ <span class="hljs-number">2022</span><span class="hljs-number">-07</span><span class="hljs-number">-13</span> │ (<span class="hljs-number">-7.9</span>,<span class="hljs-number">38.533</span>)     │
└─────────┴─────────────┴────────────┴───────────────────┘

<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">1.440</span> sec. Processed <span class="hljs-number">1.08</span> billion <span class="hljs-keyword">rows</span>, <span class="hljs-number">7.39</span> GB (<span class="hljs-number">747.38</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">5.13</span> GB<span class="hljs-operator">/</span>s.)
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="36">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-36" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-36" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-36.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p>We&nbsp;can see that it&nbsp;is&nbsp;already 10&nbsp;times faster, but only because we&nbsp;have some meta information about how the station_id is&nbsp;built. If&nbsp;however the station_id would just be&nbsp;a&nbsp;generic id, we&nbsp;would not be&nbsp;able to&nbsp;use it&nbsp;for speeding up&nbsp;that query.</p>
<p>So&nbsp;let&rsquo;s go&nbsp;back to&nbsp;the original query and analyze what&rsquo;s taking so&nbsp;long.</p>
<p>Actually it&nbsp;is&nbsp;the denormalization of&nbsp;the main table which slows down the whole query. For each of&nbsp;the 1.08 billion rows ClickHouse has to&nbsp;read the location from disk, decompress it&nbsp;(16GB in&nbsp;total), throw it&nbsp;into the dictionary (which is&nbsp;cached of&nbsp;course), and then throw it&nbsp;away if&nbsp;the condition of&nbsp;'Portugal' does not hold.</p>
<p>The same problem occurs with the already optimized version, but of&nbsp;course much faster as&nbsp;the station_id is&nbsp;much smaller and handling substrings is&nbsp;of&nbsp;course faster than checking if&nbsp;a&nbsp;point lies within a&nbsp;polygon.</p>
<h2 id="speed-up"><a href="../de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems.html#speed-up" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Speed Up&nbsp;Query by&nbsp;Normalization</span></a>Speed Up&nbsp;Query by&nbsp;Normalization</h2>
<p>After analyzing the query and what it&nbsp;does, especially reading a&nbsp;lot of&nbsp;redundant data from disk and decompressing it, we&nbsp;can speed up&nbsp;the query by&nbsp;undoing the denormalization.</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> stations_blog (
    station_id String,
    `location` Point,
    elevation Float32, 
    name String
) Engine<span class="hljs-operator">=</span>ReplacingMergeTree <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> tuple() <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (station_id);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> stations_blog
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> station_id, location, elevation, name
<span class="hljs-keyword">FROM</span> sensors_blog

<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)
<span class="hljs-keyword">FROM</span> stations_blog

Query id: <span class="hljs-number">700</span>a0ef9<span class="hljs-operator">-</span>d97b<span class="hljs-number">-4</span>a1b<span class="hljs-number">-9144</span><span class="hljs-operator">-</span>bdaf5bbbf2cc

┌─<span class="hljs-built_in">count</span>()─┐
│  <span class="hljs-number">121564</span> │
└─────────┘
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="55">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-55" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-55" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-55.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p>Of&nbsp;course if&nbsp;you&rsquo;ve downloaded the original stations.txt you could have created the table from that file as&nbsp;well. So&nbsp;now as&nbsp;we&nbsp;have our stations_blog table we&nbsp;can finally speed up&nbsp;the query to&nbsp;find the top five temperatures of&nbsp;Portugal to&nbsp;get the result in&nbsp;a&nbsp;ClickHouse felt way:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>
    tempMax <span class="hljs-operator">/</span> <span class="hljs-number">10</span> <span class="hljs-keyword">AS</span> maxTemp,
    station_id,
    <span class="hljs-type">date</span>,
    location
<span class="hljs-keyword">FROM</span> sensors_blog
<span class="hljs-comment">-- WHERE dictGet(country_polygons, 'name', location) = 'Portugal'</span>
<span class="hljs-keyword">WHERE</span> station_id <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> station_id
    <span class="hljs-keyword">FROM</span> stations_blog
    <span class="hljs-keyword">WHERE</span> dictGet(country_polygons, <span class="hljs-string">'name'</span>, location) <span class="hljs-operator">=</span> <span class="hljs-string">'Portugal'</span>
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> tempMax <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">5</span>

Query id: <span class="hljs-number">5e08</span>add8<span class="hljs-operator">-</span>ab76<span class="hljs-number">-4273</span><span class="hljs-number">-9019</span><span class="hljs-operator">-</span>ae1519b72988

┌─maxTemp─┬─station_id──┬───────<span class="hljs-type">date</span>─┬─location──────────┐
│    <span class="hljs-number">45.8</span> │ PO000008549 │ <span class="hljs-number">1944</span><span class="hljs-number">-07</span><span class="hljs-number">-30</span> │ (<span class="hljs-number">-8.4167</span>,<span class="hljs-number">40.2</span>)    │
│    <span class="hljs-number">45.4</span> │ PO000008562 │ <span class="hljs-number">2003</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span> │ (<span class="hljs-number">-7.8667</span>,<span class="hljs-number">38.0167</span>) │
│    <span class="hljs-number">45.2</span> │ PO000008562 │ <span class="hljs-number">1995</span><span class="hljs-number">-07</span><span class="hljs-number">-23</span> │ (<span class="hljs-number">-7.8667</span>,<span class="hljs-number">38.0167</span>) │
│    <span class="hljs-number">44.5</span> │ POM00008558 │ <span class="hljs-number">2003</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span> │ (<span class="hljs-number">-7.9</span>,<span class="hljs-number">38.533</span>)     │
│    <span class="hljs-number">44.2</span> │ POM00008558 │ <span class="hljs-number">2022</span><span class="hljs-number">-07</span><span class="hljs-number">-13</span> │ (<span class="hljs-number">-7.9</span>,<span class="hljs-number">38.533</span>)     │
└─────────┴─────────────┴────────────┴───────────────────┘

<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.034</span> sec. Processed <span class="hljs-number">581.63</span> thousand <span class="hljs-keyword">rows</span>, <span class="hljs-number">20.13</span> MB (<span class="hljs-number">17.27</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">597.57</span> MB<span class="hljs-operator">/</span>s.)
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="59">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-59" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-59" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-59.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p><strong>0.034 sec</strong> now that&rsquo;s what I&nbsp;consider ClickHouse speed.</p>
<p>So&nbsp;here we&nbsp;have an&nbsp;example when denormalization does not help at&nbsp;all, or&nbsp;even worse prevents you from getting the fastest results.</p>
<h2 id="dictionaries"><a href="../de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems.html#dictionaries" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Dictionaries to&nbsp;the rescue!</span></a>Dictionaries to&nbsp;the rescue!</h2>
<p><em>But what about other queries, where we&nbsp;need to&nbsp;access the denormalized columns, will normalizing slow them down?</em></p>
<p>Well let&rsquo;s test!<br />
Let&rsquo;s say we&nbsp;want the five stations with top average maxtemperature with their name printed:<br />
Denormalised:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>
    <span class="hljs-built_in">AVG</span>(tempMax <span class="hljs-operator">/</span> <span class="hljs-number">10</span>) <span class="hljs-keyword">AS</span> avgMaxTemp,
    station_id,
    <span class="hljs-keyword">any</span>(name) <span class="hljs-keyword">AS</span> stationName
<span class="hljs-keyword">FROM</span> sensors_blog
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> station_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avgMaxTemp <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">5</span>

Query id: <span class="hljs-number">1</span>dd12cbb<span class="hljs-number">-6962</span><span class="hljs-number">-4</span>b22<span class="hljs-number">-948</span>d<span class="hljs-operator">-</span>bbc1976b691b

┌─avgMaxTemp─┬─station_id──┬─stationName────────┐
│       <span class="hljs-number">44.4</span> │ USC00143323 │ KS HADDAM          │
│      <span class="hljs-number">41.65</span> │ IN019180300 │ PHALODI            │
│       <span class="hljs-number">40.6</span> │ USC00413142 │ TX FIFE            │
│      <span class="hljs-number">40.55</span> │ USC00207427 │ MI SECORD DAM      │
│      <span class="hljs-number">39.85</span> │ USC00416953 │ TX PERRYTON <span class="hljs-number">11</span> WNW │
└────────────┴─────────────┴────────────────────┘

<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">3.596</span> sec. Processed <span class="hljs-number">1.08</span> billion <span class="hljs-keyword">rows</span>, <span class="hljs-number">17.18</span> GB (<span class="hljs-number">299.34</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">4.78</span> GB<span class="hljs-operator">/</span>s.)
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="75">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-75" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-75" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-75.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p>Normalized and joining the data:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>
    <span class="hljs-built_in">AVG</span>(tempMax <span class="hljs-operator">/</span> <span class="hljs-number">10</span>) <span class="hljs-keyword">AS</span> avgMaxTemp,
    station_id,
    <span class="hljs-keyword">any</span>(stations_blog.name) <span class="hljs-keyword">AS</span> stationName
<span class="hljs-keyword">FROM</span> sensors_blog
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> stations_blog <span class="hljs-keyword">ON</span> stations_blog.station_id <span class="hljs-operator">=</span> sensors_blog.station_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> station_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avgMaxTemp <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">5</span>

Query id: <span class="hljs-number">7</span>fdf927d<span class="hljs-number">-1446</span><span class="hljs-number">-443</span>c<span class="hljs-operator">-</span>af5a<span class="hljs-number">-48573440060</span>c

┌─avgMaxTemp─┬─station_id──┬─stationName────────┐
│       <span class="hljs-number">44.4</span> │ USC00143323 │ KS HADDAM          │
│      <span class="hljs-number">41.65</span> │ IN019180300 │ PHALODI            │
│       <span class="hljs-number">40.6</span> │ USC00413142 │ TX FIFE            │
│      <span class="hljs-number">40.55</span> │ USC00207427 │ MI SECORD DAM      │
│      <span class="hljs-number">39.85</span> │ USC00416953 │ TX PERRYTON <span class="hljs-number">11</span> WNW │
└────────────┴─────────────┴────────────────────┘

<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">9.005</span> sec. Processed <span class="hljs-number">1.08</span> billion <span class="hljs-keyword">rows</span>, <span class="hljs-number">10.98</span> GB (<span class="hljs-number">119.54</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">1.22</span> GB<span class="hljs-operator">/</span>s.)
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="79">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-79" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-79" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-79.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p>So&nbsp;as&nbsp;most of&nbsp;you might have expected already, joining the stations table makes the query nearly three times slower going up&nbsp;from <strong>3.5 sec</strong> to&nbsp;<strong>9.0 sec</strong>&hellip; Of&nbsp;course there are ways to&nbsp;prevent the join by&nbsp;getting the station name later, or&nbsp;by&nbsp;building more complicated queries with SubSelects or&nbsp;some special tricks, but that just isn&rsquo;t fun, and ClickHouse is&nbsp;all about fun&hellip; right?</p>
<p>So&nbsp;what can we&nbsp;do&nbsp;to&nbsp;speed up&nbsp;those types of&nbsp;select queries?</p>
<p>We&nbsp;can build a&nbsp;dictionary out of&nbsp;the stations_blog table and use that instead of&nbsp;the join:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DICTIONARY stations_dict
(
   `station_id` String,
   `name` String
)
<span class="hljs-keyword">PRIMARY</span> KEY station_id
SOURCE(CLICKHOUSE(<span class="hljs-keyword">TABLE</span> <span class="hljs-string">'stations_blog'</span>))
LIFETIME(MIN <span class="hljs-number">0</span> MAX <span class="hljs-number">0</span>)
LAYOUT(complex_key_hashed())

<span class="hljs-keyword">SELECT</span>
    <span class="hljs-built_in">AVG</span>(tempMax <span class="hljs-operator">/</span> <span class="hljs-number">10</span>) <span class="hljs-keyword">AS</span> avgMaxTemp,
    station_id,
    dictGet(stations_dict, <span class="hljs-string">'name'</span>, station_id) <span class="hljs-keyword">AS</span> stationName
<span class="hljs-keyword">FROM</span> sensors_blog
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> station_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avgMaxTemp <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">5</span>

Query id: df158271<span class="hljs-operator">-</span>faee<span class="hljs-number">-4</span>b48<span class="hljs-number">-9</span>f9b<span class="hljs-number">-7e82</span>e48a1009

┌─avgMaxTemp─┬─station_id──┬─stationName────────┐
│       <span class="hljs-number">44.4</span> │ USC00143323 │ KS HADDAM          │
│      <span class="hljs-number">41.65</span> │ IN019180300 │ PHALODI            │
│       <span class="hljs-number">40.6</span> │ USC00413142 │ TX FIFE            │
│      <span class="hljs-number">40.55</span> │ USC00207427 │ MI SECORD DAM      │
│      <span class="hljs-number">39.85</span> │ USC00416953 │ TX PERRYTON <span class="hljs-number">11</span> WNW │
└────────────┴─────────────┴────────────────────┘

<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">1.930</span> sec. Processed <span class="hljs-number">1.08</span> billion <span class="hljs-keyword">rows</span>, <span class="hljs-number">10.97</span> GB (<span class="hljs-number">557.63</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">5.69</span> GB<span class="hljs-operator">/</span>s.)
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="89">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-89" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-89" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-89.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p><strong>1.9 sec</strong> wow, that&rsquo;s even faster than the select on&nbsp;the denormalized table.</p>
<p>Again the reason here is, that ClickHouse does not have to&nbsp;read and uncompress the name column at&nbsp;all, but uses the station_id to&nbsp;fetch the corresponding name form the cached dictionary.</p>
<p><em>So&nbsp;what to&nbsp;take with you?</em></p>
<p>Even in&nbsp;OLAP scenarios, denormalisation can be&nbsp;problematic and slow down your queries apart from the other known facts. Normalization can help with optimization but can complicate things. ClickHouse dictionaries can help you get the best out of&nbsp;both worlds sometimes. It&rsquo;s always worth trying to&nbsp;optimize stuff, you will find out something new a&nbsp;lot of&nbsp;the time. So&nbsp;have fun using ClickHouse, support the OpenSource world, and when you need help managing ClickHouse within the cloud ask us!</p></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-author-block"></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><ul>
<li><a href="../de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems.html#how-can">How can dictionaries help with those problems?</a></li>
<li><a href="../de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems.html#speed-up">Speed Up&nbsp;Query by&nbsp;Normalization</a></li>
<li><a href="../de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems.html#dictionaries">Dictionaries to&nbsp;the rescue!</a></li>
</ul></div></section></div></div></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_indentTop_l pc-block-base_indentBottom_l pc-constructor-block pc-constructor-block_type_content-layout-block"><div class="pc-content-layout-block pc-content-layout-block_size_l pc-content-layout-block_theme_default pc-content-layout-block_background"><div class="col  col-12 col-md-8 col-reset pc-content pc-content_size_l pc-content_centered pc-content_theme_default pc-content-layout-block__content"><div class="pc-title pc-content__title" id="g-uniq-278785"><div class="col  col-12 col-reset"><h2 class="pc-title-item pc-title-item_size_m pc-title-item_reset-margin" data-qa="undefined-header"><span class="pc-title-item__text">Get started with DoubleCloud</span></h2></div></div><div class="pc-buttons pc-buttons_size_l pc-content__buttons pc-content__buttons_size_l"><a aria-describedby="g-uniq-278785" class="g-button g-button_view_action g-button_size_xl g-button_pin_round-round pc-button-block pc-button-block_size_xl pc-button-block_theme_accent pc-buttons__button" href="https://auth.double.cloud/s/signup" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><span class="pc-button-block__text">Start free trial</span></span></span></a><a aria-describedby="g-uniq-278785" class="g-button g-button_view_outlined g-button_size_xl g-button_pin_round-round pc-button-block pc-button-block_size_xl pc-button-block_theme_pseudo pc-buttons__button" href="../de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems.html#contact-us-form" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><span class="pc-button-block__text">Contact us</span></span></span></a></div></div><div class="pc-content-layout-block__background"><div class="pc-storage-background-image pc-content-layout-block__background-item" style="background-color:#CA1551" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/doublecloud/doublecloud-cover-5.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/doublecloud/doublecloud-cover-5.png" class="pc-storage-background-image__img" style="background-color:#CA1551"/></picture></div></div></div></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-suggest-block"><section class="bc-wrapper bc-wrapper_padding-top_l bc-wrapper_padding-bottom_l"><div class="pc-SliderBlock"><div class="pc-title pc-SliderBlock__header pc-SliderBlock__header_no-description"><div class="col  col-12 col-sm-8 col-reset"><h2 class="pc-title-item pc-title-item_size_m pc-title-item_reset-margin" data-qa="undefined-header"><span class="pc-title-item__text">See also</span></h2></div></div><div class="pc-SliderBlock__animate-slides"><span style="font-size:0"></span><div><div class="slick-slider pc-slick-origin slick-initialized"><div class="slick-list"><div class="slick-track" style="width:100%;left:0%"><div data-index="0" class="slick-slide slick-active slick-current" tabindex="-1" aria-hidden="false" style="outline:none;width:33.333333333333336%"><div><div class="link" data-link-type="router"><a draggable="false" aria-labelledby="g-uniq-278786" aria-describedby="g-uniq-278788 g-uniq-278790" class="g-link g-link_view_normal pc-card-base-block pc-card-base-block_border_shadow bc-post-card__card" href="../../09/how-do-data-warehouses-save-businesses-money.html"><div class="pc-storage-background-image pc-card-base-block__header bc-post-card__header" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/blog/default-covers/how-do-data-warehouses-save-businesses-money-small-cover.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/blog/default-covers/how-do-data-warehouses-save-businesses-money-small-cover.png" class="pc-storage-background-image__img"/></picture><div class="pc-storage-background-image__container"><div class="pc-card-base-block__header-content"><div class="bc-post-card__image-container" data-qa="blog-suggest-header"></div></div></div></div><div class="pc-card-base-block__body"><div class="pc-card-base-block__content"><h3 class="bc-post-card__title bc-post-card__title_size_s"><span><span id="g-uniq-278786">How do data warehouses save businesses money?</span></span></h3></div><div class="pc-card-base-block__footer"><div class="bc-post-info__container"><div class="bc-post-info__suggest-container"><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-278788">September 5, 2022</div><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-278790"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>10 mins to read</div></div></div></div></div></a></div></div></div><div data-index="1" class="slick-slide slick-active" tabindex="-1" aria-hidden="false" style="outline:none;width:33.333333333333336%"><div><div class="link" data-link-type="router"><a draggable="false" aria-labelledby="g-uniq-278791" aria-describedby="g-uniq-278792 g-uniq-278793 g-uniq-278795" class="g-link g-link_view_normal pc-card-base-block pc-card-base-block_border_shadow bc-post-card__card" href="../managing-best-in-class-open-source-tools-so-you-can-focus-on-the-data.html"><div class="pc-storage-background-image pc-card-base-block__header bc-post-card__header" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/blog/default-covers/video-adam-small-cover.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/blog/default-covers/video-adam-small-cover.png" class="pc-storage-background-image__img"/></picture><div class="pc-storage-background-image__container"><div class="pc-card-base-block__header-content"><div class="bc-post-card__image-container" data-qa="blog-suggest-header"></div></div></div></div><div class="pc-card-base-block__body"><div class="pc-card-base-block__content"><h3 class="bc-post-card__title bc-post-card__title_size_s"><span><span id="g-uniq-278791">Managing best-in-class open-source tools so you can focus on the data</span></span></h3><span class="yfm yfm_blog_card bc-post-card__description" id="g-uniq-278792">Webinar with Adam Jennings, Solution Architect</span></div><div class="pc-card-base-block__footer"><div class="bc-post-info__container"><div class="bc-post-info__suggest-container"><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-278793">October 24, 2022</div><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-278795"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>30 mins to read</div></div></div></div></div></a></div></div></div><div data-index="2" class="slick-slide slick-active" tabindex="-1" aria-hidden="false" style="outline:none;width:33.333333333333336%"><div><div class="link" data-link-type="router"><a draggable="false" aria-labelledby="g-uniq-278796" aria-describedby="g-uniq-278798 g-uniq-278800" class="g-link g-link_view_normal pc-card-base-block pc-card-base-block_border_shadow bc-post-card__card" href="../../09/what-is-clickhouse-why-column-oriented-dbms-are-important.html"><div class="pc-storage-background-image pc-card-base-block__header bc-post-card__header" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/blog/articles/what-is-clickhouse-a-revolutionary-tool-small-cover.jpg.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/blog/articles/what-is-clickhouse-a-revolutionary-tool-small-cover.jpg" class="pc-storage-background-image__img"/></picture><div class="pc-storage-background-image__container"><div class="pc-card-base-block__header-content"><div class="bc-post-card__image-container" data-qa="blog-suggest-header"></div></div></div></div><div class="pc-card-base-block__body"><div class="pc-card-base-block__content"><h3 class="bc-post-card__title bc-post-card__title_size_s"><span><span id="g-uniq-278796">What is ClickHouse: A revolutionary tool for real-time data processing</span></span></h3></div><div class="pc-card-base-block__footer"><div class="bc-post-info__container"><div class="bc-post-info__suggest-container"><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-278798">September 27, 2022</div><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-278800"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>20 mins to read</div></div></div></div></div></a></div></div></div></div></div></div><div class="pc-SliderBlock__footer"></div></div></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>*&nbsp;ClickHouse&reg; is&nbsp;a&nbsp;trademark of&nbsp;ClickHouse, Inc. <a href="https://clickhouse.com" target="_blank">https://clickhouse.com</a></p></div></section></div></div></div></div></div></main></div></div></div><div class="bc-prompt bc-prompt_close"><div class="bc-prompt__content"><span class="bc-prompt__text">Sign in to save this post</span><div class="bc-prompt__actions"><button class="g-button g-button_view_action g-button_size_l g-button_pin_round-round bc-prompt__action" type="button"><span class="g-button__text">Sign In</span></button></div></div></div></div><footer class="footer"><div class="pc-Grid"><div class="container-fluid "><div class="row"><div class="col  col-12 col-md-4 footer__column"><div class="link" data-link-type="router"><div class="logo footer__logo"><img alt="Logo Icon" src="../../../../../assets/logo/dc-logo-dark.svg" width="178" height="36" decoding="async" data-nimg="future" class="logo__icon" loading="lazy" style="color:transparent"/><span class="logo__text"></span></div></div></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Products</div><a aria-label="Managed Service for ClickHouse®" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/managed-clickhouse.html"><div class="navigation-item"><span class="navigation-item__text">Managed Service for ClickHouse®</span></div></a><a aria-label="Managed Service for Apache Kafka®" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/managed-kafka.html"><div class="navigation-item"><span class="navigation-item__text">Managed Service for Apache Kafka®</span></div></a><a aria-label="Managed Service for Apache Airflow®" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/managed-airflow/index.html"><div class="navigation-item"><span class="navigation-item__text">Managed Service for Apache Airflow®</span></div></a><a aria-label="Data Transfer" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/doublecloud-transfer.html"><div class="navigation-item"><span class="navigation-item__text">Data Transfer</span></div></a><a aria-label="Data Visualization" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/doublecloud-visualization.html"><div class="navigation-item"><span class="navigation-item__text">Data Visualization</span></div></a></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Solutions</div><a aria-label="Case studies" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../resources/case-studies/index.html"><div class="navigation-item"><span class="navigation-item__text">Case studies</span></div></a><a aria-label="Customer-facing analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../customer-facing-analytics/index.html"><div class="navigation-item"><span class="navigation-item__text">Customer-facing analytics</span></div></a><a aria-label="Real-time analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/real-time-analytics/index.html"><div class="navigation-item"><span class="navigation-item__text">Real-time analytics</span></div></a><a aria-label="Observability and monitoring" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/observability-and-monitoring/index.html"><div class="navigation-item"><span class="navigation-item__text">Observability and monitoring</span></div></a><a aria-label="AdTech and MarTech data analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/adtech.html"><div class="navigation-item"><span class="navigation-item__text">AdTech and MarTech data analytics</span></div></a><a aria-label="Analytics for mobile and gaming Apps" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/web-mobile-gaming-apps.html"><div class="navigation-item"><span class="navigation-item__text">Analytics for mobile and gaming Apps</span></div></a><a aria-label="EdTech data analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/edtech/index.html"><div class="navigation-item"><span class="navigation-item__text">EdTech data analytics</span></div></a><a aria-label="FinTech data analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/fintech-real-time-analytics/index.html"><div class="navigation-item"><span class="navigation-item__text">FinTech data analytics</span></div></a></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Resources</div><a aria-label="Documentation" class="navigation-item navigation-item_type_link footer__column-link" href="../../../../../docs/index.html"><div class="navigation-item"><span class="navigation-item__text">Documentation</span></div></a><a aria-label="Webinars" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../webinars/index.html"><div class="navigation-item"><span class="navigation-item__text">Webinars</span></div></a><a aria-label="Blog" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../index.html"><div class="navigation-item navigation-item_selected"><span class="navigation-item__text">Blog</span></div></a><a aria-label="Support" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../support/index.html"><div class="navigation-item"><span class="navigation-item__text">Support</span></div></a><a href="https://status.double.cloud/" aria-label="Status updates" class="navigation-item navigation-item_type_link footer__column-link" target="_blank" rel="noopener noreferrer"><div class="navigation-item"><span class="navigation-item__text">Status updates</span></div></a><a aria-label="Product comparisons" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../comparison/index.html"><div class="navigation-item"><span class="navigation-item__text">Product comparisons</span></div></a><a aria-label="Site map" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../sitemap/index.html"><div class="navigation-item"><span class="navigation-item__text">Site map</span></div></a></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Company</div><a aria-label="About DoubleCloud" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../company/about-us.html"><div class="navigation-item"><span class="navigation-item__text">About DoubleCloud</span></div></a><a aria-label="Careers" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../company/careers.html"><div class="navigation-item"><span class="navigation-item__text">Careers</span></div></a><a aria-label="AWS Partnership" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../aws-partnership/index.html"><div class="navigation-item"><span class="navigation-item__text">AWS Partnership</span></div></a></div></div><div class="row"><div class="col  col-12 footer__underline"><div class="footer__underline-links"><a href="../../../../../legal/customer_agreement/index.html" aria-label="Customer Agreement" class="navigation-item navigation-item_type_link footer__underline-link" target="_blank"><div class="navigation-item"><span class="navigation-item__text">Customer Agreement</span></div></a><a href="../../../../../legal/privacy.html" aria-label="Privacy Policy" class="navigation-item navigation-item_type_link footer__underline-link" target="_blank"><div class="navigation-item"><span class="navigation-item__text">Privacy Policy</span></div></a><a aria-label="Pricing" class="navigation-item navigation-item_type_link footer__underline-link" data-link-type="router" href="../../../../../pricing.html"><div class="navigation-item"><span class="navigation-item__text">Pricing</span></div></a><a href="../../../../../security.html" aria-label="Security" class="navigation-item navigation-item_type_link footer__underline-link" target="_blank"><div class="navigation-item"><span class="navigation-item__text">Security</span></div></a></div><div class="footer__underline-copyright">© 2024 DoubleCloud</div></div></div></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json" nonce="JUvjHaH4XkX7JEE/WCd5Kw==">{"props":{"pageProps":{"data":{"status":"fulfilled","pageContent":{"page":{"id":10,"name":"blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems","createdAt":"2024-08-21T09:50:03.952Z","updatedAt":"2024-08-21T09:50:03.952Z","type":"default","isDeleted":false,"versionOnTranslationId":null,"pageId":10,"locale":"en","publishedVersionId":2222,"lastVersionId":2222,"content":{"blocks":[{"type":"blog-header-block","resetPaddings":true,"paddingBottom":"l","width":"m","verticalOffset":"xl","background":{"image":{"src":"/assets/doublecloud/(de-)normalization_cover.jpg","disableCompress":true,"fetchPriority":"high"},"color":"#000000","fullWidth":false}},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-author-block","column":"right","resetPaddings":true,"authorId":387},{"type":"blog-yfm-block","column":"right","resetPaddings":true,"text":"\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#how-can\"\u003eHow can dictionaries help with those problems?\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#speed-up\"\u003eSpeed Up\u0026nbsp;Query by\u0026nbsp;Normalization\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#dictionaries\"\u003eDictionaries to\u0026nbsp;the rescue!\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"},{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003e\u003cem\u003eWritten by\u0026nbsp;\u003ca href=\"https://www.linkedin.com/in/stefan-k%C3%A4ser-344903119/\" target=\"_blank\"\u003eStefan Kaeser\u003c/a\u003e, DoubleCloud Solutions Architect\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eA\u0026nbsp;few days ago I\u0026nbsp;stumbled across a\u0026nbsp;blog post from our friends over at\u0026nbsp;ClickHouse\u0026reg; about \u003ca href=\"https://clickhouse.com/blog/real-world-data-noaa-climate-data\" target=\"_blank\"\u003eExploring massive, real-world data sets: 100+ Years of\u0026nbsp;Weather Records in\u0026nbsp;ClickHouse\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s a\u0026nbsp;well written blog and really shows what ClickHouse is\u0026nbsp;capable of, regarding transforming billions of\u0026nbsp;datapoints with low effort. They showed how to\u0026nbsp;load data from files from external urls, how to\u0026nbsp;use regex for formatting data, creation of\u0026nbsp;dictionaries, etc. If\u0026nbsp;you haven\u0026rsquo;t already, then go\u0026nbsp;ahead and read through their post.\u003c/p\u003e\n\u003cp\u003eHowever\u0026hellip; there was something in\u0026nbsp;the blog I\u0026nbsp;couldn\u0026rsquo;t stop thinking about:\u003c/p\u003e\n\u003cp\u003eTheir main query for analyzing the data still took 14\u0026nbsp;seconds after optimization, which is\u0026nbsp;a\u0026nbsp;really long time when you are used to\u0026nbsp;ClickHouse and its normally sub-second responses. The second thing which makes me\u0026nbsp;feel uncomfortable is\u0026nbsp;the denormalized structure of\u0026nbsp;their main table.\u003c/p\u003e\n\u003cp\u003eWhen I\u0026nbsp;first learnt about normalization during my\u0026nbsp;time at\u0026nbsp;University two decades ago, denormalisation was\u0026nbsp;bad. It\u0026nbsp;was drummed into us\u0026nbsp;that you should normalize as\u0026nbsp;much as\u0026nbsp;possible, and during that time, mainly with the usage of\u0026nbsp;only OLTP, this was the correct choice to\u0026nbsp;do. But times have changed and OLAP took over in\u0026nbsp;a\u0026nbsp;lot of\u0026nbsp;places, and with big analytica workflows denormalisation got a\u0026nbsp;revival and helped to\u0026nbsp;maximize query speeds in\u0026nbsp;a\u0026nbsp;lot of\u0026nbsp;cases.\u003c/p\u003e\n\u003cp\u003eBut still there are things to\u0026nbsp;consider when you denormalise, especially when handling huge amounts of\u0026nbsp;data:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWhen data changes it\u0026nbsp;can take a\u0026nbsp;very long time to\u0026nbsp;update old data\u003c/li\u003e\n\u003cli\u003eWith billions or\u0026nbsp;trillions of\u0026nbsp;rows, even small columns can take up\u0026nbsp;very much space\u003c/li\u003e\n\u003c/ul\u003e"},{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003ch2 id=\"how-can\"\u003e\u003ca href=\"#how-can\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eHow can dictionaries help with those problems?\u003c/span\u003e\u003c/a\u003eHow can dictionaries help with those problems?\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSpoiler Alert: You can speed the query up\u0026nbsp;from multiple seconds to\u0026nbsp;milliseconds!\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eFirst of\u0026nbsp;all, if\u0026nbsp;you want to\u0026nbsp;play around with optimizations yourself, I\u0026nbsp;encourage you once again to\u0026nbsp;read ClickHouses' blog post, as\u0026nbsp;I\u0026nbsp;won\u0026rsquo;t repeat the filling process from them, but instead build up\u0026nbsp;on\u0026nbsp;it. But for those of\u0026nbsp;you just enjoying the read without replaying it, I\u0026rsquo;ll give you the tabledefinitions and some cardinalities. The main table which has weather data from weather stations all over the world since 1900\u0026nbsp;looks like this:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e sensors_blog\n(\n    `station_id` LowCardinality(String),\n    `\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e` Date32,\n    `tempAvg` Nullable(Int32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Average temperature (tenths of a degrees C)'\u003c/span\u003e,\n    `tempMax` Nullable(Int32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Maximum temperature (tenths of degrees C)'\u003c/span\u003e,\n    `tempMin` Nullable(Int32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Minimum temperature (tenths of degrees C)'\u003c/span\u003e,\n    `precipitation` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Precipitation (tenths of mm)'\u003c/span\u003e,\n    `snowfall` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Snowfall (mm)'\u003c/span\u003e,\n    `snowDepth` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Snow depth (mm)'\u003c/span\u003e,\n    `percentDailySun` Nullable(UInt8) COMMENT \u003cspan class=\"hljs-string\"\u003e'Daily percent of possible sunshine (percent)'\u003c/span\u003e,\n    `averageWindSpeed` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Average daily wind speed (tenths of meters per second)'\u003c/span\u003e,\n    `maxWindSpeed` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Peak gust wind speed (tenths of meters per second)'\u003c/span\u003e,\n    `weatherType` Nullable(Enum8(\u003cspan class=\"hljs-string\"\u003e'Normal'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Heavy Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Thunder'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Small Hail'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Hail'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Glaze'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Dust/Ash'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Smoke/Haze'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e, \n                      \u003cspan class=\"hljs-string\"\u003e'Blowing/Drifting Snow'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Tornado'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'High Winds'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Blowing Spray'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Mist'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Drizzle'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e14\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Freezing Drizzle'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e15\u003c/span\u003e, \n                      \u003cspan class=\"hljs-string\"\u003e'Rain'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Freezing Rain'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e17\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Snow'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Unknown Precipitation'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e19\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Ground Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e21\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Freezing Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e22\u003c/span\u003e)),\n    `location` Point,\n    `elevation` Float32,\n    `name` LowCardinality(String)\n) ENGINE \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e MergeTree() \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e (station_id, \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"9\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-9\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-9\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-9.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eNotice I\u0026rsquo;ve changed the name from noaa to\u0026nbsp;sensors_blog and added some Nullables for some internal reasons. The table contains around \u003cstrong\u003e1.08 billion\u003c/strong\u003e rows and there are around \u003cstrong\u003e120k\u003c/strong\u003e unique stations within.\u003c/p\u003e\n\u003cp\u003eThe columns location, elevation and name are all depended directly from station_id and make up\u0026nbsp;the denormalized part, so\u0026nbsp;let\u0026rsquo;s look to\u0026nbsp;see if\u0026nbsp;it\u0026rsquo;s worth adding them to\u0026nbsp;the table at\u0026nbsp;all and what it\u0026nbsp;costs:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    name,\n    formatReadableSize(\u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(data_compressed_bytes)) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e compressed,\n    formatReadableSize(\u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(data_uncompressed_bytes)) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e uncompressed\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e system.columns\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e (database \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'weather'\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etable\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'sensors_blog'\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e name\n    \u003cspan class=\"hljs-keyword\"\u003eWITH\u003c/span\u003e TOTALS\n\n┌─name─────────────┬─compressed─┬─uncompressed─┐\n│ \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e             │ \u003cspan class=\"hljs-number\"\u003e2.46\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e4.01\u003c/span\u003e GiB     │\n│ snowfall         │ \u003cspan class=\"hljs-number\"\u003e124.18\u003c/span\u003e MiB │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ tempMax          │ \u003cspan class=\"hljs-number\"\u003e1.17\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ tempMin          │ \u003cspan class=\"hljs-number\"\u003e1.17\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ tempAvg          │ \u003cspan class=\"hljs-number\"\u003e279.95\u003c/span\u003e MiB │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ weatherType      │ \u003cspan class=\"hljs-number\"\u003e40.65\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e2.00\u003c/span\u003e GiB     │\n│ snowDepth        │ \u003cspan class=\"hljs-number\"\u003e141.74\u003c/span\u003e MiB │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ precipitation    │ \u003cspan class=\"hljs-number\"\u003e1.11\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ averageWindSpeed │ \u003cspan class=\"hljs-number\"\u003e41.31\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ maxWindSpeed     │ \u003cspan class=\"hljs-number\"\u003e35.07\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ percentDailySun  │ \u003cspan class=\"hljs-number\"\u003e10.28\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e2.00\u003c/span\u003e GiB     │\n\n│ station_id       │ \u003cspan class=\"hljs-number\"\u003e16.63\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e1.98\u003c/span\u003e GiB     │\n\n│ name             │ \u003cspan class=\"hljs-number\"\u003e20.85\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e1.99\u003c/span\u003e GiB     │\n│ location         │ \u003cspan class=\"hljs-number\"\u003e87.51\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e16.04\u003c/span\u003e GiB    │\n│ elevation        │ \u003cspan class=\"hljs-number\"\u003e22.52\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e4.01\u003c/span\u003e GiB     │\n└──────────────────┴────────────┴──────────────┘\n\nTotals:\n┌─name─┬─compressed─┬─uncompressed─┐\n│      │ \u003cspan class=\"hljs-number\"\u003e6.71\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e72.14\u003c/span\u003e GiB    │\n└──────┴────────────┴──────────────┘\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"16\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-16\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-16\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-16.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eI\u0026rsquo;ve separated the denormalized columns for better readability.\u003c/p\u003e\n\u003cp\u003eAs\u0026nbsp;the table is\u0026nbsp;ordered by\u0026nbsp;station_id, the denormalized depended columns compress extremely well, but still take up\u0026nbsp;nearly 2% of\u0026nbsp;the total data. Uncompressed it\u0026rsquo;s 30% of\u0026nbsp;the data, which will eat some of\u0026nbsp;your cpu cycles for decompression when querying\u0026nbsp;it. That not only takes denormalisation more space, it\u0026nbsp;can also slow down your queries.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s take a\u0026nbsp;look now at\u0026nbsp;the main query which bothered me\u0026nbsp;the most when I\u0026nbsp;read the original post:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e maxTemp,\n    station_id,\n    \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e,\n    location\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e dictGet(country_polygons, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, location) \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'Portugal'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tempMax \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e2e2\u003c/span\u003ebd273\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ef4a0\u003cspan class=\"hljs-number\"\u003e-4268\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-856\u003c/span\u003ec\u003cspan class=\"hljs-number\"\u003e-20\u003c/span\u003eef5fec9f61\n\n┌─maxTemp─┬─station_id──┬───────\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e─┬─location──────────┐\n│    \u003cspan class=\"hljs-number\"\u003e45.8\u003c/span\u003e │ PO000008549 │ \u003cspan class=\"hljs-number\"\u003e1944\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-30\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-8.4167\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e40.2\u003c/span\u003e)    │\n│    \u003cspan class=\"hljs-number\"\u003e45.4\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e45.2\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e1995\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-23\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e44.5\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n│    \u003cspan class=\"hljs-number\"\u003e44.2\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-13\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n└─────────┴─────────────┴────────────┴───────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e14.427\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e35.94\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e74.61\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e2.49\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"26\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-26\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-26\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-26.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eThe query tries to\u0026nbsp;get the top five temperatures occurring in\u0026nbsp;Portugal since the recordings began. It\u0026rsquo;s already optimized by\u0026nbsp;using a\u0026nbsp;dictionary to\u0026nbsp;look up\u0026nbsp;the geolocations of\u0026nbsp;Portugal, but still it\u0026nbsp;takes nearly 15\u0026nbsp;seconds\u0026hellip; and for clickhouse that\u0026rsquo;s like an\u0026nbsp;eternity.\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;can it\u0026nbsp;be\u0026nbsp;improved?\u003c/p\u003e\n\u003cp\u003eActually it\u0026nbsp;can, and the authors of\u0026nbsp;the original blog already did so, as\u0026nbsp;they found out that the first two characters of\u0026nbsp;station_id already contained some kind of\u0026nbsp;country code:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e maxTemp,\n    station_id,\n    \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e,\n    location\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003esubstring\u003c/span\u003e(station_id,\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e) \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'PO'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tempMax \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\n┌─maxTemp─┬─station_id──┬───────\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e─┬─location──────────┐\n│    \u003cspan class=\"hljs-number\"\u003e45.8\u003c/span\u003e │ PO000008549 │ \u003cspan class=\"hljs-number\"\u003e1944\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-30\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-8.4167\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e40.2\u003c/span\u003e)    │\n│    \u003cspan class=\"hljs-number\"\u003e45.4\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e45.2\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e1995\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-23\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e44.5\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n│    \u003cspan class=\"hljs-number\"\u003e44.2\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-13\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n└─────────┴─────────────┴────────────┴───────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e1.440\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e7.39\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e747.38\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e5.13\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"36\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-36\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-36\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-36.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eWe\u0026nbsp;can see that it\u0026nbsp;is\u0026nbsp;already 10\u0026nbsp;times faster, but only because we\u0026nbsp;have some meta information about how the station_id is\u0026nbsp;built. If\u0026nbsp;however the station_id would just be\u0026nbsp;a\u0026nbsp;generic id, we\u0026nbsp;would not be\u0026nbsp;able to\u0026nbsp;use it\u0026nbsp;for speeding up\u0026nbsp;that query.\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;let\u0026rsquo;s go\u0026nbsp;back to\u0026nbsp;the original query and analyze what\u0026rsquo;s taking so\u0026nbsp;long.\u003c/p\u003e\n\u003cp\u003eActually it\u0026nbsp;is\u0026nbsp;the denormalization of\u0026nbsp;the main table which slows down the whole query. For each of\u0026nbsp;the 1.08 billion rows ClickHouse has to\u0026nbsp;read the location from disk, decompress it\u0026nbsp;(16GB in\u0026nbsp;total), throw it\u0026nbsp;into the dictionary (which is\u0026nbsp;cached of\u0026nbsp;course), and then throw it\u0026nbsp;away if\u0026nbsp;the condition of\u0026nbsp;'Portugal' does not hold.\u003c/p\u003e\n\u003cp\u003eThe same problem occurs with the already optimized version, but of\u0026nbsp;course much faster as\u0026nbsp;the station_id is\u0026nbsp;much smaller and handling substrings is\u0026nbsp;of\u0026nbsp;course faster than checking if\u0026nbsp;a\u0026nbsp;point lies within a\u0026nbsp;polygon.\u003c/p\u003e\n\u003ch2 id=\"speed-up\"\u003e\u003ca href=\"#speed-up\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eSpeed Up\u0026nbsp;Query by\u0026nbsp;Normalization\u003c/span\u003e\u003c/a\u003eSpeed Up\u0026nbsp;Query by\u0026nbsp;Normalization\u003c/h2\u003e\n\u003cp\u003eAfter analyzing the query and what it\u0026nbsp;does, especially reading a\u0026nbsp;lot of\u0026nbsp;redundant data from disk and decompressing it, we\u0026nbsp;can speed up\u0026nbsp;the query by\u0026nbsp;undoing the denormalization.\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e stations_blog (\n    station_id String,\n    `location` Point,\n    elevation Float32, \n    name String\n) Engine\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003eReplacingMergeTree \u003cspan class=\"hljs-keyword\"\u003ePARTITION\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tuple() \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e (station_id);\n\n\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e stations_blog\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e station_id, location, elevation, name\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ecount\u003c/span\u003e(\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e stations_blog\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e700\u003c/span\u003ea0ef9\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ed97b\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003ea1b\u003cspan class=\"hljs-number\"\u003e-9144\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ebdaf5bbbf2cc\n\n┌─\u003cspan class=\"hljs-built_in\"\u003ecount\u003c/span\u003e()─┐\n│  \u003cspan class=\"hljs-number\"\u003e121564\u003c/span\u003e │\n└─────────┘\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"55\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-55\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-55\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-55.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eOf\u0026nbsp;course if\u0026nbsp;you\u0026rsquo;ve downloaded the original stations.txt you could have created the table from that file as\u0026nbsp;well. So\u0026nbsp;now as\u0026nbsp;we\u0026nbsp;have our stations_blog table we\u0026nbsp;can finally speed up\u0026nbsp;the query to\u0026nbsp;find the top five temperatures of\u0026nbsp;Portugal to\u0026nbsp;get the result in\u0026nbsp;a\u0026nbsp;ClickHouse felt way:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e maxTemp,\n    station_id,\n    \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e,\n    location\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-comment\"\u003e-- WHERE dictGet(country_polygons, 'name', location) = 'Portugal'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e station_id \u003cspan class=\"hljs-keyword\"\u003eIN\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e station_id\n    \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e stations_blog\n    \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e dictGet(country_polygons, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, location) \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'Portugal'\u003c/span\u003e\n)\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tempMax \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e5e08\u003c/span\u003eadd8\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eab76\u003cspan class=\"hljs-number\"\u003e-4273\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-9019\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eae1519b72988\n\n┌─maxTemp─┬─station_id──┬───────\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e─┬─location──────────┐\n│    \u003cspan class=\"hljs-number\"\u003e45.8\u003c/span\u003e │ PO000008549 │ \u003cspan class=\"hljs-number\"\u003e1944\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-30\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-8.4167\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e40.2\u003c/span\u003e)    │\n│    \u003cspan class=\"hljs-number\"\u003e45.4\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e45.2\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e1995\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-23\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e44.5\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n│    \u003cspan class=\"hljs-number\"\u003e44.2\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-13\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n└─────────┴─────────────┴────────────┴───────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e0.034\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e581.63\u003c/span\u003e thousand \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e20.13\u003c/span\u003e MB (\u003cspan class=\"hljs-number\"\u003e17.27\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e597.57\u003c/span\u003e MB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"59\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-59\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-59\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-59.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e0.034 sec\u003c/strong\u003e now that\u0026rsquo;s what I\u0026nbsp;consider ClickHouse speed.\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;here we\u0026nbsp;have an\u0026nbsp;example when denormalization does not help at\u0026nbsp;all, or\u0026nbsp;even worse prevents you from getting the fastest results.\u003c/p\u003e\n\u003ch2 id=\"dictionaries\"\u003e\u003ca href=\"#dictionaries\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eDictionaries to\u0026nbsp;the rescue!\u003c/span\u003e\u003c/a\u003eDictionaries to\u0026nbsp;the rescue!\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eBut what about other queries, where we\u0026nbsp;need to\u0026nbsp;access the denormalized columns, will normalizing slow them down?\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eWell let\u0026rsquo;s test!\u003cbr /\u003e\nLet\u0026rsquo;s say we\u0026nbsp;want the five stations with top average maxtemperature with their name printed:\u003cbr /\u003e\nDenormalised:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eAVG\u003c/span\u003e(tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e avgMaxTemp,\n    station_id,\n    \u003cspan class=\"hljs-keyword\"\u003eany\u003c/span\u003e(name) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e stationName\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e station_id\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e avgMaxTemp \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003edd12cbb\u003cspan class=\"hljs-number\"\u003e-6962\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003eb22\u003cspan class=\"hljs-number\"\u003e-948\u003c/span\u003ed\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ebbc1976b691b\n\n┌─avgMaxTemp─┬─station_id──┬─stationName────────┐\n│       \u003cspan class=\"hljs-number\"\u003e44.4\u003c/span\u003e │ USC00143323 │ KS HADDAM          │\n│      \u003cspan class=\"hljs-number\"\u003e41.65\u003c/span\u003e │ IN019180300 │ PHALODI            │\n│       \u003cspan class=\"hljs-number\"\u003e40.6\u003c/span\u003e │ USC00413142 │ TX FIFE            │\n│      \u003cspan class=\"hljs-number\"\u003e40.55\u003c/span\u003e │ USC00207427 │ MI SECORD DAM      │\n│      \u003cspan class=\"hljs-number\"\u003e39.85\u003c/span\u003e │ USC00416953 │ TX PERRYTON \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e WNW │\n└────────────┴─────────────┴────────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e3.596\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e17.18\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e299.34\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e4.78\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"75\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-75\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-75\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-75.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eNormalized and joining the data:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eAVG\u003c/span\u003e(tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e avgMaxTemp,\n    station_id,\n    \u003cspan class=\"hljs-keyword\"\u003eany\u003c/span\u003e(stations_blog.name) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e stationName\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eINNER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eJOIN\u003c/span\u003e stations_blog \u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e stations_blog.station_id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e sensors_blog.station_id\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e station_id\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e avgMaxTemp \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003efdf927d\u003cspan class=\"hljs-number\"\u003e-1446\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-443\u003c/span\u003ec\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaf5a\u003cspan class=\"hljs-number\"\u003e-48573440060\u003c/span\u003ec\n\n┌─avgMaxTemp─┬─station_id──┬─stationName────────┐\n│       \u003cspan class=\"hljs-number\"\u003e44.4\u003c/span\u003e │ USC00143323 │ KS HADDAM          │\n│      \u003cspan class=\"hljs-number\"\u003e41.65\u003c/span\u003e │ IN019180300 │ PHALODI            │\n│       \u003cspan class=\"hljs-number\"\u003e40.6\u003c/span\u003e │ USC00413142 │ TX FIFE            │\n│      \u003cspan class=\"hljs-number\"\u003e40.55\u003c/span\u003e │ USC00207427 │ MI SECORD DAM      │\n│      \u003cspan class=\"hljs-number\"\u003e39.85\u003c/span\u003e │ USC00416953 │ TX PERRYTON \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e WNW │\n└────────────┴─────────────┴────────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e9.005\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e10.98\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e119.54\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e1.22\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"79\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-79\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-79\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-79.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eSo\u0026nbsp;as\u0026nbsp;most of\u0026nbsp;you might have expected already, joining the stations table makes the query nearly three times slower going up\u0026nbsp;from \u003cstrong\u003e3.5 sec\u003c/strong\u003e to\u0026nbsp;\u003cstrong\u003e9.0 sec\u003c/strong\u003e\u0026hellip; Of\u0026nbsp;course there are ways to\u0026nbsp;prevent the join by\u0026nbsp;getting the station name later, or\u0026nbsp;by\u0026nbsp;building more complicated queries with SubSelects or\u0026nbsp;some special tricks, but that just isn\u0026rsquo;t fun, and ClickHouse is\u0026nbsp;all about fun\u0026hellip; right?\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;what can we\u0026nbsp;do\u0026nbsp;to\u0026nbsp;speed up\u0026nbsp;those types of\u0026nbsp;select queries?\u003c/p\u003e\n\u003cp\u003eWe\u0026nbsp;can build a\u0026nbsp;dictionary out of\u0026nbsp;the stations_blog table and use that instead of\u0026nbsp;the join:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e DICTIONARY stations_dict\n(\n   `station_id` String,\n   `name` String\n)\n\u003cspan class=\"hljs-keyword\"\u003ePRIMARY\u003c/span\u003e KEY station_id\nSOURCE(CLICKHOUSE(\u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'stations_blog'\u003c/span\u003e))\nLIFETIME(MIN \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e MAX \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\nLAYOUT(complex_key_hashed())\n\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eAVG\u003c/span\u003e(tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e avgMaxTemp,\n    station_id,\n    dictGet(stations_dict, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, station_id) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e stationName\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e station_id\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e avgMaxTemp \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: df158271\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efaee\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003eb48\u003cspan class=\"hljs-number\"\u003e-9\u003c/span\u003ef9b\u003cspan class=\"hljs-number\"\u003e-7e82\u003c/span\u003ee48a1009\n\n┌─avgMaxTemp─┬─station_id──┬─stationName────────┐\n│       \u003cspan class=\"hljs-number\"\u003e44.4\u003c/span\u003e │ USC00143323 │ KS HADDAM          │\n│      \u003cspan class=\"hljs-number\"\u003e41.65\u003c/span\u003e │ IN019180300 │ PHALODI            │\n│       \u003cspan class=\"hljs-number\"\u003e40.6\u003c/span\u003e │ USC00413142 │ TX FIFE            │\n│      \u003cspan class=\"hljs-number\"\u003e40.55\u003c/span\u003e │ USC00207427 │ MI SECORD DAM      │\n│      \u003cspan class=\"hljs-number\"\u003e39.85\u003c/span\u003e │ USC00416953 │ TX PERRYTON \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e WNW │\n└────────────┴─────────────┴────────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e1.930\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e10.97\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e557.63\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e5.69\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"89\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-89\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-89\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-89.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e1.9 sec\u003c/strong\u003e wow, that\u0026rsquo;s even faster than the select on\u0026nbsp;the denormalized table.\u003c/p\u003e\n\u003cp\u003eAgain the reason here is, that ClickHouse does not have to\u0026nbsp;read and uncompress the name column at\u0026nbsp;all, but uses the station_id to\u0026nbsp;fetch the corresponding name form the cached dictionary.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eSo\u0026nbsp;what to\u0026nbsp;take with you?\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eEven in\u0026nbsp;OLAP scenarios, denormalisation can be\u0026nbsp;problematic and slow down your queries apart from the other known facts. Normalization can help with optimization but can complicate things. ClickHouse dictionaries can help you get the best out of\u0026nbsp;both worlds sometimes. It\u0026rsquo;s always worth trying to\u0026nbsp;optimize stuff, you will find out something new a\u0026nbsp;lot of\u0026nbsp;the time. So\u0026nbsp;have fun using ClickHouse, support the OpenSource world, and when you need help managing ClickHouse within the cloud ask us!\u003c/p\u003e"}]},{"type":"content-layout-block","background":{"src":"/assets/doublecloud/doublecloud-cover-5.png","style":{"backgroundColor":"#CA1551"}},"centered":true,"textContent":{"title":"Get started with DoubleCloud","buttons":[{"text":"Start free trial","size":"promo","theme":"accent","url":"https://auth.double.cloud/s/signup"},{"text":"Contact us","theme":"pseudo","url":"#contact-us-form"}]}},{"type":"blog-suggest-block","resetPaddings":true,"fullWidth":false},{"type":"blog-yfm-block","column":"right","resetPaddings":true,"text":"\u003cp\u003e*\u0026nbsp;ClickHouse\u0026reg; is\u0026nbsp;a\u0026nbsp;trademark of\u0026nbsp;ClickHouse, Inc. \u003ca href=\"https://clickhouse.com\" target=\"_blank\"\u003ehttps://clickhouse.com\u003c/a\u003e\u003c/p\u003e"}]},"title":null,"noIndex":false,"shareTitle":null,"shareDescription":"Written by Stefan Kaeser, DoubleCloud Solutions Architect","shareImage":"/assets/blog/articles/new-sharing-images/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems-sharing.png","pageLocaleId":20,"author":"unknown","metaDescription":null,"keywords":[],"shareGenTitle":null,"canonicalLink":null,"sharingType":"custom","sharingTheme":"dark","comment":"add fetchProperty prop to header or bg","shareImageUrl":null,"pageRegionId":null,"service":null,"solution":null,"locales":[{"locale":"ru","publishedVersionId":null},{"locale":"en","publishedVersionId":2222}],"regions":[],"pageRegions":[]},"post":{"url":"","id":10,"name":"de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems","isPinned":false,"blogPostId":10,"image":"/assets/blog/default-covers/denormalization-small-cover.png","readingTime":20,"date":"2022-10-10T00:00:00Z","likes":0,"hasUserLike":false,"services":[],"slug":"","authors":[],"locale":{"lang":"en"},"textTitle":"(De-)normalization \u0026amp; how ClickHouse® dictionaries can solve typical problems","htmlTitle":"(De-)normalization \u0026amp; how ClickHouse\u0026reg; dictionaries can solve typical problems","title":"(De-)normalization \u0026 how ClickHouse® dictionaries can solve typical problems","tags":[{"icon":null,"slug":"insights","name":"Insights","createdAt":"","updatedAt":"","count":0},{"icon":null,"slug":"ClickHouse","name":"ClickHouse","createdAt":"","updatedAt":"","count":0}],"metaTitle":"(De-)normalization \u0026 how ClickHouse® dictionaries can solve typical problems","description":"\u003cp\u003eWritten by\u0026nbsp;Stefan Kaeser, DoubleCloud Solutions Architect\u003c/p\u003e","content":"\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#how-can\"\u003eHow can dictionaries help with those problems?\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#speed-up\"\u003eSpeed Up\u0026nbsp;Query by\u0026nbsp;Normalization\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#dictionaries\"\u003eDictionaries to\u0026nbsp;the rescue!\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cem\u003eWritten by\u0026nbsp;\u003ca href=\"https://www.linkedin.com/in/stefan-k%C3%A4ser-344903119/\" target=\"_blank\"\u003eStefan Kaeser\u003c/a\u003e, DoubleCloud Solutions Architect\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eA\u0026nbsp;few days ago I\u0026nbsp;stumbled across a\u0026nbsp;blog post from our friends over at\u0026nbsp;ClickHouse\u0026reg; about \u003ca href=\"https://clickhouse.com/blog/real-world-data-noaa-climate-data\" target=\"_blank\"\u003eExploring massive, real-world data sets: 100+ Years of\u0026nbsp;Weather Records in\u0026nbsp;ClickHouse\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s a\u0026nbsp;well written blog and really shows what ClickHouse is\u0026nbsp;capable of, regarding transforming billions of\u0026nbsp;datapoints with low effort. They showed how to\u0026nbsp;load data from files from external urls, how to\u0026nbsp;use regex for formatting data, creation of\u0026nbsp;dictionaries, etc. If\u0026nbsp;you haven\u0026rsquo;t already, then go\u0026nbsp;ahead and read through their post.\u003c/p\u003e\n\u003cp\u003eHowever\u0026hellip; there was something in\u0026nbsp;the blog I\u0026nbsp;couldn\u0026rsquo;t stop thinking about:\u003c/p\u003e\n\u003cp\u003eTheir main query for analyzing the data still took 14\u0026nbsp;seconds after optimization, which is\u0026nbsp;a\u0026nbsp;really long time when you are used to\u0026nbsp;ClickHouse and its normally sub-second responses. The second thing which makes me\u0026nbsp;feel uncomfortable is\u0026nbsp;the denormalized structure of\u0026nbsp;their main table.\u003c/p\u003e\n\u003cp\u003eWhen I\u0026nbsp;first learnt about normalization during my\u0026nbsp;time at\u0026nbsp;University two decades ago, denormalisation was\u0026nbsp;bad. It\u0026nbsp;was drummed into us\u0026nbsp;that you should normalize as\u0026nbsp;much as\u0026nbsp;possible, and during that time, mainly with the usage of\u0026nbsp;only OLTP, this was the correct choice to\u0026nbsp;do. But times have changed and OLAP took over in\u0026nbsp;a\u0026nbsp;lot of\u0026nbsp;places, and with big analytica workflows denormalisation got a\u0026nbsp;revival and helped to\u0026nbsp;maximize query speeds in\u0026nbsp;a\u0026nbsp;lot of\u0026nbsp;cases.\u003c/p\u003e\n\u003cp\u003eBut still there are things to\u0026nbsp;consider when you denormalise, especially when handling huge amounts of\u0026nbsp;data:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWhen data changes it\u0026nbsp;can take a\u0026nbsp;very long time to\u0026nbsp;update old data\u003c/li\u003e\n\u003cli\u003eWith billions or\u0026nbsp;trillions of\u0026nbsp;rows, even small columns can take up\u0026nbsp;very much space\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"how-can\"\u003e\u003ca href=\"#how-can\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eHow can dictionaries help with those problems?\u003c/span\u003e\u003c/a\u003eHow can dictionaries help with those problems?\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSpoiler Alert: You can speed the query up\u0026nbsp;from multiple seconds to\u0026nbsp;milliseconds!\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eFirst of\u0026nbsp;all, if\u0026nbsp;you want to\u0026nbsp;play around with optimizations yourself, I\u0026nbsp;encourage you once again to\u0026nbsp;read ClickHouses' blog post, as\u0026nbsp;I\u0026nbsp;won\u0026rsquo;t repeat the filling process from them, but instead build up\u0026nbsp;on\u0026nbsp;it. But for those of\u0026nbsp;you just enjoying the read without replaying it, I\u0026rsquo;ll give you the tabledefinitions and some cardinalities. The main table which has weather data from weather stations all over the world since 1900\u0026nbsp;looks like this:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e sensors_blog\n(\n    `station_id` LowCardinality(String),\n    `\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e` Date32,\n    `tempAvg` Nullable(Int32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Average temperature (tenths of a degrees C)'\u003c/span\u003e,\n    `tempMax` Nullable(Int32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Maximum temperature (tenths of degrees C)'\u003c/span\u003e,\n    `tempMin` Nullable(Int32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Minimum temperature (tenths of degrees C)'\u003c/span\u003e,\n    `precipitation` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Precipitation (tenths of mm)'\u003c/span\u003e,\n    `snowfall` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Snowfall (mm)'\u003c/span\u003e,\n    `snowDepth` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Snow depth (mm)'\u003c/span\u003e,\n    `percentDailySun` Nullable(UInt8) COMMENT \u003cspan class=\"hljs-string\"\u003e'Daily percent of possible sunshine (percent)'\u003c/span\u003e,\n    `averageWindSpeed` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Average daily wind speed (tenths of meters per second)'\u003c/span\u003e,\n    `maxWindSpeed` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Peak gust wind speed (tenths of meters per second)'\u003c/span\u003e,\n    `weatherType` Nullable(Enum8(\u003cspan class=\"hljs-string\"\u003e'Normal'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Heavy Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Thunder'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Small Hail'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Hail'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Glaze'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Dust/Ash'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Smoke/Haze'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e, \n                      \u003cspan class=\"hljs-string\"\u003e'Blowing/Drifting Snow'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Tornado'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'High Winds'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Blowing Spray'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Mist'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Drizzle'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e14\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Freezing Drizzle'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e15\u003c/span\u003e, \n                      \u003cspan class=\"hljs-string\"\u003e'Rain'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Freezing Rain'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e17\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Snow'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Unknown Precipitation'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e19\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Ground Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e21\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Freezing Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e22\u003c/span\u003e)),\n    `location` Point,\n    `elevation` Float32,\n    `name` LowCardinality(String)\n) ENGINE \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e MergeTree() \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e (station_id, \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"9\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-9\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-9\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-9.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eNotice I\u0026rsquo;ve changed the name from noaa to\u0026nbsp;sensors_blog and added some Nullables for some internal reasons. The table contains around \u003cstrong\u003e1.08 billion\u003c/strong\u003e rows and there are around \u003cstrong\u003e120k\u003c/strong\u003e unique stations within.\u003c/p\u003e\n\u003cp\u003eThe columns location, elevation and name are all depended directly from station_id and make up\u0026nbsp;the denormalized part, so\u0026nbsp;let\u0026rsquo;s look to\u0026nbsp;see if\u0026nbsp;it\u0026rsquo;s worth adding them to\u0026nbsp;the table at\u0026nbsp;all and what it\u0026nbsp;costs:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    name,\n    formatReadableSize(\u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(data_compressed_bytes)) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e compressed,\n    formatReadableSize(\u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(data_uncompressed_bytes)) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e uncompressed\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e system.columns\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e (database \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'weather'\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etable\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'sensors_blog'\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e name\n    \u003cspan class=\"hljs-keyword\"\u003eWITH\u003c/span\u003e TOTALS\n\n┌─name─────────────┬─compressed─┬─uncompressed─┐\n│ \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e             │ \u003cspan class=\"hljs-number\"\u003e2.46\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e4.01\u003c/span\u003e GiB     │\n│ snowfall         │ \u003cspan class=\"hljs-number\"\u003e124.18\u003c/span\u003e MiB │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ tempMax          │ \u003cspan class=\"hljs-number\"\u003e1.17\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ tempMin          │ \u003cspan class=\"hljs-number\"\u003e1.17\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ tempAvg          │ \u003cspan class=\"hljs-number\"\u003e279.95\u003c/span\u003e MiB │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ weatherType      │ \u003cspan class=\"hljs-number\"\u003e40.65\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e2.00\u003c/span\u003e GiB     │\n│ snowDepth        │ \u003cspan class=\"hljs-number\"\u003e141.74\u003c/span\u003e MiB │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ precipitation    │ \u003cspan class=\"hljs-number\"\u003e1.11\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ averageWindSpeed │ \u003cspan class=\"hljs-number\"\u003e41.31\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ maxWindSpeed     │ \u003cspan class=\"hljs-number\"\u003e35.07\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ percentDailySun  │ \u003cspan class=\"hljs-number\"\u003e10.28\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e2.00\u003c/span\u003e GiB     │\n\n│ station_id       │ \u003cspan class=\"hljs-number\"\u003e16.63\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e1.98\u003c/span\u003e GiB     │\n\n│ name             │ \u003cspan class=\"hljs-number\"\u003e20.85\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e1.99\u003c/span\u003e GiB     │\n│ location         │ \u003cspan class=\"hljs-number\"\u003e87.51\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e16.04\u003c/span\u003e GiB    │\n│ elevation        │ \u003cspan class=\"hljs-number\"\u003e22.52\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e4.01\u003c/span\u003e GiB     │\n└──────────────────┴────────────┴──────────────┘\n\nTotals:\n┌─name─┬─compressed─┬─uncompressed─┐\n│      │ \u003cspan class=\"hljs-number\"\u003e6.71\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e72.14\u003c/span\u003e GiB    │\n└──────┴────────────┴──────────────┘\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"16\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-16\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-16\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-16.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eI\u0026rsquo;ve separated the denormalized columns for better readability.\u003c/p\u003e\n\u003cp\u003eAs\u0026nbsp;the table is\u0026nbsp;ordered by\u0026nbsp;station_id, the denormalized depended columns compress extremely well, but still take up\u0026nbsp;nearly 2% of\u0026nbsp;the total data. Uncompressed it\u0026rsquo;s 30% of\u0026nbsp;the data, which will eat some of\u0026nbsp;your cpu cycles for decompression when querying\u0026nbsp;it. That not only takes denormalisation more space, it\u0026nbsp;can also slow down your queries.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s take a\u0026nbsp;look now at\u0026nbsp;the main query which bothered me\u0026nbsp;the most when I\u0026nbsp;read the original post:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e maxTemp,\n    station_id,\n    \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e,\n    location\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e dictGet(country_polygons, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, location) \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'Portugal'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tempMax \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e2e2\u003c/span\u003ebd273\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ef4a0\u003cspan class=\"hljs-number\"\u003e-4268\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-856\u003c/span\u003ec\u003cspan class=\"hljs-number\"\u003e-20\u003c/span\u003eef5fec9f61\n\n┌─maxTemp─┬─station_id──┬───────\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e─┬─location──────────┐\n│    \u003cspan class=\"hljs-number\"\u003e45.8\u003c/span\u003e │ PO000008549 │ \u003cspan class=\"hljs-number\"\u003e1944\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-30\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-8.4167\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e40.2\u003c/span\u003e)    │\n│    \u003cspan class=\"hljs-number\"\u003e45.4\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e45.2\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e1995\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-23\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e44.5\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n│    \u003cspan class=\"hljs-number\"\u003e44.2\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-13\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n└─────────┴─────────────┴────────────┴───────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e14.427\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e35.94\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e74.61\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e2.49\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"26\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-26\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-26\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-26.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eThe query tries to\u0026nbsp;get the top five temperatures occurring in\u0026nbsp;Portugal since the recordings began. It\u0026rsquo;s already optimized by\u0026nbsp;using a\u0026nbsp;dictionary to\u0026nbsp;look up\u0026nbsp;the geolocations of\u0026nbsp;Portugal, but still it\u0026nbsp;takes nearly 15\u0026nbsp;seconds\u0026hellip; and for clickhouse that\u0026rsquo;s like an\u0026nbsp;eternity.\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;can it\u0026nbsp;be\u0026nbsp;improved?\u003c/p\u003e\n\u003cp\u003eActually it\u0026nbsp;can, and the authors of\u0026nbsp;the original blog already did so, as\u0026nbsp;they found out that the first two characters of\u0026nbsp;station_id already contained some kind of\u0026nbsp;country code:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e maxTemp,\n    station_id,\n    \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e,\n    location\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003esubstring\u003c/span\u003e(station_id,\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e) \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'PO'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tempMax \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\n┌─maxTemp─┬─station_id──┬───────\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e─┬─location──────────┐\n│    \u003cspan class=\"hljs-number\"\u003e45.8\u003c/span\u003e │ PO000008549 │ \u003cspan class=\"hljs-number\"\u003e1944\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-30\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-8.4167\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e40.2\u003c/span\u003e)    │\n│    \u003cspan class=\"hljs-number\"\u003e45.4\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e45.2\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e1995\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-23\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e44.5\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n│    \u003cspan class=\"hljs-number\"\u003e44.2\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-13\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n└─────────┴─────────────┴────────────┴───────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e1.440\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e7.39\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e747.38\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e5.13\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"36\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-36\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-36\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-36.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eWe\u0026nbsp;can see that it\u0026nbsp;is\u0026nbsp;already 10\u0026nbsp;times faster, but only because we\u0026nbsp;have some meta information about how the station_id is\u0026nbsp;built. If\u0026nbsp;however the station_id would just be\u0026nbsp;a\u0026nbsp;generic id, we\u0026nbsp;would not be\u0026nbsp;able to\u0026nbsp;use it\u0026nbsp;for speeding up\u0026nbsp;that query.\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;let\u0026rsquo;s go\u0026nbsp;back to\u0026nbsp;the original query and analyze what\u0026rsquo;s taking so\u0026nbsp;long.\u003c/p\u003e\n\u003cp\u003eActually it\u0026nbsp;is\u0026nbsp;the denormalization of\u0026nbsp;the main table which slows down the whole query. For each of\u0026nbsp;the 1.08 billion rows ClickHouse has to\u0026nbsp;read the location from disk, decompress it\u0026nbsp;(16GB in\u0026nbsp;total), throw it\u0026nbsp;into the dictionary (which is\u0026nbsp;cached of\u0026nbsp;course), and then throw it\u0026nbsp;away if\u0026nbsp;the condition of\u0026nbsp;'Portugal' does not hold.\u003c/p\u003e\n\u003cp\u003eThe same problem occurs with the already optimized version, but of\u0026nbsp;course much faster as\u0026nbsp;the station_id is\u0026nbsp;much smaller and handling substrings is\u0026nbsp;of\u0026nbsp;course faster than checking if\u0026nbsp;a\u0026nbsp;point lies within a\u0026nbsp;polygon.\u003c/p\u003e\n\u003ch2 id=\"speed-up\"\u003e\u003ca href=\"#speed-up\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eSpeed Up\u0026nbsp;Query by\u0026nbsp;Normalization\u003c/span\u003e\u003c/a\u003eSpeed Up\u0026nbsp;Query by\u0026nbsp;Normalization\u003c/h2\u003e\n\u003cp\u003eAfter analyzing the query and what it\u0026nbsp;does, especially reading a\u0026nbsp;lot of\u0026nbsp;redundant data from disk and decompressing it, we\u0026nbsp;can speed up\u0026nbsp;the query by\u0026nbsp;undoing the denormalization.\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e stations_blog (\n    station_id String,\n    `location` Point,\n    elevation Float32, \n    name String\n) Engine\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003eReplacingMergeTree \u003cspan class=\"hljs-keyword\"\u003ePARTITION\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tuple() \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e (station_id);\n\n\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e stations_blog\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e station_id, location, elevation, name\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ecount\u003c/span\u003e(\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e stations_blog\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e700\u003c/span\u003ea0ef9\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ed97b\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003ea1b\u003cspan class=\"hljs-number\"\u003e-9144\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ebdaf5bbbf2cc\n\n┌─\u003cspan class=\"hljs-built_in\"\u003ecount\u003c/span\u003e()─┐\n│  \u003cspan class=\"hljs-number\"\u003e121564\u003c/span\u003e │\n└─────────┘\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"55\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-55\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-55\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-55.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eOf\u0026nbsp;course if\u0026nbsp;you\u0026rsquo;ve downloaded the original stations.txt you could have created the table from that file as\u0026nbsp;well. So\u0026nbsp;now as\u0026nbsp;we\u0026nbsp;have our stations_blog table we\u0026nbsp;can finally speed up\u0026nbsp;the query to\u0026nbsp;find the top five temperatures of\u0026nbsp;Portugal to\u0026nbsp;get the result in\u0026nbsp;a\u0026nbsp;ClickHouse felt way:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e maxTemp,\n    station_id,\n    \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e,\n    location\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-comment\"\u003e-- WHERE dictGet(country_polygons, 'name', location) = 'Portugal'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e station_id \u003cspan class=\"hljs-keyword\"\u003eIN\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e station_id\n    \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e stations_blog\n    \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e dictGet(country_polygons, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, location) \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'Portugal'\u003c/span\u003e\n)\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tempMax \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e5e08\u003c/span\u003eadd8\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eab76\u003cspan class=\"hljs-number\"\u003e-4273\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-9019\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eae1519b72988\n\n┌─maxTemp─┬─station_id──┬───────\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e─┬─location──────────┐\n│    \u003cspan class=\"hljs-number\"\u003e45.8\u003c/span\u003e │ PO000008549 │ \u003cspan class=\"hljs-number\"\u003e1944\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-30\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-8.4167\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e40.2\u003c/span\u003e)    │\n│    \u003cspan class=\"hljs-number\"\u003e45.4\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e45.2\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e1995\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-23\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e44.5\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n│    \u003cspan class=\"hljs-number\"\u003e44.2\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-13\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n└─────────┴─────────────┴────────────┴───────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e0.034\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e581.63\u003c/span\u003e thousand \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e20.13\u003c/span\u003e MB (\u003cspan class=\"hljs-number\"\u003e17.27\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e597.57\u003c/span\u003e MB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"59\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-59\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-59\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-59.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e0.034 sec\u003c/strong\u003e now that\u0026rsquo;s what I\u0026nbsp;consider ClickHouse speed.\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;here we\u0026nbsp;have an\u0026nbsp;example when denormalization does not help at\u0026nbsp;all, or\u0026nbsp;even worse prevents you from getting the fastest results.\u003c/p\u003e\n\u003ch2 id=\"dictionaries\"\u003e\u003ca href=\"#dictionaries\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eDictionaries to\u0026nbsp;the rescue!\u003c/span\u003e\u003c/a\u003eDictionaries to\u0026nbsp;the rescue!\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eBut what about other queries, where we\u0026nbsp;need to\u0026nbsp;access the denormalized columns, will normalizing slow them down?\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eWell let\u0026rsquo;s test!\u003cbr /\u003e\nLet\u0026rsquo;s say we\u0026nbsp;want the five stations with top average maxtemperature with their name printed:\u003cbr /\u003e\nDenormalised:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eAVG\u003c/span\u003e(tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e avgMaxTemp,\n    station_id,\n    \u003cspan class=\"hljs-keyword\"\u003eany\u003c/span\u003e(name) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e stationName\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e station_id\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e avgMaxTemp \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003edd12cbb\u003cspan class=\"hljs-number\"\u003e-6962\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003eb22\u003cspan class=\"hljs-number\"\u003e-948\u003c/span\u003ed\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ebbc1976b691b\n\n┌─avgMaxTemp─┬─station_id──┬─stationName────────┐\n│       \u003cspan class=\"hljs-number\"\u003e44.4\u003c/span\u003e │ USC00143323 │ KS HADDAM          │\n│      \u003cspan class=\"hljs-number\"\u003e41.65\u003c/span\u003e │ IN019180300 │ PHALODI            │\n│       \u003cspan class=\"hljs-number\"\u003e40.6\u003c/span\u003e │ USC00413142 │ TX FIFE            │\n│      \u003cspan class=\"hljs-number\"\u003e40.55\u003c/span\u003e │ USC00207427 │ MI SECORD DAM      │\n│      \u003cspan class=\"hljs-number\"\u003e39.85\u003c/span\u003e │ USC00416953 │ TX PERRYTON \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e WNW │\n└────────────┴─────────────┴────────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e3.596\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e17.18\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e299.34\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e4.78\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"75\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-75\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-75\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-75.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eNormalized and joining the data:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eAVG\u003c/span\u003e(tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e avgMaxTemp,\n    station_id,\n    \u003cspan class=\"hljs-keyword\"\u003eany\u003c/span\u003e(stations_blog.name) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e stationName\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eINNER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eJOIN\u003c/span\u003e stations_blog \u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e stations_blog.station_id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e sensors_blog.station_id\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e station_id\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e avgMaxTemp \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003efdf927d\u003cspan class=\"hljs-number\"\u003e-1446\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-443\u003c/span\u003ec\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaf5a\u003cspan class=\"hljs-number\"\u003e-48573440060\u003c/span\u003ec\n\n┌─avgMaxTemp─┬─station_id──┬─stationName────────┐\n│       \u003cspan class=\"hljs-number\"\u003e44.4\u003c/span\u003e │ USC00143323 │ KS HADDAM          │\n│      \u003cspan class=\"hljs-number\"\u003e41.65\u003c/span\u003e │ IN019180300 │ PHALODI            │\n│       \u003cspan class=\"hljs-number\"\u003e40.6\u003c/span\u003e │ USC00413142 │ TX FIFE            │\n│      \u003cspan class=\"hljs-number\"\u003e40.55\u003c/span\u003e │ USC00207427 │ MI SECORD DAM      │\n│      \u003cspan class=\"hljs-number\"\u003e39.85\u003c/span\u003e │ USC00416953 │ TX PERRYTON \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e WNW │\n└────────────┴─────────────┴────────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e9.005\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e10.98\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e119.54\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e1.22\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"79\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-79\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-79\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-79.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eSo\u0026nbsp;as\u0026nbsp;most of\u0026nbsp;you might have expected already, joining the stations table makes the query nearly three times slower going up\u0026nbsp;from \u003cstrong\u003e3.5 sec\u003c/strong\u003e to\u0026nbsp;\u003cstrong\u003e9.0 sec\u003c/strong\u003e\u0026hellip; Of\u0026nbsp;course there are ways to\u0026nbsp;prevent the join by\u0026nbsp;getting the station name later, or\u0026nbsp;by\u0026nbsp;building more complicated queries with SubSelects or\u0026nbsp;some special tricks, but that just isn\u0026rsquo;t fun, and ClickHouse is\u0026nbsp;all about fun\u0026hellip; right?\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;what can we\u0026nbsp;do\u0026nbsp;to\u0026nbsp;speed up\u0026nbsp;those types of\u0026nbsp;select queries?\u003c/p\u003e\n\u003cp\u003eWe\u0026nbsp;can build a\u0026nbsp;dictionary out of\u0026nbsp;the stations_blog table and use that instead of\u0026nbsp;the join:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e DICTIONARY stations_dict\n(\n   `station_id` String,\n   `name` String\n)\n\u003cspan class=\"hljs-keyword\"\u003ePRIMARY\u003c/span\u003e KEY station_id\nSOURCE(CLICKHOUSE(\u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'stations_blog'\u003c/span\u003e))\nLIFETIME(MIN \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e MAX \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\nLAYOUT(complex_key_hashed())\n\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eAVG\u003c/span\u003e(tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e avgMaxTemp,\n    station_id,\n    dictGet(stations_dict, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, station_id) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e stationName\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e station_id\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e avgMaxTemp \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: df158271\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efaee\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003eb48\u003cspan class=\"hljs-number\"\u003e-9\u003c/span\u003ef9b\u003cspan class=\"hljs-number\"\u003e-7e82\u003c/span\u003ee48a1009\n\n┌─avgMaxTemp─┬─station_id──┬─stationName────────┐\n│       \u003cspan class=\"hljs-number\"\u003e44.4\u003c/span\u003e │ USC00143323 │ KS HADDAM          │\n│      \u003cspan class=\"hljs-number\"\u003e41.65\u003c/span\u003e │ IN019180300 │ PHALODI            │\n│       \u003cspan class=\"hljs-number\"\u003e40.6\u003c/span\u003e │ USC00413142 │ TX FIFE            │\n│      \u003cspan class=\"hljs-number\"\u003e40.55\u003c/span\u003e │ USC00207427 │ MI SECORD DAM      │\n│      \u003cspan class=\"hljs-number\"\u003e39.85\u003c/span\u003e │ USC00416953 │ TX PERRYTON \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e WNW │\n└────────────┴─────────────┴────────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e1.930\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e10.97\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e557.63\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e5.69\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"89\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-89\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-89\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-89.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e1.9 sec\u003c/strong\u003e wow, that\u0026rsquo;s even faster than the select on\u0026nbsp;the denormalized table.\u003c/p\u003e\n\u003cp\u003eAgain the reason here is, that ClickHouse does not have to\u0026nbsp;read and uncompress the name column at\u0026nbsp;all, but uses the station_id to\u0026nbsp;fetch the corresponding name form the cached dictionary.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eSo\u0026nbsp;what to\u0026nbsp;take with you?\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eEven in\u0026nbsp;OLAP scenarios, denormalisation can be\u0026nbsp;problematic and slow down your queries apart from the other known facts. Normalization can help with optimization but can complicate things. ClickHouse dictionaries can help you get the best out of\u0026nbsp;both worlds sometimes. It\u0026rsquo;s always worth trying to\u0026nbsp;optimize stuff, you will find out something new a\u0026nbsp;lot of\u0026nbsp;the time. So\u0026nbsp;have fun using ClickHouse, support the OpenSource world, and when you need help managing ClickHouse within the cloud ask us!\u003c/p\u003e\n\u003cp\u003e*\u0026nbsp;ClickHouse\u0026reg; is\u0026nbsp;a\u0026nbsp;trademark of\u0026nbsp;ClickHouse, Inc. \u003ca href=\"https://clickhouse.com\" target=\"_blank\"\u003ehttps://clickhouse.com\u003c/a\u003e\u003c/p\u003e\n"},"suggestedPosts":[{"url":"/blog/posts/2022/09/how-do-data-warehouses-save-businesses-money","id":5,"name":"how-do-data-warehouses-save-businesses-money","date":"2022-09-05T00:00:00Z","description":"","readingTime":10,"image":"/assets/blog/default-covers/how-do-data-warehouses-save-businesses-money-small-cover.png","blogPostId":5,"likes":0,"hasUserLike":false,"slug":"","title":"How do data warehouses save businesses money?","authors":[],"tags":[],"locale":{"lang":"en"},"textTitle":"How do data warehouses save businesses money?","htmlTitle":"How do data warehouses save businesses money?"},{"url":"/blog/posts/2022/10/managing-best-in-class-open-source-tools-so-you-can-focus-on-the-data","id":16,"name":"managing-best-in-class-open-source-tools-so-you-can-focus-on-the-data","date":"2022-10-24T00:00:00Z","description":"Webinar with Adam Jennings, Solution Architect","readingTime":30,"image":"/assets/blog/default-covers/video-adam-small-cover.png","blogPostId":16,"likes":0,"hasUserLike":false,"slug":"","title":"Managing best-in-class open-source tools so you can focus on the data","authors":[],"tags":[],"locale":{"lang":"en"},"textTitle":"Managing best-in-class open-source tools so you can focus on the data","htmlTitle":"Managing best-in-class open-source tools so you can focus on the data"},{"url":"/blog/posts/2022/09/what-is-clickhouse-why-column-oriented-dbms-are-important","id":6,"name":"what-is-clickhouse-why-column-oriented-dbms-are-important","date":"2022-09-27T00:00:00Z","description":"","readingTime":20,"image":"/assets/blog/articles/what-is-clickhouse-a-revolutionary-tool-small-cover.jpg","blogPostId":6,"likes":0,"hasUserLike":false,"slug":"","title":"What is ClickHouse: A revolutionary tool for real-time data processing","authors":[],"tags":[],"locale":{"lang":"en"},"textTitle":"What is ClickHouse: A revolutionary tool for real-time data processing","htmlTitle":"What is ClickHouse: A revolutionary tool for real-time data processing"}]}},"navigationData":{"newMenu":true,"header":{"leftItems":[{"text":"Why DoubleCloud","type":"dc-dropdown","data":{"view":"list","groups":[{"items":[{"text":"Performance","url":"/performance-boost/","description":"Get the best performance with the highest ROI"},{"text":"Security","url":"/security/","description":"Keep your data protected and maintain compliance"},{"text":"DoubleCloud vs. other solutions","url":"/comparison/","description":"Learn how DoubleCloud’s products compare to other solutions"},{"text":"Customer stories","url":"/resources/case-studies/","description":"See our solutions in action"}]},{"image":{"src":"/assets/doublecloud/menu-bar/menu-banner-dc-results.png.webp","style":{"width":300,"height":300}},"text":"\u003ca href='/performance-boost/' target='_self'\u003eGet more and spend less with DoubleCloud  →\u003c/a\u003e"}]}},{"text":"Products","type":"dc-dropdown","metaSchema":{"@graph":[{"@type":"SoftwareApplication","sameAs":["https://twitter.com/getdoublecloud","https://www.youtube.com/@doublecloud2499","https://www.linkedin.com/company/doublecloudplatform/","https://www.facebook.com/GetDoubleCloud/"]},{"@context":"https://schema.org","@type":"Organization","foundingDate":2022,"contactPoint":{"@type":"ContactPoint","contactType":"customer support","telephone":"+1 302-658-7581","email":"info@double.cloud"},"sameAs":["https://twitter.com/getdoublecloud","https://www.youtube.com/@doublecloud2499","https://www.linkedin.com/company/doublecloudplatform/","https://www.facebook.com/GetDoubleCloud/"]}]},"data":{"items":[{"text":"Managed Service for ClickHouse®","url":"/services/managed-clickhouse/","icon":"/assets/icons/dc-clickhouse.svg","description":"The fastest, most resource-efficient OLAP database for real-time analytics"},{"text":"Managed Service for Apache Kafka®","url":"/services/managed-kafka/","icon":"/assets/icons/dc-kafka.svg","description":"A leading data streaming technology for large-scale, data-intensive applications"},{"text":"Managed Service for Apache Airflow®","url":"/services/managed-airflow/","icon":"/assets/icons/dc-airflow.svg","description":"Open-source tool to orchestrate and monitor workflows"},{"text":"Data Transfer","url":"/services/doublecloud-transfer/","icon":"/assets/icons/dc-transfer.svg","description":"No-code ELT tool for aggregating, collecting, and migrating data"},{"text":"Data Visualization","url":"/services/doublecloud-visualization/","icon":"/assets/icons/dc-data-vis.svg","description":"Free tool to create, modify, and share dashboards and charts"}]}},{"text":"Solutions","type":"dc-dropdown","data":{"view":"list","groups":[{"title":"By use case","items":[{"text":"Customer-facing analytics","url":"/solutions/customer-facing-analytics/","description":"Provide business insights for your clients or partners"},{"text":"Real-time analytics","url":"/solutions/real-time-analytics/","description":"Build a data infrastructure to collect, process, and analyze data in real time"},{"text":"Observability and monitoring","url":"/solutions/observability-and-monitoring/","description":"Analyze terabytes of your logs, events, and traces with ease"}]},{"title":"By industry","items":[{"text":"AdTech and MarTech data analytics","url":"/solutions/adtech/","description":"Extract and analyze data from Meta ads, Google ads, LinkedIn ads, and others"},{"text":"Analytics for mobile and gaming apps","url":"/solutions/web-mobile-gaming-apps/","description":"Optimize and scale your mobile and gaming app analytics"},{"text":"EdTech data analytics","url":"/solutions/edtech/","description":"Improve online learning and identify new sales opportunities"},{"text":"FinTech data analytics","url":"/solutions/fintech-real-time-analytics/","description":"Manage and process large amounts of financial data efficiently"}]}]}},{"text":"Resources","type":"dc-dropdown","data":{"view":"list","groups":[{"title":"Using DoubleCloud","items":[{"text":"DoubleCloud API","url":"/docs/en/public-api/","description":"Read up on API tutorials and instructions","target":"_self"},{"text":"Terraform","url":"/docs/en/developer-resources/terraform/create-resources","description":"Deploy and manage cloud resources with the infrastructure-as-code approach"},{"text":"Status updates","url":"https://status.double.cloud/","description":"Check the current operational status of our services"},{"text":"Support","url":"/support/","description":"Learn more about our support tiers"}]},{"title":"Discover","items":[{"text":"Webinars","url":"/webinars/","description":"Sign up for the next webinar or watch previous ones"},{"text":"Blog","url":"/blog/","description":"Get insights from our team and the latest news"}]},{"image":{"src":"/assets/doublecloud/menu-bar/menu-banners-dc-ebook.png.webp","style":{"width":300,"height":300}},"text":"\u003ca href='/resources/clickhouse-ebook/' target='_self'\u003eGrab your ebook  →\u003c/a\u003e"}]}},{"text":"Company","type":"dc-dropdown","data":{"items":[{"text":"About DoubleCloud","url":"/company/about-us/"},{"text":"Careers","url":"/company/careers/"},{"text":"Contact us","url":"/company/contact-us/"}]}},{"text":"Pricing","url":"/pricing/"},{"text":"Documentation","url":"/docs/en/","target":"_self"}]},"logo":{"icon":"/assets/logo/dc-logo-dark.svg","text":""},"footer":{"underline":{"links":[{"text":"Customer Agreement","url":"/legal/en/customer_agreement/","target":"_blank"},{"text":"Privacy Policy","url":"/legal/en/privacy/","target":"_blank"},{"text":"Pricing","url":"/pricing/"},{"text":"Security","url":"/security/","target":"_blank"}],"copyright":"© 2024 DoubleCloud"},"columns":[{"title":"Products","links":[{"text":"Managed Service for ClickHouse®","url":"/services/managed-clickhouse/"},{"text":"Managed Service for Apache Kafka®","url":"/services/managed-kafka/"},{"text":"Managed Service for Apache Airflow®","url":"/services/managed-airflow"},{"text":"Data Transfer","url":"/services/doublecloud-transfer/"},{"text":"Data Visualization","url":"/services/doublecloud-visualization"}]},{"title":"Solutions","links":[{"text":"Case studies","url":"/resources/case-studies/"},{"text":"Customer-facing analytics","url":"/solutions/customer-facing-analytics/"},{"text":"Real-time analytics","url":"/solutions/real-time-analytics/"},{"text":"Observability and monitoring","url":"/solutions/observability-and-monitoring/"},{"text":"AdTech and MarTech data analytics","url":"/solutions/adtech/"},{"text":"Analytics for mobile and gaming Apps","url":"/solutions/web-mobile-gaming-apps/"},{"text":"EdTech data analytics","url":"/solutions/edtech/"},{"text":"FinTech data analytics","url":"/solutions/fintech-real-time-analytics/"}]},{"title":"Resources","links":[{"text":"Documentation","url":"/docs/en/"},{"text":"Webinars","url":"/webinars/"},{"text":"Blog","url":"/blog/"},{"text":"Support","url":"/support/"},{"text":"Status updates","url":"https://status.double.cloud/"},{"text":"Product comparisons","url":"/comparison/"},{"text":"Site map","url":"/sitemap/"}]},{"title":"Company","links":[{"text":"About DoubleCloud","url":"/company/about-us/"},{"text":"Careers","url":"/company/careers"},{"text":"AWS Partnership","url":"/aws-partnership/"}]}]},"forms":{"contact":"11819433.daba96b39df83b7903708cc4842e9dbb9c944cce"},"favicon":{"folder":"/assets/favicon"},"analytics":{"id":"GTM-5M39N8J","ignore":true,"popup":{"text":"\u003cp\u003eBy\u0026nbsp;clicking \u0026ldquo;Accept\u0026rdquo;, you agree to\u0026nbsp;the storing of\u0026nbsp;cookies on\u0026nbsp;your device to\u0026nbsp;help us\u0026nbsp;analyze site usage and assist in\u0026nbsp;our marketing efforts. However, you may \u0026ldquo;Decline\u0026rdquo; that. More details here in\u0026nbsp;\u003ca href=\"/legal/en/privacy/\"\u003ePrivacy Policy\u003c/a\u003e\u003c/p\u003e","buttons":{"accept":{"size":"xl","text":"Accept"},"decline":{"size":"xl","text":"Decline"}}}},"announcement":{"name":"webinar_announcement","url":"https://doublecloud-archive.github.io/blog/posts/2024/10/doublecloud-final-update/","conditions":{"date":{"start":"2000-01-01T00:00:00Z","end":"2099-12-31T00:00:00Z"}},"text":"\u003cp\u003e\u003cb\u003eDoubleCloud has wound down operations\u003c/b\u003e | This is\u0026nbsp;an\u0026nbsp;archived version of\u0026nbsp;the site. \u003cb\u003eLearn more \u0026rarr; \u003c/b\u003e\u003c/p\u003e"}},"meta":{"title":"(De-)normalization \u0026 how ClickHouse® dictionaries can solve typical problems | DoubleCloud","date":"2022-10-10T00:00:00Z","image":"/assets/blog/articles/new-sharing-images/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems-sharing.png","canonicalUrl":"","organization":{"appTitle":"DoubleCloud","legalName":"DoubleCloud Inc","supportEmail":"","url":"https://double.cloud"},"description":"\u003cp\u003eWritten by\u0026nbsp;Stefan Kaeser, DoubleCloud Solutions Architect\u003c/p\u003e","content":"\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#how-can\"\u003eHow can dictionaries help with those problems?\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#speed-up\"\u003eSpeed Up\u0026nbsp;Query by\u0026nbsp;Normalization\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#dictionaries\"\u003eDictionaries to\u0026nbsp;the rescue!\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cem\u003eWritten by\u0026nbsp;\u003ca href=\"https://www.linkedin.com/in/stefan-k%C3%A4ser-344903119/\" target=\"_blank\"\u003eStefan Kaeser\u003c/a\u003e, DoubleCloud Solutions Architect\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eA\u0026nbsp;few days ago I\u0026nbsp;stumbled across a\u0026nbsp;blog post from our friends over at\u0026nbsp;ClickHouse\u0026reg; about \u003ca href=\"https://clickhouse.com/blog/real-world-data-noaa-climate-data\" target=\"_blank\"\u003eExploring massive, real-world data sets: 100+ Years of\u0026nbsp;Weather Records in\u0026nbsp;ClickHouse\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s a\u0026nbsp;well written blog and really shows what ClickHouse is\u0026nbsp;capable of, regarding transforming billions of\u0026nbsp;datapoints with low effort. They showed how to\u0026nbsp;load data from files from external urls, how to\u0026nbsp;use regex for formatting data, creation of\u0026nbsp;dictionaries, etc. If\u0026nbsp;you haven\u0026rsquo;t already, then go\u0026nbsp;ahead and read through their post.\u003c/p\u003e\n\u003cp\u003eHowever\u0026hellip; there was something in\u0026nbsp;the blog I\u0026nbsp;couldn\u0026rsquo;t stop thinking about:\u003c/p\u003e\n\u003cp\u003eTheir main query for analyzing the data still took 14\u0026nbsp;seconds after optimization, which is\u0026nbsp;a\u0026nbsp;really long time when you are used to\u0026nbsp;ClickHouse and its normally sub-second responses. The second thing which makes me\u0026nbsp;feel uncomfortable is\u0026nbsp;the denormalized structure of\u0026nbsp;their main table.\u003c/p\u003e\n\u003cp\u003eWhen I\u0026nbsp;first learnt about normalization during my\u0026nbsp;time at\u0026nbsp;University two decades ago, denormalisation was\u0026nbsp;bad. It\u0026nbsp;was drummed into us\u0026nbsp;that you should normalize as\u0026nbsp;much as\u0026nbsp;possible, and during that time, mainly with the usage of\u0026nbsp;only OLTP, this was the correct choice to\u0026nbsp;do. But times have changed and OLAP took over in\u0026nbsp;a\u0026nbsp;lot of\u0026nbsp;places, and with big analytica workflows denormalisation got a\u0026nbsp;revival and helped to\u0026nbsp;maximize query speeds in\u0026nbsp;a\u0026nbsp;lot of\u0026nbsp;cases.\u003c/p\u003e\n\u003cp\u003eBut still there are things to\u0026nbsp;consider when you denormalise, especially when handling huge amounts of\u0026nbsp;data:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWhen data changes it\u0026nbsp;can take a\u0026nbsp;very long time to\u0026nbsp;update old data\u003c/li\u003e\n\u003cli\u003eWith billions or\u0026nbsp;trillions of\u0026nbsp;rows, even small columns can take up\u0026nbsp;very much space\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"how-can\"\u003e\u003ca href=\"#how-can\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eHow can dictionaries help with those problems?\u003c/span\u003e\u003c/a\u003eHow can dictionaries help with those problems?\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSpoiler Alert: You can speed the query up\u0026nbsp;from multiple seconds to\u0026nbsp;milliseconds!\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eFirst of\u0026nbsp;all, if\u0026nbsp;you want to\u0026nbsp;play around with optimizations yourself, I\u0026nbsp;encourage you once again to\u0026nbsp;read ClickHouses' blog post, as\u0026nbsp;I\u0026nbsp;won\u0026rsquo;t repeat the filling process from them, but instead build up\u0026nbsp;on\u0026nbsp;it. But for those of\u0026nbsp;you just enjoying the read without replaying it, I\u0026rsquo;ll give you the tabledefinitions and some cardinalities. The main table which has weather data from weather stations all over the world since 1900\u0026nbsp;looks like this:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e sensors_blog\n(\n    `station_id` LowCardinality(String),\n    `\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e` Date32,\n    `tempAvg` Nullable(Int32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Average temperature (tenths of a degrees C)'\u003c/span\u003e,\n    `tempMax` Nullable(Int32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Maximum temperature (tenths of degrees C)'\u003c/span\u003e,\n    `tempMin` Nullable(Int32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Minimum temperature (tenths of degrees C)'\u003c/span\u003e,\n    `precipitation` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Precipitation (tenths of mm)'\u003c/span\u003e,\n    `snowfall` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Snowfall (mm)'\u003c/span\u003e,\n    `snowDepth` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Snow depth (mm)'\u003c/span\u003e,\n    `percentDailySun` Nullable(UInt8) COMMENT \u003cspan class=\"hljs-string\"\u003e'Daily percent of possible sunshine (percent)'\u003c/span\u003e,\n    `averageWindSpeed` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Average daily wind speed (tenths of meters per second)'\u003c/span\u003e,\n    `maxWindSpeed` Nullable(UInt32) COMMENT \u003cspan class=\"hljs-string\"\u003e'Peak gust wind speed (tenths of meters per second)'\u003c/span\u003e,\n    `weatherType` Nullable(Enum8(\u003cspan class=\"hljs-string\"\u003e'Normal'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Heavy Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Thunder'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Small Hail'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Hail'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Glaze'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Dust/Ash'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Smoke/Haze'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e, \n                      \u003cspan class=\"hljs-string\"\u003e'Blowing/Drifting Snow'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Tornado'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'High Winds'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Blowing Spray'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Mist'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Drizzle'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e14\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Freezing Drizzle'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e15\u003c/span\u003e, \n                      \u003cspan class=\"hljs-string\"\u003e'Rain'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Freezing Rain'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e17\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Snow'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Unknown Precipitation'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e19\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Ground Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e21\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Freezing Fog'\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e22\u003c/span\u003e)),\n    `location` Point,\n    `elevation` Float32,\n    `name` LowCardinality(String)\n) ENGINE \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e MergeTree() \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e (station_id, \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"9\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-9\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-9\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-9.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eNotice I\u0026rsquo;ve changed the name from noaa to\u0026nbsp;sensors_blog and added some Nullables for some internal reasons. The table contains around \u003cstrong\u003e1.08 billion\u003c/strong\u003e rows and there are around \u003cstrong\u003e120k\u003c/strong\u003e unique stations within.\u003c/p\u003e\n\u003cp\u003eThe columns location, elevation and name are all depended directly from station_id and make up\u0026nbsp;the denormalized part, so\u0026nbsp;let\u0026rsquo;s look to\u0026nbsp;see if\u0026nbsp;it\u0026rsquo;s worth adding them to\u0026nbsp;the table at\u0026nbsp;all and what it\u0026nbsp;costs:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    name,\n    formatReadableSize(\u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(data_compressed_bytes)) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e compressed,\n    formatReadableSize(\u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(data_uncompressed_bytes)) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e uncompressed\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e system.columns\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e (database \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'weather'\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etable\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'sensors_blog'\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e name\n    \u003cspan class=\"hljs-keyword\"\u003eWITH\u003c/span\u003e TOTALS\n\n┌─name─────────────┬─compressed─┬─uncompressed─┐\n│ \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e             │ \u003cspan class=\"hljs-number\"\u003e2.46\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e4.01\u003c/span\u003e GiB     │\n│ snowfall         │ \u003cspan class=\"hljs-number\"\u003e124.18\u003c/span\u003e MiB │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ tempMax          │ \u003cspan class=\"hljs-number\"\u003e1.17\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ tempMin          │ \u003cspan class=\"hljs-number\"\u003e1.17\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ tempAvg          │ \u003cspan class=\"hljs-number\"\u003e279.95\u003c/span\u003e MiB │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ weatherType      │ \u003cspan class=\"hljs-number\"\u003e40.65\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e2.00\u003c/span\u003e GiB     │\n│ snowDepth        │ \u003cspan class=\"hljs-number\"\u003e141.74\u003c/span\u003e MiB │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ precipitation    │ \u003cspan class=\"hljs-number\"\u003e1.11\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ averageWindSpeed │ \u003cspan class=\"hljs-number\"\u003e41.31\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ maxWindSpeed     │ \u003cspan class=\"hljs-number\"\u003e35.07\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e5.01\u003c/span\u003e GiB     │\n│ percentDailySun  │ \u003cspan class=\"hljs-number\"\u003e10.28\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e2.00\u003c/span\u003e GiB     │\n\n│ station_id       │ \u003cspan class=\"hljs-number\"\u003e16.63\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e1.98\u003c/span\u003e GiB     │\n\n│ name             │ \u003cspan class=\"hljs-number\"\u003e20.85\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e1.99\u003c/span\u003e GiB     │\n│ location         │ \u003cspan class=\"hljs-number\"\u003e87.51\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e16.04\u003c/span\u003e GiB    │\n│ elevation        │ \u003cspan class=\"hljs-number\"\u003e22.52\u003c/span\u003e MiB  │ \u003cspan class=\"hljs-number\"\u003e4.01\u003c/span\u003e GiB     │\n└──────────────────┴────────────┴──────────────┘\n\nTotals:\n┌─name─┬─compressed─┬─uncompressed─┐\n│      │ \u003cspan class=\"hljs-number\"\u003e6.71\u003c/span\u003e GiB   │ \u003cspan class=\"hljs-number\"\u003e72.14\u003c/span\u003e GiB    │\n└──────┴────────────┴──────────────┘\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"16\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-16\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-16\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-16.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eI\u0026rsquo;ve separated the denormalized columns for better readability.\u003c/p\u003e\n\u003cp\u003eAs\u0026nbsp;the table is\u0026nbsp;ordered by\u0026nbsp;station_id, the denormalized depended columns compress extremely well, but still take up\u0026nbsp;nearly 2% of\u0026nbsp;the total data. Uncompressed it\u0026rsquo;s 30% of\u0026nbsp;the data, which will eat some of\u0026nbsp;your cpu cycles for decompression when querying\u0026nbsp;it. That not only takes denormalisation more space, it\u0026nbsp;can also slow down your queries.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s take a\u0026nbsp;look now at\u0026nbsp;the main query which bothered me\u0026nbsp;the most when I\u0026nbsp;read the original post:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e maxTemp,\n    station_id,\n    \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e,\n    location\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e dictGet(country_polygons, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, location) \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'Portugal'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tempMax \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e2e2\u003c/span\u003ebd273\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ef4a0\u003cspan class=\"hljs-number\"\u003e-4268\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-856\u003c/span\u003ec\u003cspan class=\"hljs-number\"\u003e-20\u003c/span\u003eef5fec9f61\n\n┌─maxTemp─┬─station_id──┬───────\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e─┬─location──────────┐\n│    \u003cspan class=\"hljs-number\"\u003e45.8\u003c/span\u003e │ PO000008549 │ \u003cspan class=\"hljs-number\"\u003e1944\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-30\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-8.4167\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e40.2\u003c/span\u003e)    │\n│    \u003cspan class=\"hljs-number\"\u003e45.4\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e45.2\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e1995\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-23\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e44.5\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n│    \u003cspan class=\"hljs-number\"\u003e44.2\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-13\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n└─────────┴─────────────┴────────────┴───────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e14.427\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e35.94\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e74.61\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e2.49\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"26\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-26\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-26\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-26.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eThe query tries to\u0026nbsp;get the top five temperatures occurring in\u0026nbsp;Portugal since the recordings began. It\u0026rsquo;s already optimized by\u0026nbsp;using a\u0026nbsp;dictionary to\u0026nbsp;look up\u0026nbsp;the geolocations of\u0026nbsp;Portugal, but still it\u0026nbsp;takes nearly 15\u0026nbsp;seconds\u0026hellip; and for clickhouse that\u0026rsquo;s like an\u0026nbsp;eternity.\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;can it\u0026nbsp;be\u0026nbsp;improved?\u003c/p\u003e\n\u003cp\u003eActually it\u0026nbsp;can, and the authors of\u0026nbsp;the original blog already did so, as\u0026nbsp;they found out that the first two characters of\u0026nbsp;station_id already contained some kind of\u0026nbsp;country code:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e maxTemp,\n    station_id,\n    \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e,\n    location\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003esubstring\u003c/span\u003e(station_id,\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e) \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'PO'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tempMax \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\n┌─maxTemp─┬─station_id──┬───────\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e─┬─location──────────┐\n│    \u003cspan class=\"hljs-number\"\u003e45.8\u003c/span\u003e │ PO000008549 │ \u003cspan class=\"hljs-number\"\u003e1944\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-30\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-8.4167\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e40.2\u003c/span\u003e)    │\n│    \u003cspan class=\"hljs-number\"\u003e45.4\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e45.2\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e1995\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-23\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e44.5\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n│    \u003cspan class=\"hljs-number\"\u003e44.2\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-13\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n└─────────┴─────────────┴────────────┴───────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e1.440\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e7.39\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e747.38\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e5.13\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"36\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-36\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-36\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-36.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eWe\u0026nbsp;can see that it\u0026nbsp;is\u0026nbsp;already 10\u0026nbsp;times faster, but only because we\u0026nbsp;have some meta information about how the station_id is\u0026nbsp;built. If\u0026nbsp;however the station_id would just be\u0026nbsp;a\u0026nbsp;generic id, we\u0026nbsp;would not be\u0026nbsp;able to\u0026nbsp;use it\u0026nbsp;for speeding up\u0026nbsp;that query.\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;let\u0026rsquo;s go\u0026nbsp;back to\u0026nbsp;the original query and analyze what\u0026rsquo;s taking so\u0026nbsp;long.\u003c/p\u003e\n\u003cp\u003eActually it\u0026nbsp;is\u0026nbsp;the denormalization of\u0026nbsp;the main table which slows down the whole query. For each of\u0026nbsp;the 1.08 billion rows ClickHouse has to\u0026nbsp;read the location from disk, decompress it\u0026nbsp;(16GB in\u0026nbsp;total), throw it\u0026nbsp;into the dictionary (which is\u0026nbsp;cached of\u0026nbsp;course), and then throw it\u0026nbsp;away if\u0026nbsp;the condition of\u0026nbsp;'Portugal' does not hold.\u003c/p\u003e\n\u003cp\u003eThe same problem occurs with the already optimized version, but of\u0026nbsp;course much faster as\u0026nbsp;the station_id is\u0026nbsp;much smaller and handling substrings is\u0026nbsp;of\u0026nbsp;course faster than checking if\u0026nbsp;a\u0026nbsp;point lies within a\u0026nbsp;polygon.\u003c/p\u003e\n\u003ch2 id=\"speed-up\"\u003e\u003ca href=\"#speed-up\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eSpeed Up\u0026nbsp;Query by\u0026nbsp;Normalization\u003c/span\u003e\u003c/a\u003eSpeed Up\u0026nbsp;Query by\u0026nbsp;Normalization\u003c/h2\u003e\n\u003cp\u003eAfter analyzing the query and what it\u0026nbsp;does, especially reading a\u0026nbsp;lot of\u0026nbsp;redundant data from disk and decompressing it, we\u0026nbsp;can speed up\u0026nbsp;the query by\u0026nbsp;undoing the denormalization.\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e stations_blog (\n    station_id String,\n    `location` Point,\n    elevation Float32, \n    name String\n) Engine\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003eReplacingMergeTree \u003cspan class=\"hljs-keyword\"\u003ePARTITION\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tuple() \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e (station_id);\n\n\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e stations_blog\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e station_id, location, elevation, name\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ecount\u003c/span\u003e(\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e stations_blog\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e700\u003c/span\u003ea0ef9\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ed97b\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003ea1b\u003cspan class=\"hljs-number\"\u003e-9144\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ebdaf5bbbf2cc\n\n┌─\u003cspan class=\"hljs-built_in\"\u003ecount\u003c/span\u003e()─┐\n│  \u003cspan class=\"hljs-number\"\u003e121564\u003c/span\u003e │\n└─────────┘\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"55\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-55\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-55\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-55.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eOf\u0026nbsp;course if\u0026nbsp;you\u0026rsquo;ve downloaded the original stations.txt you could have created the table from that file as\u0026nbsp;well. So\u0026nbsp;now as\u0026nbsp;we\u0026nbsp;have our stations_blog table we\u0026nbsp;can finally speed up\u0026nbsp;the query to\u0026nbsp;find the top five temperatures of\u0026nbsp;Portugal to\u0026nbsp;get the result in\u0026nbsp;a\u0026nbsp;ClickHouse felt way:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e maxTemp,\n    station_id,\n    \u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e,\n    location\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-comment\"\u003e-- WHERE dictGet(country_polygons, 'name', location) = 'Portugal'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e station_id \u003cspan class=\"hljs-keyword\"\u003eIN\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e station_id\n    \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e stations_blog\n    \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e dictGet(country_polygons, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, location) \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'Portugal'\u003c/span\u003e\n)\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e tempMax \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e5e08\u003c/span\u003eadd8\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eab76\u003cspan class=\"hljs-number\"\u003e-4273\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-9019\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eae1519b72988\n\n┌─maxTemp─┬─station_id──┬───────\u003cspan class=\"hljs-type\"\u003edate\u003c/span\u003e─┬─location──────────┐\n│    \u003cspan class=\"hljs-number\"\u003e45.8\u003c/span\u003e │ PO000008549 │ \u003cspan class=\"hljs-number\"\u003e1944\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-30\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-8.4167\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e40.2\u003c/span\u003e)    │\n│    \u003cspan class=\"hljs-number\"\u003e45.4\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e45.2\u003c/span\u003e │ PO000008562 │ \u003cspan class=\"hljs-number\"\u003e1995\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-23\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.8667\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.0167\u003c/span\u003e) │\n│    \u003cspan class=\"hljs-number\"\u003e44.5\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2003\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-08\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-01\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n│    \u003cspan class=\"hljs-number\"\u003e44.2\u003c/span\u003e │ POM00008558 │ \u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-07\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-13\u003c/span\u003e │ (\u003cspan class=\"hljs-number\"\u003e-7.9\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e38.533\u003c/span\u003e)     │\n└─────────┴─────────────┴────────────┴───────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e0.034\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e581.63\u003c/span\u003e thousand \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e20.13\u003c/span\u003e MB (\u003cspan class=\"hljs-number\"\u003e17.27\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e597.57\u003c/span\u003e MB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"59\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-59\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-59\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-59.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e0.034 sec\u003c/strong\u003e now that\u0026rsquo;s what I\u0026nbsp;consider ClickHouse speed.\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;here we\u0026nbsp;have an\u0026nbsp;example when denormalization does not help at\u0026nbsp;all, or\u0026nbsp;even worse prevents you from getting the fastest results.\u003c/p\u003e\n\u003ch2 id=\"dictionaries\"\u003e\u003ca href=\"#dictionaries\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eDictionaries to\u0026nbsp;the rescue!\u003c/span\u003e\u003c/a\u003eDictionaries to\u0026nbsp;the rescue!\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eBut what about other queries, where we\u0026nbsp;need to\u0026nbsp;access the denormalized columns, will normalizing slow them down?\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eWell let\u0026rsquo;s test!\u003cbr /\u003e\nLet\u0026rsquo;s say we\u0026nbsp;want the five stations with top average maxtemperature with their name printed:\u003cbr /\u003e\nDenormalised:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eAVG\u003c/span\u003e(tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e avgMaxTemp,\n    station_id,\n    \u003cspan class=\"hljs-keyword\"\u003eany\u003c/span\u003e(name) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e stationName\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e station_id\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e avgMaxTemp \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003edd12cbb\u003cspan class=\"hljs-number\"\u003e-6962\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003eb22\u003cspan class=\"hljs-number\"\u003e-948\u003c/span\u003ed\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ebbc1976b691b\n\n┌─avgMaxTemp─┬─station_id──┬─stationName────────┐\n│       \u003cspan class=\"hljs-number\"\u003e44.4\u003c/span\u003e │ USC00143323 │ KS HADDAM          │\n│      \u003cspan class=\"hljs-number\"\u003e41.65\u003c/span\u003e │ IN019180300 │ PHALODI            │\n│       \u003cspan class=\"hljs-number\"\u003e40.6\u003c/span\u003e │ USC00413142 │ TX FIFE            │\n│      \u003cspan class=\"hljs-number\"\u003e40.55\u003c/span\u003e │ USC00207427 │ MI SECORD DAM      │\n│      \u003cspan class=\"hljs-number\"\u003e39.85\u003c/span\u003e │ USC00416953 │ TX PERRYTON \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e WNW │\n└────────────┴─────────────┴────────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e3.596\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e17.18\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e299.34\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e4.78\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"75\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-75\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-75\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-75.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eNormalized and joining the data:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eAVG\u003c/span\u003e(tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e avgMaxTemp,\n    station_id,\n    \u003cspan class=\"hljs-keyword\"\u003eany\u003c/span\u003e(stations_blog.name) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e stationName\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eINNER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eJOIN\u003c/span\u003e stations_blog \u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e stations_blog.station_id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e sensors_blog.station_id\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e station_id\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e avgMaxTemp \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003efdf927d\u003cspan class=\"hljs-number\"\u003e-1446\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-443\u003c/span\u003ec\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaf5a\u003cspan class=\"hljs-number\"\u003e-48573440060\u003c/span\u003ec\n\n┌─avgMaxTemp─┬─station_id──┬─stationName────────┐\n│       \u003cspan class=\"hljs-number\"\u003e44.4\u003c/span\u003e │ USC00143323 │ KS HADDAM          │\n│      \u003cspan class=\"hljs-number\"\u003e41.65\u003c/span\u003e │ IN019180300 │ PHALODI            │\n│       \u003cspan class=\"hljs-number\"\u003e40.6\u003c/span\u003e │ USC00413142 │ TX FIFE            │\n│      \u003cspan class=\"hljs-number\"\u003e40.55\u003c/span\u003e │ USC00207427 │ MI SECORD DAM      │\n│      \u003cspan class=\"hljs-number\"\u003e39.85\u003c/span\u003e │ USC00416953 │ TX PERRYTON \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e WNW │\n└────────────┴─────────────┴────────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e9.005\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e10.98\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e119.54\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e1.22\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"79\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-79\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-79\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-79.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eSo\u0026nbsp;as\u0026nbsp;most of\u0026nbsp;you might have expected already, joining the stations table makes the query nearly three times slower going up\u0026nbsp;from \u003cstrong\u003e3.5 sec\u003c/strong\u003e to\u0026nbsp;\u003cstrong\u003e9.0 sec\u003c/strong\u003e\u0026hellip; Of\u0026nbsp;course there are ways to\u0026nbsp;prevent the join by\u0026nbsp;getting the station name later, or\u0026nbsp;by\u0026nbsp;building more complicated queries with SubSelects or\u0026nbsp;some special tricks, but that just isn\u0026rsquo;t fun, and ClickHouse is\u0026nbsp;all about fun\u0026hellip; right?\u003c/p\u003e\n\u003cp\u003eSo\u0026nbsp;what can we\u0026nbsp;do\u0026nbsp;to\u0026nbsp;speed up\u0026nbsp;those types of\u0026nbsp;select queries?\u003c/p\u003e\n\u003cp\u003eWe\u0026nbsp;can build a\u0026nbsp;dictionary out of\u0026nbsp;the stations_blog table and use that instead of\u0026nbsp;the join:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e DICTIONARY stations_dict\n(\n   `station_id` String,\n   `name` String\n)\n\u003cspan class=\"hljs-keyword\"\u003ePRIMARY\u003c/span\u003e KEY station_id\nSOURCE(CLICKHOUSE(\u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'stations_blog'\u003c/span\u003e))\nLIFETIME(MIN \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e MAX \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\nLAYOUT(complex_key_hashed())\n\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eAVG\u003c/span\u003e(tempMax \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e avgMaxTemp,\n    station_id,\n    dictGet(stations_dict, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, station_id) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e stationName\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e sensors_blog\n\u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e station_id\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e avgMaxTemp \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e\nLIMIT \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\n\nQuery id: df158271\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efaee\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003eb48\u003cspan class=\"hljs-number\"\u003e-9\u003c/span\u003ef9b\u003cspan class=\"hljs-number\"\u003e-7e82\u003c/span\u003ee48a1009\n\n┌─avgMaxTemp─┬─station_id──┬─stationName────────┐\n│       \u003cspan class=\"hljs-number\"\u003e44.4\u003c/span\u003e │ USC00143323 │ KS HADDAM          │\n│      \u003cspan class=\"hljs-number\"\u003e41.65\u003c/span\u003e │ IN019180300 │ PHALODI            │\n│       \u003cspan class=\"hljs-number\"\u003e40.6\u003c/span\u003e │ USC00413142 │ TX FIFE            │\n│      \u003cspan class=\"hljs-number\"\u003e40.55\u003c/span\u003e │ USC00207427 │ MI SECORD DAM      │\n│      \u003cspan class=\"hljs-number\"\u003e39.85\u003c/span\u003e │ USC00416953 │ TX PERRYTON \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e WNW │\n└────────────┴─────────────┴────────────────────┘\n\n\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e set. Elapsed: \u003cspan class=\"hljs-number\"\u003e1.930\u003c/span\u003e sec. Processed \u003cspan class=\"hljs-number\"\u003e1.08\u003c/span\u003e billion \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e10.97\u003c/span\u003e GB (\u003cspan class=\"hljs-number\"\u003e557.63\u003c/span\u003e million \u003cspan class=\"hljs-keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es., \u003cspan class=\"hljs-number\"\u003e5.69\u003c/span\u003e GB\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es.)\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"89\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-89\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-89\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-89.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e1.9 sec\u003c/strong\u003e wow, that\u0026rsquo;s even faster than the select on\u0026nbsp;the denormalized table.\u003c/p\u003e\n\u003cp\u003eAgain the reason here is, that ClickHouse does not have to\u0026nbsp;read and uncompress the name column at\u0026nbsp;all, but uses the station_id to\u0026nbsp;fetch the corresponding name form the cached dictionary.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eSo\u0026nbsp;what to\u0026nbsp;take with you?\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eEven in\u0026nbsp;OLAP scenarios, denormalisation can be\u0026nbsp;problematic and slow down your queries apart from the other known facts. Normalization can help with optimization but can complicate things. ClickHouse dictionaries can help you get the best out of\u0026nbsp;both worlds sometimes. It\u0026rsquo;s always worth trying to\u0026nbsp;optimize stuff, you will find out something new a\u0026nbsp;lot of\u0026nbsp;the time. So\u0026nbsp;have fun using ClickHouse, support the OpenSource world, and when you need help managing ClickHouse within the cloud ask us!\u003c/p\u003e\n\u003cp\u003e*\u0026nbsp;ClickHouse\u0026reg; is\u0026nbsp;a\u0026nbsp;trademark of\u0026nbsp;ClickHouse, Inc. \u003ca href=\"https://clickhouse.com\" target=\"_blank\"\u003ehttps://clickhouse.com\u003c/a\u003e\u003c/p\u003e\n","sharing":{"title":"(De-)normalization \u0026 how ClickHouse® dictionaries can solve typical problems","description":"Written by Stefan Kaeser, DoubleCloud Solutions Architect","image":"/assets/blog/articles/new-sharing-images/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems-sharing.png","shareGenImage":"","shareGenTitle":"(De-)normalization \u0026 how ClickHouse® dictionaries can solve typical problems"},"keywords":[],"noIndex":false,"authors":[],"tags":[{"icon":null,"slug":"insights","name":"Insights","createdAt":"","updatedAt":"","count":0},{"icon":null,"slug":"ClickHouse","name":"ClickHouse","createdAt":"","updatedAt":"","count":0}],"metaSchema":{"@context":"https://schema.org","@graph":[{"@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"insights","name":"Insights"}},{"@type":"ListItem","position":2,"item":{"@id":"ClickHouse","name":"ClickHouse"}}]},{"@type":"BlogPosting","@id":"https://double.cloud/blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems/","url":"https://double.cloud/blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems/","name":"(De-)normalization \u0026amp; how ClickHouse® dictionaries can solve typical problems","headline":"(De-)normalization \u0026amp; how ClickHouse® dictionaries can solve typical problems","abstract":"\u003cp\u003eWritten by\u0026nbsp;Stefan Kaeser, DoubleCloud Solutions Architect\u003c/p\u003e","description":"\u003cp\u003eWritten by\u0026nbsp;Stefan Kaeser, DoubleCloud Solutions Architect\u003c/p\u003e","dateCreated":"2022-10-10T00:00:00Z","datePublished":"2022-10-10T00:00:00Z","dateModified":"2022-10-10T00:00:00Z","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"creator":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"publisher":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightHolder":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightYear":2025,"mainEntityOfPage":{"@type":"WebPage","@id":"https://double.cloud/blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems/"},"inLanguage":{"@type":"Language","name":"English","alternateName":"en"},"keywords":["Insights","ClickHouse"],"image":"https://double.cloud/assets/blog/default-covers/denormalization-small-cover.png","sharedContent":{"@type":"WebPage","headline":"(De-)normalization \u0026amp; how ClickHouse® dictionaries can solve typical problems","url":"https://double.cloud/blog/posts/2022/10/de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems/","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}}},"wordCount":"","articleBody":""}]}},"routingData":{"hostname":"double.cloud"},"deviceData":{"isRobot":true,"isMobile":false,"isTablet":false},"csrfToken":"O3aI5Bb4-45tPPM_ojRXgxC35hehRF-CwwAM","clientConfig":{"appTitle":"DoubleCloud","legalName":"DoubleCloud Inc","supportEmail":"","hosts":{"site":"https://double.cloud","console":"https://app.double.cloud"}},"ignoreConsent":false,"noNextImg":false,"noSnippet":null},"__N_SSP":true},"page":"/blog/posts/[...slug]","query":{"slug":["2022","10","de-normalization-how-clickhouse-dictionaries-can-solve-typical-problems"]},"buildId":"HkxA3M0ES7gp3V0n_0ecw","isFallback":false,"gssp":true,"locale":"en","locales":["en"],"defaultLocale":"en","scriptLoader":[]}</script></body></html>