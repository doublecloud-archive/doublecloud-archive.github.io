<!DOCTYPE html><html lang="en"><head itemscope=""><script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"insights","name":"Insights"}},{"@type":"ListItem","position":2,"item":{"@id":"ClickHouse","name":"ClickHouse"}}]},{"@type":"BlogPosting","@id":"https://double.cloud/blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood/","url":"https://double.cloud/blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood/","name":"How S3-based ClickHouse hybrid storage works under the hood","headline":"How S3-based ClickHouse hybrid storage works under the hood","abstract":"","description":"","dateCreated":"2022-11-25T00:00:00Z","datePublished":"2022-11-25T00:00:00Z","dateModified":"2022-11-25T00:00:00Z","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"creator":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"publisher":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightHolder":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightYear":2025,"mainEntityOfPage":{"@type":"WebPage","@id":"https://double.cloud/blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood/"},"inLanguage":{"@type":"Language","name":"English","alternateName":"en"},"keywords":["Insights","ClickHouse"],"image":"https://double.cloud/assets/blog/articles/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-small-cover.png.webp","sharedContent":{"@type":"WebPage","headline":"How S3-based ClickHouse hybrid storage works under the hood","url":"https://double.cloud/blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood/","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}}},"wordCount":"","articleBody":""}]}</script><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>How S3-based ClickHouse hybrid storage works under the hood | DoubleCloud</title><link rel="canonical" href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html"/><meta itemProp="name" content="How S3-based ClickHouse hybrid storage works under the hood"/><meta itemProp="image" content="https://double.cloud/assets/blog/articles/new-sharing-images/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-sharing.png"/><meta property="og:type" content="website"/><meta property="og:url" content="https://double.cloud/blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood/"/><meta property="og:title" content="How S3-based ClickHouse hybrid storage works under the hood"/><meta property="og:image" content="https://double.cloud/assets/blog/articles/new-sharing-images/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-sharing.png"/><meta property="og:locale" content="en"/><meta property="og:site_name" content="DoubleCloud"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="How S3-based ClickHouse hybrid storage works under the hood"/><meta name="twitter:image" content="https://double.cloud/assets/blog/articles/new-sharing-images/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-sharing.png"/><meta name="robots" content="follow, index"/><meta property="article:published_time" content="2022-11-25T00:00:00Z"/><meta property="article:author" content=""/><meta property="article:tag" content="Insights"/><meta property="article:tag" content="ClickHouse"/><meta name="next-head-count" content="21"/><link rel="icon" href="../../../../../assets/favicon/favicon.ico" sizes="any"/><link type="image/x-icon" rel="shortcut icon" href="../../../../../assets/favicon/favicon.ico"/><link type="image/png" sizes="16x16" rel="icon" href="../../../../../assets/favicon/favicon-16x16.png"/><link type="image/png" sizes="32x32" rel="icon" href="../../../../../assets/favicon/favicon-32x32.png"/><link type="image/png" sizes="120x120" rel="icon" href="../../../../../assets/favicon/favicon-120x120.png"/><link type="image/png" sizes="192x192" rel="icon" href="../../../../../assets/favicon/favicon-192x192.png"/><link type="image/png" sizes="76x76" rel="apple-touch-icon" href="https://double.cloud/assets/favicon/favicon-76x76.png"/><link type="image/png" sizes="152x152" rel="apple-touch-icon" href="../../../../../assets/favicon/favicon-152x152.png"/><link type="image/png" sizes="180x180" rel="apple-touch-icon" href="../../../../../assets/favicon/favicon-180x180.png"/><script id="data-google-tag-manager" nonce="RRAgWORhqEZHg/MBRMnoKg==" data-nonce="RRAgWORhqEZHg/MBRMnoKg==">
                // Define dataLayer and the gtag function.
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}

                // Default analytics_storage to 'denied'.
                window.gtag = window.gtag || gtag;

                const hasAnalyticsConsent = window?.localStorage.getItem('hasAnalyticsConsent');
                const consent =  hasAnalyticsConsent === 'true' ? 'granted' : 'denied';

                window.gtag('consent', 'default', {
                    'analytics_storage': consent,
                    'ad_storage': consent,
                    'wait_for_update': hasAnalyticsConsent === 'true' ? 0 : Infinity,
                });

                dataLayer.push({
                    'event': 'default_consent'
                });

                (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                'https://www.googletagmanager.com/gtm.js?id='+i+dl;var n=d.querySelector('[nonce]');
                n&&j.setAttribute('nonce',n.nonce||n.getAttribute('nonce'));f.parentNode.insertBefore(j,f);
                })(window,document,'script','dataLayer','GTM-5M39N8J');
            </script><script nonce="RRAgWORhqEZHg/MBRMnoKg==">window.__webpack_nonce__ = "RRAgWORhqEZHg/MBRMnoKg=="</script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="preconnect" href="https://snap.licdn.com"/><link rel="preconnect" href="https://www.google.com"/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="preload" href="../../../../../_next/static/css/a4c87e381fd61058.css" as="style"/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="stylesheet" href="../../../../../_next/static/css/a4c87e381fd61058.css" data-n-g=""/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="preload" href="../../../../../_next/static/css/2facd84af36bff2e.css" as="style"/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="stylesheet" href="../../../../../_next/static/css/2facd84af36bff2e.css" data-n-p=""/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="preload" href="../../../../../_next/static/css/c413166e8b0da734.css" as="style"/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="stylesheet" href="../../../../../_next/static/css/c413166e8b0da734.css" data-n-p=""/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="preload" href="../../../../../_next/static/css/248e88462928fa2f.css" as="style"/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="stylesheet" href="../../../../../_next/static/css/248e88462928fa2f.css" data-n-p=""/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="preload" href="../../../../../_next/static/css/eb8a627e7f585420.css" as="style"/><link nonce="RRAgWORhqEZHg/MBRMnoKg==" rel="stylesheet" href="../../../../../_next/static/css/eb8a627e7f585420.css" data-n-p=""/><noscript data-n-css="RRAgWORhqEZHg/MBRMnoKg=="></noscript><script defer="" nonce="RRAgWORhqEZHg/MBRMnoKg==" nomodule="" src="../../../../../_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="../../../../../_next/static/chunks/webpack-d326a7489defa990.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/chunks/framework-cc7effedd0fd3d95.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/chunks/main-ebfff3515213fa2f.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/chunks/pages/_app-4cd98c5be1eceb26.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/chunks/f69bbb46-eed95df46583a2d8.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/chunks/030d571f-c7510aa4f8d650e7.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/chunks/193-fdb54e47dd6b7c7b.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/chunks/756-04d1c95c632019ed.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/chunks/387-27526d5e8e2a9173.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/chunks/pages/blog/posts/[...slug]-896d627301783262.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/HkxA3M0ES7gp3V0n_0ecw/_buildManifest.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script><script src="../../../../../_next/static/HkxA3M0ES7gp3V0n_0ecw/_ssgManifest.js" nonce="RRAgWORhqEZHg/MBRMnoKg==" defer=""></script></head><body class="dc-root g-root g-root_theme_dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5M39N8J" title="Googletagmanager" height="0" width="0" style="display:none;visibility:hidden" loading="lazy"></iframe></noscript><div id="__next" data-reactroot=""><div class="layout"><div class="layout__content"><div class="g-root g-root_theme_dark pc-page-constructor"><div class="pc-page-constructor__wrapper"><div class="pc-layout"><div class="pc-Grid pc-navigation pc-layout__navigation"><div class="container-fluid "><div class="row"><div class="col"><nav><div class="pc-desktop-navigation__wrapper"><div class="pc-desktop-navigation__left"><div class="link" data-link-type="router"><span class="pc-logo pc-desktop-navigation__logo"><picture><img alt="Logo icon" src="../../../../../assets/logo/dc-logo-dark.svg" class="pc-logo__icon"/></picture><span class="pc-logo__text"></span></span></div></div><div class="pc-desktop-navigation__navigation-container"><div class="pc-overflow-scroller__container"><div class="pc-overflow-scroller pc-desktop-navigation__navigation"><div class="pc-overflow-scroller__wrapper" style="left:0"><ul class="pc-desktop-navigation__links"><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Why DoubleCloud</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="group-list-content"><div class="row item-list-content"><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Performance" data-link-type="router" href="../../../../../performance-boost/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Performance</span><span class="navigation-popup-item__description">Get the best performance with the highest ROI</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Security" data-link-type="router" href="../../../../../security.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Security</span><span class="navigation-popup-item__description">Keep your data protected and maintain compliance</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="DoubleCloud vs. other solutions" data-link-type="router" href="../../../../../comparison/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">DoubleCloud vs. other solutions</span><span class="navigation-popup-item__description">Learn how DoubleCloud’s products compare to other solutions</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Customer stories" data-link-type="router" href="../../../../../resources/case-studies/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Customer stories</span><span class="navigation-popup-item__description">See our solutions in action</span></div></a></div></div><div class="group-list-content__banner"><picture><img alt="" src="../../../../../assets/doublecloud/menu-bar/menu-banner-dc-results.png.webp" class="group-list-content__image" style="width:300px;height:300px"/></picture><span class="yfm yfm_constructor"><a href='../../../../../performance-boost/index.html' target='_self'>Get more and spend less with DoubleCloud  →</a></span></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Products</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="row item-list-content"><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Managed Service for ClickHouse®" data-link-type="router" href="../../../../../services/managed-clickhouse.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-clickhouse.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Managed Service for ClickHouse®</span><span class="navigation-popup-item__description">The fastest, most resource-efficient OLAP database for real-time analytics</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Managed Service for Apache Kafka®" data-link-type="router" href="../../../../../services/managed-kafka.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-kafka.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Managed Service for Apache Kafka®</span><span class="navigation-popup-item__description">A leading data streaming technology for large-scale, data-intensive applications</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Managed Service for Apache Airflow®" data-link-type="router" href="../../../../../services/managed-airflow/index.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-airflow.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Managed Service for Apache Airflow®</span><span class="navigation-popup-item__description">Open-source tool to orchestrate and monitor workflows</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Data Transfer" data-link-type="router" href="../../../../../services/doublecloud-transfer.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-transfer.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Data Transfer</span><span class="navigation-popup-item__description">No-code ELT tool for aggregating, collecting, and migrating data</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Data Visualization" data-link-type="router" href="../../../../../services/doublecloud-visualization.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-data-vis.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Data Visualization</span><span class="navigation-popup-item__description">Free tool to create, modify, and share dashboards and charts</span></div></a></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Solutions</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="group-list-content"><div class="row item-list-content"><h4 class="item-list-content__title">By use case</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Customer-facing analytics" data-link-type="router" href="../../../../../customer-facing-analytics/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Customer-facing analytics</span><span class="navigation-popup-item__description">Provide business insights for your clients or partners</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Real-time analytics" data-link-type="router" href="../../../../../solutions/real-time-analytics/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Real-time analytics</span><span class="navigation-popup-item__description">Build a data infrastructure to collect, process, and analyze data in real time</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Observability and monitoring" data-link-type="router" href="../../../../../solutions/observability-and-monitoring/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Observability and monitoring</span><span class="navigation-popup-item__description">Analyze terabytes of your logs, events, and traces with ease</span></div></a></div></div><div class="row item-list-content"><h4 class="item-list-content__title">By industry</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="AdTech and MarTech data analytics" data-link-type="router" href="../../../../../solutions/adtech.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">AdTech and MarTech data analytics</span><span class="navigation-popup-item__description">Extract and analyze data from Meta ads, Google ads, LinkedIn ads, and others</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Analytics for mobile and gaming apps" data-link-type="router" href="../../../../../solutions/web-mobile-gaming-apps.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Analytics for mobile and gaming apps</span><span class="navigation-popup-item__description">Optimize and scale your mobile and gaming app analytics</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="EdTech data analytics" data-link-type="router" href="../../../../../solutions/edtech/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">EdTech data analytics</span><span class="navigation-popup-item__description">Improve online learning and identify new sales opportunities</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="FinTech data analytics" data-link-type="router" href="../../../../../solutions/fintech-real-time-analytics/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">FinTech data analytics</span><span class="navigation-popup-item__description">Manage and process large amounts of financial data efficiently</span></div></a></div></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control dc-dropdown-navigation-item__control_selected"><span class="dc-dropdown-navigation-item__title">Resources</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="group-list-content"><div class="row item-list-content"><h4 class="item-list-content__title">Using DoubleCloud</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="DoubleCloud API" href="../../../../../docs/en/public-api/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">DoubleCloud API</span><span class="navigation-popup-item__description">Read up on API tutorials and instructions</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Terraform" href="../../../../../docs/en/developer-resources/terraform/create-resources.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Terraform</span><span class="navigation-popup-item__description">Deploy and manage cloud resources with the infrastructure-as-code approach</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Status updates" data-link-type="router" href="https://status.double.cloud/"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Status updates</span><span class="navigation-popup-item__description">Check the current operational status of our services</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Support" data-link-type="router" href="../../../../../support/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Support</span><span class="navigation-popup-item__description">Learn more about our support tiers</span></div></a></div></div><div class="row item-list-content"><h4 class="item-list-content__title">Discover</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Webinars" data-link-type="router" href="../../../../../webinars/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Webinars</span><span class="navigation-popup-item__description">Sign up for the next webinar or watch previous ones</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover navigation-popup-item__content_selected" aria-label="Blog" data-link-type="router" href="../../../../index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Blog</span><span class="navigation-popup-item__description">Get insights from our team and the latest news</span></div></a></div></div><div class="group-list-content__banner"><picture><img alt="" src="../../../../../assets/doublecloud/menu-bar/menu-banners-dc-ebook.png.webp" class="group-list-content__image" style="width:300px;height:300px"/></picture><span class="yfm yfm_constructor"><a href='../../../../../resources/clickhouse-ebook/index.html' target='_self'>Grab your ebook  →</a></span></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Company</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="row item-list-content"><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="About DoubleCloud" data-link-type="router" href="../../../../../company/about-us.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">About DoubleCloud</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Careers" data-link-type="router" href="../../../../../company/careers.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Careers</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Contact us" data-link-type="router" href="../../../../../company/contact-us.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Contact us</span></div></a></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><a aria-label="Pricing" class="pc-navigation-item__content pc-navigation-item__content_type_link" data-link-type="router" href="../../../../../pricing.html"><div class="navigation-item"><span class="navigation-item__text">Pricing</span></div></a></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><a href="../../../../../docs/index.html" aria-label="Documentation" class="pc-navigation-item__content pc-navigation-item__content_type_link" target="_self"><div class="navigation-item"><span class="navigation-item__text">Documentation</span></div></a></li></ul></div></div></div></div><div class="pc-desktop-navigation__right"><button type="button" aria-label="Button label" class="pc-control pc-control_size_l pc-control_theme_primary pc-mobile-menu-button"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="24" class="g-icon" fill="currentColor" stroke="none" data-qa="icon-test-id" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="currentColor" fill-rule="evenodd" d="M1.25 3.25A.75.75 0 0 1 2 2.5h12A.75.75 0 0 1 14 4H2a.75.75 0 0 1-.75-.75Zm0 4.75A.75.75 0 0 1 2 7.25h12a.75.75 0 0 1 0 1.5H2A.75.75 0 0 1 1.25 8ZM2 12a.75.75 0 0 0 0 1.5h12a.75.75 0 0 0 0-1.5H2Z" clip-rule="evenodd"></path></svg></svg></button><ul class="pc-desktop-navigation__buttons"><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><div class="link" data-link-type="router"><a class="g-button g-button_view_flat g-button_size_l g-button_pin_round-round pc-button-block pc-button-block_position_left pc-button-block_size_l pc-button-block_theme_flat pc-navigation-button pc-navigation-item__content pc-navigation-item__content_type_button" href="https://join.slack.com/t/double-cloud/shared_invite/zt-1pbz9lfte-5GoIX~8CmVYqmVQfRFPNdA" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><img class="pc-button-block__image" src="../../../../../assets/icons/slack.svg" alt="Button image"/><span class="pc-button-block__text">Slack</span></span></span></a></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><div class="link" data-link-type="router"><a class="g-button g-button_view_flat g-button_size_l g-button_pin_round-round pc-button-block pc-button-block_size_l pc-button-block_theme_flat pc-navigation-button pc-navigation-item__content pc-navigation-item__content_type_button" href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#contact-us-form" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><span class="pc-button-block__text">Contact us</span></span></span></a></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><div class="link" data-link-type="router"><a class="g-button g-button_view_action g-button_size_l g-button_pin_round-round pc-button-block pc-button-block_size_l pc-button-block_theme_accent pc-navigation-button pc-navigation-item__content pc-navigation-item__content_type_button" href="https://app.double.cloud" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><span class="pc-button-block__text">Console</span></span></span></a></div></li></ul></div></div><div></div></nav></div></div></div></div><main class="pc-layout__content"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><header class="pc-header-block pc-header-block_media-view_full"><div class="pc-header-block__background pc-header-block__background_media" style="background-color:#000000"><div class="pc-Media pc-header-block__background-media" style="background-color:#000000"><div style="transform:"><div class="pc-storage-background-image pc-media-component-image__item pc-header-block__image" data-qa="background-image"><picture data-qa="background-image-image"><img fetchpriority="high" alt="" src="../../../../../assets/blog/articles/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-cover.png.webp" class="pc-storage-background-image__img"/></picture></div></div></div></div><div class="pc-Grid"><div class="container-fluid pc-header-block__container-fluid"><div class="row pc-header-block__breadcrumbs"><div class="col"><div class="pc-header-breadcrumbs pc-header-breadcrumbs_theme_light" aria-label="You are here:"><div class="pc-header-breadcrumbs__item"><a href="../../../../index.html" class="pc-header-breadcrumbs__text">Blog</a></div><div class="pc-header-breadcrumbs__item"><a href="../../../../index.html%3Ftags=insights.html" class="pc-header-breadcrumbs__text">Insights</a></div></div></div></div><div class="row"><div class="col col-reset pc-header-block__content-wrapper"><div class="row"><div class="col pc-header-block__content pc-header-block__content_offset_default pc-header-block__content_theme_light pc-header-block__content_vertical-offset_l"><div class="col  col-lg-8 col-md-8 col-sm-12 col-12 pc-header-block__content-inner"><h1 class="pc-header-block__title" id="g-uniq-1226151"><span>How S3-based ClickHouse hybrid storage works under the hood</span></h1><div class="bc-post-info__container bc-post-info__container_theme_light"><div class="bc-post-info__item bc-post-info__item_size_s" data-qa="blog-header-meta-container-date">November 25, 2022</div><div class="bc-post-info__item bc-post-info__item_size_s" data-qa="blog-header-meta-container-reading-time"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>15 mins to read</div><div class="bc-post-info__item"><div class="bc-post-info__icon"><div class="g-popover gc-share-popover bc-post-info__share"><button class="gc-share-popover__container bc-post-info__switcher bc-post-info__switcher_theme_light" aria-expanded="false" aria-controls="g-uniq-1226152" aria-describedby="g-uniq-1226152"><div class="gc-share-popover__icon-container"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon gc-share-popover__icon bc-post-info__share-icon" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.798 3.16a.5.5 0 0 0 .363.842H7V9a1 1 0 0 0 2 0V4.002h1.839a.5.5 0 0 0 .363-.844L8.363.156a.5.5 0 0 0-.726 0l-2.84 3.002.001.001ZM13 7a1 1 0 0 1 2 0v6.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 13.5V7a1 1 0 0 1 2 0v6h10V7Z"></path></svg></svg></div><div class="gc-share-popover__title">Share</div></button></div></div></div></div></div></div></div></div></div></div></div></header></section><div class="pc-Grid"><div class="container-fluid "><div class="row pc-constructor-row"><div class="col"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p><em>Written by&nbsp;Anton Ivashkin, DoubleCloud Dev lead for ClickHouse service.</em></p>
<p>Everyone knows that ClickHouse is&nbsp;extremely fast at&nbsp;processing a&nbsp;lot of&nbsp;data. A&nbsp;dataset may reach tens/hundreds of&nbsp;terabytes or&nbsp;even a&nbsp;hundred petabytes. Of&nbsp;course, this data needs to&nbsp;be&nbsp;stored somewhere with the following core requirements: cost-efficiency, high speed, accessibility, security, and reliability. S3 or&nbsp;object storage is&nbsp;a&nbsp;perfect match, but the only critical point it&nbsp;lacks is&nbsp;speed. Therefore, we&nbsp;built a&nbsp;hybrid approach where you can fuse the speed of&nbsp;SSD disks and the affordability of&nbsp;S3.</p>
<p>Our team at&nbsp;DoubleCloud started developing the S3 hybrid storage feature a&nbsp;year ago, and it&nbsp;was successfully merged in&nbsp;version 22.3 on&nbsp;April 18, 2022&nbsp;with further fixes and optimizations in&nbsp;the version 22.8. It&nbsp;was widely accepted by&nbsp;the community and Clickhouse team primarily because compute is&nbsp;now decoupled from the storage. We&nbsp;see a&nbsp;reduction from 3-5 times in&nbsp;storage cost in&nbsp;those scenarios where hybrid storage is&nbsp;applicable, and that&rsquo;s a&nbsp;real game changer for scenarios like logs, metrics, traces, or&nbsp;other data scenarios where users primarily work with fresh data and the rest is&nbsp;stored for rare cases.</p>
<p>Below I&nbsp;will describe how it&rsquo;s working under the hood and on&nbsp;what principles it&rsquo;s based.</p>
<h2 id="conservative-approach"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#conservative-approach" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">The conservative approach</span></a>The conservative approach</h2>
<p>The classical approach is&nbsp;to&nbsp;use a&nbsp;sharded ClickHouse cluster. Let&rsquo;s say the data is&nbsp;100&nbsp;TB, and there is&nbsp;10&nbsp;TB&nbsp;of&nbsp;storage space available on&nbsp;each&nbsp;VM. Then a&nbsp;perfect partitioning would require ten shards, with two replicated nodes per shard. This requirement adds up&nbsp;to&nbsp;20&nbsp;machines. However, it&rsquo;s only sometimes the case that the data gets evenly split, so&nbsp;you can safely multiply that number by&nbsp;one and a&nbsp;half.</p>
<p>Plus, ClickHouse works sub-optimally when the storage has no&nbsp;free space. With read-only data, which is&nbsp;completely frozen, you can still manage, but if&nbsp;the new data flows in&nbsp;regularly, you must have at&nbsp;least 10&nbsp;percent more free space for it&nbsp;to&nbsp;work correctly.</p>
<p>Now we&nbsp;face the need to&nbsp;run 30+ machines, which is&nbsp;quite significant. In&nbsp;this case, most VMs will use only disk space, and the CPU and RAM will be&nbsp;almost idle.</p>
<p>Of&nbsp;course, there are situations when there is&nbsp;a&nbsp;large flow of&nbsp;requests, and other resources will get their share of&nbsp;the load, but according to&nbsp;our data on&nbsp;clusters with 10+ shards, they tend to&nbsp;be&nbsp;indefinitely idle.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/сh-over-S3-scheme-1.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/сh-over-S3-scheme-1.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><h2 id="alternate-approach"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#alternate-approach" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">The alternate approach</span></a>The alternate approach</h2>
<p>ClickHouse can use S3-compatible storage. The advantages of&nbsp;this approach are the following:</p>
<ul>
<li>
<p>Almost unlimited capacity,</p>
</li>
<li>
<p>Significantly lower cost than dedicated VMs with the same amount of&nbsp;disk space.</p>
</li>
</ul>
<p>The main disadvantage is&nbsp;that S3-compatible storage is&nbsp;a&nbsp;network resource, so&nbsp;the speed of&nbsp;access to&nbsp;data, as&nbsp;a&nbsp;consequence, increases the time of&nbsp;operations.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/сh-over-S3-scheme-2.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/сh-over-S3-scheme-2.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Let&rsquo;s see how it&nbsp;works. An&nbsp;IDisk interface provides methods for basic file operations such as&nbsp;create, copy, rename, delete, etc. The ClickHouse engine works with that interface. Most of&nbsp;the time, it&nbsp;doesn&rsquo;t matter what&rsquo;s under the hood. There are implementations for specific storage methods:</p>
<ul>
<li>
<p>local disk (<code>DiskLocal</code>),</p>
</li>
<li>
<p>in-memory storage (<code>DiskMemory</code>),</p>
</li>
<li>
<p>cloud storage (<code>DiskObjectStorage</code>).</p>
</li>
</ul>
<p>The latter implements logic for storing data in&nbsp;different types of&nbsp;storage, notably in&nbsp;S3.<br />
The other storages are HDFS and MS&nbsp;Azure. They&rsquo;re similar conceptually, but for now let&rsquo;s focus on&nbsp;S3.</p>
<h3 id="managing-s3"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#managing-s3" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Managing data in&nbsp;S3</span></a>Managing data in&nbsp;S3</h3>
<p>When the engine wants to&nbsp;&ldquo;create a&nbsp;file&rdquo; on&nbsp;an&nbsp;S3 disk, it&nbsp;creates an&nbsp;object in&nbsp;S3 with a&nbsp;random name, writes a&nbsp;data stream to&nbsp;it&nbsp;and creates a&nbsp;metadata file on&nbsp;the local disk with the name, size and some other information. The size of&nbsp;such a&nbsp;local metadata file is&nbsp;tens of&nbsp;bytes.</p>
<p>Then operations such as&nbsp;renaming and creating hard links are performed only on&nbsp;the local metadata file, while the object on&nbsp;S3 remains untouched.</p>
<p>S3 doesn&rsquo;t provide a&nbsp;straightforward way to&nbsp;modify created S3 objects. For example, the renaming operation is&nbsp;a&nbsp;load-intensive procedure to&nbsp;create a&nbsp;new object. The above scheme with a&nbsp;small local metadata file allows you to&nbsp;bypass this limitation.</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"># aws s3 ls s3:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-keyword">double</span><span class="hljs-operator">-</span>cloud<span class="hljs-operator">-</span>storage<span class="hljs-operator">-</span>chc8d6h0ehe98li0k4sn<span class="hljs-operator">/</span>cloud_storage<span class="hljs-operator">/</span>chc8d6h0ehe98li0k4sn<span class="hljs-operator">/</span>s1<span class="hljs-operator">/</span>
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">58</span>      <span class="hljs-number">8</span> bpmwovnptyvtbxrxpaixgnjhgsjfekwd
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">58</span>     <span class="hljs-number">80</span> enmwkqfptmghyxzxhiczjgpkhzsvexgi
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>     <span class="hljs-number">10</span> mjgumajoilbkcpnvlbbglgajrkvqbpea
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>      <span class="hljs-number">1</span> aoazgzkryvhceolzichwyprzsmjotkw
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>      <span class="hljs-number">4</span> xiyltehvfxbkqbnytyjwbsmyafgjscwg
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>    <span class="hljs-number">235</span> ickdlneqkzcrgpeokcubmkwtyyayukmg
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>     <span class="hljs-number">65</span> lyggepidqbgyxqwzsfoxltxpbfbehrqy
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>     <span class="hljs-number">60</span> ytfhoupmfahdakydbfumxxkqgloakanh
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>      <span class="hljs-number">8</span> tddzrmzildnwtmvescmbkhqzhoxwoqmq
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="35">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-35" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-35" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-35.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"># ls <span class="hljs-operator">-</span>l <span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>lib<span class="hljs-operator">/</span>clickhouse<span class="hljs-operator">/</span>disks<span class="hljs-operator">/</span>object_storage<span class="hljs-operator">/</span>store<span class="hljs-operator">/</span><span class="hljs-number">133</span><span class="hljs-operator">/</span><span class="hljs-number">13344</span>eec<span class="hljs-operator">-</span>d80a<span class="hljs-number">-4</span>a5b<span class="hljs-operator">-</span>b99d<span class="hljs-number">-6177</span>f144e62a<span class="hljs-operator">/</span><span class="hljs-number">2</span>_0_0_0<span class="hljs-operator">/</span>
total <span class="hljs-number">36</span>
<span class="hljs-operator">-</span>rw<span class="hljs-operator">-</span>r<span class="hljs-comment">----- 1 clickhouse clickhouse 120 Nov 21 12:32 checksums.txt</span>
<span class="hljs-operator">-</span>rw<span class="hljs-operator">-</span>r<span class="hljs-comment">----- 1 clickhouse clickhouse 118 Nov 21 12:32 columns.txt</span>
<span class="hljs-operator">-</span>rw<span class="hljs-operator">-</span>r<span class="hljs-comment">----- 1 clickhouse clickhouse 116 Nov 21 12:32 count.txt</span>
<span class="hljs-operator">-</span>rw<span class="hljs-operator">-</span>r<span class="hljs-comment">----- 1 clickhouse clickhouse 118 Nov 21 12:32 data.bin</span>
<span class="hljs-operator">-</span>rw<span class="hljs-operator">-</span>r<span class="hljs-comment">----- 1 clickhouse clickhouse 118 Nov 21 12:32 data.mrk3</span>
<span class="hljs-operator">-</span>rw<span class="hljs-operator">-</span>r<span class="hljs-comment">----- 1 clickhouse clickhouse 118 Nov 21 12:32 default_compression_codec.txt</span>
<span class="hljs-operator">-</span>rw<span class="hljs-operator">-</span>r<span class="hljs-comment">----- 1 clickhouse clickhouse 116 Nov 21 12:32 minmax_key.idx</span>
<span class="hljs-operator">-</span>rw<span class="hljs-operator">-</span>r<span class="hljs-comment">----- 1 clickhouse clickhouse 116 Nov 21 12:32 partition.dat</span>
<span class="hljs-operator">-</span>rw<span class="hljs-operator">-</span>r<span class="hljs-comment">----- 1 clickhouse clickhouse 116 Nov 21 12:32 primary.idx</span>
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="36">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-36" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-36" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-36.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"># cat <span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>lib<span class="hljs-operator">/</span>clickhouse<span class="hljs-operator">/</span>disks<span class="hljs-operator">/</span>object_storage<span class="hljs-operator">/</span>store<span class="hljs-operator">/</span><span class="hljs-number">133</span><span class="hljs-operator">/</span><span class="hljs-number">13344</span>eec<span class="hljs-operator">-</span>d80a<span class="hljs-number">-4</span>a5b<span class="hljs-operator">-</span>b99d<span class="hljs-number">-6177</span>f144e62a<span class="hljs-operator">/</span><span class="hljs-number">2</span>_0_0_0<span class="hljs-operator">/</span>data.mrk3
<span class="hljs-number">3</span>                                       # [metadata file format version]
<span class="hljs-number">1</span>    <span class="hljs-number">80</span>                                 # [objects count] [total size]
<span class="hljs-number">80</span>    enmwkqfptmghyxzxhiczjgpkhzsvexgi  # [object size] [object name]
<span class="hljs-number">0</span>                                       # [reference count]
<span class="hljs-number">0</span>                                       # [readonly flag]
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="37">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-37" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-37" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-37.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<p>A&nbsp;separate operation is&nbsp;adding data to&nbsp;the file. As&nbsp;mentioned earlier, S3 doesn&rsquo;t allow changing objects after creation, so&nbsp;we&nbsp;create another object to&nbsp;which a&nbsp;new portion of&nbsp;data is&nbsp;added. The name of&nbsp;this object is&nbsp;written in&nbsp;the metadata file mentioned earlier, and it&nbsp;starts referring to&nbsp;multiple objects.</p>
<p>Please note that such operation in&nbsp;ClickHouse is&nbsp;performed only for <a href="https://clickhouse.com/docs/en/engines/table-engines/log-family/" target="_blank">Log family engines</a>, which almost nobody uses. In&nbsp;the popular <a href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/" target="_blank">MergeTree engine</a>, the file is&nbsp;created once and is&nbsp;never modified again.</p>
<p>For some operations, such as&nbsp;mutation, the engine creates a&nbsp;new part with a&nbsp;new structure when adding a&nbsp;new column. However, as&nbsp;some data doesn&rsquo;t change, we&nbsp;use the operation to&nbsp;create hard links to&nbsp;the old ones instead of&nbsp;copying them. Only the local metadata file is&nbsp;linked, where, among other things, we&nbsp;store the link counter, which increases with this operation.</p>
<h4 id="limitations"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#limitations" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">ClickHouse limitations with S3 data operations</span></a>ClickHouse limitations with S3 data operations</h4>
<p>When you perform the deletion, the engine decrements the link count and deletes the local metadata file, and if&nbsp;this is&nbsp;the last hard link to&nbsp;the deleted file, it&nbsp;possibly removes the object in&nbsp;S3. We&rsquo;ll get back to&nbsp;why it&rsquo;s possible when discussing replication.</p>
<p>ClickHouse doesn&rsquo;t use such manipulations as&nbsp;data replacement in&nbsp;the middle of&nbsp;the file. Thus, it&nbsp;wasn&rsquo;t implemented.</p>
<p>Let&rsquo;s elaborate on&nbsp;two more points.</p>
<p>The first one is&nbsp;that the object&rsquo;s name in&nbsp;S3 is&nbsp;random. It&rsquo;s pretty inconvenient because it&nbsp;isn&rsquo;t clear from the object itself what it&nbsp;is. Below we&rsquo;ll talk about the operations log, it&rsquo;s a&nbsp;mechanism that allows us&nbsp;to&nbsp;streamline things somewhat, but it&rsquo;s not perfect either.</p>
<p>The second point is&nbsp;that storing the count of&nbsp;hard links in&nbsp;the metadata file seems unnecessary since we&nbsp;can obtain it&nbsp;from the file system. But in&nbsp;the case of&nbsp;manual manipulation of&nbsp;local files past ClickHouse, the link could get broken. In&nbsp;this case, both copies would have an&nbsp;increased counter, which wouldn&rsquo;t allow the object to&nbsp;be&nbsp;deleted in&nbsp;S3 when one of&nbsp;the copies is&nbsp;deleted. Deleting the second one won&rsquo;t delete it&nbsp;either, but it&rsquo;s better to&nbsp;leave the garbage on&nbsp;S3 than lose the needed data.</p>
<p>When a&nbsp;local metadata file is&nbsp;read, it&nbsp;learns the name of&nbsp;the object or&nbsp;objects in&nbsp;S3, and S3 requests the desired portion of&nbsp;data. It&nbsp;helps that S3 allows you to&nbsp;download a&nbsp;fragment of&nbsp;an&nbsp;object by&nbsp;offset and size.</p>
<h4 id="сaching"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#сaching" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Caching</span></a>Caching</h4>
<p>In&nbsp;the <a href="https://clickhouse.com/docs/en/whats-new/changelog/" target="_blank">latest ClickHouse versions</a>, we&nbsp;can cache data downloaded from object storage. We&nbsp;can add data into the cache while writing with a&nbsp;separate option. It&nbsp;can speed up&nbsp;requests execution when different requests access the same data. Within one request, repeated reading of&nbsp;the same data doesn&rsquo;t occur. This functionality is&nbsp;built into the engine. However, the cache size is&nbsp;limited, so&nbsp;the best choice depends on&nbsp;your case.</p>
<h4 id="operations-log-in-hybrid-storage"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#operations-log-in-hybrid-storage" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Operations log in&nbsp;hybrid storage</span></a>Operations log in&nbsp;hybrid storage</h4>
<p>There is&nbsp;a&nbsp;default <code>send_metadata</code> setting, which is&nbsp;disabled by&nbsp;default. ClickHouse keeps a&nbsp;counter of&nbsp;operations, which increments with each operation of&nbsp;file creation, renaming and hard link creation.</p>
<p>When creating, the operation number is&nbsp;added to&nbsp;the object name in&nbsp;binary form, and S3 metadata (not to&nbsp;be&nbsp;confused with the local metadata file, we&nbsp;have a&nbsp;certain deficit in&nbsp;terminology here) is&nbsp;added to&nbsp;the object, in&nbsp;which the original file name is&nbsp;written.</p>
<p>When renaming and hard linking, a&nbsp;special small object is&nbsp;created in&nbsp;S3, whose name also contains the operation number and whose S3 metadata records from which local name to&nbsp;which a&nbsp;hard link was renamed or&nbsp;created.</p>
<p>When performing the deletion, the operation counter isn&rsquo;t incremented after the object is&nbsp;deleted. It&nbsp;allows you to&nbsp;restore local metadata&nbsp;&mdash; S3 queries the complete list of&nbsp;objects containing data. It&nbsp;enables you to&nbsp;recover the original name using the S3 metadata, then rename and hard link operations are applied to&nbsp;the existing files. It&rsquo;s triggered by&nbsp;creating a&nbsp;special file before the disk starts.</p>
<p>This mechanism allows to&nbsp;perform not all operations but only up&nbsp;to&nbsp;some revision, which can be&nbsp;used for backups.</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"># aws s3 ls s3:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-keyword">double</span><span class="hljs-operator">-</span>cloud<span class="hljs-operator">-</span>storage<span class="hljs-operator">-</span>chc8d6h0ehe98li0k4sn<span class="hljs-operator">/</span>cloud_storage<span class="hljs-operator">/</span>chc8d6h0ehe98li0k4sn<span class="hljs-operator">/</span>s1<span class="hljs-operator">/</span>
             PRE operations<span class="hljs-operator">/</span>
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>      <span class="hljs-number">1</span> .SCHEMA_VERSION
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">58</span>      <span class="hljs-number">8</span> r0000000000000000000000000000000000000000000000000000000000000001<span class="hljs-operator">-</span>file<span class="hljs-operator">-</span>bpmwovnptyvtbxrxpaixgnjhgsjfekwd
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">58</span>     <span class="hljs-number">80</span> r0000000000000000000000000000000000000000000000000000000000000010<span class="hljs-operator">-</span>file<span class="hljs-operator">-</span>enmwkqfptmghyxzxhiczjgpkhzsvexgi
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>     <span class="hljs-number">10</span> r0000000000000000000000000000000000000000000000000000000000000011<span class="hljs-operator">-</span>file<span class="hljs-operator">-</span>mjgumajoilbkcpnvlbbglgajrkvqbpea
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>      <span class="hljs-number">1</span> r0000000000000000000000000000000000000000000000000000000000000100<span class="hljs-operator">-</span>file<span class="hljs-operator">-</span>aaoazgzkryvhceolzichwyprzsmjotkw
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>      <span class="hljs-number">4</span> r0000000000000000000000000000000000000000000000000000000000000101<span class="hljs-operator">-</span>file<span class="hljs-operator">-</span>xiyltehvfxbkqbnytyjwbsmyafgjscwg
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>    <span class="hljs-number">235</span> r0000000000000000000000000000000000000000000000000000000000000110<span class="hljs-operator">-</span>file<span class="hljs-operator">-</span>ickdlneqkzcrgpeokcubmkwtyyayukmg
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>     <span class="hljs-number">65</span> r0000000000000000000000000000000000000000000000000000000000000111<span class="hljs-operator">-</span>file<span class="hljs-operator">-</span>lyggepidqbgyxqwzsfoxltxpbfbehrqy
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>     <span class="hljs-number">60</span> r0000000000000000000000000000000000000000000000000000000000001000<span class="hljs-operator">-</span>file<span class="hljs-operator">-</span>ytfhoupmfahdakydbfumxxkqgloakanh
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>      <span class="hljs-number">8</span> r0000000000000000000000000000000000000000000000000000000000001001<span class="hljs-operator">-</span>file<span class="hljs-operator">-</span>tddzrmzildnwtmvescmbkhqzhoxwoqmq
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="92">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-92" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-92" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-92.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"># aws s3api head<span class="hljs-operator">-</span>object <span class="hljs-comment">--bucket double-cloud-storage-chc8d6h0ehe98li0k4sn --key cloud_storage/chc8d6h0ehe98li0k4sn/s1/r0000000000000000000000000000000000000000000000000000000000000010-file-enmwkqfptmghyxzxhiczjgpkhzsvexgi</span>
{
  "AcceptRanges": "bytes",
  "LastModified": "Mon, 21 Nov 2022 12:32:58 GMT",
  "ContentLength": <span class="hljs-number">80</span>,
  "ETag": "\"fbc2bf6ed653c03001977f21a1416ace\"",
  "ContentType": "binary/octet-stream",
  "Metadata": {
      "path": "store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/moving/2_0_0_0/data.mrk3"
  }
}
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="93">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-93" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-93" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-93.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"># aws s3 ls s3:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-keyword">double</span><span class="hljs-operator">-</span>cloud<span class="hljs-operator">-</span>storage<span class="hljs-operator">-</span>chc8d6h0ehe98li0k4sn<span class="hljs-operator">/</span>cloud_storage<span class="hljs-operator">/</span>chc8d6h0ehe98li0k4sn<span class="hljs-operator">/</span>s1<span class="hljs-operator">/</span>operations<span class="hljs-operator">/</span>
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">33</span>:<span class="hljs-number">02</span>      <span class="hljs-number">1</span> r0000000000000000000000000000000000000000000000000000000000000001<span class="hljs-operator">-</span>ach<span class="hljs-operator">-</span>euc1<span class="hljs-operator">-</span>az1<span class="hljs-operator">-</span>s1<span class="hljs-number">-1.</span>chc8d6h0ehe98li0k4sn.at.yadc.io<span class="hljs-operator">-</span>rename
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">33</span>:<span class="hljs-number">02</span>      <span class="hljs-number">1</span> r0000000000000000000000000000000000000000000000000000000000000010<span class="hljs-operator">-</span>ach<span class="hljs-operator">-</span>euc1<span class="hljs-operator">-</span>az1<span class="hljs-operator">-</span>s1<span class="hljs-number">-1.</span>chc8d6h0ehe98li0k4sn.at.yadc.io<span class="hljs-operator">-</span>rename
<span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">12</span>:<span class="hljs-number">32</span>:<span class="hljs-number">59</span>      <span class="hljs-number">1</span> r0000000000000000000000000000000000000000000000000000000000001010<span class="hljs-operator">-</span>ach<span class="hljs-operator">-</span>euc1<span class="hljs-operator">-</span>az1<span class="hljs-operator">-</span>s1<span class="hljs-number">-1.</span>chc8d6h0ehe98li0k4sn.at.yadc.io<span class="hljs-operator">-</span>rename
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="94">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-94" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-94" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-94.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"># aws s3api head<span class="hljs-operator">-</span>object <span class="hljs-comment">--bucket double-cloud-storage-chc8d6h0ehe98li0k4sn --key cloud_storage/chc8d6h0ehe98li0k4sn/s1/operations/r0000000000000000000000000000000000000000000000000000000000001010-ach-euc1-az1-s1-1.chc8d6h0ehe98li0k4sn.at.yadc.io-rename</span>
{
  "AcceptRanges": "bytes",
  "LastModified": "Mon, 21 Nov 2022 12:32:59 GMT",
  "ContentLength": <span class="hljs-number">1</span>,
  "ETag": "\"cfcd208495d565ef66e7dff9f98764da\"",
  "ContentType": "binary/octet-stream",
  "Metadata": {
      "to_path": "store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/2_0_0_0/",
      "from_path": "store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/moving/2_0_0_0"
  }
}
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="95">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-95" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-95" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-95.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div>
<h4 id="backups"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#backups" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Backups</span></a>Backups</h4>
<p>On&nbsp;a&nbsp;live VM&nbsp;and with data on&nbsp;local disks, backups are made by&nbsp;calling <code>FREEZE TABLE</code> for each table. This command creates a&nbsp;snapshot of&nbsp;the tables (hard links to&nbsp;all files) in&nbsp;a&nbsp;separate directory so&nbsp;that they can be&nbsp;copied somewhere for the future, then delete the directories manually or&nbsp;via <code>TABLE UNFREEZE</code>. It&nbsp;allows you to&nbsp;keep the tables in&nbsp;a&nbsp;consistent (but not atomic) condition.</p>
<p>This option isn&rsquo;t suitable for S3 because only local metadata can be&nbsp;copied this&nbsp;way. Objects in&nbsp;S3 have to&nbsp;be&nbsp;extracted separately.</p>
<p>We&nbsp;use a&nbsp;way that isn&rsquo;t a&nbsp;backup for S3 per se&nbsp;but a&nbsp;snapshot:</p>
<ul>
<li>
<p>Execute <code>TABLE FREEZE</code>,</p>
</li>
<li>
<p>Save the revision number,</p>
</li>
<li>
<p>Delete the directory with frozen data once the backup is&nbsp;no&nbsp;longer relevant.</p>
</li>
</ul>
<p>The presence of&nbsp;these hard links prevents ClickHouse from deleting objects in&nbsp;S3. When restoring from the operation log, we&nbsp;restore the state for the desired revision.</p>
<p>When a&nbsp;backup becomes obsolete, delete the frozen metadata via <code>UNFREEZE</code> to&nbsp;correctly delete unnecessary objects in&nbsp;S3.</p>
<p>At&nbsp;the same time, since some tables from the backup may already be&nbsp;deleted in&nbsp;the working version and <code>TABLE UNFREEZE</code> cannot be&nbsp;done for them, run the <code>SYSTEM UNFREEZE</code> command. It&nbsp;removes all the frozen data from all the tables by&nbsp;backup name and can work with tables that don&rsquo;t exist&nbsp;now. Please note that this mechanism can take a&nbsp;long time to&nbsp;execute if&nbsp;you have a&nbsp;big log of&nbsp;operations. At&nbsp;the moment, an&nbsp;alternative system for creating backups is&nbsp;in&nbsp;development.</p>
<p>The above method isn&rsquo;t a&nbsp;classic backup, the data is&nbsp;in&nbsp;a&nbsp;single object in&nbsp;S3, and its safety relies on&nbsp;the high reliability of&nbsp;cloud storage. For example, in&nbsp;case of&nbsp;a&nbsp;logical error or&nbsp;unauthorized access, you&rsquo;ll lose the data when an&nbsp;object is&nbsp;deleted.</p>
<p>Working with just S3 storage has a&nbsp;disadvantage&nbsp;&mdash; the <code>Merge</code> operation. It&nbsp;downloads all the partitions ClickHouse wants to&nbsp;merge and uploads a&nbsp;new higher-level part. If&nbsp;the workflow is&nbsp;not organized correctly, adding new data to&nbsp;already merged large chunks, can generate unexpectedly heavy traffic compared to&nbsp;the data being added.</p>
<p>For example, if&nbsp;S3 has a&nbsp;1&nbsp;Gb&nbsp;partition, and 1&nbsp;kb&nbsp;of&nbsp;new data is&nbsp;added, ClickHouse will download this 1&nbsp;Gb, measure the partitions and upload a&nbsp;new part to&nbsp;S3. As&nbsp;a&nbsp;result, adding a&nbsp;small chunk of&nbsp;data causes significantly more traffic.</p>
<p>One possible solution is&nbsp;to&nbsp;prohibit merges on&nbsp;the S3 disk (<a href="https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/mergetree/" target="_blank">prefer_not_to_merge</a> setting), but this will cause another problem&nbsp;&mdash; a&nbsp;large number of&nbsp;small parts, which can significantly (sometimes catastrophically) reduce performance for <code>SELECT</code> queries. So, in&nbsp;a&nbsp;normal situation, it&rsquo;s better not to&nbsp;use prefer_not_to_merge&nbsp;&mdash; this is&nbsp;a&nbsp;mechanism for serious breakdowns that can lead to&nbsp;fairly negative consequences. In&nbsp;a&nbsp;situation where the data arrives more or&nbsp;less consistently, there will be&nbsp;no&nbsp;network load problems.</p>
<h3 id="hybrid-storage"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#hybrid-storage" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Hybrid storage</span></a>Hybrid storage</h3>
<p>A&nbsp;better solution is&nbsp;hybrid storage. Hybrid storage uses a&nbsp;pair of&nbsp;disks, local and S3. New data is&nbsp;stored on&nbsp;the local disk, gets merged into large parts, and then these parts, which aren&rsquo;t expected to&nbsp;merge further, are sent to&nbsp;S3. In&nbsp;this case, the access speed to&nbsp;local data will be&nbsp;higher, and this approach, in&nbsp;most cases, combines the performance of&nbsp;local disks and the volume of&nbsp;cloud storage. You can configure the move:</p>
<ul>
<li>
<p>By&nbsp;data age (<a href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/" target="_blank">TTL MOVE TO&nbsp;&hellip;</a>),</p>
</li>
<li>
<p>By&nbsp;the amount of&nbsp;free space on&nbsp;the local disk (<a href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/" target="_blank">move_factor</a>),</p>
</li>
<li>
<p>Move the data yourself (<a href="https://clickhouse.com/docs/en/sql-reference/statements/alter/partition/" target="_blank">ALTER TABLE MOVE PARTITION</a>).</p>
</li>
</ul>
<p>Setting up&nbsp;a&nbsp;move by&nbsp;time should be&nbsp;chosen to&nbsp;consider the uniformity of&nbsp;data flow so&nbsp;that the principal amount of&nbsp;merges occur while the data is&nbsp;still on&nbsp;the local drive. Another thing to&nbsp;consider is&nbsp;the need to&nbsp;read data: reading from the local drive will usually be&nbsp;much faster. Thus, it&nbsp;makes sense to&nbsp;transfer cold data to&nbsp;S3, which is&nbsp;expected to&nbsp;be&nbsp;accessed less frequently. It&nbsp;would be&nbsp;best if&nbsp;you also didn&rsquo;t rely on&nbsp;the free space transfer alone, as&nbsp;hot, actively used data may be&nbsp;moved, reducing performance.</p>
<p>However, note that there is&nbsp;no&nbsp;special mechanism to&nbsp;reduce merge number specifically on&nbsp;S3 apart from a&nbsp;total restriction. So, if&nbsp;new data is&nbsp;added to&nbsp;an&nbsp;old partition already located in&nbsp;S3, the merge operation will involve downloading and uploading. To&nbsp;reduce the number of&nbsp;merges, you can use the <a href="../../../../../docs/managed-clickhouse/settings-reference.html#maxbytestomergeatmaxspaceinpool">maxBytesToMergeAtMaxSpaceInPool</a> setting, which limits the maximum chunk size, but it&nbsp;applies to&nbsp;all disks with table data, including the local one.</p>
<p>Additionally, the mechanics of&nbsp;using multiple disks aren&rsquo;t limited to&nbsp;this case. For example, you can have a&nbsp;small, fast SSD disk and a&nbsp;larger but slow HDD, or&nbsp;even organize a&nbsp;multi-tiered pie with cloud storage at&nbsp;the end.</p>
<h3 id="replication"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#replication" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Replication</span></a>Replication</h3>
<p>By&nbsp;default, S3 uses the same replication mechanism as&nbsp;for local disks:</p>
<ol>
<li>
<p>New data is&nbsp;written to&nbsp;any node, information about the new part is&nbsp;put into ZooKeeper/ClickHouse Keeper (for convenience, we&rsquo;ll refer to&nbsp;both as&nbsp;just &ldquo;Keeper&rdquo;),</p>
</li>
<li>
<p>Other nodes from Keeper learn about this,</p>
</li>
<li>
<p>They access the node where this data exists and download it&nbsp;from this node (Fetch operation).</p>
</li>
</ol></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/сh-over-S3-scheme-3.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/сh-over-S3-scheme-3.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>For S3, the sequence looks as&nbsp;follows:</p>
<ol>
<li>
<p>The first node downloaded the part from S3,</p>
</li>
<li>
<p>The second node downloaded the part from the first node,</p>
</li>
<li>
<p>The second node uploaded the part to&nbsp;S3.</p>
</li>
</ol></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/сh-over-S3-scheme-4.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/сh-over-S3-scheme-4.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><h3 id="zero-copy-replication"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#zero-copy-replication" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Zero-copy replication</span></a>Zero-copy replication</h3>
<p>This can be&nbsp;avoided by&nbsp;enabling the zero-copy replication mechanism (<a href="../../../../../docs/managed-clickhouse/settings-reference.html" target="_blank">the allowRemoteFsZeroCopyReplication</a> setting).</p>
<p>As&nbsp;a&nbsp;rule, nodes share the same S3. When the second node requests data from the first one, the first one only sends a&nbsp;small bit of&nbsp;local metadata. The second node checks that it&nbsp;can get data from this metadata (in&nbsp;fact, it&nbsp;only requests the presence of&nbsp;one object); if&nbsp;it&nbsp;does, it&nbsp;stores this metadata and uses the S3 objects together with the first&nbsp;one. If&nbsp;there is&nbsp;no&nbsp;access (different S3 bucket or&nbsp;storage), the full copy of&nbsp;the data from the conservative approach takes place. This mechanism with accessibility testing makes it&nbsp;possible, for example, to&nbsp;move live to&nbsp;another object storage&nbsp;&mdash; two more replicas working with S3-A are added to&nbsp;S3-B, they replicate data to&nbsp;themselves via full copying, and each pair shares objects in&nbsp;its S3.</p>
<p>With zero-copy, each replica additionally marks in&nbsp;the Keeper which parts it&nbsp;uses in&nbsp;S3, and when deleting the last hard link from a&nbsp;node, it&nbsp;checks if&nbsp;someone else uses that data, and if&nbsp;it&nbsp;does, it&nbsp;doesn&rsquo;t touch the object in&nbsp;S3.</p>
<p>This is&nbsp;the case of&nbsp;the &ldquo;object on&nbsp;S3 will probably get deleted&rdquo; we&nbsp;mentioned earlier.</p>
<h4 id="zero-copy-imitations-and-issues"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#zero-copy-imitations-and-issues" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Zero-copy limitations and issues</span></a>Zero-copy limitations and issues</h4>
<p>The zero-copy mechanism isn&rsquo;t yet considered production-ready; sometimes, there are bugs. The last example, which is&nbsp;already fixed in&nbsp;recent versions&nbsp;&mdash; is&nbsp;the case of&nbsp;double replication during mutations.</p>
<p>When one node creates a&nbsp;part, the following happens:</p>
<ol>
<li>
<p>The second node replicates it,</p>
</li>
<li>
<p>A&nbsp;mutation is&nbsp;run on&nbsp;the part, resulting in&nbsp;a&nbsp;new part with hard links to&nbsp;the original data,</p>
</li>
<li>
<p>The second node replicates the new part.</p>
</li>
</ol>
<p>At&nbsp;the same time, the second node knows nothing about the connections between these parts.</p>
<p>If&nbsp;the first node deletes the old part before, the second node at&nbsp;the moment of&nbsp;deletion will decide that it&rsquo;s deleting the last local link to&nbsp;the objects. As&nbsp;a&nbsp;result, it&rsquo;ll get information from the Keeper that no&nbsp;one else uses objects of&nbsp;this part, and thus, it&rsquo;ll delete objects in&nbsp;S3.</p>
<p>As&nbsp;stated above, this bug has already been fixed, and we&nbsp;have been using zero-copy in&nbsp;our solution for a&nbsp;long time.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/сh-over-S3-scheme-5.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/сh-over-S3-scheme-5.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><h2 id="final-thoughts"><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#final-thoughts" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Final thoughts</span></a>Final thoughts</h2>
<p>We&nbsp;also see that that community has started to&nbsp;add other object storage providers like <a href="https://github.com/ClickHouse/ClickHouse/issues/29430" target="_blank">Azure blob storage developed</a> by&nbsp;our friends from Content Square, which once again showed us&nbsp;that we&nbsp;are moving in&nbsp;the right direction.</p>
<p>Small note about the availability of&nbsp;that feature at&nbsp;DoubleCloud. All clusters at&nbsp;DoubleCloud already have S3-based hybrid storage by&nbsp;default; you don&rsquo;t need to&nbsp;provision or&nbsp;set up&nbsp;anything additional. <a href="../../../../../docs/managed-clickhouse/step-by-step/use-hybrid-storage.html" target="_blank">Just create a&nbsp;table</a> with your preferred hybrid storage profile, and you are ready to&nbsp;go.</p>
<p><a href="mailto:viktor@double.cloud" target="_blank">Contact our architects</a> to&nbsp;find out how to&nbsp;apply this approach to&nbsp;your project or&nbsp;even if&nbsp;you are looking for help setting up&nbsp;and using that functionality and want to&nbsp;chat with us.</p>
<p>ClickHouse&reg; is&nbsp;a&nbsp;trademark of&nbsp;ClickHouse, Inc. <a href="https://clickhouse.com/" target="_blank">https://clickhouse.com</a></p></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>In&nbsp;this article, we&rsquo;ll talk about:</p>
<ul>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#conservative-approach">The conservative approach</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#alternate-approach">The alternate approach</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#managing-s3">Managing data in&nbsp;S3</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#limitations">ClickHouse limitations with S3 data operations</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#caching">Caching</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#operations-log-in-hybrid-storage">Operations log in&nbsp;hybrid storage</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#backups">Backups</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#hybrid-storage">Hybrid storage</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#replication">Replication</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#zero-copy-replication">Zero-copy replication</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#zero-copy-imitations-and-issues">Zero-copy limitations and issues</a></li>
<li><a href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#final-thoughts">Final thoughts</a></li>
</ul></div></section></div></div><div class="bc-layout__item"><div class="pc-card-base-block pc-card-base-block_border_shadow pc-background-card pc-background-card_theme_default"><div class="pc-card-base-block__body"><div class="pc-card-base-block__content pc-background-card__content"><div class="pc-storage-background-image pc-background-card__image" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/doublecloud/customer-facing-benefits-6.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/doublecloud/customer-facing-benefits-6.png" class="pc-storage-background-image__img"/></picture></div><div class="col  col-12 col-md-12 col-reset pc-content pc-content_size_s pc-content_theme_default pc-content_control-position_default"><div class="pc-title pc-content__title" id="g-uniq-1226154"><div class="col  col-12 col-reset"><h3 class="pc-title-item pc-title-item_size_s pc-title-item_reset-margin" data-qa="undefined-header"><span class="pc-title-item__text">DoubleCloud Managed Service for ClickHouse&reg;</span></h3></div></div><div class="pc-content__text"><div class="yfm yfm_constructor yfm_constructor_size_s"><p>An&nbsp;open-source, managed ClickHouse DBMS service for sub-second analytics.</p></div></div><div class="pc-buttons pc-buttons_size_s pc-content__buttons pc-content__buttons_size_s"><a aria-describedby="g-uniq-1226154" class="g-button g-button_view_action g-button_size_l g-button_pin_round-round pc-button-block pc-button-block_size_m pc-button-block_theme_action pc-buttons__button" href="../../../../../services/managed-clickhouse.html" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><span class="pc-button-block__text">Learn more</span></span></span></a></div></div></div></div></div></div></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_indentTop_l pc-block-base_indentBottom_l pc-constructor-block pc-constructor-block_type_content-layout-block"><div class="pc-content-layout-block pc-content-layout-block_size_l pc-content-layout-block_theme_default pc-content-layout-block_background"><div class="col  col-12 col-md-8 col-reset pc-content pc-content_size_l pc-content_centered pc-content_theme_default pc-content-layout-block__content"><div class="pc-title pc-content__title" id="g-uniq-1226156"><div class="col  col-12 col-reset"><h2 class="pc-title-item pc-title-item_size_m pc-title-item_reset-margin" data-qa="undefined-header"><span class="pc-title-item__text">Start your trial today</span></h2></div></div><div class="pc-buttons pc-buttons_size_l pc-content__buttons pc-content__buttons_size_l"><a aria-describedby="g-uniq-1226156" class="g-button g-button_view_action g-button_size_xl g-button_pin_round-round pc-button-block pc-button-block_size_xl pc-button-block_theme_accent pc-buttons__button" href="https://auth.double.cloud/s/signup" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><span class="pc-button-block__text">Start free trial</span></span></span></a><a aria-describedby="g-uniq-1226156" class="g-button g-button_view_outlined g-button_size_xl g-button_pin_round-round pc-button-block pc-button-block_size_xl pc-button-block_theme_pseudo pc-buttons__button" href="../how-s3-based-clickhouse-hybrid-storage-works-under-the-hood.html#contact-us-form" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><span class="pc-button-block__text">Contact us</span></span></span></a></div></div><div class="pc-content-layout-block__background"><div class="pc-storage-background-image pc-content-layout-block__background-item" style="background-color:#CA1551" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/doublecloud/doublecloud-cover-5.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/doublecloud/doublecloud-cover-5.png" class="pc-storage-background-image__img" style="background-color:#CA1551"/></picture></div></div></div></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-suggest-block"><section class="bc-wrapper bc-wrapper_padding-top_l bc-wrapper_padding-bottom_l"><div class="pc-SliderBlock"><div class="pc-title pc-SliderBlock__header pc-SliderBlock__header_no-description"><div class="col  col-12 col-sm-8 col-reset"><h2 class="pc-title-item pc-title-item_size_m pc-title-item_reset-margin" data-qa="undefined-header"><span class="pc-title-item__text">See also</span></h2></div></div><div class="pc-SliderBlock__animate-slides"><span style="font-size:0"></span><div><div class="slick-slider pc-slick-origin slick-initialized"><div class="slick-list"><div class="slick-track" style="width:100%;left:0%"><div data-index="0" class="slick-slide slick-active slick-current" tabindex="-1" aria-hidden="false" style="outline:none;width:33.333333333333336%"><div><div class="link" data-link-type="router"><a draggable="false" aria-labelledby="g-uniq-1226157" aria-describedby="g-uniq-1226159 g-uniq-1226161" class="g-link g-link_view_normal pc-card-base-block pc-card-base-block_border_shadow bc-post-card__card" href="../../12/advantages-of-integrating-clickhouse-with-hybrid-s3-storage.html"><div class="pc-storage-background-image pc-card-base-block__header bc-post-card__header" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/blog/articles/advantages-of-integrating-clickhouse-with-hybrid-s3-storage-small-cover.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/blog/articles/advantages-of-integrating-clickhouse-with-hybrid-s3-storage-small-cover.png" class="pc-storage-background-image__img"/></picture><div class="pc-storage-background-image__container"><div class="pc-card-base-block__header-content"><div class="bc-post-card__image-container" data-qa="blog-suggest-header"></div></div></div></div><div class="pc-card-base-block__body"><div class="pc-card-base-block__content"><h3 class="bc-post-card__title bc-post-card__title_size_s"><span><span id="g-uniq-1226157">Advantages of integrating ClickHouse® with Hybrid S3 Storage</span></span></h3></div><div class="pc-card-base-block__footer"><div class="bc-post-info__container"><div class="bc-post-info__suggest-container"><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-1226159">December 26, 2022</div><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-1226161"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>15 mins to read</div></div></div></div></div></a></div></div></div><div data-index="1" class="slick-slide slick-active" tabindex="-1" aria-hidden="false" style="outline:none;width:33.333333333333336%"><div><div class="link" data-link-type="router"><a draggable="false" aria-labelledby="g-uniq-1226162" aria-describedby="g-uniq-1226163 g-uniq-1226164 g-uniq-1226166" class="g-link g-link_view_normal pc-card-base-block pc-card-base-block_border_shadow bc-post-card__card" href="../../../2023/03/machine-learning-with-clickhouse-and-doublecloud.html"><div class="pc-storage-background-image pc-card-base-block__header bc-post-card__header" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/blog/articles/machine-learning-with-clickhouse-and-doublecloud-small-cover.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/blog/articles/machine-learning-with-clickhouse-and-doublecloud-small-cover.png" class="pc-storage-background-image__img"/></picture><div class="pc-storage-background-image__container"><div class="pc-card-base-block__header-content"><div class="bc-post-card__image-container" data-qa="blog-suggest-header"></div></div></div></div><div class="pc-card-base-block__body"><div class="pc-card-base-block__content"><h3 class="bc-post-card__title bc-post-card__title_size_s"><span><span id="g-uniq-1226162">Machine learning with ClickHouse and DoubleCloud</span></span></h3><span class="yfm yfm_blog_card bc-post-card__description" id="g-uniq-1226163">Written by: Adam Jennings, DoubleCloud Solution Architect</span></div><div class="pc-card-base-block__footer"><div class="bc-post-info__container"><div class="bc-post-info__suggest-container"><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-1226164">March 14, 2023</div><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-1226166"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>15 mins to read</div></div></div></div></div></a></div></div></div><div data-index="2" class="slick-slide slick-active" tabindex="-1" aria-hidden="false" style="outline:none;width:33.333333333333336%"><div><div class="link" data-link-type="router"><a draggable="false" aria-labelledby="g-uniq-1226167" aria-describedby="g-uniq-1226168 g-uniq-1226169 g-uniq-1226171" class="g-link g-link_view_normal pc-card-base-block pc-card-base-block_border_shadow bc-post-card__card" href="../../../2023/04/clickhouse-as-storage-engine-for-mysql.html"><div class="pc-storage-background-image pc-card-base-block__header bc-post-card__header" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/blog/articles/clickhouse-as-storage-engine-for-mysql-small-cover.jpg.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/blog/articles/clickhouse-as-storage-engine-for-mysql-small-cover.jpg" class="pc-storage-background-image__img"/></picture><div class="pc-storage-background-image__container"><div class="pc-card-base-block__header-content"><div class="bc-post-card__image-container" data-qa="blog-suggest-header"></div></div></div></div><div class="pc-card-base-block__body"><div class="pc-card-base-block__content"><h3 class="bc-post-card__title bc-post-card__title_size_s"><span><span id="g-uniq-1226167">ClickHouse as storage engine for MySQL? An experimental approach</span></span></h3><span class="yfm yfm_blog_card bc-post-card__description" id="g-uniq-1226168">Written By: Stefan Kaeser, DoubleCloud Senior Solution Architect</span></div><div class="pc-card-base-block__footer"><div class="bc-post-info__container"><div class="bc-post-info__suggest-container"><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-1226169">April 24, 2023</div><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-1226171"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>10 mins to read</div></div></div></div></div></a></div></div></div></div></div></div><div class="pc-SliderBlock__footer"></div></div></div></div></section></div></div></div></div></div></main></div></div></div><div class="bc-prompt bc-prompt_close"><div class="bc-prompt__content"><span class="bc-prompt__text">Sign in to save this post</span><div class="bc-prompt__actions"><button class="g-button g-button_view_action g-button_size_l g-button_pin_round-round bc-prompt__action" type="button"><span class="g-button__text">Sign In</span></button></div></div></div></div><footer class="footer"><div class="pc-Grid"><div class="container-fluid "><div class="row"><div class="col  col-12 col-md-4 footer__column"><div class="link" data-link-type="router"><div class="logo footer__logo"><img alt="Logo Icon" src="../../../../../assets/logo/dc-logo-dark.svg" width="178" height="36" decoding="async" data-nimg="future" class="logo__icon" loading="lazy" style="color:transparent"/><span class="logo__text"></span></div></div><div class="pc-Grid subscription-form-block"><div class="container-fluid "><div class="row subscription-form-block__container"><div class="col  col-12"><span class="subscription-form-block__header">Subscribe to our newsletter</span></div><div class="col  col-12"><div class="pc-hubspot-form pc-hubspot-form_theme_light" id="hubspot-form-b9015518-c7ea-4173-a96b-a251994635e3"></div></div><div class="col  col-12"><span class="subscription-form-block__footer">By submitting this form, you agree to our <a href="../../../../../legal/privacy.html">Privacy policy</a></span></div></div></div></div></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Products</div><a aria-label="Managed Service for ClickHouse®" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/managed-clickhouse.html"><div class="navigation-item"><span class="navigation-item__text">Managed Service for ClickHouse®</span></div></a><a aria-label="Managed Service for Apache Kafka®" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/managed-kafka.html"><div class="navigation-item"><span class="navigation-item__text">Managed Service for Apache Kafka®</span></div></a><a aria-label="Managed Service for Apache Airflow®" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/managed-airflow/index.html"><div class="navigation-item"><span class="navigation-item__text">Managed Service for Apache Airflow®</span></div></a><a aria-label="Data Transfer" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/doublecloud-transfer.html"><div class="navigation-item"><span class="navigation-item__text">Data Transfer</span></div></a><a aria-label="Data Visualization" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/doublecloud-visualization.html"><div class="navigation-item"><span class="navigation-item__text">Data Visualization</span></div></a></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Solutions</div><a aria-label="Case studies" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../resources/case-studies/index.html"><div class="navigation-item"><span class="navigation-item__text">Case studies</span></div></a><a aria-label="Customer-facing analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../customer-facing-analytics/index.html"><div class="navigation-item"><span class="navigation-item__text">Customer-facing analytics</span></div></a><a aria-label="Real-time analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/real-time-analytics/index.html"><div class="navigation-item"><span class="navigation-item__text">Real-time analytics</span></div></a><a aria-label="Observability and monitoring" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/observability-and-monitoring/index.html"><div class="navigation-item"><span class="navigation-item__text">Observability and monitoring</span></div></a><a aria-label="AdTech and MarTech data analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/adtech.html"><div class="navigation-item"><span class="navigation-item__text">AdTech and MarTech data analytics</span></div></a><a aria-label="Analytics for mobile and gaming Apps" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/web-mobile-gaming-apps.html"><div class="navigation-item"><span class="navigation-item__text">Analytics for mobile and gaming Apps</span></div></a><a aria-label="EdTech data analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/edtech/index.html"><div class="navigation-item"><span class="navigation-item__text">EdTech data analytics</span></div></a><a aria-label="FinTech data analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/fintech-real-time-analytics/index.html"><div class="navigation-item"><span class="navigation-item__text">FinTech data analytics</span></div></a></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Resources</div><a aria-label="Documentation" class="navigation-item navigation-item_type_link footer__column-link" href="../../../../../docs/index.html"><div class="navigation-item"><span class="navigation-item__text">Documentation</span></div></a><a aria-label="Webinars" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../webinars/index.html"><div class="navigation-item"><span class="navigation-item__text">Webinars</span></div></a><a aria-label="Blog" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../index.html"><div class="navigation-item navigation-item_selected"><span class="navigation-item__text">Blog</span></div></a><a href="https://join.slack.com/t/double-cloud/shared_invite/zt-1pbz9lfte-5GoIX~8CmVYqmVQfRFPNdA" aria-label="Slack" class="navigation-item navigation-item_type_link footer__column-link" target="_blank" rel="noopener noreferrer"><div class="navigation-item"><span class="navigation-item__text">Slack</span></div></a><a aria-label="Support" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../support/index.html"><div class="navigation-item"><span class="navigation-item__text">Support</span></div></a><a href="https://status.double.cloud/" aria-label="Status updates" class="navigation-item navigation-item_type_link footer__column-link" target="_blank" rel="noopener noreferrer"><div class="navigation-item"><span class="navigation-item__text">Status updates</span></div></a><a aria-label="Product comparisons" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../comparison/index.html"><div class="navigation-item"><span class="navigation-item__text">Product comparisons</span></div></a><a aria-label="Site map" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../sitemap/index.html"><div class="navigation-item"><span class="navigation-item__text">Site map</span></div></a></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Company</div><a aria-label="About DoubleCloud" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../company/about-us.html"><div class="navigation-item"><span class="navigation-item__text">About DoubleCloud</span></div></a><a aria-label="Careers" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../company/careers.html"><div class="navigation-item"><span class="navigation-item__text">Careers</span></div></a><a aria-label="AWS Partnership" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../aws-partnership/index.html"><div class="navigation-item"><span class="navigation-item__text">AWS Partnership</span></div></a><a aria-label="Contact us" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../company/contact-us.html"><div class="navigation-item"><span class="navigation-item__text">Contact us</span></div></a></div></div><div class="row"><div class="col  col-12 footer__underline"><div class="footer__underline-links"><a href="../../../../../legal/customer_agreement/index.html" aria-label="Customer Agreement" class="navigation-item navigation-item_type_link footer__underline-link" target="_blank"><div class="navigation-item"><span class="navigation-item__text">Customer Agreement</span></div></a><a href="../../../../../legal/privacy.html" aria-label="Privacy Policy" class="navigation-item navigation-item_type_link footer__underline-link" target="_blank"><div class="navigation-item"><span class="navigation-item__text">Privacy Policy</span></div></a><a aria-label="Pricing" class="navigation-item navigation-item_type_link footer__underline-link" data-link-type="router" href="../../../../../pricing.html"><div class="navigation-item"><span class="navigation-item__text">Pricing</span></div></a><a href="../../../../../security.html" aria-label="Security" class="navigation-item navigation-item_type_link footer__underline-link" target="_blank"><div class="navigation-item"><span class="navigation-item__text">Security</span></div></a></div><div class="footer__underline-copyright">© 2024 DoubleCloud</div></div></div></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json" nonce="RRAgWORhqEZHg/MBRMnoKg==">{"props":{"pageProps":{"data":{"status":"fulfilled","pageContent":{"page":{"id":31,"name":"blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood","createdAt":"2024-08-21T09:49:42.388Z","updatedAt":"2024-08-21T09:49:42.388Z","type":"default","isDeleted":false,"versionOnTranslationId":null,"pageId":31,"locale":"en","publishedVersionId":2203,"lastVersionId":2203,"content":{"blocks":[{"type":"blog-header-block","resetPaddings":true,"paddingBottom":"l","width":"m","verticalOffset":"l","background":{"image":{"src":"/assets/blog/articles/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-cover.png.webp","fetchPriority":"high"},"color":"#000000","fullWidth":false}},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"right","resetPaddings":true,"text":"\u003cp\u003eIn\u0026nbsp;this article, we\u0026rsquo;ll talk about:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#conservative-approach\"\u003eThe conservative approach\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#alternate-approach\"\u003eThe alternate approach\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#managing-s3\"\u003eManaging data in\u0026nbsp;S3\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#limitations\"\u003eClickHouse limitations with S3 data operations\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#caching\"\u003eCaching\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#operations-log-in-hybrid-storage\"\u003eOperations log in\u0026nbsp;hybrid storage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#backups\"\u003eBackups\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#hybrid-storage\"\u003eHybrid storage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#replication\"\u003eReplication\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#zero-copy-replication\"\u003eZero-copy replication\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#zero-copy-imitations-and-issues\"\u003eZero-copy limitations and issues\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#final-thoughts\"\u003eFinal thoughts\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"},{"type":"background-card","column":"right","background":{"src":"/assets/doublecloud/customer-facing-benefits-6.png"},"title":"DoubleCloud Managed Service for ClickHouse\u0026reg;","text":"\u003cp\u003eAn\u0026nbsp;open-source, managed ClickHouse DBMS service for sub-second analytics.\u003c/p\u003e","buttons":[{"text":"Learn more","theme":"action","url":"/services/managed-clickhouse/"}]},{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003e\u003cem\u003eWritten by\u0026nbsp;Anton Ivashkin, DoubleCloud Dev lead for ClickHouse service.\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eEveryone knows that ClickHouse is\u0026nbsp;extremely fast at\u0026nbsp;processing a\u0026nbsp;lot of\u0026nbsp;data. A\u0026nbsp;dataset may reach tens/hundreds of\u0026nbsp;terabytes or\u0026nbsp;even a\u0026nbsp;hundred petabytes. Of\u0026nbsp;course, this data needs to\u0026nbsp;be\u0026nbsp;stored somewhere with the following core requirements: cost-efficiency, high speed, accessibility, security, and reliability. S3 or\u0026nbsp;object storage is\u0026nbsp;a\u0026nbsp;perfect match, but the only critical point it\u0026nbsp;lacks is\u0026nbsp;speed. Therefore, we\u0026nbsp;built a\u0026nbsp;hybrid approach where you can fuse the speed of\u0026nbsp;SSD disks and the affordability of\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eOur team at\u0026nbsp;DoubleCloud started developing the S3 hybrid storage feature a\u0026nbsp;year ago, and it\u0026nbsp;was successfully merged in\u0026nbsp;version 22.3 on\u0026nbsp;April 18, 2022\u0026nbsp;with further fixes and optimizations in\u0026nbsp;the version 22.8. It\u0026nbsp;was widely accepted by\u0026nbsp;the community and Clickhouse team primarily because compute is\u0026nbsp;now decoupled from the storage. We\u0026nbsp;see a\u0026nbsp;reduction from 3-5 times in\u0026nbsp;storage cost in\u0026nbsp;those scenarios where hybrid storage is\u0026nbsp;applicable, and that\u0026rsquo;s a\u0026nbsp;real game changer for scenarios like logs, metrics, traces, or\u0026nbsp;other data scenarios where users primarily work with fresh data and the rest is\u0026nbsp;stored for rare cases.\u003c/p\u003e\n\u003cp\u003eBelow I\u0026nbsp;will describe how it\u0026rsquo;s working under the hood and on\u0026nbsp;what principles it\u0026rsquo;s based.\u003c/p\u003e\n\u003ch2 id=\"conservative-approach\"\u003e\u003ca href=\"#conservative-approach\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eThe conservative approach\u003c/span\u003e\u003c/a\u003eThe conservative approach\u003c/h2\u003e\n\u003cp\u003eThe classical approach is\u0026nbsp;to\u0026nbsp;use a\u0026nbsp;sharded ClickHouse cluster. Let\u0026rsquo;s say the data is\u0026nbsp;100\u0026nbsp;TB, and there is\u0026nbsp;10\u0026nbsp;TB\u0026nbsp;of\u0026nbsp;storage space available on\u0026nbsp;each\u0026nbsp;VM. Then a\u0026nbsp;perfect partitioning would require ten shards, with two replicated nodes per shard. This requirement adds up\u0026nbsp;to\u0026nbsp;20\u0026nbsp;machines. However, it\u0026rsquo;s only sometimes the case that the data gets evenly split, so\u0026nbsp;you can safely multiply that number by\u0026nbsp;one and a\u0026nbsp;half.\u003c/p\u003e\n\u003cp\u003ePlus, ClickHouse works sub-optimally when the storage has no\u0026nbsp;free space. With read-only data, which is\u0026nbsp;completely frozen, you can still manage, but if\u0026nbsp;the new data flows in\u0026nbsp;regularly, you must have at\u0026nbsp;least 10\u0026nbsp;percent more free space for it\u0026nbsp;to\u0026nbsp;work correctly.\u003c/p\u003e\n\u003cp\u003eNow we\u0026nbsp;face the need to\u0026nbsp;run 30+ machines, which is\u0026nbsp;quite significant. In\u0026nbsp;this case, most VMs will use only disk space, and the CPU and RAM will be\u0026nbsp;almost idle.\u003c/p\u003e\n\u003cp\u003eOf\u0026nbsp;course, there are situations when there is\u0026nbsp;a\u0026nbsp;large flow of\u0026nbsp;requests, and other resources will get their share of\u0026nbsp;the load, but according to\u0026nbsp;our data on\u0026nbsp;clusters with 10+ shards, they tend to\u0026nbsp;be\u0026nbsp;indefinitely idle.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"image":"/assets/blog/articles/сh-over-S3-scheme-1.png","fullWidth":false},{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003ch2 id=\"alternate-approach\"\u003e\u003ca href=\"#alternate-approach\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eThe alternate approach\u003c/span\u003e\u003c/a\u003eThe alternate approach\u003c/h2\u003e\n\u003cp\u003eClickHouse can use S3-compatible storage. The advantages of\u0026nbsp;this approach are the following:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eAlmost unlimited capacity,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSignificantly lower cost than dedicated VMs with the same amount of\u0026nbsp;disk space.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe main disadvantage is\u0026nbsp;that S3-compatible storage is\u0026nbsp;a\u0026nbsp;network resource, so\u0026nbsp;the speed of\u0026nbsp;access to\u0026nbsp;data, as\u0026nbsp;a\u0026nbsp;consequence, increases the time of\u0026nbsp;operations.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"image":"/assets/blog/articles/сh-over-S3-scheme-2.png","fullWidth":false},{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eLet\u0026rsquo;s see how it\u0026nbsp;works. An\u0026nbsp;IDisk interface provides methods for basic file operations such as\u0026nbsp;create, copy, rename, delete, etc. The ClickHouse engine works with that interface. Most of\u0026nbsp;the time, it\u0026nbsp;doesn\u0026rsquo;t matter what\u0026rsquo;s under the hood. There are implementations for specific storage methods:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003elocal disk (\u003ccode\u003eDiskLocal\u003c/code\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ein-memory storage (\u003ccode\u003eDiskMemory\u003c/code\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ecloud storage (\u003ccode\u003eDiskObjectStorage\u003c/code\u003e).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe latter implements logic for storing data in\u0026nbsp;different types of\u0026nbsp;storage, notably in\u0026nbsp;S3.\u003cbr /\u003e\nThe other storages are HDFS and MS\u0026nbsp;Azure. They\u0026rsquo;re similar conceptually, but for now let\u0026rsquo;s focus on\u0026nbsp;S3.\u003c/p\u003e\n\u003ch3 id=\"managing-s3\"\u003e\u003ca href=\"#managing-s3\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eManaging data in\u0026nbsp;S3\u003c/span\u003e\u003c/a\u003eManaging data in\u0026nbsp;S3\u003c/h3\u003e\n\u003cp\u003eWhen the engine wants to\u0026nbsp;\u0026ldquo;create a\u0026nbsp;file\u0026rdquo; on\u0026nbsp;an\u0026nbsp;S3 disk, it\u0026nbsp;creates an\u0026nbsp;object in\u0026nbsp;S3 with a\u0026nbsp;random name, writes a\u0026nbsp;data stream to\u0026nbsp;it\u0026nbsp;and creates a\u0026nbsp;metadata file on\u0026nbsp;the local disk with the name, size and some other information. The size of\u0026nbsp;such a\u0026nbsp;local metadata file is\u0026nbsp;tens of\u0026nbsp;bytes.\u003c/p\u003e\n\u003cp\u003eThen operations such as\u0026nbsp;renaming and creating hard links are performed only on\u0026nbsp;the local metadata file, while the object on\u0026nbsp;S3 remains untouched.\u003c/p\u003e\n\u003cp\u003eS3 doesn\u0026rsquo;t provide a\u0026nbsp;straightforward way to\u0026nbsp;modify created S3 objects. For example, the renaming operation is\u0026nbsp;a\u0026nbsp;load-intensive procedure to\u0026nbsp;create a\u0026nbsp;new object. The above scheme with a\u0026nbsp;small local metadata file allows you to\u0026nbsp;bypass this limitation.\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3 ls s3:\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003edouble\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ecloud\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003estorage\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003ecloud_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es1\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e bpmwovnptyvtbxrxpaixgnjhgsjfekwd\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e enmwkqfptmghyxzxhiczjgpkhzsvexgi\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e mjgumajoilbkcpnvlbbglgajrkvqbpea\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e aoazgzkryvhceolzichwyprzsmjotkw\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e xiyltehvfxbkqbnytyjwbsmyafgjscwg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e235\u003c/span\u003e ickdlneqkzcrgpeokcubmkwtyyayukmg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e65\u003c/span\u003e lyggepidqbgyxqwzsfoxltxpbfbehrqy\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e60\u003c/span\u003e ytfhoupmfahdakydbfumxxkqgloakanh\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e tddzrmzildnwtmvescmbkhqzhoxwoqmq\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"35\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-35\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-35\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-35.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# ls \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003el \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003evar\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003elib\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eclickhouse\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003edisks\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eobject_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003estore\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e133\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e13344\u003c/span\u003eeec\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ed80a\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003ea5b\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eb99d\u003cspan class=\"hljs-number\"\u003e-6177\u003c/span\u003ef144e62a\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e_0_0_0\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\ntotal \u003cspan class=\"hljs-number\"\u003e36\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 120 Nov 21 12:32 checksums.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 columns.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 count.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 data.bin\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 data.mrk3\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 default_compression_codec.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 minmax_key.idx\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 partition.dat\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 primary.idx\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"36\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-36\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-36\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-36.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# cat \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003evar\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003elib\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eclickhouse\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003edisks\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eobject_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003estore\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e133\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e13344\u003c/span\u003eeec\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ed80a\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003ea5b\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eb99d\u003cspan class=\"hljs-number\"\u003e-6177\u003c/span\u003ef144e62a\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e_0_0_0\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003edata.mrk3\n\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e                                       # [metadata file format version]\n\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e                                 # [objects count] [total size]\n\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e    enmwkqfptmghyxzxhiczjgpkhzsvexgi  # [object size] [object name]\n\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e                                       # [reference count]\n\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e                                       # [readonly flag]\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"37\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-37\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-37\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-37.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eA\u0026nbsp;separate operation is\u0026nbsp;adding data to\u0026nbsp;the file. As\u0026nbsp;mentioned earlier, S3 doesn\u0026rsquo;t allow changing objects after creation, so\u0026nbsp;we\u0026nbsp;create another object to\u0026nbsp;which a\u0026nbsp;new portion of\u0026nbsp;data is\u0026nbsp;added. The name of\u0026nbsp;this object is\u0026nbsp;written in\u0026nbsp;the metadata file mentioned earlier, and it\u0026nbsp;starts referring to\u0026nbsp;multiple objects.\u003c/p\u003e\n\u003cp\u003ePlease note that such operation in\u0026nbsp;ClickHouse is\u0026nbsp;performed only for \u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/log-family/\" target=\"_blank\"\u003eLog family engines\u003c/a\u003e, which almost nobody uses. In\u0026nbsp;the popular \u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003eMergeTree engine\u003c/a\u003e, the file is\u0026nbsp;created once and is\u0026nbsp;never modified again.\u003c/p\u003e\n\u003cp\u003eFor some operations, such as\u0026nbsp;mutation, the engine creates a\u0026nbsp;new part with a\u0026nbsp;new structure when adding a\u0026nbsp;new column. However, as\u0026nbsp;some data doesn\u0026rsquo;t change, we\u0026nbsp;use the operation to\u0026nbsp;create hard links to\u0026nbsp;the old ones instead of\u0026nbsp;copying them. Only the local metadata file is\u0026nbsp;linked, where, among other things, we\u0026nbsp;store the link counter, which increases with this operation.\u003c/p\u003e\n\u003ch4 id=\"limitations\"\u003e\u003ca href=\"#limitations\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eClickHouse limitations with S3 data operations\u003c/span\u003e\u003c/a\u003eClickHouse limitations with S3 data operations\u003c/h4\u003e\n\u003cp\u003eWhen you perform the deletion, the engine decrements the link count and deletes the local metadata file, and if\u0026nbsp;this is\u0026nbsp;the last hard link to\u0026nbsp;the deleted file, it\u0026nbsp;possibly removes the object in\u0026nbsp;S3. We\u0026rsquo;ll get back to\u0026nbsp;why it\u0026rsquo;s possible when discussing replication.\u003c/p\u003e\n\u003cp\u003eClickHouse doesn\u0026rsquo;t use such manipulations as\u0026nbsp;data replacement in\u0026nbsp;the middle of\u0026nbsp;the file. Thus, it\u0026nbsp;wasn\u0026rsquo;t implemented.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s elaborate on\u0026nbsp;two more points.\u003c/p\u003e\n\u003cp\u003eThe first one is\u0026nbsp;that the object\u0026rsquo;s name in\u0026nbsp;S3 is\u0026nbsp;random. It\u0026rsquo;s pretty inconvenient because it\u0026nbsp;isn\u0026rsquo;t clear from the object itself what it\u0026nbsp;is. Below we\u0026rsquo;ll talk about the operations log, it\u0026rsquo;s a\u0026nbsp;mechanism that allows us\u0026nbsp;to\u0026nbsp;streamline things somewhat, but it\u0026rsquo;s not perfect either.\u003c/p\u003e\n\u003cp\u003eThe second point is\u0026nbsp;that storing the count of\u0026nbsp;hard links in\u0026nbsp;the metadata file seems unnecessary since we\u0026nbsp;can obtain it\u0026nbsp;from the file system. But in\u0026nbsp;the case of\u0026nbsp;manual manipulation of\u0026nbsp;local files past ClickHouse, the link could get broken. In\u0026nbsp;this case, both copies would have an\u0026nbsp;increased counter, which wouldn\u0026rsquo;t allow the object to\u0026nbsp;be\u0026nbsp;deleted in\u0026nbsp;S3 when one of\u0026nbsp;the copies is\u0026nbsp;deleted. Deleting the second one won\u0026rsquo;t delete it\u0026nbsp;either, but it\u0026rsquo;s better to\u0026nbsp;leave the garbage on\u0026nbsp;S3 than lose the needed data.\u003c/p\u003e\n\u003cp\u003eWhen a\u0026nbsp;local metadata file is\u0026nbsp;read, it\u0026nbsp;learns the name of\u0026nbsp;the object or\u0026nbsp;objects in\u0026nbsp;S3, and S3 requests the desired portion of\u0026nbsp;data. It\u0026nbsp;helps that S3 allows you to\u0026nbsp;download a\u0026nbsp;fragment of\u0026nbsp;an\u0026nbsp;object by\u0026nbsp;offset and size.\u003c/p\u003e\n\u003ch4 id=\"сaching\"\u003e\u003ca href=\"#сaching\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eCaching\u003c/span\u003e\u003c/a\u003eCaching\u003c/h4\u003e\n\u003cp\u003eIn\u0026nbsp;the \u003ca href=\"https://clickhouse.com/docs/en/whats-new/changelog/\" target=\"_blank\"\u003elatest ClickHouse versions\u003c/a\u003e, we\u0026nbsp;can cache data downloaded from object storage. We\u0026nbsp;can add data into the cache while writing with a\u0026nbsp;separate option. It\u0026nbsp;can speed up\u0026nbsp;requests execution when different requests access the same data. Within one request, repeated reading of\u0026nbsp;the same data doesn\u0026rsquo;t occur. This functionality is\u0026nbsp;built into the engine. However, the cache size is\u0026nbsp;limited, so\u0026nbsp;the best choice depends on\u0026nbsp;your case.\u003c/p\u003e\n\u003ch4 id=\"operations-log-in-hybrid-storage\"\u003e\u003ca href=\"#operations-log-in-hybrid-storage\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eOperations log in\u0026nbsp;hybrid storage\u003c/span\u003e\u003c/a\u003eOperations log in\u0026nbsp;hybrid storage\u003c/h4\u003e\n\u003cp\u003eThere is\u0026nbsp;a\u0026nbsp;default \u003ccode\u003esend_metadata\u003c/code\u003e setting, which is\u0026nbsp;disabled by\u0026nbsp;default. ClickHouse keeps a\u0026nbsp;counter of\u0026nbsp;operations, which increments with each operation of\u0026nbsp;file creation, renaming and hard link creation.\u003c/p\u003e\n\u003cp\u003eWhen creating, the operation number is\u0026nbsp;added to\u0026nbsp;the object name in\u0026nbsp;binary form, and S3 metadata (not to\u0026nbsp;be\u0026nbsp;confused with the local metadata file, we\u0026nbsp;have a\u0026nbsp;certain deficit in\u0026nbsp;terminology here) is\u0026nbsp;added to\u0026nbsp;the object, in\u0026nbsp;which the original file name is\u0026nbsp;written.\u003c/p\u003e\n\u003cp\u003eWhen renaming and hard linking, a\u0026nbsp;special small object is\u0026nbsp;created in\u0026nbsp;S3, whose name also contains the operation number and whose S3 metadata records from which local name to\u0026nbsp;which a\u0026nbsp;hard link was renamed or\u0026nbsp;created.\u003c/p\u003e\n\u003cp\u003eWhen performing the deletion, the operation counter isn\u0026rsquo;t incremented after the object is\u0026nbsp;deleted. It\u0026nbsp;allows you to\u0026nbsp;restore local metadata\u0026nbsp;\u0026mdash; S3 queries the complete list of\u0026nbsp;objects containing data. It\u0026nbsp;enables you to\u0026nbsp;recover the original name using the S3 metadata, then rename and hard link operations are applied to\u0026nbsp;the existing files. It\u0026rsquo;s triggered by\u0026nbsp;creating a\u0026nbsp;special file before the disk starts.\u003c/p\u003e\n\u003cp\u003eThis mechanism allows to\u0026nbsp;perform not all operations but only up\u0026nbsp;to\u0026nbsp;some revision, which can be\u0026nbsp;used for backups.\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3 ls s3:\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003edouble\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ecloud\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003estorage\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003ecloud_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es1\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n             PRE operations\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e .SCHEMA_VERSION\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000001\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ebpmwovnptyvtbxrxpaixgnjhgsjfekwd\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000010\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eenmwkqfptmghyxzxhiczjgpkhzsvexgi\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000011\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003emjgumajoilbkcpnvlbbglgajrkvqbpea\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000100\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaaoazgzkryvhceolzichwyprzsmjotkw\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000101\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003exiyltehvfxbkqbnytyjwbsmyafgjscwg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e235\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000110\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eickdlneqkzcrgpeokcubmkwtyyayukmg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e65\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000111\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003elyggepidqbgyxqwzsfoxltxpbfbehrqy\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e60\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000001000\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eytfhoupmfahdakydbfumxxkqgloakanh\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000001001\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003etddzrmzildnwtmvescmbkhqzhoxwoqmq\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"92\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-92\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-92\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-92.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3api head\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eobject \u003cspan class=\"hljs-comment\"\u003e--bucket double-cloud-storage-chc8d6h0ehe98li0k4sn --key cloud_storage/chc8d6h0ehe98li0k4sn/s1/r0000000000000000000000000000000000000000000000000000000000000010-file-enmwkqfptmghyxzxhiczjgpkhzsvexgi\u003c/span\u003e\n{\n  \"AcceptRanges\": \"bytes\",\n  \"LastModified\": \"Mon, 21 Nov 2022 12:32:58 GMT\",\n  \"ContentLength\": \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e,\n  \"ETag\": \"\\\"fbc2bf6ed653c03001977f21a1416ace\\\"\",\n  \"ContentType\": \"binary/octet-stream\",\n  \"Metadata\": {\n      \"path\": \"store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/moving/2_0_0_0/data.mrk3\"\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"93\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-93\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-93\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-93.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3 ls s3:\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003edouble\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ecloud\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003estorage\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003ecloud_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es1\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eoperations\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e33\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e02\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000001\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003each\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eeuc1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaz1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003es1\u003cspan class=\"hljs-number\"\u003e-1.\u003c/span\u003echc8d6h0ehe98li0k4sn.at.yadc.io\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erename\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e33\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e02\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000010\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003each\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eeuc1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaz1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003es1\u003cspan class=\"hljs-number\"\u003e-1.\u003c/span\u003echc8d6h0ehe98li0k4sn.at.yadc.io\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erename\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000001010\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003each\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eeuc1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaz1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003es1\u003cspan class=\"hljs-number\"\u003e-1.\u003c/span\u003echc8d6h0ehe98li0k4sn.at.yadc.io\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erename\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"94\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-94\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-94\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-94.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3api head\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eobject \u003cspan class=\"hljs-comment\"\u003e--bucket double-cloud-storage-chc8d6h0ehe98li0k4sn --key cloud_storage/chc8d6h0ehe98li0k4sn/s1/operations/r0000000000000000000000000000000000000000000000000000000000001010-ach-euc1-az1-s1-1.chc8d6h0ehe98li0k4sn.at.yadc.io-rename\u003c/span\u003e\n{\n  \"AcceptRanges\": \"bytes\",\n  \"LastModified\": \"Mon, 21 Nov 2022 12:32:59 GMT\",\n  \"ContentLength\": \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\n  \"ETag\": \"\\\"cfcd208495d565ef66e7dff9f98764da\\\"\",\n  \"ContentType\": \"binary/octet-stream\",\n  \"Metadata\": {\n      \"to_path\": \"store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/2_0_0_0/\",\n      \"from_path\": \"store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/moving/2_0_0_0\"\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"95\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-95\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-95\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-95.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003ch4 id=\"backups\"\u003e\u003ca href=\"#backups\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eBackups\u003c/span\u003e\u003c/a\u003eBackups\u003c/h4\u003e\n\u003cp\u003eOn\u0026nbsp;a\u0026nbsp;live VM\u0026nbsp;and with data on\u0026nbsp;local disks, backups are made by\u0026nbsp;calling \u003ccode\u003eFREEZE TABLE\u003c/code\u003e for each table. This command creates a\u0026nbsp;snapshot of\u0026nbsp;the tables (hard links to\u0026nbsp;all files) in\u0026nbsp;a\u0026nbsp;separate directory so\u0026nbsp;that they can be\u0026nbsp;copied somewhere for the future, then delete the directories manually or\u0026nbsp;via \u003ccode\u003eTABLE UNFREEZE\u003c/code\u003e. It\u0026nbsp;allows you to\u0026nbsp;keep the tables in\u0026nbsp;a\u0026nbsp;consistent (but not atomic) condition.\u003c/p\u003e\n\u003cp\u003eThis option isn\u0026rsquo;t suitable for S3 because only local metadata can be\u0026nbsp;copied this\u0026nbsp;way. Objects in\u0026nbsp;S3 have to\u0026nbsp;be\u0026nbsp;extracted separately.\u003c/p\u003e\n\u003cp\u003eWe\u0026nbsp;use a\u0026nbsp;way that isn\u0026rsquo;t a\u0026nbsp;backup for S3 per se\u0026nbsp;but a\u0026nbsp;snapshot:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eExecute \u003ccode\u003eTABLE FREEZE\u003c/code\u003e,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSave the revision number,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDelete the directory with frozen data once the backup is\u0026nbsp;no\u0026nbsp;longer relevant.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe presence of\u0026nbsp;these hard links prevents ClickHouse from deleting objects in\u0026nbsp;S3. When restoring from the operation log, we\u0026nbsp;restore the state for the desired revision.\u003c/p\u003e\n\u003cp\u003eWhen a\u0026nbsp;backup becomes obsolete, delete the frozen metadata via \u003ccode\u003eUNFREEZE\u003c/code\u003e to\u0026nbsp;correctly delete unnecessary objects in\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eAt\u0026nbsp;the same time, since some tables from the backup may already be\u0026nbsp;deleted in\u0026nbsp;the working version and \u003ccode\u003eTABLE UNFREEZE\u003c/code\u003e cannot be\u0026nbsp;done for them, run the \u003ccode\u003eSYSTEM UNFREEZE\u003c/code\u003e command. It\u0026nbsp;removes all the frozen data from all the tables by\u0026nbsp;backup name and can work with tables that don\u0026rsquo;t exist\u0026nbsp;now. Please note that this mechanism can take a\u0026nbsp;long time to\u0026nbsp;execute if\u0026nbsp;you have a\u0026nbsp;big log of\u0026nbsp;operations. At\u0026nbsp;the moment, an\u0026nbsp;alternative system for creating backups is\u0026nbsp;in\u0026nbsp;development.\u003c/p\u003e\n\u003cp\u003eThe above method isn\u0026rsquo;t a\u0026nbsp;classic backup, the data is\u0026nbsp;in\u0026nbsp;a\u0026nbsp;single object in\u0026nbsp;S3, and its safety relies on\u0026nbsp;the high reliability of\u0026nbsp;cloud storage. For example, in\u0026nbsp;case of\u0026nbsp;a\u0026nbsp;logical error or\u0026nbsp;unauthorized access, you\u0026rsquo;ll lose the data when an\u0026nbsp;object is\u0026nbsp;deleted.\u003c/p\u003e\n\u003cp\u003eWorking with just S3 storage has a\u0026nbsp;disadvantage\u0026nbsp;\u0026mdash; the \u003ccode\u003eMerge\u003c/code\u003e operation. It\u0026nbsp;downloads all the partitions ClickHouse wants to\u0026nbsp;merge and uploads a\u0026nbsp;new higher-level part. If\u0026nbsp;the workflow is\u0026nbsp;not organized correctly, adding new data to\u0026nbsp;already merged large chunks, can generate unexpectedly heavy traffic compared to\u0026nbsp;the data being added.\u003c/p\u003e\n\u003cp\u003eFor example, if\u0026nbsp;S3 has a\u0026nbsp;1\u0026nbsp;Gb\u0026nbsp;partition, and 1\u0026nbsp;kb\u0026nbsp;of\u0026nbsp;new data is\u0026nbsp;added, ClickHouse will download this 1\u0026nbsp;Gb, measure the partitions and upload a\u0026nbsp;new part to\u0026nbsp;S3. As\u0026nbsp;a\u0026nbsp;result, adding a\u0026nbsp;small chunk of\u0026nbsp;data causes significantly more traffic.\u003c/p\u003e\n\u003cp\u003eOne possible solution is\u0026nbsp;to\u0026nbsp;prohibit merges on\u0026nbsp;the S3 disk (\u003ca href=\"https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003eprefer_not_to_merge\u003c/a\u003e setting), but this will cause another problem\u0026nbsp;\u0026mdash; a\u0026nbsp;large number of\u0026nbsp;small parts, which can significantly (sometimes catastrophically) reduce performance for \u003ccode\u003eSELECT\u003c/code\u003e queries. So, in\u0026nbsp;a\u0026nbsp;normal situation, it\u0026rsquo;s better not to\u0026nbsp;use prefer_not_to_merge\u0026nbsp;\u0026mdash; this is\u0026nbsp;a\u0026nbsp;mechanism for serious breakdowns that can lead to\u0026nbsp;fairly negative consequences. In\u0026nbsp;a\u0026nbsp;situation where the data arrives more or\u0026nbsp;less consistently, there will be\u0026nbsp;no\u0026nbsp;network load problems.\u003c/p\u003e\n\u003ch3 id=\"hybrid-storage\"\u003e\u003ca href=\"#hybrid-storage\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eHybrid storage\u003c/span\u003e\u003c/a\u003eHybrid storage\u003c/h3\u003e\n\u003cp\u003eA\u0026nbsp;better solution is\u0026nbsp;hybrid storage. Hybrid storage uses a\u0026nbsp;pair of\u0026nbsp;disks, local and S3. New data is\u0026nbsp;stored on\u0026nbsp;the local disk, gets merged into large parts, and then these parts, which aren\u0026rsquo;t expected to\u0026nbsp;merge further, are sent to\u0026nbsp;S3. In\u0026nbsp;this case, the access speed to\u0026nbsp;local data will be\u0026nbsp;higher, and this approach, in\u0026nbsp;most cases, combines the performance of\u0026nbsp;local disks and the volume of\u0026nbsp;cloud storage. You can configure the move:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eBy\u0026nbsp;data age (\u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003eTTL MOVE TO\u0026nbsp;\u0026hellip;\u003c/a\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eBy\u0026nbsp;the amount of\u0026nbsp;free space on\u0026nbsp;the local disk (\u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003emove_factor\u003c/a\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eMove the data yourself (\u003ca href=\"https://clickhouse.com/docs/en/sql-reference/statements/alter/partition/\" target=\"_blank\"\u003eALTER TABLE MOVE PARTITION\u003c/a\u003e).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSetting up\u0026nbsp;a\u0026nbsp;move by\u0026nbsp;time should be\u0026nbsp;chosen to\u0026nbsp;consider the uniformity of\u0026nbsp;data flow so\u0026nbsp;that the principal amount of\u0026nbsp;merges occur while the data is\u0026nbsp;still on\u0026nbsp;the local drive. Another thing to\u0026nbsp;consider is\u0026nbsp;the need to\u0026nbsp;read data: reading from the local drive will usually be\u0026nbsp;much faster. Thus, it\u0026nbsp;makes sense to\u0026nbsp;transfer cold data to\u0026nbsp;S3, which is\u0026nbsp;expected to\u0026nbsp;be\u0026nbsp;accessed less frequently. It\u0026nbsp;would be\u0026nbsp;best if\u0026nbsp;you also didn\u0026rsquo;t rely on\u0026nbsp;the free space transfer alone, as\u0026nbsp;hot, actively used data may be\u0026nbsp;moved, reducing performance.\u003c/p\u003e\n\u003cp\u003eHowever, note that there is\u0026nbsp;no\u0026nbsp;special mechanism to\u0026nbsp;reduce merge number specifically on\u0026nbsp;S3 apart from a\u0026nbsp;total restriction. So, if\u0026nbsp;new data is\u0026nbsp;added to\u0026nbsp;an\u0026nbsp;old partition already located in\u0026nbsp;S3, the merge operation will involve downloading and uploading. To\u0026nbsp;reduce the number of\u0026nbsp;merges, you can use the \u003ca href=\"/docs/en/managed-clickhouse/settings-reference#maxbytestomergeatmaxspaceinpool\"\u003emaxBytesToMergeAtMaxSpaceInPool\u003c/a\u003e setting, which limits the maximum chunk size, but it\u0026nbsp;applies to\u0026nbsp;all disks with table data, including the local one.\u003c/p\u003e\n\u003cp\u003eAdditionally, the mechanics of\u0026nbsp;using multiple disks aren\u0026rsquo;t limited to\u0026nbsp;this case. For example, you can have a\u0026nbsp;small, fast SSD disk and a\u0026nbsp;larger but slow HDD, or\u0026nbsp;even organize a\u0026nbsp;multi-tiered pie with cloud storage at\u0026nbsp;the end.\u003c/p\u003e\n\u003ch3 id=\"replication\"\u003e\u003ca href=\"#replication\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eReplication\u003c/span\u003e\u003c/a\u003eReplication\u003c/h3\u003e\n\u003cp\u003eBy\u0026nbsp;default, S3 uses the same replication mechanism as\u0026nbsp;for local disks:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eNew data is\u0026nbsp;written to\u0026nbsp;any node, information about the new part is\u0026nbsp;put into ZooKeeper/ClickHouse Keeper (for convenience, we\u0026rsquo;ll refer to\u0026nbsp;both as\u0026nbsp;just \u0026ldquo;Keeper\u0026rdquo;),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOther nodes from Keeper learn about this,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThey access the node where this data exists and download it\u0026nbsp;from this node (Fetch operation).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"image":"/assets/blog/articles/сh-over-S3-scheme-3.png","fullWidth":false},{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eFor S3, the sequence looks as\u0026nbsp;follows:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eThe first node downloaded the part from S3,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node downloaded the part from the first node,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node uploaded the part to\u0026nbsp;S3.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"image":"/assets/blog/articles/сh-over-S3-scheme-4.png","fullWidth":false},{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003ch3 id=\"zero-copy-replication\"\u003e\u003ca href=\"#zero-copy-replication\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eZero-copy replication\u003c/span\u003e\u003c/a\u003eZero-copy replication\u003c/h3\u003e\n\u003cp\u003eThis can be\u0026nbsp;avoided by\u0026nbsp;enabling the zero-copy replication mechanism (\u003ca href=\"https://double.cloud/docs/en/managed-clickhouse/settings-reference\" target=\"_blank\"\u003ethe allowRemoteFsZeroCopyReplication\u003c/a\u003e setting).\u003c/p\u003e\n\u003cp\u003eAs\u0026nbsp;a\u0026nbsp;rule, nodes share the same S3. When the second node requests data from the first one, the first one only sends a\u0026nbsp;small bit of\u0026nbsp;local metadata. The second node checks that it\u0026nbsp;can get data from this metadata (in\u0026nbsp;fact, it\u0026nbsp;only requests the presence of\u0026nbsp;one object); if\u0026nbsp;it\u0026nbsp;does, it\u0026nbsp;stores this metadata and uses the S3 objects together with the first\u0026nbsp;one. If\u0026nbsp;there is\u0026nbsp;no\u0026nbsp;access (different S3 bucket or\u0026nbsp;storage), the full copy of\u0026nbsp;the data from the conservative approach takes place. This mechanism with accessibility testing makes it\u0026nbsp;possible, for example, to\u0026nbsp;move live to\u0026nbsp;another object storage\u0026nbsp;\u0026mdash; two more replicas working with S3-A are added to\u0026nbsp;S3-B, they replicate data to\u0026nbsp;themselves via full copying, and each pair shares objects in\u0026nbsp;its S3.\u003c/p\u003e\n\u003cp\u003eWith zero-copy, each replica additionally marks in\u0026nbsp;the Keeper which parts it\u0026nbsp;uses in\u0026nbsp;S3, and when deleting the last hard link from a\u0026nbsp;node, it\u0026nbsp;checks if\u0026nbsp;someone else uses that data, and if\u0026nbsp;it\u0026nbsp;does, it\u0026nbsp;doesn\u0026rsquo;t touch the object in\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eThis is\u0026nbsp;the case of\u0026nbsp;the \u0026ldquo;object on\u0026nbsp;S3 will probably get deleted\u0026rdquo; we\u0026nbsp;mentioned earlier.\u003c/p\u003e\n\u003ch4 id=\"zero-copy-imitations-and-issues\"\u003e\u003ca href=\"#zero-copy-imitations-and-issues\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eZero-copy limitations and issues\u003c/span\u003e\u003c/a\u003eZero-copy limitations and issues\u003c/h4\u003e\n\u003cp\u003eThe zero-copy mechanism isn\u0026rsquo;t yet considered production-ready; sometimes, there are bugs. The last example, which is\u0026nbsp;already fixed in\u0026nbsp;recent versions\u0026nbsp;\u0026mdash; is\u0026nbsp;the case of\u0026nbsp;double replication during mutations.\u003c/p\u003e\n\u003cp\u003eWhen one node creates a\u0026nbsp;part, the following happens:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node replicates it,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eA\u0026nbsp;mutation is\u0026nbsp;run on\u0026nbsp;the part, resulting in\u0026nbsp;a\u0026nbsp;new part with hard links to\u0026nbsp;the original data,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node replicates the new part.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAt\u0026nbsp;the same time, the second node knows nothing about the connections between these parts.\u003c/p\u003e\n\u003cp\u003eIf\u0026nbsp;the first node deletes the old part before, the second node at\u0026nbsp;the moment of\u0026nbsp;deletion will decide that it\u0026rsquo;s deleting the last local link to\u0026nbsp;the objects. As\u0026nbsp;a\u0026nbsp;result, it\u0026rsquo;ll get information from the Keeper that no\u0026nbsp;one else uses objects of\u0026nbsp;this part, and thus, it\u0026rsquo;ll delete objects in\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eAs\u0026nbsp;stated above, this bug has already been fixed, and we\u0026nbsp;have been using zero-copy in\u0026nbsp;our solution for a\u0026nbsp;long time.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"image":"/assets/blog/articles/сh-over-S3-scheme-5.png","fullWidth":false},{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003ch2 id=\"final-thoughts\"\u003e\u003ca href=\"#final-thoughts\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eFinal thoughts\u003c/span\u003e\u003c/a\u003eFinal thoughts\u003c/h2\u003e\n\u003cp\u003eWe\u0026nbsp;also see that that community has started to\u0026nbsp;add other object storage providers like \u003ca href=\"https://github.com/ClickHouse/ClickHouse/issues/29430\" target=\"_blank\"\u003eAzure blob storage developed\u003c/a\u003e by\u0026nbsp;our friends from Content Square, which once again showed us\u0026nbsp;that we\u0026nbsp;are moving in\u0026nbsp;the right direction.\u003c/p\u003e\n\u003cp\u003eSmall note about the availability of\u0026nbsp;that feature at\u0026nbsp;DoubleCloud. All clusters at\u0026nbsp;DoubleCloud already have S3-based hybrid storage by\u0026nbsp;default; you don\u0026rsquo;t need to\u0026nbsp;provision or\u0026nbsp;set up\u0026nbsp;anything additional. \u003ca href=\"https://double.cloud/docs/en/managed-clickhouse/step-by-step/use-hybrid-storage\" target=\"_blank\"\u003eJust create a\u0026nbsp;table\u003c/a\u003e with your preferred hybrid storage profile, and you are ready to\u0026nbsp;go.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"mailto:viktor@double.cloud\" target=\"_blank\"\u003eContact our architects\u003c/a\u003e to\u0026nbsp;find out how to\u0026nbsp;apply this approach to\u0026nbsp;your project or\u0026nbsp;even if\u0026nbsp;you are looking for help setting up\u0026nbsp;and using that functionality and want to\u0026nbsp;chat with us.\u003c/p\u003e\n\u003cp\u003eClickHouse\u0026reg; is\u0026nbsp;a\u0026nbsp;trademark of\u0026nbsp;ClickHouse, Inc. \u003ca href=\"https://clickhouse.com/\" target=\"_blank\"\u003ehttps://clickhouse.com\u003c/a\u003e\u003c/p\u003e"}]},{"type":"content-layout-block","background":{"src":"/assets/doublecloud/doublecloud-cover-5.png","style":{"backgroundColor":"#CA1551"}},"centered":true,"textContent":{"title":"Start your trial today","buttons":[{"text":"Start free trial","size":"promo","theme":"accent","url":"https://auth.double.cloud/s/signup"},{"text":"Contact us","theme":"pseudo","url":"#contact-us-form"}]}},{"type":"blog-suggest-block","resetPaddings":true,"fullWidth":false}]},"title":"How S3-based ClickHouse hybrid storage works under the hood","noIndex":false,"shareTitle":"","shareDescription":null,"shareImage":"/assets/blog/articles/new-sharing-images/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-sharing.png","pageLocaleId":62,"author":"unknown","metaDescription":null,"keywords":[],"shareGenTitle":null,"canonicalLink":null,"sharingType":"custom","sharingTheme":"dark","comment":"add fetchProperty prop to header or bg","shareImageUrl":null,"pageRegionId":null,"service":null,"solution":null,"locales":[{"locale":"ru","publishedVersionId":null},{"locale":"en","publishedVersionId":2203}],"regions":[],"pageRegions":[]},"post":{"url":"","id":31,"name":"how-s3-based-clickhouse-hybrid-storage-works-under-the-hood","isPinned":false,"blogPostId":31,"image":"/assets/blog/articles/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-small-cover.png.webp","readingTime":15,"date":"2022-11-25T00:00:00Z","likes":0,"hasUserLike":false,"services":[],"slug":"","authors":[],"locale":{"lang":"en"},"textTitle":"How S3-based ClickHouse hybrid storage works under the hood","htmlTitle":"How S3-based ClickHouse hybrid storage works under the hood","title":"How S3-based ClickHouse hybrid storage works under the hood","tags":[{"icon":null,"slug":"insights","name":"Insights","createdAt":"","updatedAt":"","count":0},{"icon":null,"slug":"ClickHouse","name":"ClickHouse","createdAt":"","updatedAt":"","count":0}],"metaTitle":"How S3-based ClickHouse hybrid storage works under the hood","description":"","content":"\u003cp\u003eIn\u0026nbsp;this article, we\u0026rsquo;ll talk about:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#conservative-approach\"\u003eThe conservative approach\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#alternate-approach\"\u003eThe alternate approach\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#managing-s3\"\u003eManaging data in\u0026nbsp;S3\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#limitations\"\u003eClickHouse limitations with S3 data operations\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#caching\"\u003eCaching\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#operations-log-in-hybrid-storage\"\u003eOperations log in\u0026nbsp;hybrid storage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#backups\"\u003eBackups\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#hybrid-storage\"\u003eHybrid storage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#replication\"\u003eReplication\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#zero-copy-replication\"\u003eZero-copy replication\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#zero-copy-imitations-and-issues\"\u003eZero-copy limitations and issues\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#final-thoughts\"\u003eFinal thoughts\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cem\u003eWritten by\u0026nbsp;Anton Ivashkin, DoubleCloud Dev lead for ClickHouse service.\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eEveryone knows that ClickHouse is\u0026nbsp;extremely fast at\u0026nbsp;processing a\u0026nbsp;lot of\u0026nbsp;data. A\u0026nbsp;dataset may reach tens/hundreds of\u0026nbsp;terabytes or\u0026nbsp;even a\u0026nbsp;hundred petabytes. Of\u0026nbsp;course, this data needs to\u0026nbsp;be\u0026nbsp;stored somewhere with the following core requirements: cost-efficiency, high speed, accessibility, security, and reliability. S3 or\u0026nbsp;object storage is\u0026nbsp;a\u0026nbsp;perfect match, but the only critical point it\u0026nbsp;lacks is\u0026nbsp;speed. Therefore, we\u0026nbsp;built a\u0026nbsp;hybrid approach where you can fuse the speed of\u0026nbsp;SSD disks and the affordability of\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eOur team at\u0026nbsp;DoubleCloud started developing the S3 hybrid storage feature a\u0026nbsp;year ago, and it\u0026nbsp;was successfully merged in\u0026nbsp;version 22.3 on\u0026nbsp;April 18, 2022\u0026nbsp;with further fixes and optimizations in\u0026nbsp;the version 22.8. It\u0026nbsp;was widely accepted by\u0026nbsp;the community and Clickhouse team primarily because compute is\u0026nbsp;now decoupled from the storage. We\u0026nbsp;see a\u0026nbsp;reduction from 3-5 times in\u0026nbsp;storage cost in\u0026nbsp;those scenarios where hybrid storage is\u0026nbsp;applicable, and that\u0026rsquo;s a\u0026nbsp;real game changer for scenarios like logs, metrics, traces, or\u0026nbsp;other data scenarios where users primarily work with fresh data and the rest is\u0026nbsp;stored for rare cases.\u003c/p\u003e\n\u003cp\u003eBelow I\u0026nbsp;will describe how it\u0026rsquo;s working under the hood and on\u0026nbsp;what principles it\u0026rsquo;s based.\u003c/p\u003e\n\u003ch2 id=\"conservative-approach\"\u003e\u003ca href=\"#conservative-approach\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eThe conservative approach\u003c/span\u003e\u003c/a\u003eThe conservative approach\u003c/h2\u003e\n\u003cp\u003eThe classical approach is\u0026nbsp;to\u0026nbsp;use a\u0026nbsp;sharded ClickHouse cluster. Let\u0026rsquo;s say the data is\u0026nbsp;100\u0026nbsp;TB, and there is\u0026nbsp;10\u0026nbsp;TB\u0026nbsp;of\u0026nbsp;storage space available on\u0026nbsp;each\u0026nbsp;VM. Then a\u0026nbsp;perfect partitioning would require ten shards, with two replicated nodes per shard. This requirement adds up\u0026nbsp;to\u0026nbsp;20\u0026nbsp;machines. However, it\u0026rsquo;s only sometimes the case that the data gets evenly split, so\u0026nbsp;you can safely multiply that number by\u0026nbsp;one and a\u0026nbsp;half.\u003c/p\u003e\n\u003cp\u003ePlus, ClickHouse works sub-optimally when the storage has no\u0026nbsp;free space. With read-only data, which is\u0026nbsp;completely frozen, you can still manage, but if\u0026nbsp;the new data flows in\u0026nbsp;regularly, you must have at\u0026nbsp;least 10\u0026nbsp;percent more free space for it\u0026nbsp;to\u0026nbsp;work correctly.\u003c/p\u003e\n\u003cp\u003eNow we\u0026nbsp;face the need to\u0026nbsp;run 30+ machines, which is\u0026nbsp;quite significant. In\u0026nbsp;this case, most VMs will use only disk space, and the CPU and RAM will be\u0026nbsp;almost idle.\u003c/p\u003e\n\u003cp\u003eOf\u0026nbsp;course, there are situations when there is\u0026nbsp;a\u0026nbsp;large flow of\u0026nbsp;requests, and other resources will get their share of\u0026nbsp;the load, but according to\u0026nbsp;our data on\u0026nbsp;clusters with 10+ shards, they tend to\u0026nbsp;be\u0026nbsp;indefinitely idle.\u003c/p\u003e\n\n\u003ch2 id=\"alternate-approach\"\u003e\u003ca href=\"#alternate-approach\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eThe alternate approach\u003c/span\u003e\u003c/a\u003eThe alternate approach\u003c/h2\u003e\n\u003cp\u003eClickHouse can use S3-compatible storage. The advantages of\u0026nbsp;this approach are the following:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eAlmost unlimited capacity,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSignificantly lower cost than dedicated VMs with the same amount of\u0026nbsp;disk space.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe main disadvantage is\u0026nbsp;that S3-compatible storage is\u0026nbsp;a\u0026nbsp;network resource, so\u0026nbsp;the speed of\u0026nbsp;access to\u0026nbsp;data, as\u0026nbsp;a\u0026nbsp;consequence, increases the time of\u0026nbsp;operations.\u003c/p\u003e\n\n\u003cp\u003eLet\u0026rsquo;s see how it\u0026nbsp;works. An\u0026nbsp;IDisk interface provides methods for basic file operations such as\u0026nbsp;create, copy, rename, delete, etc. The ClickHouse engine works with that interface. Most of\u0026nbsp;the time, it\u0026nbsp;doesn\u0026rsquo;t matter what\u0026rsquo;s under the hood. There are implementations for specific storage methods:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003elocal disk (\u003ccode\u003eDiskLocal\u003c/code\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ein-memory storage (\u003ccode\u003eDiskMemory\u003c/code\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ecloud storage (\u003ccode\u003eDiskObjectStorage\u003c/code\u003e).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe latter implements logic for storing data in\u0026nbsp;different types of\u0026nbsp;storage, notably in\u0026nbsp;S3.\u003cbr /\u003e\nThe other storages are HDFS and MS\u0026nbsp;Azure. They\u0026rsquo;re similar conceptually, but for now let\u0026rsquo;s focus on\u0026nbsp;S3.\u003c/p\u003e\n\u003ch3 id=\"managing-s3\"\u003e\u003ca href=\"#managing-s3\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eManaging data in\u0026nbsp;S3\u003c/span\u003e\u003c/a\u003eManaging data in\u0026nbsp;S3\u003c/h3\u003e\n\u003cp\u003eWhen the engine wants to\u0026nbsp;\u0026ldquo;create a\u0026nbsp;file\u0026rdquo; on\u0026nbsp;an\u0026nbsp;S3 disk, it\u0026nbsp;creates an\u0026nbsp;object in\u0026nbsp;S3 with a\u0026nbsp;random name, writes a\u0026nbsp;data stream to\u0026nbsp;it\u0026nbsp;and creates a\u0026nbsp;metadata file on\u0026nbsp;the local disk with the name, size and some other information. The size of\u0026nbsp;such a\u0026nbsp;local metadata file is\u0026nbsp;tens of\u0026nbsp;bytes.\u003c/p\u003e\n\u003cp\u003eThen operations such as\u0026nbsp;renaming and creating hard links are performed only on\u0026nbsp;the local metadata file, while the object on\u0026nbsp;S3 remains untouched.\u003c/p\u003e\n\u003cp\u003eS3 doesn\u0026rsquo;t provide a\u0026nbsp;straightforward way to\u0026nbsp;modify created S3 objects. For example, the renaming operation is\u0026nbsp;a\u0026nbsp;load-intensive procedure to\u0026nbsp;create a\u0026nbsp;new object. The above scheme with a\u0026nbsp;small local metadata file allows you to\u0026nbsp;bypass this limitation.\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3 ls s3:\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003edouble\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ecloud\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003estorage\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003ecloud_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es1\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e bpmwovnptyvtbxrxpaixgnjhgsjfekwd\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e enmwkqfptmghyxzxhiczjgpkhzsvexgi\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e mjgumajoilbkcpnvlbbglgajrkvqbpea\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e aoazgzkryvhceolzichwyprzsmjotkw\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e xiyltehvfxbkqbnytyjwbsmyafgjscwg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e235\u003c/span\u003e ickdlneqkzcrgpeokcubmkwtyyayukmg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e65\u003c/span\u003e lyggepidqbgyxqwzsfoxltxpbfbehrqy\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e60\u003c/span\u003e ytfhoupmfahdakydbfumxxkqgloakanh\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e tddzrmzildnwtmvescmbkhqzhoxwoqmq\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"35\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-35\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-35\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-35.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# ls \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003el \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003evar\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003elib\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eclickhouse\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003edisks\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eobject_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003estore\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e133\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e13344\u003c/span\u003eeec\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ed80a\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003ea5b\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eb99d\u003cspan class=\"hljs-number\"\u003e-6177\u003c/span\u003ef144e62a\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e_0_0_0\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\ntotal \u003cspan class=\"hljs-number\"\u003e36\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 120 Nov 21 12:32 checksums.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 columns.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 count.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 data.bin\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 data.mrk3\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 default_compression_codec.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 minmax_key.idx\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 partition.dat\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 primary.idx\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"36\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-36\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-36\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-36.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# cat \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003evar\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003elib\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eclickhouse\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003edisks\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eobject_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003estore\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e133\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e13344\u003c/span\u003eeec\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ed80a\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003ea5b\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eb99d\u003cspan class=\"hljs-number\"\u003e-6177\u003c/span\u003ef144e62a\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e_0_0_0\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003edata.mrk3\n\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e                                       # [metadata file format version]\n\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e                                 # [objects count] [total size]\n\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e    enmwkqfptmghyxzxhiczjgpkhzsvexgi  # [object size] [object name]\n\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e                                       # [reference count]\n\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e                                       # [readonly flag]\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"37\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-37\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-37\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-37.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eA\u0026nbsp;separate operation is\u0026nbsp;adding data to\u0026nbsp;the file. As\u0026nbsp;mentioned earlier, S3 doesn\u0026rsquo;t allow changing objects after creation, so\u0026nbsp;we\u0026nbsp;create another object to\u0026nbsp;which a\u0026nbsp;new portion of\u0026nbsp;data is\u0026nbsp;added. The name of\u0026nbsp;this object is\u0026nbsp;written in\u0026nbsp;the metadata file mentioned earlier, and it\u0026nbsp;starts referring to\u0026nbsp;multiple objects.\u003c/p\u003e\n\u003cp\u003ePlease note that such operation in\u0026nbsp;ClickHouse is\u0026nbsp;performed only for \u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/log-family/\" target=\"_blank\"\u003eLog family engines\u003c/a\u003e, which almost nobody uses. In\u0026nbsp;the popular \u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003eMergeTree engine\u003c/a\u003e, the file is\u0026nbsp;created once and is\u0026nbsp;never modified again.\u003c/p\u003e\n\u003cp\u003eFor some operations, such as\u0026nbsp;mutation, the engine creates a\u0026nbsp;new part with a\u0026nbsp;new structure when adding a\u0026nbsp;new column. However, as\u0026nbsp;some data doesn\u0026rsquo;t change, we\u0026nbsp;use the operation to\u0026nbsp;create hard links to\u0026nbsp;the old ones instead of\u0026nbsp;copying them. Only the local metadata file is\u0026nbsp;linked, where, among other things, we\u0026nbsp;store the link counter, which increases with this operation.\u003c/p\u003e\n\u003ch4 id=\"limitations\"\u003e\u003ca href=\"#limitations\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eClickHouse limitations with S3 data operations\u003c/span\u003e\u003c/a\u003eClickHouse limitations with S3 data operations\u003c/h4\u003e\n\u003cp\u003eWhen you perform the deletion, the engine decrements the link count and deletes the local metadata file, and if\u0026nbsp;this is\u0026nbsp;the last hard link to\u0026nbsp;the deleted file, it\u0026nbsp;possibly removes the object in\u0026nbsp;S3. We\u0026rsquo;ll get back to\u0026nbsp;why it\u0026rsquo;s possible when discussing replication.\u003c/p\u003e\n\u003cp\u003eClickHouse doesn\u0026rsquo;t use such manipulations as\u0026nbsp;data replacement in\u0026nbsp;the middle of\u0026nbsp;the file. Thus, it\u0026nbsp;wasn\u0026rsquo;t implemented.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s elaborate on\u0026nbsp;two more points.\u003c/p\u003e\n\u003cp\u003eThe first one is\u0026nbsp;that the object\u0026rsquo;s name in\u0026nbsp;S3 is\u0026nbsp;random. It\u0026rsquo;s pretty inconvenient because it\u0026nbsp;isn\u0026rsquo;t clear from the object itself what it\u0026nbsp;is. Below we\u0026rsquo;ll talk about the operations log, it\u0026rsquo;s a\u0026nbsp;mechanism that allows us\u0026nbsp;to\u0026nbsp;streamline things somewhat, but it\u0026rsquo;s not perfect either.\u003c/p\u003e\n\u003cp\u003eThe second point is\u0026nbsp;that storing the count of\u0026nbsp;hard links in\u0026nbsp;the metadata file seems unnecessary since we\u0026nbsp;can obtain it\u0026nbsp;from the file system. But in\u0026nbsp;the case of\u0026nbsp;manual manipulation of\u0026nbsp;local files past ClickHouse, the link could get broken. In\u0026nbsp;this case, both copies would have an\u0026nbsp;increased counter, which wouldn\u0026rsquo;t allow the object to\u0026nbsp;be\u0026nbsp;deleted in\u0026nbsp;S3 when one of\u0026nbsp;the copies is\u0026nbsp;deleted. Deleting the second one won\u0026rsquo;t delete it\u0026nbsp;either, but it\u0026rsquo;s better to\u0026nbsp;leave the garbage on\u0026nbsp;S3 than lose the needed data.\u003c/p\u003e\n\u003cp\u003eWhen a\u0026nbsp;local metadata file is\u0026nbsp;read, it\u0026nbsp;learns the name of\u0026nbsp;the object or\u0026nbsp;objects in\u0026nbsp;S3, and S3 requests the desired portion of\u0026nbsp;data. It\u0026nbsp;helps that S3 allows you to\u0026nbsp;download a\u0026nbsp;fragment of\u0026nbsp;an\u0026nbsp;object by\u0026nbsp;offset and size.\u003c/p\u003e\n\u003ch4 id=\"сaching\"\u003e\u003ca href=\"#сaching\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eCaching\u003c/span\u003e\u003c/a\u003eCaching\u003c/h4\u003e\n\u003cp\u003eIn\u0026nbsp;the \u003ca href=\"https://clickhouse.com/docs/en/whats-new/changelog/\" target=\"_blank\"\u003elatest ClickHouse versions\u003c/a\u003e, we\u0026nbsp;can cache data downloaded from object storage. We\u0026nbsp;can add data into the cache while writing with a\u0026nbsp;separate option. It\u0026nbsp;can speed up\u0026nbsp;requests execution when different requests access the same data. Within one request, repeated reading of\u0026nbsp;the same data doesn\u0026rsquo;t occur. This functionality is\u0026nbsp;built into the engine. However, the cache size is\u0026nbsp;limited, so\u0026nbsp;the best choice depends on\u0026nbsp;your case.\u003c/p\u003e\n\u003ch4 id=\"operations-log-in-hybrid-storage\"\u003e\u003ca href=\"#operations-log-in-hybrid-storage\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eOperations log in\u0026nbsp;hybrid storage\u003c/span\u003e\u003c/a\u003eOperations log in\u0026nbsp;hybrid storage\u003c/h4\u003e\n\u003cp\u003eThere is\u0026nbsp;a\u0026nbsp;default \u003ccode\u003esend_metadata\u003c/code\u003e setting, which is\u0026nbsp;disabled by\u0026nbsp;default. ClickHouse keeps a\u0026nbsp;counter of\u0026nbsp;operations, which increments with each operation of\u0026nbsp;file creation, renaming and hard link creation.\u003c/p\u003e\n\u003cp\u003eWhen creating, the operation number is\u0026nbsp;added to\u0026nbsp;the object name in\u0026nbsp;binary form, and S3 metadata (not to\u0026nbsp;be\u0026nbsp;confused with the local metadata file, we\u0026nbsp;have a\u0026nbsp;certain deficit in\u0026nbsp;terminology here) is\u0026nbsp;added to\u0026nbsp;the object, in\u0026nbsp;which the original file name is\u0026nbsp;written.\u003c/p\u003e\n\u003cp\u003eWhen renaming and hard linking, a\u0026nbsp;special small object is\u0026nbsp;created in\u0026nbsp;S3, whose name also contains the operation number and whose S3 metadata records from which local name to\u0026nbsp;which a\u0026nbsp;hard link was renamed or\u0026nbsp;created.\u003c/p\u003e\n\u003cp\u003eWhen performing the deletion, the operation counter isn\u0026rsquo;t incremented after the object is\u0026nbsp;deleted. It\u0026nbsp;allows you to\u0026nbsp;restore local metadata\u0026nbsp;\u0026mdash; S3 queries the complete list of\u0026nbsp;objects containing data. It\u0026nbsp;enables you to\u0026nbsp;recover the original name using the S3 metadata, then rename and hard link operations are applied to\u0026nbsp;the existing files. It\u0026rsquo;s triggered by\u0026nbsp;creating a\u0026nbsp;special file before the disk starts.\u003c/p\u003e\n\u003cp\u003eThis mechanism allows to\u0026nbsp;perform not all operations but only up\u0026nbsp;to\u0026nbsp;some revision, which can be\u0026nbsp;used for backups.\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3 ls s3:\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003edouble\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ecloud\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003estorage\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003ecloud_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es1\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n             PRE operations\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e .SCHEMA_VERSION\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000001\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ebpmwovnptyvtbxrxpaixgnjhgsjfekwd\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000010\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eenmwkqfptmghyxzxhiczjgpkhzsvexgi\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000011\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003emjgumajoilbkcpnvlbbglgajrkvqbpea\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000100\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaaoazgzkryvhceolzichwyprzsmjotkw\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000101\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003exiyltehvfxbkqbnytyjwbsmyafgjscwg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e235\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000110\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eickdlneqkzcrgpeokcubmkwtyyayukmg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e65\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000111\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003elyggepidqbgyxqwzsfoxltxpbfbehrqy\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e60\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000001000\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eytfhoupmfahdakydbfumxxkqgloakanh\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000001001\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003etddzrmzildnwtmvescmbkhqzhoxwoqmq\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"92\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-92\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-92\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-92.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3api head\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eobject \u003cspan class=\"hljs-comment\"\u003e--bucket double-cloud-storage-chc8d6h0ehe98li0k4sn --key cloud_storage/chc8d6h0ehe98li0k4sn/s1/r0000000000000000000000000000000000000000000000000000000000000010-file-enmwkqfptmghyxzxhiczjgpkhzsvexgi\u003c/span\u003e\n{\n  \"AcceptRanges\": \"bytes\",\n  \"LastModified\": \"Mon, 21 Nov 2022 12:32:58 GMT\",\n  \"ContentLength\": \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e,\n  \"ETag\": \"\\\"fbc2bf6ed653c03001977f21a1416ace\\\"\",\n  \"ContentType\": \"binary/octet-stream\",\n  \"Metadata\": {\n      \"path\": \"store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/moving/2_0_0_0/data.mrk3\"\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"93\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-93\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-93\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-93.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3 ls s3:\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003edouble\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ecloud\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003estorage\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003ecloud_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es1\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eoperations\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e33\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e02\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000001\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003each\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eeuc1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaz1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003es1\u003cspan class=\"hljs-number\"\u003e-1.\u003c/span\u003echc8d6h0ehe98li0k4sn.at.yadc.io\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erename\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e33\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e02\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000010\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003each\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eeuc1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaz1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003es1\u003cspan class=\"hljs-number\"\u003e-1.\u003c/span\u003echc8d6h0ehe98li0k4sn.at.yadc.io\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erename\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000001010\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003each\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eeuc1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaz1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003es1\u003cspan class=\"hljs-number\"\u003e-1.\u003c/span\u003echc8d6h0ehe98li0k4sn.at.yadc.io\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erename\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"94\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-94\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-94\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-94.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3api head\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eobject \u003cspan class=\"hljs-comment\"\u003e--bucket double-cloud-storage-chc8d6h0ehe98li0k4sn --key cloud_storage/chc8d6h0ehe98li0k4sn/s1/operations/r0000000000000000000000000000000000000000000000000000000000001010-ach-euc1-az1-s1-1.chc8d6h0ehe98li0k4sn.at.yadc.io-rename\u003c/span\u003e\n{\n  \"AcceptRanges\": \"bytes\",\n  \"LastModified\": \"Mon, 21 Nov 2022 12:32:59 GMT\",\n  \"ContentLength\": \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\n  \"ETag\": \"\\\"cfcd208495d565ef66e7dff9f98764da\\\"\",\n  \"ContentType\": \"binary/octet-stream\",\n  \"Metadata\": {\n      \"to_path\": \"store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/2_0_0_0/\",\n      \"from_path\": \"store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/moving/2_0_0_0\"\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"95\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-95\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-95\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-95.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003ch4 id=\"backups\"\u003e\u003ca href=\"#backups\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eBackups\u003c/span\u003e\u003c/a\u003eBackups\u003c/h4\u003e\n\u003cp\u003eOn\u0026nbsp;a\u0026nbsp;live VM\u0026nbsp;and with data on\u0026nbsp;local disks, backups are made by\u0026nbsp;calling \u003ccode\u003eFREEZE TABLE\u003c/code\u003e for each table. This command creates a\u0026nbsp;snapshot of\u0026nbsp;the tables (hard links to\u0026nbsp;all files) in\u0026nbsp;a\u0026nbsp;separate directory so\u0026nbsp;that they can be\u0026nbsp;copied somewhere for the future, then delete the directories manually or\u0026nbsp;via \u003ccode\u003eTABLE UNFREEZE\u003c/code\u003e. It\u0026nbsp;allows you to\u0026nbsp;keep the tables in\u0026nbsp;a\u0026nbsp;consistent (but not atomic) condition.\u003c/p\u003e\n\u003cp\u003eThis option isn\u0026rsquo;t suitable for S3 because only local metadata can be\u0026nbsp;copied this\u0026nbsp;way. Objects in\u0026nbsp;S3 have to\u0026nbsp;be\u0026nbsp;extracted separately.\u003c/p\u003e\n\u003cp\u003eWe\u0026nbsp;use a\u0026nbsp;way that isn\u0026rsquo;t a\u0026nbsp;backup for S3 per se\u0026nbsp;but a\u0026nbsp;snapshot:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eExecute \u003ccode\u003eTABLE FREEZE\u003c/code\u003e,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSave the revision number,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDelete the directory with frozen data once the backup is\u0026nbsp;no\u0026nbsp;longer relevant.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe presence of\u0026nbsp;these hard links prevents ClickHouse from deleting objects in\u0026nbsp;S3. When restoring from the operation log, we\u0026nbsp;restore the state for the desired revision.\u003c/p\u003e\n\u003cp\u003eWhen a\u0026nbsp;backup becomes obsolete, delete the frozen metadata via \u003ccode\u003eUNFREEZE\u003c/code\u003e to\u0026nbsp;correctly delete unnecessary objects in\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eAt\u0026nbsp;the same time, since some tables from the backup may already be\u0026nbsp;deleted in\u0026nbsp;the working version and \u003ccode\u003eTABLE UNFREEZE\u003c/code\u003e cannot be\u0026nbsp;done for them, run the \u003ccode\u003eSYSTEM UNFREEZE\u003c/code\u003e command. It\u0026nbsp;removes all the frozen data from all the tables by\u0026nbsp;backup name and can work with tables that don\u0026rsquo;t exist\u0026nbsp;now. Please note that this mechanism can take a\u0026nbsp;long time to\u0026nbsp;execute if\u0026nbsp;you have a\u0026nbsp;big log of\u0026nbsp;operations. At\u0026nbsp;the moment, an\u0026nbsp;alternative system for creating backups is\u0026nbsp;in\u0026nbsp;development.\u003c/p\u003e\n\u003cp\u003eThe above method isn\u0026rsquo;t a\u0026nbsp;classic backup, the data is\u0026nbsp;in\u0026nbsp;a\u0026nbsp;single object in\u0026nbsp;S3, and its safety relies on\u0026nbsp;the high reliability of\u0026nbsp;cloud storage. For example, in\u0026nbsp;case of\u0026nbsp;a\u0026nbsp;logical error or\u0026nbsp;unauthorized access, you\u0026rsquo;ll lose the data when an\u0026nbsp;object is\u0026nbsp;deleted.\u003c/p\u003e\n\u003cp\u003eWorking with just S3 storage has a\u0026nbsp;disadvantage\u0026nbsp;\u0026mdash; the \u003ccode\u003eMerge\u003c/code\u003e operation. It\u0026nbsp;downloads all the partitions ClickHouse wants to\u0026nbsp;merge and uploads a\u0026nbsp;new higher-level part. If\u0026nbsp;the workflow is\u0026nbsp;not organized correctly, adding new data to\u0026nbsp;already merged large chunks, can generate unexpectedly heavy traffic compared to\u0026nbsp;the data being added.\u003c/p\u003e\n\u003cp\u003eFor example, if\u0026nbsp;S3 has a\u0026nbsp;1\u0026nbsp;Gb\u0026nbsp;partition, and 1\u0026nbsp;kb\u0026nbsp;of\u0026nbsp;new data is\u0026nbsp;added, ClickHouse will download this 1\u0026nbsp;Gb, measure the partitions and upload a\u0026nbsp;new part to\u0026nbsp;S3. As\u0026nbsp;a\u0026nbsp;result, adding a\u0026nbsp;small chunk of\u0026nbsp;data causes significantly more traffic.\u003c/p\u003e\n\u003cp\u003eOne possible solution is\u0026nbsp;to\u0026nbsp;prohibit merges on\u0026nbsp;the S3 disk (\u003ca href=\"https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003eprefer_not_to_merge\u003c/a\u003e setting), but this will cause another problem\u0026nbsp;\u0026mdash; a\u0026nbsp;large number of\u0026nbsp;small parts, which can significantly (sometimes catastrophically) reduce performance for \u003ccode\u003eSELECT\u003c/code\u003e queries. So, in\u0026nbsp;a\u0026nbsp;normal situation, it\u0026rsquo;s better not to\u0026nbsp;use prefer_not_to_merge\u0026nbsp;\u0026mdash; this is\u0026nbsp;a\u0026nbsp;mechanism for serious breakdowns that can lead to\u0026nbsp;fairly negative consequences. In\u0026nbsp;a\u0026nbsp;situation where the data arrives more or\u0026nbsp;less consistently, there will be\u0026nbsp;no\u0026nbsp;network load problems.\u003c/p\u003e\n\u003ch3 id=\"hybrid-storage\"\u003e\u003ca href=\"#hybrid-storage\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eHybrid storage\u003c/span\u003e\u003c/a\u003eHybrid storage\u003c/h3\u003e\n\u003cp\u003eA\u0026nbsp;better solution is\u0026nbsp;hybrid storage. Hybrid storage uses a\u0026nbsp;pair of\u0026nbsp;disks, local and S3. New data is\u0026nbsp;stored on\u0026nbsp;the local disk, gets merged into large parts, and then these parts, which aren\u0026rsquo;t expected to\u0026nbsp;merge further, are sent to\u0026nbsp;S3. In\u0026nbsp;this case, the access speed to\u0026nbsp;local data will be\u0026nbsp;higher, and this approach, in\u0026nbsp;most cases, combines the performance of\u0026nbsp;local disks and the volume of\u0026nbsp;cloud storage. You can configure the move:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eBy\u0026nbsp;data age (\u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003eTTL MOVE TO\u0026nbsp;\u0026hellip;\u003c/a\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eBy\u0026nbsp;the amount of\u0026nbsp;free space on\u0026nbsp;the local disk (\u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003emove_factor\u003c/a\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eMove the data yourself (\u003ca href=\"https://clickhouse.com/docs/en/sql-reference/statements/alter/partition/\" target=\"_blank\"\u003eALTER TABLE MOVE PARTITION\u003c/a\u003e).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSetting up\u0026nbsp;a\u0026nbsp;move by\u0026nbsp;time should be\u0026nbsp;chosen to\u0026nbsp;consider the uniformity of\u0026nbsp;data flow so\u0026nbsp;that the principal amount of\u0026nbsp;merges occur while the data is\u0026nbsp;still on\u0026nbsp;the local drive. Another thing to\u0026nbsp;consider is\u0026nbsp;the need to\u0026nbsp;read data: reading from the local drive will usually be\u0026nbsp;much faster. Thus, it\u0026nbsp;makes sense to\u0026nbsp;transfer cold data to\u0026nbsp;S3, which is\u0026nbsp;expected to\u0026nbsp;be\u0026nbsp;accessed less frequently. It\u0026nbsp;would be\u0026nbsp;best if\u0026nbsp;you also didn\u0026rsquo;t rely on\u0026nbsp;the free space transfer alone, as\u0026nbsp;hot, actively used data may be\u0026nbsp;moved, reducing performance.\u003c/p\u003e\n\u003cp\u003eHowever, note that there is\u0026nbsp;no\u0026nbsp;special mechanism to\u0026nbsp;reduce merge number specifically on\u0026nbsp;S3 apart from a\u0026nbsp;total restriction. So, if\u0026nbsp;new data is\u0026nbsp;added to\u0026nbsp;an\u0026nbsp;old partition already located in\u0026nbsp;S3, the merge operation will involve downloading and uploading. To\u0026nbsp;reduce the number of\u0026nbsp;merges, you can use the \u003ca href=\"/docs/en/managed-clickhouse/settings-reference#maxbytestomergeatmaxspaceinpool\"\u003emaxBytesToMergeAtMaxSpaceInPool\u003c/a\u003e setting, which limits the maximum chunk size, but it\u0026nbsp;applies to\u0026nbsp;all disks with table data, including the local one.\u003c/p\u003e\n\u003cp\u003eAdditionally, the mechanics of\u0026nbsp;using multiple disks aren\u0026rsquo;t limited to\u0026nbsp;this case. For example, you can have a\u0026nbsp;small, fast SSD disk and a\u0026nbsp;larger but slow HDD, or\u0026nbsp;even organize a\u0026nbsp;multi-tiered pie with cloud storage at\u0026nbsp;the end.\u003c/p\u003e\n\u003ch3 id=\"replication\"\u003e\u003ca href=\"#replication\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eReplication\u003c/span\u003e\u003c/a\u003eReplication\u003c/h3\u003e\n\u003cp\u003eBy\u0026nbsp;default, S3 uses the same replication mechanism as\u0026nbsp;for local disks:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eNew data is\u0026nbsp;written to\u0026nbsp;any node, information about the new part is\u0026nbsp;put into ZooKeeper/ClickHouse Keeper (for convenience, we\u0026rsquo;ll refer to\u0026nbsp;both as\u0026nbsp;just \u0026ldquo;Keeper\u0026rdquo;),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOther nodes from Keeper learn about this,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThey access the node where this data exists and download it\u0026nbsp;from this node (Fetch operation).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eFor S3, the sequence looks as\u0026nbsp;follows:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eThe first node downloaded the part from S3,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node downloaded the part from the first node,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node uploaded the part to\u0026nbsp;S3.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"zero-copy-replication\"\u003e\u003ca href=\"#zero-copy-replication\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eZero-copy replication\u003c/span\u003e\u003c/a\u003eZero-copy replication\u003c/h3\u003e\n\u003cp\u003eThis can be\u0026nbsp;avoided by\u0026nbsp;enabling the zero-copy replication mechanism (\u003ca href=\"https://double.cloud/docs/en/managed-clickhouse/settings-reference\" target=\"_blank\"\u003ethe allowRemoteFsZeroCopyReplication\u003c/a\u003e setting).\u003c/p\u003e\n\u003cp\u003eAs\u0026nbsp;a\u0026nbsp;rule, nodes share the same S3. When the second node requests data from the first one, the first one only sends a\u0026nbsp;small bit of\u0026nbsp;local metadata. The second node checks that it\u0026nbsp;can get data from this metadata (in\u0026nbsp;fact, it\u0026nbsp;only requests the presence of\u0026nbsp;one object); if\u0026nbsp;it\u0026nbsp;does, it\u0026nbsp;stores this metadata and uses the S3 objects together with the first\u0026nbsp;one. If\u0026nbsp;there is\u0026nbsp;no\u0026nbsp;access (different S3 bucket or\u0026nbsp;storage), the full copy of\u0026nbsp;the data from the conservative approach takes place. This mechanism with accessibility testing makes it\u0026nbsp;possible, for example, to\u0026nbsp;move live to\u0026nbsp;another object storage\u0026nbsp;\u0026mdash; two more replicas working with S3-A are added to\u0026nbsp;S3-B, they replicate data to\u0026nbsp;themselves via full copying, and each pair shares objects in\u0026nbsp;its S3.\u003c/p\u003e\n\u003cp\u003eWith zero-copy, each replica additionally marks in\u0026nbsp;the Keeper which parts it\u0026nbsp;uses in\u0026nbsp;S3, and when deleting the last hard link from a\u0026nbsp;node, it\u0026nbsp;checks if\u0026nbsp;someone else uses that data, and if\u0026nbsp;it\u0026nbsp;does, it\u0026nbsp;doesn\u0026rsquo;t touch the object in\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eThis is\u0026nbsp;the case of\u0026nbsp;the \u0026ldquo;object on\u0026nbsp;S3 will probably get deleted\u0026rdquo; we\u0026nbsp;mentioned earlier.\u003c/p\u003e\n\u003ch4 id=\"zero-copy-imitations-and-issues\"\u003e\u003ca href=\"#zero-copy-imitations-and-issues\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eZero-copy limitations and issues\u003c/span\u003e\u003c/a\u003eZero-copy limitations and issues\u003c/h4\u003e\n\u003cp\u003eThe zero-copy mechanism isn\u0026rsquo;t yet considered production-ready; sometimes, there are bugs. The last example, which is\u0026nbsp;already fixed in\u0026nbsp;recent versions\u0026nbsp;\u0026mdash; is\u0026nbsp;the case of\u0026nbsp;double replication during mutations.\u003c/p\u003e\n\u003cp\u003eWhen one node creates a\u0026nbsp;part, the following happens:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node replicates it,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eA\u0026nbsp;mutation is\u0026nbsp;run on\u0026nbsp;the part, resulting in\u0026nbsp;a\u0026nbsp;new part with hard links to\u0026nbsp;the original data,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node replicates the new part.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAt\u0026nbsp;the same time, the second node knows nothing about the connections between these parts.\u003c/p\u003e\n\u003cp\u003eIf\u0026nbsp;the first node deletes the old part before, the second node at\u0026nbsp;the moment of\u0026nbsp;deletion will decide that it\u0026rsquo;s deleting the last local link to\u0026nbsp;the objects. As\u0026nbsp;a\u0026nbsp;result, it\u0026rsquo;ll get information from the Keeper that no\u0026nbsp;one else uses objects of\u0026nbsp;this part, and thus, it\u0026rsquo;ll delete objects in\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eAs\u0026nbsp;stated above, this bug has already been fixed, and we\u0026nbsp;have been using zero-copy in\u0026nbsp;our solution for a\u0026nbsp;long time.\u003c/p\u003e\n\n\u003ch2 id=\"final-thoughts\"\u003e\u003ca href=\"#final-thoughts\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eFinal thoughts\u003c/span\u003e\u003c/a\u003eFinal thoughts\u003c/h2\u003e\n\u003cp\u003eWe\u0026nbsp;also see that that community has started to\u0026nbsp;add other object storage providers like \u003ca href=\"https://github.com/ClickHouse/ClickHouse/issues/29430\" target=\"_blank\"\u003eAzure blob storage developed\u003c/a\u003e by\u0026nbsp;our friends from Content Square, which once again showed us\u0026nbsp;that we\u0026nbsp;are moving in\u0026nbsp;the right direction.\u003c/p\u003e\n\u003cp\u003eSmall note about the availability of\u0026nbsp;that feature at\u0026nbsp;DoubleCloud. All clusters at\u0026nbsp;DoubleCloud already have S3-based hybrid storage by\u0026nbsp;default; you don\u0026rsquo;t need to\u0026nbsp;provision or\u0026nbsp;set up\u0026nbsp;anything additional. \u003ca href=\"https://double.cloud/docs/en/managed-clickhouse/step-by-step/use-hybrid-storage\" target=\"_blank\"\u003eJust create a\u0026nbsp;table\u003c/a\u003e with your preferred hybrid storage profile, and you are ready to\u0026nbsp;go.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"mailto:viktor@double.cloud\" target=\"_blank\"\u003eContact our architects\u003c/a\u003e to\u0026nbsp;find out how to\u0026nbsp;apply this approach to\u0026nbsp;your project or\u0026nbsp;even if\u0026nbsp;you are looking for help setting up\u0026nbsp;and using that functionality and want to\u0026nbsp;chat with us.\u003c/p\u003e\n\u003cp\u003eClickHouse\u0026reg; is\u0026nbsp;a\u0026nbsp;trademark of\u0026nbsp;ClickHouse, Inc. \u003ca href=\"https://clickhouse.com/\" target=\"_blank\"\u003ehttps://clickhouse.com\u003c/a\u003e\u003c/p\u003e\n"},"suggestedPosts":[{"url":"/blog/posts/2022/12/advantages-of-integrating-clickhouse-with-hybrid-s3-storage","id":45,"name":"advantages-of-integrating-clickhouse-with-hybrid-s3-storage","date":"2022-12-26T00:00:00Z","description":"","readingTime":15,"image":"/assets/blog/articles/advantages-of-integrating-clickhouse-with-hybrid-s3-storage-small-cover.png","blogPostId":45,"likes":0,"hasUserLike":false,"slug":"","title":"Advantages of integrating ClickHouse® with Hybrid S3 Storage","authors":[],"tags":[],"locale":{"lang":"en"},"textTitle":"Advantages of integrating ClickHouse® with Hybrid S3 Storage","htmlTitle":"Advantages of integrating ClickHouse® with Hybrid S3 Storage"},{"url":"/blog/posts/2023/03/machine-learning-with-clickhouse-and-doublecloud","id":74,"name":"machine-learning-with-clickhouse-and-doublecloud","date":"2023-03-14T00:00:00Z","description":"Written by: Adam Jennings, DoubleCloud Solution Architect","readingTime":15,"image":"/assets/blog/articles/machine-learning-with-clickhouse-and-doublecloud-small-cover.png","blogPostId":74,"likes":0,"hasUserLike":false,"slug":"","title":"Machine learning with ClickHouse and DoubleCloud","authors":[],"tags":[],"locale":{"lang":"en"},"textTitle":"Machine learning with ClickHouse and DoubleCloud","htmlTitle":"Machine learning with ClickHouse and DoubleCloud"},{"url":"/blog/posts/2023/04/clickhouse-as-storage-engine-for-mysql","id":92,"name":"clickhouse-as-storage-engine-for-mysql","date":"2023-04-24T00:00:00Z","description":"Written By: Stefan Kaeser, DoubleCloud Senior Solution Architect","readingTime":10,"image":"/assets/blog/articles/clickhouse-as-storage-engine-for-mysql-small-cover.jpg","blogPostId":92,"likes":0,"hasUserLike":false,"slug":"","title":"ClickHouse as storage engine for MySQL? An experimental approach","authors":[],"tags":[],"locale":{"lang":"en"},"textTitle":"ClickHouse as storage engine for MySQL? An experimental approach","htmlTitle":"ClickHouse as storage engine for MySQL? An experimental approach"}]}},"navigationData":{"newMenu":true,"header":{"leftItems":[{"text":"Why DoubleCloud","type":"dc-dropdown","data":{"view":"list","groups":[{"items":[{"text":"Performance","url":"/performance-boost/","description":"Get the best performance with the highest ROI"},{"text":"Security","url":"/security/","description":"Keep your data protected and maintain compliance"},{"text":"DoubleCloud vs. other solutions","url":"/comparison/","description":"Learn how DoubleCloud’s products compare to other solutions"},{"text":"Customer stories","url":"/resources/case-studies/","description":"See our solutions in action"}]},{"image":{"src":"/assets/doublecloud/menu-bar/menu-banner-dc-results.png.webp","style":{"width":300,"height":300}},"text":"\u003ca href='/performance-boost/' target='_self'\u003eGet more and spend less with DoubleCloud  →\u003c/a\u003e"}]}},{"text":"Products","type":"dc-dropdown","metaSchema":{"@graph":[{"@type":"SoftwareApplication","sameAs":["https://twitter.com/getdoublecloud","https://www.youtube.com/@doublecloud2499","https://www.linkedin.com/company/doublecloudplatform/","https://www.facebook.com/GetDoubleCloud/"]},{"@context":"https://schema.org","@type":"Organization","foundingDate":2022,"contactPoint":{"@type":"ContactPoint","contactType":"customer support","telephone":"+1 302-658-7581","email":"info@double.cloud"},"sameAs":["https://twitter.com/getdoublecloud","https://www.youtube.com/@doublecloud2499","https://www.linkedin.com/company/doublecloudplatform/","https://www.facebook.com/GetDoubleCloud/"]}]},"data":{"items":[{"text":"Managed Service for ClickHouse®","url":"/services/managed-clickhouse/","icon":"/assets/icons/dc-clickhouse.svg","description":"The fastest, most resource-efficient OLAP database for real-time analytics"},{"text":"Managed Service for Apache Kafka®","url":"/services/managed-kafka/","icon":"/assets/icons/dc-kafka.svg","description":"A leading data streaming technology for large-scale, data-intensive applications"},{"text":"Managed Service for Apache Airflow®","url":"/services/managed-airflow/","icon":"/assets/icons/dc-airflow.svg","description":"Open-source tool to orchestrate and monitor workflows"},{"text":"Data Transfer","url":"/services/doublecloud-transfer/","icon":"/assets/icons/dc-transfer.svg","description":"No-code ELT tool for aggregating, collecting, and migrating data"},{"text":"Data Visualization","url":"/services/doublecloud-visualization/","icon":"/assets/icons/dc-data-vis.svg","description":"Free tool to create, modify, and share dashboards and charts"}]}},{"text":"Solutions","type":"dc-dropdown","data":{"view":"list","groups":[{"title":"By use case","items":[{"text":"Customer-facing analytics","url":"/solutions/customer-facing-analytics/","description":"Provide business insights for your clients or partners"},{"text":"Real-time analytics","url":"/solutions/real-time-analytics/","description":"Build a data infrastructure to collect, process, and analyze data in real time"},{"text":"Observability and monitoring","url":"/solutions/observability-and-monitoring/","description":"Analyze terabytes of your logs, events, and traces with ease"}]},{"title":"By industry","items":[{"text":"AdTech and MarTech data analytics","url":"/solutions/adtech/","description":"Extract and analyze data from Meta ads, Google ads, LinkedIn ads, and others"},{"text":"Analytics for mobile and gaming apps","url":"/solutions/web-mobile-gaming-apps/","description":"Optimize and scale your mobile and gaming app analytics"},{"text":"EdTech data analytics","url":"/solutions/edtech/","description":"Improve online learning and identify new sales opportunities"},{"text":"FinTech data analytics","url":"/solutions/fintech-real-time-analytics/","description":"Manage and process large amounts of financial data efficiently"}]}]}},{"text":"Resources","type":"dc-dropdown","data":{"view":"list","groups":[{"title":"Using DoubleCloud","items":[{"text":"DoubleCloud API","url":"/docs/en/public-api/","description":"Read up on API tutorials and instructions","target":"_self"},{"text":"Terraform","url":"/docs/en/developer-resources/terraform/create-resources","description":"Deploy and manage cloud resources with the infrastructure-as-code approach"},{"text":"Status updates","url":"https://status.double.cloud/","description":"Check the current operational status of our services"},{"text":"Support","url":"/support/","description":"Learn more about our support tiers"}]},{"title":"Discover","items":[{"text":"Webinars","url":"/webinars/","description":"Sign up for the next webinar or watch previous ones"},{"text":"Blog","url":"/blog/","description":"Get insights from our team and the latest news"}]},{"image":{"src":"/assets/doublecloud/menu-bar/menu-banners-dc-ebook.png.webp","style":{"width":300,"height":300}},"text":"\u003ca href='/resources/clickhouse-ebook/' target='_self'\u003eGrab your ebook  →\u003c/a\u003e"}]}},{"text":"Company","type":"dc-dropdown","data":{"items":[{"text":"About DoubleCloud","url":"/company/about-us/"},{"text":"Careers","url":"/company/careers/"},{"text":"Contact us","url":"/company/contact-us/"}]}},{"text":"Pricing","url":"/pricing/"},{"text":"Documentation","url":"/docs/en/","target":"_self"}],"rightItems":[{"type":"button","text":"Slack","url":"https://join.slack.com/t/double-cloud/shared_invite/zt-1pbz9lfte-5GoIX~8CmVYqmVQfRFPNdA","img":"/assets/icons/slack.svg","theme":"flat"},{"type":"button","text":"Contact us","theme":"flat","url":"#contact-us-form"},{"type":"button","text":"Console","url":"https://app.double.cloud","theme":"accent"}]},"logo":{"icon":"/assets/logo/dc-logo-dark.svg","text":""},"footer":{"subscriptionForm":{"header":"Subscribe to our newsletter","footer":"By submitting this form, you agree to our \u003ca href=\"/legal/en/privacy/\"\u003ePrivacy policy\u003c/a\u003e","form":{"scriptSrc":"//js-eu1.hsforms.net/forms/embed/v2.js","region":"eu1","portalId":"25659674","formId":"b9015518-c7ea-4173-a96b-a251994635e3"}},"underline":{"links":[{"text":"Customer Agreement","url":"/legal/en/customer_agreement/","target":"_blank"},{"text":"Privacy Policy","url":"/legal/en/privacy/","target":"_blank"},{"text":"Pricing","url":"/pricing/"},{"text":"Security","url":"/security/","target":"_blank"}],"copyright":"© 2024 DoubleCloud"},"columns":[{"title":"Products","links":[{"text":"Managed Service for ClickHouse®","url":"/services/managed-clickhouse/"},{"text":"Managed Service for Apache Kafka®","url":"/services/managed-kafka/"},{"text":"Managed Service for Apache Airflow®","url":"/services/managed-airflow"},{"text":"Data Transfer","url":"/services/doublecloud-transfer/"},{"text":"Data Visualization","url":"/services/doublecloud-visualization"}]},{"title":"Solutions","links":[{"text":"Case studies","url":"/resources/case-studies/"},{"text":"Customer-facing analytics","url":"/solutions/customer-facing-analytics/"},{"text":"Real-time analytics","url":"/solutions/real-time-analytics/"},{"text":"Observability and monitoring","url":"/solutions/observability-and-monitoring/"},{"text":"AdTech and MarTech data analytics","url":"/solutions/adtech/"},{"text":"Analytics for mobile and gaming Apps","url":"/solutions/web-mobile-gaming-apps/"},{"text":"EdTech data analytics","url":"/solutions/edtech/"},{"text":"FinTech data analytics","url":"/solutions/fintech-real-time-analytics/"}]},{"title":"Resources","links":[{"text":"Documentation","url":"/docs/en/"},{"text":"Webinars","url":"/webinars/"},{"text":"Blog","url":"/blog/"},{"text":"Slack","url":"https://join.slack.com/t/double-cloud/shared_invite/zt-1pbz9lfte-5GoIX~8CmVYqmVQfRFPNdA"},{"text":"Support","url":"/support/"},{"text":"Status updates","url":"https://status.double.cloud/"},{"text":"Product comparisons","url":"/comparison/"},{"text":"Site map","url":"/sitemap/"}]},{"title":"Company","links":[{"text":"About DoubleCloud","url":"/company/about-us/"},{"text":"Careers","url":"/company/careers"},{"text":"AWS Partnership","url":"/aws-partnership/"},{"text":"Contact us","url":"/company/contact-us/"}]}]},"forms":{"contact":"11819433.daba96b39df83b7903708cc4842e9dbb9c944cce"},"favicon":{"folder":"/assets/favicon"},"analytics":{"id":"GTM-5M39N8J","ignore":true,"popup":{"text":"\u003cp\u003eBy\u0026nbsp;clicking \u0026ldquo;Accept\u0026rdquo;, you agree to\u0026nbsp;the storing of\u0026nbsp;cookies on\u0026nbsp;your device to\u0026nbsp;help us\u0026nbsp;analyze site usage and assist in\u0026nbsp;our marketing efforts. However, you may \u0026ldquo;Decline\u0026rdquo; that. More details here in\u0026nbsp;\u003ca href=\"/legal/en/privacy/\"\u003ePrivacy Policy\u003c/a\u003e\u003c/p\u003e","buttons":{"accept":{"size":"xl","text":"Accept"},"decline":{"size":"xl","text":"Decline"}}}}},"meta":{"title":"How S3-based ClickHouse hybrid storage works under the hood | DoubleCloud","date":"2022-11-25T00:00:00Z","image":"/assets/blog/articles/new-sharing-images/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-sharing.png","canonicalUrl":"","organization":{"appTitle":"DoubleCloud","legalName":"DoubleCloud Inc","supportEmail":"","url":"https://double.cloud"},"description":"","content":"\u003cp\u003eIn\u0026nbsp;this article, we\u0026rsquo;ll talk about:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#conservative-approach\"\u003eThe conservative approach\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#alternate-approach\"\u003eThe alternate approach\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#managing-s3\"\u003eManaging data in\u0026nbsp;S3\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#limitations\"\u003eClickHouse limitations with S3 data operations\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#caching\"\u003eCaching\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#operations-log-in-hybrid-storage\"\u003eOperations log in\u0026nbsp;hybrid storage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#backups\"\u003eBackups\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#hybrid-storage\"\u003eHybrid storage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#replication\"\u003eReplication\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#zero-copy-replication\"\u003eZero-copy replication\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#zero-copy-imitations-and-issues\"\u003eZero-copy limitations and issues\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#final-thoughts\"\u003eFinal thoughts\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cem\u003eWritten by\u0026nbsp;Anton Ivashkin, DoubleCloud Dev lead for ClickHouse service.\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eEveryone knows that ClickHouse is\u0026nbsp;extremely fast at\u0026nbsp;processing a\u0026nbsp;lot of\u0026nbsp;data. A\u0026nbsp;dataset may reach tens/hundreds of\u0026nbsp;terabytes or\u0026nbsp;even a\u0026nbsp;hundred petabytes. Of\u0026nbsp;course, this data needs to\u0026nbsp;be\u0026nbsp;stored somewhere with the following core requirements: cost-efficiency, high speed, accessibility, security, and reliability. S3 or\u0026nbsp;object storage is\u0026nbsp;a\u0026nbsp;perfect match, but the only critical point it\u0026nbsp;lacks is\u0026nbsp;speed. Therefore, we\u0026nbsp;built a\u0026nbsp;hybrid approach where you can fuse the speed of\u0026nbsp;SSD disks and the affordability of\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eOur team at\u0026nbsp;DoubleCloud started developing the S3 hybrid storage feature a\u0026nbsp;year ago, and it\u0026nbsp;was successfully merged in\u0026nbsp;version 22.3 on\u0026nbsp;April 18, 2022\u0026nbsp;with further fixes and optimizations in\u0026nbsp;the version 22.8. It\u0026nbsp;was widely accepted by\u0026nbsp;the community and Clickhouse team primarily because compute is\u0026nbsp;now decoupled from the storage. We\u0026nbsp;see a\u0026nbsp;reduction from 3-5 times in\u0026nbsp;storage cost in\u0026nbsp;those scenarios where hybrid storage is\u0026nbsp;applicable, and that\u0026rsquo;s a\u0026nbsp;real game changer for scenarios like logs, metrics, traces, or\u0026nbsp;other data scenarios where users primarily work with fresh data and the rest is\u0026nbsp;stored for rare cases.\u003c/p\u003e\n\u003cp\u003eBelow I\u0026nbsp;will describe how it\u0026rsquo;s working under the hood and on\u0026nbsp;what principles it\u0026rsquo;s based.\u003c/p\u003e\n\u003ch2 id=\"conservative-approach\"\u003e\u003ca href=\"#conservative-approach\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eThe conservative approach\u003c/span\u003e\u003c/a\u003eThe conservative approach\u003c/h2\u003e\n\u003cp\u003eThe classical approach is\u0026nbsp;to\u0026nbsp;use a\u0026nbsp;sharded ClickHouse cluster. Let\u0026rsquo;s say the data is\u0026nbsp;100\u0026nbsp;TB, and there is\u0026nbsp;10\u0026nbsp;TB\u0026nbsp;of\u0026nbsp;storage space available on\u0026nbsp;each\u0026nbsp;VM. Then a\u0026nbsp;perfect partitioning would require ten shards, with two replicated nodes per shard. This requirement adds up\u0026nbsp;to\u0026nbsp;20\u0026nbsp;machines. However, it\u0026rsquo;s only sometimes the case that the data gets evenly split, so\u0026nbsp;you can safely multiply that number by\u0026nbsp;one and a\u0026nbsp;half.\u003c/p\u003e\n\u003cp\u003ePlus, ClickHouse works sub-optimally when the storage has no\u0026nbsp;free space. With read-only data, which is\u0026nbsp;completely frozen, you can still manage, but if\u0026nbsp;the new data flows in\u0026nbsp;regularly, you must have at\u0026nbsp;least 10\u0026nbsp;percent more free space for it\u0026nbsp;to\u0026nbsp;work correctly.\u003c/p\u003e\n\u003cp\u003eNow we\u0026nbsp;face the need to\u0026nbsp;run 30+ machines, which is\u0026nbsp;quite significant. In\u0026nbsp;this case, most VMs will use only disk space, and the CPU and RAM will be\u0026nbsp;almost idle.\u003c/p\u003e\n\u003cp\u003eOf\u0026nbsp;course, there are situations when there is\u0026nbsp;a\u0026nbsp;large flow of\u0026nbsp;requests, and other resources will get their share of\u0026nbsp;the load, but according to\u0026nbsp;our data on\u0026nbsp;clusters with 10+ shards, they tend to\u0026nbsp;be\u0026nbsp;indefinitely idle.\u003c/p\u003e\n\n\u003ch2 id=\"alternate-approach\"\u003e\u003ca href=\"#alternate-approach\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eThe alternate approach\u003c/span\u003e\u003c/a\u003eThe alternate approach\u003c/h2\u003e\n\u003cp\u003eClickHouse can use S3-compatible storage. The advantages of\u0026nbsp;this approach are the following:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eAlmost unlimited capacity,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSignificantly lower cost than dedicated VMs with the same amount of\u0026nbsp;disk space.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe main disadvantage is\u0026nbsp;that S3-compatible storage is\u0026nbsp;a\u0026nbsp;network resource, so\u0026nbsp;the speed of\u0026nbsp;access to\u0026nbsp;data, as\u0026nbsp;a\u0026nbsp;consequence, increases the time of\u0026nbsp;operations.\u003c/p\u003e\n\n\u003cp\u003eLet\u0026rsquo;s see how it\u0026nbsp;works. An\u0026nbsp;IDisk interface provides methods for basic file operations such as\u0026nbsp;create, copy, rename, delete, etc. The ClickHouse engine works with that interface. Most of\u0026nbsp;the time, it\u0026nbsp;doesn\u0026rsquo;t matter what\u0026rsquo;s under the hood. There are implementations for specific storage methods:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003elocal disk (\u003ccode\u003eDiskLocal\u003c/code\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ein-memory storage (\u003ccode\u003eDiskMemory\u003c/code\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ecloud storage (\u003ccode\u003eDiskObjectStorage\u003c/code\u003e).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe latter implements logic for storing data in\u0026nbsp;different types of\u0026nbsp;storage, notably in\u0026nbsp;S3.\u003cbr /\u003e\nThe other storages are HDFS and MS\u0026nbsp;Azure. They\u0026rsquo;re similar conceptually, but for now let\u0026rsquo;s focus on\u0026nbsp;S3.\u003c/p\u003e\n\u003ch3 id=\"managing-s3\"\u003e\u003ca href=\"#managing-s3\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eManaging data in\u0026nbsp;S3\u003c/span\u003e\u003c/a\u003eManaging data in\u0026nbsp;S3\u003c/h3\u003e\n\u003cp\u003eWhen the engine wants to\u0026nbsp;\u0026ldquo;create a\u0026nbsp;file\u0026rdquo; on\u0026nbsp;an\u0026nbsp;S3 disk, it\u0026nbsp;creates an\u0026nbsp;object in\u0026nbsp;S3 with a\u0026nbsp;random name, writes a\u0026nbsp;data stream to\u0026nbsp;it\u0026nbsp;and creates a\u0026nbsp;metadata file on\u0026nbsp;the local disk with the name, size and some other information. The size of\u0026nbsp;such a\u0026nbsp;local metadata file is\u0026nbsp;tens of\u0026nbsp;bytes.\u003c/p\u003e\n\u003cp\u003eThen operations such as\u0026nbsp;renaming and creating hard links are performed only on\u0026nbsp;the local metadata file, while the object on\u0026nbsp;S3 remains untouched.\u003c/p\u003e\n\u003cp\u003eS3 doesn\u0026rsquo;t provide a\u0026nbsp;straightforward way to\u0026nbsp;modify created S3 objects. For example, the renaming operation is\u0026nbsp;a\u0026nbsp;load-intensive procedure to\u0026nbsp;create a\u0026nbsp;new object. The above scheme with a\u0026nbsp;small local metadata file allows you to\u0026nbsp;bypass this limitation.\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3 ls s3:\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003edouble\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ecloud\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003estorage\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003ecloud_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es1\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e bpmwovnptyvtbxrxpaixgnjhgsjfekwd\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e enmwkqfptmghyxzxhiczjgpkhzsvexgi\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e mjgumajoilbkcpnvlbbglgajrkvqbpea\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e aoazgzkryvhceolzichwyprzsmjotkw\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e xiyltehvfxbkqbnytyjwbsmyafgjscwg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e235\u003c/span\u003e ickdlneqkzcrgpeokcubmkwtyyayukmg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e65\u003c/span\u003e lyggepidqbgyxqwzsfoxltxpbfbehrqy\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e60\u003c/span\u003e ytfhoupmfahdakydbfumxxkqgloakanh\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e tddzrmzildnwtmvescmbkhqzhoxwoqmq\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"35\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-35\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-35\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-35.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# ls \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003el \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003evar\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003elib\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eclickhouse\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003edisks\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eobject_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003estore\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e133\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e13344\u003c/span\u003eeec\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ed80a\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003ea5b\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eb99d\u003cspan class=\"hljs-number\"\u003e-6177\u003c/span\u003ef144e62a\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e_0_0_0\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\ntotal \u003cspan class=\"hljs-number\"\u003e36\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 120 Nov 21 12:32 checksums.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 columns.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 count.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 data.bin\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 data.mrk3\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 118 Nov 21 12:32 default_compression_codec.txt\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 minmax_key.idx\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 partition.dat\u003c/span\u003e\n\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erw\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003er\u003cspan class=\"hljs-comment\"\u003e----- 1 clickhouse clickhouse 116 Nov 21 12:32 primary.idx\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"36\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-36\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-36\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-36.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# cat \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003evar\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003elib\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eclickhouse\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003edisks\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eobject_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003estore\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e133\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e13344\u003c/span\u003eeec\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ed80a\u003cspan class=\"hljs-number\"\u003e-4\u003c/span\u003ea5b\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eb99d\u003cspan class=\"hljs-number\"\u003e-6177\u003c/span\u003ef144e62a\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e_0_0_0\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003edata.mrk3\n\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e                                       # [metadata file format version]\n\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e                                 # [objects count] [total size]\n\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e    enmwkqfptmghyxzxhiczjgpkhzsvexgi  # [object size] [object name]\n\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e                                       # [reference count]\n\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e                                       # [readonly flag]\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"37\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-37\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-37\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-37.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eA\u0026nbsp;separate operation is\u0026nbsp;adding data to\u0026nbsp;the file. As\u0026nbsp;mentioned earlier, S3 doesn\u0026rsquo;t allow changing objects after creation, so\u0026nbsp;we\u0026nbsp;create another object to\u0026nbsp;which a\u0026nbsp;new portion of\u0026nbsp;data is\u0026nbsp;added. The name of\u0026nbsp;this object is\u0026nbsp;written in\u0026nbsp;the metadata file mentioned earlier, and it\u0026nbsp;starts referring to\u0026nbsp;multiple objects.\u003c/p\u003e\n\u003cp\u003ePlease note that such operation in\u0026nbsp;ClickHouse is\u0026nbsp;performed only for \u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/log-family/\" target=\"_blank\"\u003eLog family engines\u003c/a\u003e, which almost nobody uses. In\u0026nbsp;the popular \u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003eMergeTree engine\u003c/a\u003e, the file is\u0026nbsp;created once and is\u0026nbsp;never modified again.\u003c/p\u003e\n\u003cp\u003eFor some operations, such as\u0026nbsp;mutation, the engine creates a\u0026nbsp;new part with a\u0026nbsp;new structure when adding a\u0026nbsp;new column. However, as\u0026nbsp;some data doesn\u0026rsquo;t change, we\u0026nbsp;use the operation to\u0026nbsp;create hard links to\u0026nbsp;the old ones instead of\u0026nbsp;copying them. Only the local metadata file is\u0026nbsp;linked, where, among other things, we\u0026nbsp;store the link counter, which increases with this operation.\u003c/p\u003e\n\u003ch4 id=\"limitations\"\u003e\u003ca href=\"#limitations\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eClickHouse limitations with S3 data operations\u003c/span\u003e\u003c/a\u003eClickHouse limitations with S3 data operations\u003c/h4\u003e\n\u003cp\u003eWhen you perform the deletion, the engine decrements the link count and deletes the local metadata file, and if\u0026nbsp;this is\u0026nbsp;the last hard link to\u0026nbsp;the deleted file, it\u0026nbsp;possibly removes the object in\u0026nbsp;S3. We\u0026rsquo;ll get back to\u0026nbsp;why it\u0026rsquo;s possible when discussing replication.\u003c/p\u003e\n\u003cp\u003eClickHouse doesn\u0026rsquo;t use such manipulations as\u0026nbsp;data replacement in\u0026nbsp;the middle of\u0026nbsp;the file. Thus, it\u0026nbsp;wasn\u0026rsquo;t implemented.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s elaborate on\u0026nbsp;two more points.\u003c/p\u003e\n\u003cp\u003eThe first one is\u0026nbsp;that the object\u0026rsquo;s name in\u0026nbsp;S3 is\u0026nbsp;random. It\u0026rsquo;s pretty inconvenient because it\u0026nbsp;isn\u0026rsquo;t clear from the object itself what it\u0026nbsp;is. Below we\u0026rsquo;ll talk about the operations log, it\u0026rsquo;s a\u0026nbsp;mechanism that allows us\u0026nbsp;to\u0026nbsp;streamline things somewhat, but it\u0026rsquo;s not perfect either.\u003c/p\u003e\n\u003cp\u003eThe second point is\u0026nbsp;that storing the count of\u0026nbsp;hard links in\u0026nbsp;the metadata file seems unnecessary since we\u0026nbsp;can obtain it\u0026nbsp;from the file system. But in\u0026nbsp;the case of\u0026nbsp;manual manipulation of\u0026nbsp;local files past ClickHouse, the link could get broken. In\u0026nbsp;this case, both copies would have an\u0026nbsp;increased counter, which wouldn\u0026rsquo;t allow the object to\u0026nbsp;be\u0026nbsp;deleted in\u0026nbsp;S3 when one of\u0026nbsp;the copies is\u0026nbsp;deleted. Deleting the second one won\u0026rsquo;t delete it\u0026nbsp;either, but it\u0026rsquo;s better to\u0026nbsp;leave the garbage on\u0026nbsp;S3 than lose the needed data.\u003c/p\u003e\n\u003cp\u003eWhen a\u0026nbsp;local metadata file is\u0026nbsp;read, it\u0026nbsp;learns the name of\u0026nbsp;the object or\u0026nbsp;objects in\u0026nbsp;S3, and S3 requests the desired portion of\u0026nbsp;data. It\u0026nbsp;helps that S3 allows you to\u0026nbsp;download a\u0026nbsp;fragment of\u0026nbsp;an\u0026nbsp;object by\u0026nbsp;offset and size.\u003c/p\u003e\n\u003ch4 id=\"сaching\"\u003e\u003ca href=\"#сaching\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eCaching\u003c/span\u003e\u003c/a\u003eCaching\u003c/h4\u003e\n\u003cp\u003eIn\u0026nbsp;the \u003ca href=\"https://clickhouse.com/docs/en/whats-new/changelog/\" target=\"_blank\"\u003elatest ClickHouse versions\u003c/a\u003e, we\u0026nbsp;can cache data downloaded from object storage. We\u0026nbsp;can add data into the cache while writing with a\u0026nbsp;separate option. It\u0026nbsp;can speed up\u0026nbsp;requests execution when different requests access the same data. Within one request, repeated reading of\u0026nbsp;the same data doesn\u0026rsquo;t occur. This functionality is\u0026nbsp;built into the engine. However, the cache size is\u0026nbsp;limited, so\u0026nbsp;the best choice depends on\u0026nbsp;your case.\u003c/p\u003e\n\u003ch4 id=\"operations-log-in-hybrid-storage\"\u003e\u003ca href=\"#operations-log-in-hybrid-storage\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eOperations log in\u0026nbsp;hybrid storage\u003c/span\u003e\u003c/a\u003eOperations log in\u0026nbsp;hybrid storage\u003c/h4\u003e\n\u003cp\u003eThere is\u0026nbsp;a\u0026nbsp;default \u003ccode\u003esend_metadata\u003c/code\u003e setting, which is\u0026nbsp;disabled by\u0026nbsp;default. ClickHouse keeps a\u0026nbsp;counter of\u0026nbsp;operations, which increments with each operation of\u0026nbsp;file creation, renaming and hard link creation.\u003c/p\u003e\n\u003cp\u003eWhen creating, the operation number is\u0026nbsp;added to\u0026nbsp;the object name in\u0026nbsp;binary form, and S3 metadata (not to\u0026nbsp;be\u0026nbsp;confused with the local metadata file, we\u0026nbsp;have a\u0026nbsp;certain deficit in\u0026nbsp;terminology here) is\u0026nbsp;added to\u0026nbsp;the object, in\u0026nbsp;which the original file name is\u0026nbsp;written.\u003c/p\u003e\n\u003cp\u003eWhen renaming and hard linking, a\u0026nbsp;special small object is\u0026nbsp;created in\u0026nbsp;S3, whose name also contains the operation number and whose S3 metadata records from which local name to\u0026nbsp;which a\u0026nbsp;hard link was renamed or\u0026nbsp;created.\u003c/p\u003e\n\u003cp\u003eWhen performing the deletion, the operation counter isn\u0026rsquo;t incremented after the object is\u0026nbsp;deleted. It\u0026nbsp;allows you to\u0026nbsp;restore local metadata\u0026nbsp;\u0026mdash; S3 queries the complete list of\u0026nbsp;objects containing data. It\u0026nbsp;enables you to\u0026nbsp;recover the original name using the S3 metadata, then rename and hard link operations are applied to\u0026nbsp;the existing files. It\u0026rsquo;s triggered by\u0026nbsp;creating a\u0026nbsp;special file before the disk starts.\u003c/p\u003e\n\u003cp\u003eThis mechanism allows to\u0026nbsp;perform not all operations but only up\u0026nbsp;to\u0026nbsp;some revision, which can be\u0026nbsp;used for backups.\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3 ls s3:\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003edouble\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ecloud\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003estorage\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003ecloud_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es1\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n             PRE operations\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e .SCHEMA_VERSION\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000001\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ebpmwovnptyvtbxrxpaixgnjhgsjfekwd\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e58\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000010\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eenmwkqfptmghyxzxhiczjgpkhzsvexgi\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000011\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003emjgumajoilbkcpnvlbbglgajrkvqbpea\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000100\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaaoazgzkryvhceolzichwyprzsmjotkw\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000101\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003exiyltehvfxbkqbnytyjwbsmyafgjscwg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e235\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000110\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eickdlneqkzcrgpeokcubmkwtyyayukmg\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e65\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000111\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003elyggepidqbgyxqwzsfoxltxpbfbehrqy\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e60\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000001000\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eytfhoupmfahdakydbfumxxkqgloakanh\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000001001\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003efile\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003etddzrmzildnwtmvescmbkhqzhoxwoqmq\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"92\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-92\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-92\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-92.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3api head\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eobject \u003cspan class=\"hljs-comment\"\u003e--bucket double-cloud-storage-chc8d6h0ehe98li0k4sn --key cloud_storage/chc8d6h0ehe98li0k4sn/s1/r0000000000000000000000000000000000000000000000000000000000000010-file-enmwkqfptmghyxzxhiczjgpkhzsvexgi\u003c/span\u003e\n{\n  \"AcceptRanges\": \"bytes\",\n  \"LastModified\": \"Mon, 21 Nov 2022 12:32:58 GMT\",\n  \"ContentLength\": \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e,\n  \"ETag\": \"\\\"fbc2bf6ed653c03001977f21a1416ace\\\"\",\n  \"ContentType\": \"binary/octet-stream\",\n  \"Metadata\": {\n      \"path\": \"store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/moving/2_0_0_0/data.mrk3\"\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"93\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-93\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-93\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-93.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3 ls s3:\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003edouble\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003ecloud\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003estorage\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003ecloud_storage\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003echc8d6h0ehe98li0k4sn\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003es1\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003eoperations\u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e33\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e02\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000001\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003each\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eeuc1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaz1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003es1\u003cspan class=\"hljs-number\"\u003e-1.\u003c/span\u003echc8d6h0ehe98li0k4sn.at.yadc.io\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erename\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e33\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e02\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000000010\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003each\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eeuc1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaz1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003es1\u003cspan class=\"hljs-number\"\u003e-1.\u003c/span\u003echc8d6h0ehe98li0k4sn.at.yadc.io\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erename\n\u003cspan class=\"hljs-number\"\u003e2022\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-11\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e-21\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59\u003c/span\u003e      \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e r0000000000000000000000000000000000000000000000000000000000001010\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003each\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eeuc1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eaz1\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003es1\u003cspan class=\"hljs-number\"\u003e-1.\u003c/span\u003echc8d6h0ehe98li0k4sn.at.yadc.io\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003erename\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"94\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-94\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-94\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-94.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e# aws s3api head\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003eobject \u003cspan class=\"hljs-comment\"\u003e--bucket double-cloud-storage-chc8d6h0ehe98li0k4sn --key cloud_storage/chc8d6h0ehe98li0k4sn/s1/operations/r0000000000000000000000000000000000000000000000000000000000001010-ach-euc1-az1-s1-1.chc8d6h0ehe98li0k4sn.at.yadc.io-rename\u003c/span\u003e\n{\n  \"AcceptRanges\": \"bytes\",\n  \"LastModified\": \"Mon, 21 Nov 2022 12:32:59 GMT\",\n  \"ContentLength\": \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\n  \"ETag\": \"\\\"cfcd208495d565ef66e7dff9f98764da\\\"\",\n  \"ContentType\": \"binary/octet-stream\",\n  \"Metadata\": {\n      \"to_path\": \"store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/2_0_0_0/\",\n      \"from_path\": \"store/133/13344eec-d80a-4a5b-b99d-6177f144e62a/moving/2_0_0_0\"\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"95\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-95\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-95\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-95.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003ch4 id=\"backups\"\u003e\u003ca href=\"#backups\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eBackups\u003c/span\u003e\u003c/a\u003eBackups\u003c/h4\u003e\n\u003cp\u003eOn\u0026nbsp;a\u0026nbsp;live VM\u0026nbsp;and with data on\u0026nbsp;local disks, backups are made by\u0026nbsp;calling \u003ccode\u003eFREEZE TABLE\u003c/code\u003e for each table. This command creates a\u0026nbsp;snapshot of\u0026nbsp;the tables (hard links to\u0026nbsp;all files) in\u0026nbsp;a\u0026nbsp;separate directory so\u0026nbsp;that they can be\u0026nbsp;copied somewhere for the future, then delete the directories manually or\u0026nbsp;via \u003ccode\u003eTABLE UNFREEZE\u003c/code\u003e. It\u0026nbsp;allows you to\u0026nbsp;keep the tables in\u0026nbsp;a\u0026nbsp;consistent (but not atomic) condition.\u003c/p\u003e\n\u003cp\u003eThis option isn\u0026rsquo;t suitable for S3 because only local metadata can be\u0026nbsp;copied this\u0026nbsp;way. Objects in\u0026nbsp;S3 have to\u0026nbsp;be\u0026nbsp;extracted separately.\u003c/p\u003e\n\u003cp\u003eWe\u0026nbsp;use a\u0026nbsp;way that isn\u0026rsquo;t a\u0026nbsp;backup for S3 per se\u0026nbsp;but a\u0026nbsp;snapshot:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eExecute \u003ccode\u003eTABLE FREEZE\u003c/code\u003e,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSave the revision number,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDelete the directory with frozen data once the backup is\u0026nbsp;no\u0026nbsp;longer relevant.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe presence of\u0026nbsp;these hard links prevents ClickHouse from deleting objects in\u0026nbsp;S3. When restoring from the operation log, we\u0026nbsp;restore the state for the desired revision.\u003c/p\u003e\n\u003cp\u003eWhen a\u0026nbsp;backup becomes obsolete, delete the frozen metadata via \u003ccode\u003eUNFREEZE\u003c/code\u003e to\u0026nbsp;correctly delete unnecessary objects in\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eAt\u0026nbsp;the same time, since some tables from the backup may already be\u0026nbsp;deleted in\u0026nbsp;the working version and \u003ccode\u003eTABLE UNFREEZE\u003c/code\u003e cannot be\u0026nbsp;done for them, run the \u003ccode\u003eSYSTEM UNFREEZE\u003c/code\u003e command. It\u0026nbsp;removes all the frozen data from all the tables by\u0026nbsp;backup name and can work with tables that don\u0026rsquo;t exist\u0026nbsp;now. Please note that this mechanism can take a\u0026nbsp;long time to\u0026nbsp;execute if\u0026nbsp;you have a\u0026nbsp;big log of\u0026nbsp;operations. At\u0026nbsp;the moment, an\u0026nbsp;alternative system for creating backups is\u0026nbsp;in\u0026nbsp;development.\u003c/p\u003e\n\u003cp\u003eThe above method isn\u0026rsquo;t a\u0026nbsp;classic backup, the data is\u0026nbsp;in\u0026nbsp;a\u0026nbsp;single object in\u0026nbsp;S3, and its safety relies on\u0026nbsp;the high reliability of\u0026nbsp;cloud storage. For example, in\u0026nbsp;case of\u0026nbsp;a\u0026nbsp;logical error or\u0026nbsp;unauthorized access, you\u0026rsquo;ll lose the data when an\u0026nbsp;object is\u0026nbsp;deleted.\u003c/p\u003e\n\u003cp\u003eWorking with just S3 storage has a\u0026nbsp;disadvantage\u0026nbsp;\u0026mdash; the \u003ccode\u003eMerge\u003c/code\u003e operation. It\u0026nbsp;downloads all the partitions ClickHouse wants to\u0026nbsp;merge and uploads a\u0026nbsp;new higher-level part. If\u0026nbsp;the workflow is\u0026nbsp;not organized correctly, adding new data to\u0026nbsp;already merged large chunks, can generate unexpectedly heavy traffic compared to\u0026nbsp;the data being added.\u003c/p\u003e\n\u003cp\u003eFor example, if\u0026nbsp;S3 has a\u0026nbsp;1\u0026nbsp;Gb\u0026nbsp;partition, and 1\u0026nbsp;kb\u0026nbsp;of\u0026nbsp;new data is\u0026nbsp;added, ClickHouse will download this 1\u0026nbsp;Gb, measure the partitions and upload a\u0026nbsp;new part to\u0026nbsp;S3. As\u0026nbsp;a\u0026nbsp;result, adding a\u0026nbsp;small chunk of\u0026nbsp;data causes significantly more traffic.\u003c/p\u003e\n\u003cp\u003eOne possible solution is\u0026nbsp;to\u0026nbsp;prohibit merges on\u0026nbsp;the S3 disk (\u003ca href=\"https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003eprefer_not_to_merge\u003c/a\u003e setting), but this will cause another problem\u0026nbsp;\u0026mdash; a\u0026nbsp;large number of\u0026nbsp;small parts, which can significantly (sometimes catastrophically) reduce performance for \u003ccode\u003eSELECT\u003c/code\u003e queries. So, in\u0026nbsp;a\u0026nbsp;normal situation, it\u0026rsquo;s better not to\u0026nbsp;use prefer_not_to_merge\u0026nbsp;\u0026mdash; this is\u0026nbsp;a\u0026nbsp;mechanism for serious breakdowns that can lead to\u0026nbsp;fairly negative consequences. In\u0026nbsp;a\u0026nbsp;situation where the data arrives more or\u0026nbsp;less consistently, there will be\u0026nbsp;no\u0026nbsp;network load problems.\u003c/p\u003e\n\u003ch3 id=\"hybrid-storage\"\u003e\u003ca href=\"#hybrid-storage\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eHybrid storage\u003c/span\u003e\u003c/a\u003eHybrid storage\u003c/h3\u003e\n\u003cp\u003eA\u0026nbsp;better solution is\u0026nbsp;hybrid storage. Hybrid storage uses a\u0026nbsp;pair of\u0026nbsp;disks, local and S3. New data is\u0026nbsp;stored on\u0026nbsp;the local disk, gets merged into large parts, and then these parts, which aren\u0026rsquo;t expected to\u0026nbsp;merge further, are sent to\u0026nbsp;S3. In\u0026nbsp;this case, the access speed to\u0026nbsp;local data will be\u0026nbsp;higher, and this approach, in\u0026nbsp;most cases, combines the performance of\u0026nbsp;local disks and the volume of\u0026nbsp;cloud storage. You can configure the move:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eBy\u0026nbsp;data age (\u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003eTTL MOVE TO\u0026nbsp;\u0026hellip;\u003c/a\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eBy\u0026nbsp;the amount of\u0026nbsp;free space on\u0026nbsp;the local disk (\u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/\" target=\"_blank\"\u003emove_factor\u003c/a\u003e),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eMove the data yourself (\u003ca href=\"https://clickhouse.com/docs/en/sql-reference/statements/alter/partition/\" target=\"_blank\"\u003eALTER TABLE MOVE PARTITION\u003c/a\u003e).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSetting up\u0026nbsp;a\u0026nbsp;move by\u0026nbsp;time should be\u0026nbsp;chosen to\u0026nbsp;consider the uniformity of\u0026nbsp;data flow so\u0026nbsp;that the principal amount of\u0026nbsp;merges occur while the data is\u0026nbsp;still on\u0026nbsp;the local drive. Another thing to\u0026nbsp;consider is\u0026nbsp;the need to\u0026nbsp;read data: reading from the local drive will usually be\u0026nbsp;much faster. Thus, it\u0026nbsp;makes sense to\u0026nbsp;transfer cold data to\u0026nbsp;S3, which is\u0026nbsp;expected to\u0026nbsp;be\u0026nbsp;accessed less frequently. It\u0026nbsp;would be\u0026nbsp;best if\u0026nbsp;you also didn\u0026rsquo;t rely on\u0026nbsp;the free space transfer alone, as\u0026nbsp;hot, actively used data may be\u0026nbsp;moved, reducing performance.\u003c/p\u003e\n\u003cp\u003eHowever, note that there is\u0026nbsp;no\u0026nbsp;special mechanism to\u0026nbsp;reduce merge number specifically on\u0026nbsp;S3 apart from a\u0026nbsp;total restriction. So, if\u0026nbsp;new data is\u0026nbsp;added to\u0026nbsp;an\u0026nbsp;old partition already located in\u0026nbsp;S3, the merge operation will involve downloading and uploading. To\u0026nbsp;reduce the number of\u0026nbsp;merges, you can use the \u003ca href=\"/docs/en/managed-clickhouse/settings-reference#maxbytestomergeatmaxspaceinpool\"\u003emaxBytesToMergeAtMaxSpaceInPool\u003c/a\u003e setting, which limits the maximum chunk size, but it\u0026nbsp;applies to\u0026nbsp;all disks with table data, including the local one.\u003c/p\u003e\n\u003cp\u003eAdditionally, the mechanics of\u0026nbsp;using multiple disks aren\u0026rsquo;t limited to\u0026nbsp;this case. For example, you can have a\u0026nbsp;small, fast SSD disk and a\u0026nbsp;larger but slow HDD, or\u0026nbsp;even organize a\u0026nbsp;multi-tiered pie with cloud storage at\u0026nbsp;the end.\u003c/p\u003e\n\u003ch3 id=\"replication\"\u003e\u003ca href=\"#replication\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eReplication\u003c/span\u003e\u003c/a\u003eReplication\u003c/h3\u003e\n\u003cp\u003eBy\u0026nbsp;default, S3 uses the same replication mechanism as\u0026nbsp;for local disks:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eNew data is\u0026nbsp;written to\u0026nbsp;any node, information about the new part is\u0026nbsp;put into ZooKeeper/ClickHouse Keeper (for convenience, we\u0026rsquo;ll refer to\u0026nbsp;both as\u0026nbsp;just \u0026ldquo;Keeper\u0026rdquo;),\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOther nodes from Keeper learn about this,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThey access the node where this data exists and download it\u0026nbsp;from this node (Fetch operation).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eFor S3, the sequence looks as\u0026nbsp;follows:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eThe first node downloaded the part from S3,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node downloaded the part from the first node,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node uploaded the part to\u0026nbsp;S3.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"zero-copy-replication\"\u003e\u003ca href=\"#zero-copy-replication\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eZero-copy replication\u003c/span\u003e\u003c/a\u003eZero-copy replication\u003c/h3\u003e\n\u003cp\u003eThis can be\u0026nbsp;avoided by\u0026nbsp;enabling the zero-copy replication mechanism (\u003ca href=\"https://double.cloud/docs/en/managed-clickhouse/settings-reference\" target=\"_blank\"\u003ethe allowRemoteFsZeroCopyReplication\u003c/a\u003e setting).\u003c/p\u003e\n\u003cp\u003eAs\u0026nbsp;a\u0026nbsp;rule, nodes share the same S3. When the second node requests data from the first one, the first one only sends a\u0026nbsp;small bit of\u0026nbsp;local metadata. The second node checks that it\u0026nbsp;can get data from this metadata (in\u0026nbsp;fact, it\u0026nbsp;only requests the presence of\u0026nbsp;one object); if\u0026nbsp;it\u0026nbsp;does, it\u0026nbsp;stores this metadata and uses the S3 objects together with the first\u0026nbsp;one. If\u0026nbsp;there is\u0026nbsp;no\u0026nbsp;access (different S3 bucket or\u0026nbsp;storage), the full copy of\u0026nbsp;the data from the conservative approach takes place. This mechanism with accessibility testing makes it\u0026nbsp;possible, for example, to\u0026nbsp;move live to\u0026nbsp;another object storage\u0026nbsp;\u0026mdash; two more replicas working with S3-A are added to\u0026nbsp;S3-B, they replicate data to\u0026nbsp;themselves via full copying, and each pair shares objects in\u0026nbsp;its S3.\u003c/p\u003e\n\u003cp\u003eWith zero-copy, each replica additionally marks in\u0026nbsp;the Keeper which parts it\u0026nbsp;uses in\u0026nbsp;S3, and when deleting the last hard link from a\u0026nbsp;node, it\u0026nbsp;checks if\u0026nbsp;someone else uses that data, and if\u0026nbsp;it\u0026nbsp;does, it\u0026nbsp;doesn\u0026rsquo;t touch the object in\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eThis is\u0026nbsp;the case of\u0026nbsp;the \u0026ldquo;object on\u0026nbsp;S3 will probably get deleted\u0026rdquo; we\u0026nbsp;mentioned earlier.\u003c/p\u003e\n\u003ch4 id=\"zero-copy-imitations-and-issues\"\u003e\u003ca href=\"#zero-copy-imitations-and-issues\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eZero-copy limitations and issues\u003c/span\u003e\u003c/a\u003eZero-copy limitations and issues\u003c/h4\u003e\n\u003cp\u003eThe zero-copy mechanism isn\u0026rsquo;t yet considered production-ready; sometimes, there are bugs. The last example, which is\u0026nbsp;already fixed in\u0026nbsp;recent versions\u0026nbsp;\u0026mdash; is\u0026nbsp;the case of\u0026nbsp;double replication during mutations.\u003c/p\u003e\n\u003cp\u003eWhen one node creates a\u0026nbsp;part, the following happens:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node replicates it,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eA\u0026nbsp;mutation is\u0026nbsp;run on\u0026nbsp;the part, resulting in\u0026nbsp;a\u0026nbsp;new part with hard links to\u0026nbsp;the original data,\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe second node replicates the new part.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAt\u0026nbsp;the same time, the second node knows nothing about the connections between these parts.\u003c/p\u003e\n\u003cp\u003eIf\u0026nbsp;the first node deletes the old part before, the second node at\u0026nbsp;the moment of\u0026nbsp;deletion will decide that it\u0026rsquo;s deleting the last local link to\u0026nbsp;the objects. As\u0026nbsp;a\u0026nbsp;result, it\u0026rsquo;ll get information from the Keeper that no\u0026nbsp;one else uses objects of\u0026nbsp;this part, and thus, it\u0026rsquo;ll delete objects in\u0026nbsp;S3.\u003c/p\u003e\n\u003cp\u003eAs\u0026nbsp;stated above, this bug has already been fixed, and we\u0026nbsp;have been using zero-copy in\u0026nbsp;our solution for a\u0026nbsp;long time.\u003c/p\u003e\n\n\u003ch2 id=\"final-thoughts\"\u003e\u003ca href=\"#final-thoughts\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eFinal thoughts\u003c/span\u003e\u003c/a\u003eFinal thoughts\u003c/h2\u003e\n\u003cp\u003eWe\u0026nbsp;also see that that community has started to\u0026nbsp;add other object storage providers like \u003ca href=\"https://github.com/ClickHouse/ClickHouse/issues/29430\" target=\"_blank\"\u003eAzure blob storage developed\u003c/a\u003e by\u0026nbsp;our friends from Content Square, which once again showed us\u0026nbsp;that we\u0026nbsp;are moving in\u0026nbsp;the right direction.\u003c/p\u003e\n\u003cp\u003eSmall note about the availability of\u0026nbsp;that feature at\u0026nbsp;DoubleCloud. All clusters at\u0026nbsp;DoubleCloud already have S3-based hybrid storage by\u0026nbsp;default; you don\u0026rsquo;t need to\u0026nbsp;provision or\u0026nbsp;set up\u0026nbsp;anything additional. \u003ca href=\"https://double.cloud/docs/en/managed-clickhouse/step-by-step/use-hybrid-storage\" target=\"_blank\"\u003eJust create a\u0026nbsp;table\u003c/a\u003e with your preferred hybrid storage profile, and you are ready to\u0026nbsp;go.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"mailto:viktor@double.cloud\" target=\"_blank\"\u003eContact our architects\u003c/a\u003e to\u0026nbsp;find out how to\u0026nbsp;apply this approach to\u0026nbsp;your project or\u0026nbsp;even if\u0026nbsp;you are looking for help setting up\u0026nbsp;and using that functionality and want to\u0026nbsp;chat with us.\u003c/p\u003e\n\u003cp\u003eClickHouse\u0026reg; is\u0026nbsp;a\u0026nbsp;trademark of\u0026nbsp;ClickHouse, Inc. \u003ca href=\"https://clickhouse.com/\" target=\"_blank\"\u003ehttps://clickhouse.com\u003c/a\u003e\u003c/p\u003e\n","sharing":{"title":"How S3-based ClickHouse hybrid storage works under the hood","description":"","image":"/assets/blog/articles/new-sharing-images/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-sharing.png","shareGenImage":"","shareGenTitle":"How S3-based ClickHouse hybrid storage works under the hood"},"keywords":[],"noIndex":false,"authors":[],"tags":[{"icon":null,"slug":"insights","name":"Insights","createdAt":"","updatedAt":"","count":0},{"icon":null,"slug":"ClickHouse","name":"ClickHouse","createdAt":"","updatedAt":"","count":0}],"metaSchema":{"@context":"https://schema.org","@graph":[{"@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"insights","name":"Insights"}},{"@type":"ListItem","position":2,"item":{"@id":"ClickHouse","name":"ClickHouse"}}]},{"@type":"BlogPosting","@id":"https://double.cloud/blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood/","url":"https://double.cloud/blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood/","name":"How S3-based ClickHouse hybrid storage works under the hood","headline":"How S3-based ClickHouse hybrid storage works under the hood","abstract":"","description":"","dateCreated":"2022-11-25T00:00:00Z","datePublished":"2022-11-25T00:00:00Z","dateModified":"2022-11-25T00:00:00Z","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"creator":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"publisher":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightHolder":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightYear":2025,"mainEntityOfPage":{"@type":"WebPage","@id":"https://double.cloud/blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood/"},"inLanguage":{"@type":"Language","name":"English","alternateName":"en"},"keywords":["Insights","ClickHouse"],"image":"https://double.cloud/assets/blog/articles/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood-small-cover.png.webp","sharedContent":{"@type":"WebPage","headline":"How S3-based ClickHouse hybrid storage works under the hood","url":"https://double.cloud/blog/posts/2022/11/how-s3-based-clickhouse-hybrid-storage-works-under-the-hood/","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}}},"wordCount":"","articleBody":""}]}},"routingData":{"hostname":"double.cloud"},"deviceData":{"isRobot":true,"isMobile":false,"isTablet":false},"csrfToken":"pbDvhFdi-QC1YXD5JbIRY4HLeT5zujSDBMGM","clientConfig":{"appTitle":"DoubleCloud","legalName":"DoubleCloud Inc","supportEmail":"","hosts":{"site":"https://double.cloud","console":"https://app.double.cloud"}},"ignoreConsent":false,"noNextImg":false,"noSnippet":null},"__N_SSP":true},"page":"/blog/posts/[...slug]","query":{"slug":["2022","11","how-s3-based-clickhouse-hybrid-storage-works-under-the-hood"]},"buildId":"HkxA3M0ES7gp3V0n_0ecw","isFallback":false,"gssp":true,"locale":"en","locales":["en"],"defaultLocale":"en","scriptLoader":[]}</script></body></html>