<!DOCTYPE html><html lang="en"><head itemscope=""><script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"insights","name":"Insights"}},{"@type":"ListItem","position":2,"item":{"@id":"ClickHouse","name":"ClickHouse"}},{"@type":"ListItem","position":3,"item":{"@id":"Airflow","name":"Airflow"}}]},{"@type":"BlogPosting","@id":"https://double.cloud/blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration/","url":"https://double.cloud/blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration/","name":"Clickstream analytics case study. Part II: ClickHouse &lt;→ Airflow","headline":"Clickstream analytics case study. Part II: ClickHouse &lt;→ Airflow","abstract":"<p>Written By: Igor Mosyagin, Developer Advocate at&nbsp;DoubleCloud</p>","description":"<p>Written By: Igor Mosyagin, Developer Advocate at&nbsp;DoubleCloud</p>","dateCreated":"2024-09-23T00:00:00Z","datePublished":"2024-09-23T00:00:00Z","dateModified":"2024-09-23T00:00:00Z","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"creator":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"publisher":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightHolder":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightYear":2025,"mainEntityOfPage":{"@type":"WebPage","@id":"https://double.cloud/blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration/"},"inLanguage":{"@type":"Language","name":"English","alternateName":"en"},"keywords":["Insights","ClickHouse","Airflow"],"image":"https://double.cloud/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-small-cover.png","sharedContent":{"@type":"WebPage","headline":"Clickstream analytics case study. Part II: ClickHouse &lt;→ Airflow","url":"https://double.cloud/blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration/","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}}},"wordCount":"","articleBody":""}]}</script><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Clickstream analytics case study. Part II: ClickHouse &lt;-&gt; Airflow | DoubleCloud</title><meta name="description" content="In this second post, we’ll show you how to set up an Airflow cluster. We’ll use it to run a batch job that takes the data we loaded in the first step and turns it into useful summaries. This is a key part of making our analytics system efficient and reliable."/><link rel="canonical" href="index.html"/><meta itemProp="name" content="Clickstream analytics case study. Part II: ClickHouse &lt;-&gt; Airflow"/><meta itemProp="description" content="In this second post, we’ll show you how to set up an Airflow cluster. We’ll use it to run a batch job that takes the data we loaded in the first step and turns it into useful summaries. This is a key part of making our analytics system efficient and reliable."/><meta itemProp="image" content="https://double.cloud/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-sharing.png"/><meta property="og:type" content="website"/><meta property="og:url" content="https://double.cloud/blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration/"/><meta property="og:title" content="Clickstream analytics case study. Part II: ClickHouse &lt;-&gt; Airflow"/><meta property="og:description" content="In this second post, we’ll show you how to set up an Airflow cluster. We’ll use it to run a batch job that takes the data we loaded in the first step and turns it into useful summaries. This is a key part of making our analytics system efficient and reliable."/><meta property="og:image" content="https://double.cloud/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-sharing.png"/><meta property="og:locale" content="en"/><meta property="og:site_name" content="DoubleCloud"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Clickstream analytics case study. Part II: ClickHouse &lt;-&gt; Airflow"/><meta name="twitter:description" content="In this second post, we’ll show you how to set up an Airflow cluster. We’ll use it to run a batch job that takes the data we loaded in the first step and turns it into useful summaries. This is a key part of making our analytics system efficient and reliable."/><meta name="twitter:image" content="https://double.cloud/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-sharing.png"/><meta name="robots" content="follow, index"/><meta property="article:published_time" content="2024-09-23T00:00:00Z"/><meta property="article:author" content=""/><meta property="article:tag" content="Insights"/><meta property="article:tag" content="ClickHouse"/><meta property="article:tag" content="Airflow"/><meta name="next-head-count" content="26"/><link rel="icon" href="../../../../../assets/favicon/favicon.ico" sizes="any"/><link type="image/x-icon" rel="shortcut icon" href="../../../../../assets/favicon/favicon.ico"/><link type="image/png" sizes="16x16" rel="icon" href="../../../../../assets/favicon/favicon-16x16.png"/><link type="image/png" sizes="32x32" rel="icon" href="../../../../../assets/favicon/favicon-32x32.png"/><link type="image/png" sizes="120x120" rel="icon" href="../../../../../assets/favicon/favicon-120x120.png"/><link type="image/png" sizes="192x192" rel="icon" href="../../../../../assets/favicon/favicon-192x192.png"/><link type="image/png" sizes="76x76" rel="apple-touch-icon" href="https://double.cloud/assets/favicon/favicon-76x76.png"/><link type="image/png" sizes="152x152" rel="apple-touch-icon" href="../../../../../assets/favicon/favicon-152x152.png"/><link type="image/png" sizes="180x180" rel="apple-touch-icon" href="../../../../../assets/favicon/favicon-180x180.png"/><script id="data-google-tag-manager" nonce="zpGfdl9st5PJR2ABdBTFVQ==" data-nonce="zpGfdl9st5PJR2ABdBTFVQ==">
                // Define dataLayer and the gtag function.
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}

                // Default analytics_storage to 'denied'.
                window.gtag = window.gtag || gtag;

                const hasAnalyticsConsent = window?.localStorage.getItem('hasAnalyticsConsent');
                const consent =  hasAnalyticsConsent === 'true' ? 'granted' : 'denied';

                window.gtag('consent', 'default', {
                    'analytics_storage': consent,
                    'ad_storage': consent,
                    'wait_for_update': hasAnalyticsConsent === 'true' ? 0 : Infinity,
                });

                dataLayer.push({
                    'event': 'default_consent'
                });

                (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                'https://www.googletagmanager.com/gtm.js?id='+i+dl;var n=d.querySelector('[nonce]');
                n&&j.setAttribute('nonce',n.nonce||n.getAttribute('nonce'));f.parentNode.insertBefore(j,f);
                })(window,document,'script','dataLayer','GTM-5M39N8J');
            </script><script nonce="zpGfdl9st5PJR2ABdBTFVQ==">window.__webpack_nonce__ = "zpGfdl9st5PJR2ABdBTFVQ=="</script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="preconnect" href="https://snap.licdn.com"/><link rel="preconnect" href="https://www.google.com"/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="preload" href="../../../../../_next/static/css/a4c87e381fd61058.css" as="style"/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="stylesheet" href="../../../../../_next/static/css/a4c87e381fd61058.css" data-n-g=""/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="preload" href="../../../../../_next/static/css/2facd84af36bff2e.css" as="style"/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="stylesheet" href="../../../../../_next/static/css/2facd84af36bff2e.css" data-n-p=""/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="preload" href="../../../../../_next/static/css/c413166e8b0da734.css" as="style"/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="stylesheet" href="../../../../../_next/static/css/c413166e8b0da734.css" data-n-p=""/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="preload" href="../../../../../_next/static/css/248e88462928fa2f.css" as="style"/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="stylesheet" href="../../../../../_next/static/css/248e88462928fa2f.css" data-n-p=""/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="preload" href="../../../../../_next/static/css/eb8a627e7f585420.css" as="style"/><link nonce="zpGfdl9st5PJR2ABdBTFVQ==" rel="stylesheet" href="../../../../../_next/static/css/eb8a627e7f585420.css" data-n-p=""/><noscript data-n-css="zpGfdl9st5PJR2ABdBTFVQ=="></noscript><script defer="" nonce="zpGfdl9st5PJR2ABdBTFVQ==" nomodule="" src="../../../../../_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="../../../../../_next/static/chunks/webpack-d326a7489defa990.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/chunks/framework-cc7effedd0fd3d95.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/chunks/main-ebfff3515213fa2f.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/chunks/pages/_app-4cd98c5be1eceb26.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/chunks/f69bbb46-eed95df46583a2d8.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/chunks/030d571f-c7510aa4f8d650e7.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/chunks/193-fdb54e47dd6b7c7b.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/chunks/756-04d1c95c632019ed.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/chunks/387-27526d5e8e2a9173.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/chunks/pages/blog/posts/[...slug]-896d627301783262.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/HkxA3M0ES7gp3V0n_0ecw/_buildManifest.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script><script src="../../../../../_next/static/HkxA3M0ES7gp3V0n_0ecw/_ssgManifest.js" nonce="zpGfdl9st5PJR2ABdBTFVQ==" defer=""></script></head><body class="dc-root g-root g-root_theme_dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5M39N8J" title="Googletagmanager" height="0" width="0" style="display:none;visibility:hidden" loading="lazy"></iframe></noscript><div id="__next" data-reactroot=""><div class="layout"><a href="https://doublecloud-archive.github.io/blog/posts/2024/10/doublecloud-final-update/"><div class="pc-Grid header-anncouncement"><div class="container-fluid "><div class="row"><div class="col"><div class="yfm yfm_constructor"><p><b>DoubleCloud has wound down operations</b> | This is&nbsp;an&nbsp;archived version of&nbsp;the site. <b>Learn more &rarr; </b></p></div></div></div></div></div></a><div class="layout__content"><div class="g-root g-root_theme_dark pc-page-constructor"><div class="pc-page-constructor__wrapper"><div class="pc-layout"><div class="pc-Grid pc-navigation pc-layout__navigation"><div class="container-fluid "><div class="row"><div class="col"><nav><div class="pc-desktop-navigation__wrapper"><div class="pc-desktop-navigation__left"><div class="link" data-link-type="router"><span class="pc-logo pc-desktop-navigation__logo"><picture><img alt="Logo icon" src="../../../../../assets/logo/dc-logo-dark.svg" class="pc-logo__icon"/></picture><span class="pc-logo__text"></span></span></div></div><div class="pc-desktop-navigation__navigation-container"><div class="pc-overflow-scroller__container"><div class="pc-overflow-scroller pc-desktop-navigation__navigation"><div class="pc-overflow-scroller__wrapper" style="left:0"><ul class="pc-desktop-navigation__links"><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Why DoubleCloud</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="group-list-content"><div class="row item-list-content"><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Performance" data-link-type="router" href="../../../../../performance-boost/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Performance</span><span class="navigation-popup-item__description">Get the best performance with the highest ROI</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Security" data-link-type="router" href="../../../../../security.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Security</span><span class="navigation-popup-item__description">Keep your data protected and maintain compliance</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="DoubleCloud vs. other solutions" data-link-type="router" href="../../../../../comparison/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">DoubleCloud vs. other solutions</span><span class="navigation-popup-item__description">Learn how DoubleCloud’s products compare to other solutions</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Customer stories" data-link-type="router" href="../../../../../resources/case-studies/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Customer stories</span><span class="navigation-popup-item__description">See our solutions in action</span></div></a></div></div><div class="group-list-content__banner"><picture><img alt="" src="../../../../../assets/doublecloud/menu-bar/menu-banner-dc-results.png.webp" class="group-list-content__image" style="width:300px;height:300px"/></picture><span class="yfm yfm_constructor"><a href='../../../../../performance-boost/index.html' target='_self'>Get more and spend less with DoubleCloud  →</a></span></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Products</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="row item-list-content"><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Managed Service for ClickHouse®" data-link-type="router" href="../../../../../services/managed-clickhouse.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-clickhouse.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Managed Service for ClickHouse®</span><span class="navigation-popup-item__description">The fastest, most resource-efficient OLAP database for real-time analytics</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Managed Service for Apache Kafka®" data-link-type="router" href="../../../../../services/managed-kafka.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-kafka.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Managed Service for Apache Kafka®</span><span class="navigation-popup-item__description">A leading data streaming technology for large-scale, data-intensive applications</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Managed Service for Apache Airflow®" data-link-type="router" href="../../../../../services/managed-airflow/index.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-airflow.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Managed Service for Apache Airflow®</span><span class="navigation-popup-item__description">Open-source tool to orchestrate and monitor workflows</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Data Transfer" data-link-type="router" href="../../../../../services/doublecloud-transfer.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-transfer.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Data Transfer</span><span class="navigation-popup-item__description">No-code ELT tool for aggregating, collecting, and migrating data</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Data Visualization" data-link-type="router" href="../../../../../services/doublecloud-visualization.html"><picture class="navigation-popup-item__icon-container"><img alt="" src="../../../../../assets/icons/dc-data-vis.svg" class="navigation-popup-item__icon"/></picture><div class="navigation-popup-item__container navigation-popup-item__container_with-margin"><span class="navigation-popup-item__title">Data Visualization</span><span class="navigation-popup-item__description">Free tool to create, modify, and share dashboards and charts</span></div></a></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Solutions</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="group-list-content"><div class="row item-list-content"><h4 class="item-list-content__title">By use case</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Customer-facing analytics" data-link-type="router" href="../../../../../customer-facing-analytics/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Customer-facing analytics</span><span class="navigation-popup-item__description">Provide business insights for your clients or partners</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Real-time analytics" data-link-type="router" href="../../../../../solutions/real-time-analytics/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Real-time analytics</span><span class="navigation-popup-item__description">Build a data infrastructure to collect, process, and analyze data in real time</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Observability and monitoring" data-link-type="router" href="../../../../../solutions/observability-and-monitoring/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Observability and monitoring</span><span class="navigation-popup-item__description">Analyze terabytes of your logs, events, and traces with ease</span></div></a></div></div><div class="row item-list-content"><h4 class="item-list-content__title">By industry</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="AdTech and MarTech data analytics" data-link-type="router" href="../../../../../solutions/adtech.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">AdTech and MarTech data analytics</span><span class="navigation-popup-item__description">Extract and analyze data from Meta ads, Google ads, LinkedIn ads, and others</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Analytics for mobile and gaming apps" data-link-type="router" href="../../../../../solutions/web-mobile-gaming-apps.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Analytics for mobile and gaming apps</span><span class="navigation-popup-item__description">Optimize and scale your mobile and gaming app analytics</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="EdTech data analytics" data-link-type="router" href="../../../../../solutions/edtech/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">EdTech data analytics</span><span class="navigation-popup-item__description">Improve online learning and identify new sales opportunities</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="FinTech data analytics" data-link-type="router" href="../../../../../solutions/fintech-real-time-analytics/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">FinTech data analytics</span><span class="navigation-popup-item__description">Manage and process large amounts of financial data efficiently</span></div></a></div></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control dc-dropdown-navigation-item__control_selected"><span class="dc-dropdown-navigation-item__title">Resources</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="group-list-content"><div class="row item-list-content"><h4 class="item-list-content__title">Using DoubleCloud</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="DoubleCloud API" href="../../../../../docs/en/public-api/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">DoubleCloud API</span><span class="navigation-popup-item__description">Read up on API tutorials and instructions</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Terraform" href="../../../../../docs/en/developer-resources/terraform/create-resources.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Terraform</span><span class="navigation-popup-item__description">Deploy and manage cloud resources with the infrastructure-as-code approach</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Status updates" data-link-type="router" href="https://status.double.cloud/"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Status updates</span><span class="navigation-popup-item__description">Check the current operational status of our services</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Support" data-link-type="router" href="../../../../../support/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Support</span><span class="navigation-popup-item__description">Learn more about our support tiers</span></div></a></div></div><div class="row item-list-content"><h4 class="item-list-content__title">Discover</h4><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Webinars" data-link-type="router" href="../../../../../webinars/index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Webinars</span><span class="navigation-popup-item__description">Sign up for the next webinar or watch previous ones</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover navigation-popup-item__content_selected" aria-label="Blog" data-link-type="router" href="../../../../index.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Blog</span><span class="navigation-popup-item__description">Get insights from our team and the latest news</span></div></a></div></div><div class="group-list-content__banner"><picture><img alt="" src="../../../../../assets/doublecloud/menu-bar/menu-banners-dc-ebook.png.webp" class="group-list-content__image" style="width:300px;height:300px"/></picture><span class="yfm yfm_constructor"><a href='../../../../../resources/clickhouse-ebook/index.html' target='_self'>Grab your ebook  →</a></span></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><button class="dc-dropdown-navigation-item__control"><span class="dc-dropdown-navigation-item__title">Company</span></button><div style="position:fixed;left:0;top:0" class="g-popup dc-dropdown-navigation-item__dropdown"><div class="g-popup__content dc-dropdown-navigation-item__dropdown-content-wrapper" tabindex="-1"><div class="row item-list-content"><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="About DoubleCloud" data-link-type="router" href="../../../../../company/about-us.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">About DoubleCloud</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Careers" data-link-type="router" href="../../../../../company/careers.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Careers</span></div></a></div><div class="col  col-12 navigation-popup-item item-list-content__item"><a class="navigation-popup-item__content navigation-popup-item__content_hover" aria-label="Contact us" data-link-type="router" href="../../../../../company/contact-us.html"><div class="navigation-popup-item__container"><span class="navigation-popup-item__title">Contact us</span></div></a></div></div></div></div></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><a aria-label="Pricing" class="pc-navigation-item__content pc-navigation-item__content_type_link" data-link-type="router" href="../../../../../pricing.html"><div class="navigation-item"><span class="navigation-item__text">Pricing</span></div></a></li><li class="pc-navigation-item pc-navigation-item_menu-layout_desktop pc-desktop-navigation__item"><a href="../../../../../docs/index.html" aria-label="Documentation" class="pc-navigation-item__content pc-navigation-item__content_type_link" target="_self"><div class="navigation-item"><span class="navigation-item__text">Documentation</span></div></a></li></ul></div></div></div></div><div class="pc-desktop-navigation__right"><button type="button" aria-label="Button label" class="pc-control pc-control_size_l pc-control_theme_primary pc-mobile-menu-button"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="24" class="g-icon" fill="currentColor" stroke="none" data-qa="icon-test-id" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="currentColor" fill-rule="evenodd" d="M1.25 3.25A.75.75 0 0 1 2 2.5h12A.75.75 0 0 1 14 4H2a.75.75 0 0 1-.75-.75Zm0 4.75A.75.75 0 0 1 2 7.25h12a.75.75 0 0 1 0 1.5H2A.75.75 0 0 1 1.25 8ZM2 12a.75.75 0 0 0 0 1.5h12a.75.75 0 0 0 0-1.5H2Z" clip-rule="evenodd"></path></svg></svg></button></div></div><div></div></nav></div></div></div></div><main class="pc-layout__content"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><header class="pc-header-block pc-header-block_media-view_full"><div class="pc-header-block__background pc-header-block__background_media" style="background-color:#000000"><div class="pc-Media pc-header-block__background-media" style="background-color:#000000"><div style="transform:"><div class="pc-storage-background-image pc-media-component-image__item pc-header-block__image" data-qa="background-image"><picture data-qa="background-image-image"><img fetchpriority="high" alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-cover.png" class="pc-storage-background-image__img"/></picture></div></div></div></div><div class="pc-Grid"><div class="container-fluid pc-header-block__container-fluid"><div class="row pc-header-block__breadcrumbs"><div class="col"><div class="pc-header-breadcrumbs pc-header-breadcrumbs_theme_light" aria-label="You are here:"><div class="pc-header-breadcrumbs__item"><a href="../../../../index.html" class="pc-header-breadcrumbs__text">Blog</a></div><div class="pc-header-breadcrumbs__item"><a href="../../../../index.html%3Ftags=insights.html" class="pc-header-breadcrumbs__text">Insights</a></div></div></div></div><div class="row"><div class="col col-reset pc-header-block__content-wrapper"><div class="row"><div class="col pc-header-block__content pc-header-block__content_offset_default pc-header-block__content_theme_light pc-header-block__content_vertical-offset_l"><div class="col  col-lg-6 col-sm-12 col-md-8 col-12 pc-header-block__content-inner"><h1 class="pc-header-block__title" id="g-uniq-277470"><span>Clickstream analytics case study. Part II: ClickHouse <-> Airflow</span></h1><div class="pc-header-block__description"><div class="yfm yfm_constructor yfm_constructor_theme_light"><p>Written By: Igor Mosyagin, Developer Advocate at&nbsp;DoubleCloud</p></div></div><div class="bc-post-info__container bc-post-info__container_theme_light"><div class="bc-post-info__item bc-post-info__item_size_s" data-qa="blog-header-meta-container-date">September 23, 2024</div><div class="bc-post-info__item bc-post-info__item_size_s" data-qa="blog-header-meta-container-reading-time"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>15 mins to read</div><div class="bc-post-info__item"><div class="bc-post-info__icon"><div class="g-popover gc-share-popover bc-post-info__share"><button class="gc-share-popover__container bc-post-info__switcher bc-post-info__switcher_theme_light" aria-expanded="false" aria-controls="g-uniq-277471" aria-describedby="g-uniq-277471"><div class="gc-share-popover__icon-container"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon gc-share-popover__icon bc-post-info__share-icon" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.798 3.16a.5.5 0 0 0 .363.842H7V9a1 1 0 0 0 2 0V4.002h1.839a.5.5 0 0 0 .363-.844L8.363.156a.5.5 0 0 0-.726 0l-2.84 3.002.001.001ZM13 7a1 1 0 0 1 2 0v6.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 13.5V7a1 1 0 0 1 2 0v6h10V7Z"></path></svg></svg></div><div class="gc-share-popover__title">Share</div></button></div></div></div></div></div></div></div></div></div></div></div></header></section><div class="pc-Grid"><div class="container-fluid "><div class="row pc-constructor-row"><div class="col"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><h2 id="introduction"><a href="index.html#introduction" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Introduction</span></a>Introduction</h2>
<p>Welcome back to&nbsp;our series on&nbsp;building a&nbsp;real-time analytics system. We&rsquo;re exploring how to&nbsp;set up&nbsp;a&nbsp;powerful analytics platform using DoubleCloud&rsquo;s managed services. This series covers everything from getting data in, to&nbsp;crunching numbers, to&nbsp;creating eye-catching dashboards.</p>
<p>In&nbsp;this second post, we&rsquo;ll show you how to&nbsp;set up&nbsp;an&nbsp;Airflow cluster. We&rsquo;ll use it&nbsp;to&nbsp;run a&nbsp;batch job that takes the data we&nbsp;loaded in&nbsp;the first step and turns it&nbsp;into useful summaries. This is&nbsp;a&nbsp;key part of&nbsp;making our analytics system efficient and reliable.</p>
<p>If&nbsp;you missed our first post about initial setup and data loading, <a href="../real-time-analytics-kafka-clickhouse-integration.html">you can find it&nbsp;here</a>.</p>
<h2 id="data-solution-overview"><a href="index.html#data-solution-overview" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Data Solution overview</span></a>Data Solution overview</h2>
<p>Le&rsquo;s recap our overall data platform architecture.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-1.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-1.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Quick navigation:</p>
<ul>
<li><a href="index.html#introduction">Introduction</a></li>
<li><a href="index.html#data-solution-overview">Data Solution overview</a></li>
<li><a href="index.html#setup-airflow-cluster">Setup Airflow cluster</a></li>
<li><a href="index.html#aggregations">Aggregations</a></li>
<li><a href="index.html#back-to-airflow">Back to&nbsp;Airflow</a></li>
<li><a href="index.html#changing-dag-structure">Changing DAG structure</a></li>
<li><a href="index.html#adjusting-airflow-dag">Adjusting Airflow DAG</a></li>
<li><a href="index.html#final-result">Final result</a></li>
<li><a href="index.html#looking-ahead-to-part-iii">Looking ahead to&nbsp;part III</a></li>
</ul></div></section></div></div></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>In&nbsp;our previous post, we&nbsp;focused on&nbsp;building the ingestion side. Now, we&rsquo;re moving on&nbsp;to&nbsp;the next crucial step: aggregations.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-2.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-2.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>We&rsquo;ve successfully set up&nbsp;our data pipeline, so&nbsp;our next challenge is&nbsp;to&nbsp;compute and automate aggregation. This is&nbsp;where we&nbsp;turnraw data into actionable insights.</p>
<h3 id="a-quick-note-on-batch-processing"><a href="index.html#a-quick-note-on-batch-processing" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">A&nbsp;quick note on&nbsp;batch processing</span></a>A&nbsp;quick note on&nbsp;batch processing</h3>
<p>You might be&nbsp;wondering: &ldquo;Wait, isn&rsquo;t this series about real-time analytics? Why are we&nbsp;talking about batch processing?&rdquo;</p>
<p>Great question! While our end goal is&nbsp;real-time analytics, it&rsquo;s important to&nbsp;remember that a&nbsp;robust data platform often combines both real-time and batch processing. Batch processing is&nbsp;crucial for handling large volumes of&nbsp;historical data, performing complex analyses, and creating aggregated views that complement our real-time insights.</p>
<p>In&nbsp;many real-world scenarios, you&rsquo;ll need both approaches to&nbsp;get a&nbsp;complete picture of&nbsp;your data. The common knowledge is&nbsp;that real time processing gives you immediate insights, while batch processing allows for more in-depth, comprehensive analysis. By&nbsp;covering batch processing in&nbsp;this post, we&rsquo;re making sure that we&rsquo;re building a&nbsp;well-rounded platform that can handle various analytical needs.</p>
<h2 id="setup-airflow-cluster"><a href="index.html#setup-airflow-cluster" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Setup Airflow cluster</span></a>Setup Airflow cluster</h2>
<p>Let&rsquo;s start by&nbsp;creating our Airflow cluster. This process takes a&nbsp;bit of&nbsp;time, so&nbsp;it&rsquo;s a&nbsp;good idea to&nbsp;get it&nbsp;started first and then move on&nbsp;to&nbsp;other tasks while it&nbsp;sets&nbsp;up. The new Airflow cluster can be&nbsp;created from a&nbsp;cluster tab in&nbsp;the DoubleCloud console. I&rsquo;ll use a&nbsp;small production environment configuration for this example.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-3.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-3.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>I&rsquo;m using the latest available version 2.10.0 which comes with a&nbsp;sleek dark theme and some handy features. We&nbsp;usually try to&nbsp;make sure new Airflow versions are available in&nbsp;a&nbsp;few days after they get released by&nbsp;the Airflow community. Remember, our platform allows you to&nbsp;create custom images if&nbsp;you need more specific setups. The default DoubleCloud Airflow comes with the ClickHouse plugin pre-installed, so&nbsp;you&rsquo;re all set to&nbsp;work with your ClickHouse cluster.</p>
<p>For this demo, I&nbsp;continue using <a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/">the same repository</a>. If&nbsp;you&rsquo;re planning to&nbsp;use yours, make sure:</p>
<ul>
<li>You can access it&nbsp;with the provided credentials or&nbsp;it&rsquo;s publicly accessible</li>
<li>You&rsquo;re using the correct branch</li>
<li>You&rsquo;ve specified the right path to&nbsp;the DAG folder</li>
</ul>
<p>Here&rsquo;s my&nbsp;setup: I&rsquo;m using the <code>trunk</code> branch, and my&nbsp;DAGs are in&nbsp;the <code>dags</code> folder at&nbsp;the root of&nbsp;my&nbsp;repo.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-4.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-4.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>If&nbsp;repository is&nbsp;private, you&rsquo;ll need to&nbsp;provide a&nbsp;username and a&nbsp;password or&nbsp;Personal Access Token (PAT). Check your version control system&rsquo;s documentation for details on&nbsp;setting this up.</p>
<p>The DAG folder will be&nbsp;mounted using git-sync. This means you can update your DAGs by&nbsp;simply pushing changes to&nbsp;your git branch&nbsp;&mdash; no&nbsp;need to&nbsp;update the cluster itself.</p>
<p>For now, I&rsquo;ll keep all other settings at&nbsp;their defaults and hit &ldquo;Submit&rdquo; to&nbsp;start provisioning. While my&nbsp;cluster is&nbsp;spinning up, let&rsquo;s make good use of&nbsp;this time and do&nbsp;some exploratory data analysis. This will help understand our data better nad help structure our Airflow-enhanced queries.</p>
<h2 id="aggregations"><a href="index.html#aggregations" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Aggregations</span></a>Aggregations</h2>
<p>Our data consists of&nbsp;events from various parties, and our goal is&nbsp;to&nbsp;group them effectively. Let&rsquo;s start with some EDA on&nbsp;our sample of&nbsp;1,000 events using WebSQL. This will help understand what aggregations we&nbsp;can compute.</p>
<h3 id="exploring-sample-clickstream-data"><a href="index.html#exploring-sample-clickstream-data" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Exploring sample clickstream data</span></a>Exploring sample clickstream data</h3>
<p>First, let&rsquo;s remind ourselves about the table columns and their types. In&nbsp;ClickHouse, we&nbsp;can do&nbsp;this using the <a href="https://clickhouse.com/docs/ru/sql-reference/statements/describe-table">DESCRIBE <code>&lt;tablename&gt;</code> command</a>.</p>
<p>Here&rsquo;s how it&nbsp;looks in&nbsp;WebSQL query editor:</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-5.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-5.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Our landing table is&nbsp;quite extensive, but the xey fields for our analysis are:</p>
<ul>
<li><code>partyId</code></li>
<li><code>sessionId</code></li>
<li><code>Item_price</code></li>
<li><code>eventType</code></li>
<li><code>detectedDuplicate</code></li>
<li><code>detectedCorruption</code></li>
<li><code>my_ts</code> (containing the adjusted timestamp)</li>
</ul>
<p>Now&rsquo; let&rsquo;s check for duplicates and corruption in&nbsp;our data:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> eventType, detectedDuplicate, detectedCorruption, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> events_webshop <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="43">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-43" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-43" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-43.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-7.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-7.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Interestingly, our sample doesn&rsquo;t show any detected duplicates, but there are some events marked as&nbsp;corrupted. Given our small sample size of&nbsp;1,000 events, we&nbsp;won&rsquo;t focus too much on&nbsp;duplicates now, but it&rsquo;s something to&nbsp;keep in&nbsp;mind for larger samples.</p>
<p>Let&rsquo;s move on&nbsp;to&nbsp;some more useful aggregations. We&rsquo;ll compute how many visitors we&nbsp;had each hour in&nbsp;our dataset. ClickHouse offers <a href="https://clickhouse.com/docs/en/sql-reference/functions/date-time-functions">many functions</a> for working with datetime data, all expecting DateTime64 format.</p>
<p>I&rsquo;ll cast the values on&nbsp;the fly:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql">
<span class="hljs-keyword">SELECT</span>
        toStartOfHour(my_ts::DateTime64) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">hour</span>,
        <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> partyId) <span class="hljs-keyword">AS</span> visitors,
        <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> total_events,
        <span class="hljs-built_in">MIN</span>(my_ts::DateTime64) <span class="hljs-keyword">AS</span> mnts,
        <span class="hljs-built_in">MAX</span>(my_ts::DateTime64) <span class="hljs-keyword">AS</span> mxts
<span class="hljs-keyword">FROM</span> events_webshop <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">hour</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">hour</span>
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="9">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-9" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-9" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-9.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-8.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-8.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>From these results, we&nbsp;can see that our 1,000-event sample spans 5&nbsp;hours, with a&nbsp;fairly even distribution of&nbsp;events across each hour. The events are clustered at&nbsp;the start and end of&nbsp;each hour. We&nbsp;also notice that our visitor count is&nbsp;quite low, but it&rsquo;s sufficient for building our initial pipeline.</p>
<h3 id="performance-metrics-for-sample-data"><a href="index.html#performance-metrics-for-sample-data" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Performance metrics for sample data</span></a>Performance metrics for sample data</h3>
<p>Our dataset includes two event types: <code>itemBuyEvent</code> and <code>itemViewEvent</code>. We&rsquo;ve already counted visitors, but now let&rsquo;s focus on&nbsp;purchases and revenue metrics, grouped by&nbsp;hour:</p>
<ul>
<li>
<p><strong>Total revenue:</strong> sum of&nbsp;all <code>item_price</code> fields for events with <code>eventType = itemBuyEvent</code></p>
</li>
<li>
<p><strong>Number of&nbsp;buyers:</strong> count of&nbsp;distinct <code>partyId</code></p>
</li>
<li>
<p><strong>Total purchases:</strong> count of&nbsp;distinct <code>sessionId</code> per hour</p>
</li>
<li>
<p><strong>Average revenue per purchase:</strong> total revenue divided by&nbsp;number of&nbsp;purchases</p>
</li>
</ul>
<p>Here&rsquo;s the SQL query to&nbsp;calculate these metrics:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>
    toStartOfHour(my_ts::DateTime64) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">hour</span>,
    <span class="hljs-built_in">SUM</span>(item_price) <span class="hljs-keyword">AS</span> total_revenue,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> partyId) <span class="hljs-keyword">AS</span> num_buyers,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> sessionId) <span class="hljs-keyword">AS</span> num_purchases,
    round(total_revenue <span class="hljs-operator">/</span> num_purchases, <span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> average_revenue_per_purchase
<span class="hljs-keyword">FROM</span> events_webshop <span class="hljs-keyword">WHERE</span> eventType<span class="hljs-operator">=</span><span class="hljs-string">'itemBuyEvent'</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">hour</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">hour</span>
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="34">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-34" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-34" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-34.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-9.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-9.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><h3 id="putting-it-all-together"><a href="index.html#putting-it-all-together" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Putting it&nbsp;all together</span></a>Putting it&nbsp;all together</h3>
<p>Now that we&nbsp;have our performance metrics, let&rsquo;s combine them with our visitor data and apply our filtering criteria for duplicates and corruption. I&nbsp;will use Common Tabls Experssions (CTEs) to&nbsp;organize the resulting query:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">WITH</span> good_data <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> webshop.events_webshop
    <span class="hljs-keyword">WHERE</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>
        <span class="hljs-keyword">AND</span> detectedDuplicate<span class="hljs-operator">=</span><span class="hljs-literal">false</span>
        <span class="hljs-keyword">AND</span> detectedCorruption<span class="hljs-operator">=</span><span class="hljs-literal">false</span>
), visitors <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        toStartOfHour(my_ts::DateTime64) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">hour</span>,
        <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> partyId) <span class="hljs-keyword">AS</span> visitors
    <span class="hljs-keyword">FROM</span> good_data
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">hour</span>
), performance <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        toStartOfHour(my_ts::DateTime64) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">hour</span>,
        <span class="hljs-built_in">SUM</span>(item_price) <span class="hljs-keyword">AS</span> total_revenue,
        <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> partyId) <span class="hljs-keyword">AS</span> num_buyers,
        <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> sessionId) <span class="hljs-keyword">AS</span> num_purchases
        round(total_revenue <span class="hljs-operator">/</span> num_purchases, <span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> average_revenue_per_purchase
    <span class="hljs-keyword">FROM</span> good_data
    <span class="hljs-keyword">WHERE</span> eventType<span class="hljs-operator">=</span><span class="hljs-string">'itemBuyEvent'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">hour</span>
) <span class="hljs-keyword">SELECT</span>
    v.hour,
    v.visitors,
    p.num_buyers,
    p.num_purchases,
    p.total_revenue,
    p.average_revenue_per_purchase
<span class="hljs-keyword">FROM</span> visitors v <span class="hljs-keyword">JOIN</span> performance p <span class="hljs-keyword">ON</span> v.hour <span class="hljs-operator">=</span> p.hour <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">hour</span>

</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="6">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-6" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-6" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-6.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>You can find the full query <a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/sql/compute_full_aggs.sql">at&nbsp;github here</a>.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-10.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-10.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>This query combines all the metrics we&nbsp;need for our analysis. It&nbsp;filters out duplicates and corrupted data, calculates visitor and performance metrics, and joins them together for a&nbsp;comprehensive hourly view of&nbsp;our webshop&rsquo;s performance.</p>
<p>Now that we&nbsp;have our final query, let&rsquo;s move on&nbsp;to&nbsp;automating this process with Airflow.</p>
<h2 id="back-to-airflow"><a href="index.html#back-to-airflow" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Back to&nbsp;Airflow</span></a>Back to&nbsp;Airflow</h2>
<p>Once the cluster is&nbsp;up&nbsp;and running, you can access the Web UI&nbsp;from the Cluster panel via the Web Server Connection link.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-11.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-11.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p><strong>Allowlist reminder:</strong> DoubleCloud automatically adds your IP&nbsp;address to&nbsp;the ALLOWLIST in&nbsp;the cluster settings. Keep this in&nbsp;mind if&nbsp;you frequently change networks, like switching Wi-Fi on&nbsp;your laptop. If&nbsp;the Web Server connection link doesn&rsquo;t open, make sure your IP&nbsp;is&nbsp;in&nbsp;the list.</p>
<p>Initially, your new cluster will have no&nbsp;enabled DAGs, presenting an&nbsp;empty dashboard. This is&nbsp;normal for a&nbsp;fresh setup.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-12.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-12.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Let&rsquo;s start by&nbsp;enabling and triggering the roll_d20 DAG (<a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/roll_d20.py">src here</a>). This simple two-task DAG isn&rsquo;t connecting to&nbsp;any external system,&nbsp;&mdash; it&rsquo;s just to&nbsp;verify that our Airflow setup is&nbsp;complete and workers are functioning. trigger it, and watch it&nbsp;being executed (you can actually just trigger disabled dag and it&nbsp;will be&nbsp;enabled automatically).</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-13.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-13.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>You can access the logs for each task through the Logs tab when you select a&nbsp;DAG run and a&nbsp;task:</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-14.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-14.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Looks like I&nbsp;got lucky&nbsp;&mdash; my&nbsp;DAG run rolled a&nbsp;13!</p>
<p>Now, if&nbsp;we&nbsp;try running our <code>compute_full_perf_metrics</code>, DAG (<a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/compute_full_perf_metrics.py">src here</a>), it&nbsp;will fail:</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-15.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-15.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>This is&nbsp;expected, because our newly created cluster doesn&rsquo;t know about our ClickHouse server&nbsp;yet. The logs confirm this:</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-16.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-16.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>It&nbsp;all can be&nbsp;fixed by&nbsp;creating a&nbsp;connection. Go&nbsp;to&nbsp;Admin-&gt;Connections and add a&nbsp;Generic connection using credentials for your ClickHouse server:</p>
<ul>
<li>
<p>Connection id: <code>ch_default</code></p>
</li>
<li>
<p>Connection type: <code>Generic</code></p>
</li>
<li>
<p>Set host, port, and login/password accordingly</p>
</li>
<li>
<p>Specify schema: <code>webshop</code> (this will be&nbsp;used as&nbsp;our database)</p>
</li>
<li>
<p>Add {&rdquo;<code>secure</code>&rdquo;: true} to&nbsp;extra settings. This is&nbsp;required for DoubleCloud because your data is&nbsp;always secure with us&nbsp;&mdash; we&nbsp;just need to&nbsp;tell Airflow about it!</p>
</li>
</ul></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-17.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-17.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Now, triggering our ClickHouse DAG again should result in&nbsp;a&nbsp;successful&nbsp;run. The log will show you the executed query:</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-18.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-18.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>The query result is&nbsp;saved in&nbsp;the XCom&nbsp;tab. I&rsquo;ve collapsed a&nbsp;few rows, but it&rsquo;s semantically the same result as&nbsp;in&nbsp;the WebSQL:</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-19.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-19.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>This confirms that our Airflow cluster can now interact with the ClickHouse cluster and compute the necessary metrics. However, this setup isn&rsquo;t ideal yet:</p>
<p><em>1.</em> The DAG is&nbsp;not idempotent (we&rsquo;ll address this in&nbsp;the next part of&nbsp;the series).</p>
<p><em>2.</em> The results are only saved in&nbsp;the Airflow metadata, not a&nbsp;persistent location, not in&nbsp;ClickHouse, hard to&nbsp;access, etc</p>
<p>Let&rsquo;s address the second point by&nbsp;modifying our DAG structure to&nbsp;save results in&nbsp;a&nbsp;table.</p>
<h2 id="changing-dag-structure"><a href="index.html#changing-dag-structure" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Changing DAG structure</span></a>Changing DAG structure</h2>
<p>Let&rsquo;s modify the pipeline structure to&nbsp;address the issue of&nbsp;result persistence:</p>
<p><em>1.</em> First, the pipeline will check if&nbsp;the target aggregation table exists</p>
<p><em>2.</em> If&nbsp;it&nbsp;doesn&rsquo;t exist, the pipeline should create the table and compute aggregations on&nbsp;all available data</p>
<p><em>3.</em> If&nbsp;the table exists, the pipeline will truncate it&nbsp;and insert new data</p>
<p>This pipeline isn&rsquo;t ideal for production use as&nbsp;it&nbsp;has a&nbsp;few obvious drawbacks, but it&nbsp;demonstrates how to&nbsp;write an&nbsp;Airflow pipeline with additional SQL-based checks. I&rsquo;ll discuss pipeline improvements and query performance in&nbsp;the next part of&nbsp;this series.</p>
<h3 id="additional-table"><a href="index.html#additional-table" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Additional table</span></a>Additional table</h3>
<p>For our aggregates data mart, let&rsquo;s use the following structure:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> performance_aggregates (
    ts_start DateTime,
    ts_end DateTime,
    visitors <span class="hljs-type">Integer</span>,
    num_buyers <span class="hljs-type">Integer</span>,
    num_purchases <span class="hljs-type">Integer</span>,
    total_revenue <span class="hljs-type">Integer</span>,
    average_revenue_per_purchase Float32
) ENGINE <span class="hljs-operator">=</span> MergeTree() <span class="hljs-keyword">PRIMARY</span> KEY ts_start
</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="36">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-36" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-36" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-36.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>This structure is&nbsp;similar to&nbsp;what we&rsquo;ve used before, with an&nbsp;additional column for the end of&nbsp;the interval. The MergeTree engine is&nbsp;suitable for our test sample, but for production use, you should always first check if&nbsp;you can use <a href="https://clickhouse.com/docs/en/engines/table-engines#mergetree">more specific</a> engine type.</p>
<p>To&nbsp;insert data into this table, I&nbsp;will slightly modify me&nbsp;existing query by&nbsp;adding an&nbsp;INSERT INTO statement:</p>

    <div class="yfm-clipboard">
    <pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> webshop.performance_aggregates
  (ts_start, ts_end, total_revenue, num_buyers, visitors, total_revenue, average_revenue_per_purchase)
<span class="hljs-keyword">WITH</span> good_data <span class="hljs-keyword">AS</span> (
  …

</code></pre>

    <svg width="16" height="16" viewBox="0 0 24 24" class="yfm-clipboard-button" data-animation="6">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path>
        <path stroke="currentColor" fill="transparent" stroke-width="1.5" d="M9.5 13l3 3l5 -5" visibility="hidden">
            <animate id="visibileAnimation-6" attributeName="visibility" from="hidden" to="visible" dur="0.2s" fill="freeze" begin></animate>
            <animate id="hideAnimation-6" attributeName="visibility" from="visible" to="hidden" dur="1s" begin="visibileAnimation-6.end+1" fill="freeze"></animate>
        </path>
    </svg>
    </div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Full query code <a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/sql/compute_insert_aggs.sql">can be&nbsp;found here</a>. It&rsquo;s worth noting that this approach has some limitations and wouldn&rsquo;t be&nbsp;ideal for a&nbsp;production environment. However, for our current goal of&nbsp;getting all the components working together, it&rsquo;s sufficient.</p>
<p>In&nbsp;the next part of&nbsp;this series, we&rsquo;ll address these limitations and discuss how to&nbsp;make the pipeline more robust and suitable for production use.</p>
<h2 id="adjusting-airflow-dag"><a href="index.html#adjusting-airflow-dag" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Adjusting Airflow DAG</span></a>Adjusting Airflow DAG</h2>
<p>Here&rsquo;s my&nbsp;resulting pipeline structure:</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-20.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-20.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>You can see the complete code <a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/compute_full_perf_metrics_save_to_table.py">in&nbsp;our repository</a>.</p>
<p>I&rsquo;d like to&nbsp;highlight some key points about this new DAG:</p>
<ul>
<li>
<p>This DAG has <a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L32">no&nbsp;schedule</a>. Since it&nbsp;computes across the whole table, it&rsquo;s designed more for per-trigger use rather than scheduled runs.</p>
</li>
<li>
<p>While the DAG might seem verbose with some tasks that could be&nbsp;combined, this structure showcases how to&nbsp;author more complex DAGs. Tip: Airflow has a&nbsp;lesser-known feature that allows you to&nbsp;add text on&nbsp;top of&nbsp;edges, making complicated DAGs look cleaner. <a href="https://airflow.apache.org/docs/apache-airflow/2.10.0/_modules/airflow/example_dags/example_branch_labels.html">See here</a>.</p>
</li>
<li>
<p>Given the nature of&nbsp;the overall process, I&rsquo;ve <a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L38">limited</a> the number of&nbsp;max active runs allowed for the&nbsp;DAG. This can be&nbsp;useful in&nbsp;certain scenarios when you expect multiple DAG runs triggered in&nbsp;a&nbsp;short period of&nbsp;time.</p>
</li>
<li>
<p>When implementing branching in&nbsp;Airflow, remember to&nbsp;set dependencies in&nbsp;the graph and keep task_ids naming consistent. Personally, I&nbsp;often start new DAGs with EmptyOperators to&nbsp;get the structure right before replacing them with real tasks.</p>
</li>
<li>
<p>It&rsquo;s crucial to&nbsp;set the proper TriggerRule for the final task to&nbsp;ensure it&rsquo;s not skipped when edges merge.</p>
</li>
<li>
<p>In&nbsp;the DAG code, I&nbsp;define <a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L13-L22">a&nbsp;custom ClickHouseBranchSQLOperator</a> instead of&nbsp;using the one provided by&nbsp;the airflow-clickhouse-plugin. This is&nbsp;due to&nbsp;some method resolution order (MRO) issue in&nbsp;Airflow versions &lt; 2.9.3. You might not need this in&nbsp;newer versions (see docstring for details).</p>
</li>
<li>
<p>Some SQL statements could be&nbsp;hardcoded/inlined instead of&nbsp;reading from a&nbsp;file, but I&nbsp;prefer consistency and this a&nbsp;nice minor side-effect as&nbsp;it&nbsp;makes it&nbsp;easier to&nbsp;get feedback from SQL experts (they can just read an&nbsp;SQL file and not Python code + SQL statements).</p>
</li>
<li>
<p>Depending on&nbsp;your use-case, it&nbsp;might make sense to&nbsp;set table names as&nbsp;parameters or&nbsp;Airflow variables for easier modifications. I&nbsp;will cover it&nbsp;in&nbsp;the next part, along with scheduling, idempotency, and data_interval usage.</p>
</li>
</ul>
<p>I&nbsp;want to&nbsp;emphasize that we&rsquo;re focusing on&nbsp;using Airflow with our ClickHouse cluster data, not on&nbsp;production-ready code quality. I&rsquo;d caution against using this DAG directly in&nbsp;production. However, it&nbsp;serves as&nbsp;a&nbsp;good starting point for developing your own DAGs that utilize ClickHouse.</p>
<p>Let&rsquo;s trigger this DAG and check the results. Enabling the DAG and running it&nbsp;for the first time will create the table and compute the aggregations. Subsequent runs will use the other branch.</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-21.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-21.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>In&nbsp;the next part of&nbsp;this series, we&rsquo;ll refine our approach and address some of&nbsp;the limitations in&nbsp;this initial implementation.</p>
<h2 id="final-result"><a href="index.html#final-result" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Final result</span></a>Final result</h2>
<p>Switching to&nbsp;WebSQL I&nbsp;can now see my&nbsp;new table and query data from it:</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-22.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-22.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Running the DAG again would takes a&nbsp;different path in&nbsp;the graph. Since we&nbsp;limited the max active runs, multiple triggers won&rsquo;t interfere with each other:</p></div></section></div></div><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-media-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l bc-media__container"><div class="bc-media__border" data-qa="blog-media-content"><div class="pc-Media bc-media__content"><picture><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-23.png.webp" type="image/webp"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-23.png" class="pc-media-component-image__item bc-media__image"/></picture></div></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-layout-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_xs"><div class="row bc-layout__row no-gutter"><div class="col  col-12 col-lg-8  order-3 order-lg-1 bc-layout__left-col"><div class="bc-layout__item"><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-yfm-block"><section class="bc-wrapper bc-wrapper_padding-top_xs bc-wrapper_padding-bottom_l"><div class="yfm yfm_blog yfm_reset_paddings yfm_no-list-reset"><p>Everything seems to&nbsp;be&nbsp;working as&nbsp;expected. Let&rsquo;s recap what we&rsquo;ve accomplished:</p>
<p><em>1.</em> We&nbsp;started by&nbsp;spinning up&nbsp;an&nbsp;Airflow cluster. My&nbsp;DAGs are stored in&nbsp;separate folder <a href="https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/tree/trunk">in&nbsp;a&nbsp;repository</a>.</p>
<p><em>2.</em> I&nbsp;did some Exploratory Data Analysis to&nbsp;determine what we&nbsp;wanted to&nbsp;compute and got our first working query in&nbsp;WebSQL. The fancy phrase basically means &ldquo;I&rsquo;ve ran some queries to&nbsp;check what&rsquo;s up&nbsp;with my&nbsp;data&rdquo;. This helped me&nbsp;understand my&nbsp;data better and prepare for automation in&nbsp;Airflow. By&nbsp;saving queries as&nbsp;SQL files in&nbsp;my&nbsp;DAGs folder, I&nbsp;can later easily reuse them.</p>
<p><em>3.</em> Using ClickHouseOperator in&nbsp;Airflow, I&rsquo;ve set up&nbsp;a&nbsp;simple DAG that runs the query as-is. This helped me&nbsp;ensure everything is&nbsp;working fine from connectivity standpoint.</p>
<p><em>4.</em> I&rsquo;ve added a&nbsp;few additional steps to&nbsp;my&nbsp;DAG that create the aggregation table and save the result, allowing me&nbsp;to&nbsp;rerun it&nbsp;whenever needed.</p>
<p>This is&nbsp;a&nbsp;point in&nbsp;our imaginary communication with the data client where I&nbsp;can now present these results to&nbsp;data analysts and gather feedback on&nbsp;either the SQL queries or&nbsp;the data mart structure. It&rsquo;s a&nbsp;good place to&nbsp;wrap up&nbsp;this part of&nbsp;our series.</p>
<h2 id="looking-ahead-to-part-iii"><a href="index.html#looking-ahead-to-part-iii" class="yfm-anchor" aria-hidden="true"><span class="visually-hidden">Looking ahead to&nbsp;part III</span></a>Looking ahead to&nbsp;part III</h2>
<p>In&nbsp;the next installment of&nbsp;this series, we&rsquo;re going to&nbsp;take our analytics platform to&nbsp;the next level:</p>
<p><em>1.</em> We&rsquo;ll build an&nbsp;interactive dashboard using the DoubleCloud Visualization tool, bringing our data to&nbsp;life visually.</p>
<p><em>2.</em> We&rsquo;ll shorten the time bucket for more granular analysis and utilize a&nbsp;bigger dataset to&nbsp;stress-test our system.</p>
<p><em>3.</em> We&rsquo;ll refine our DAG, addressing improvements such as:</p>
<ul>
<li>Implementing idempotency</li>
<li>Setting up&nbsp;proper scheduling</li>
<li>Making our pipeline more robust for production use</li>
<li>Parametrizing table names and leveraging Airflow variables for increased flexibility</li>
</ul>
<p><em>4.</em> We&rsquo;ll explore how this entire setup can be&nbsp;deployed using Terraform, streamlining the infrastructure-as-code process.</p>
<p><em>5.</em> We&rsquo;ll also cover different table structures and approaches for this problem and how different ClickHouse engines can be&nbsp;used here, and if&nbsp;we&nbsp;indeed need to&nbsp;use something different than the basic MergeTree for optimizing this analytics pipeline.</p>
<p>Remember, while our current implementation works, it&rsquo;s designed as&nbsp;a&nbsp;learning exercise. For production environments, if&nbsp;you were going with self-hosted solutions, you&rsquo;d need to&nbsp;implement additional error handling, logging, and performance optimizations. However, with DoubleCloud, many of&nbsp;these issues are solved for you, allowing you to&nbsp;focus on&nbsp;your data processing needs instead.</p>
<p>Thanks for joining us&nbsp;on&nbsp;this journey so&nbsp;far. Stay tuned for part III, where we&rsquo;ll bring all these pieces together into a&nbsp;comprehensive, production-grade analytics solution! If&nbsp;you have any questions or&nbsp;would like to&nbsp;discuss this series further, feel free to&nbsp;reach out on&nbsp;Slack. DoubleCloud is&nbsp;always here to&nbsp;help you make the most of&nbsp;your data!</p></div></section></div></div></div><div class="col  col-12 col-lg-3  offset-0 offset-lg-1  order-2 order-lg-2 bc-layout__right-col"></div></div></section></div><div class="col col-reset pc-block-base pc-block-base_indentTop_l pc-block-base_indentBottom_l pc-constructor-block pc-constructor-block_type_content-layout-block"><div class="pc-content-layout-block pc-content-layout-block_size_l pc-content-layout-block_theme_default pc-content-layout-block_background"><div class="col  col-12 col-md-8 col-reset pc-content pc-content_size_l pc-content_centered pc-content_theme_default pc-content-layout-block__content"><div class="pc-title pc-content__title" id="g-uniq-277473"><div class="col  col-12 col-reset"><h2 class="pc-title-item pc-title-item_size_m pc-title-item_reset-margin" data-qa="undefined-header"><span class="pc-title-item__text">Get started with DoubleCloud</span></h2></div></div><div class="pc-buttons pc-buttons_size_l pc-content__buttons pc-content__buttons_size_l"><a aria-describedby="g-uniq-277473" class="g-button g-button_view_action g-button_size_xl g-button_pin_round-round pc-button-block pc-button-block_size_xl pc-button-block_theme_accent pc-buttons__button" href="https://auth.double.cloud/s/signup" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><span class="pc-button-block__text">Start free trial</span></span></span></a><a aria-describedby="g-uniq-277473" class="g-button g-button_view_outlined g-button_size_xl g-button_pin_round-round pc-button-block pc-button-block_size_xl pc-button-block_theme_pseudo pc-buttons__button" href="index.html#contact-us-form" aria-disabled="false"><span class="g-button__text"><span class="pc-button-block__content"><span class="pc-button-block__text">Contact us</span></span></span></a></div></div><div class="pc-content-layout-block__background"><div class="pc-storage-background-image pc-content-layout-block__background-item" style="background-color:#CA1551" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/doublecloud/doublecloud-cover-5.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/doublecloud/doublecloud-cover-5.png" class="pc-storage-background-image__img" style="background-color:#CA1551"/></picture></div></div></div></div><div class="col col-reset pc-block-base pc-block-base_reset-paddings pc-block-base_indentTop_0 pc-block-base_indentBottom_0 pc-constructor-block pc-constructor-block_type_blog-suggest-block"><section class="bc-wrapper bc-wrapper_padding-top_l bc-wrapper_padding-bottom_l"><div class="pc-SliderBlock"><div class="pc-title pc-SliderBlock__header pc-SliderBlock__header_no-description"><div class="col  col-12 col-sm-8 col-reset"><h2 class="pc-title-item pc-title-item_size_m pc-title-item_reset-margin" data-qa="undefined-header"><span class="pc-title-item__text">See also</span></h2></div></div><div class="pc-SliderBlock__animate-slides"><span style="font-size:0"></span><div><div class="slick-slider pc-slick-origin slick-initialized"><div class="slick-list"><div class="slick-track" style="width:100%;left:0%"><div data-index="0" class="slick-slide slick-active slick-current" tabindex="-1" aria-hidden="false" style="outline:none;width:33.333333333333336%"><div><div class="link" data-link-type="router"><a draggable="false" aria-labelledby="g-uniq-277474" aria-describedby="g-uniq-277476 g-uniq-277478" class="g-link g-link_view_normal pc-card-base-block pc-card-base-block_border_shadow bc-post-card__card" href="../../../2023/10/introducing-the-preview-launch-of-doublecloud-managed-apache-airflow.html"><div class="pc-storage-background-image pc-card-base-block__header bc-post-card__header" data-qa="background-image"><picture data-qa="background-image-image"><img alt="" src="../../../../../assets/blog/articles/introducing-the-preview-launch-of-doublecloud-managed-apache-airflow-small-cover-2.webp" class="pc-storage-background-image__img"/></picture><div class="pc-storage-background-image__container"><div class="pc-card-base-block__header-content"><div class="bc-post-card__image-container" data-qa="blog-suggest-header"></div></div></div></div><div class="pc-card-base-block__body"><div class="pc-card-base-block__content"><h3 class="bc-post-card__title bc-post-card__title_size_s"><span><span id="g-uniq-277474">Introducing the preview launch of DoubleCloud Managed Apache Airflow</span></span></h3></div><div class="pc-card-base-block__footer"><div class="bc-post-info__container"><div class="bc-post-info__suggest-container"><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-277476">October 25, 2023</div><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-277478"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>15 mins to read</div></div></div></div></div></a></div></div></div><div data-index="1" class="slick-slide slick-active" tabindex="-1" aria-hidden="false" style="outline:none;width:33.333333333333336%"><div><div class="link" data-link-type="router"><a draggable="false" aria-labelledby="g-uniq-277479" aria-describedby="g-uniq-277481 g-uniq-277483" class="g-link g-link_view_normal pc-card-base-block pc-card-base-block_border_shadow bc-post-card__card" href="../../08/data-transformation-best-practices.html"><div class="pc-storage-background-image pc-card-base-block__header bc-post-card__header" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/blog/articles/2024/best-practices-for-data-transformation-as-pipeline-complexity-grows-small-cover.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/blog/articles/2024/best-practices-for-data-transformation-as-pipeline-complexity-grows-small-cover.png" class="pc-storage-background-image__img"/></picture><div class="pc-storage-background-image__container"><div class="pc-card-base-block__header-content"><div class="bc-post-card__image-container" data-qa="blog-suggest-header"></div></div></div></div><div class="pc-card-base-block__body"><div class="pc-card-base-block__content"><h3 class="bc-post-card__title bc-post-card__title_size_s"><span><span id="g-uniq-277479">Best practices for data transformation as pipeline complexity grows</span></span></h3></div><div class="pc-card-base-block__footer"><div class="bc-post-info__container"><div class="bc-post-info__suggest-container"><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-277481">August 20, 2024</div><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-277483"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>15 mins to read</div></div></div></div></div></a></div></div></div><div data-index="2" class="slick-slide slick-active" tabindex="-1" aria-hidden="false" style="outline:none;width:33.333333333333336%"><div><div class="link" data-link-type="router"><a draggable="false" aria-labelledby="g-uniq-277484" aria-describedby="g-uniq-277485 g-uniq-277486 g-uniq-277488" class="g-link g-link_view_normal pc-card-base-block pc-card-base-block_border_shadow bc-post-card__card" href="../real-time-analytics-kafka-clickhouse-integration.html"><div class="pc-storage-background-image pc-card-base-block__header bc-post-card__header" data-qa="background-image"><picture data-qa="background-image-image"><source srcSet="../../../../../assets/blog/articles/2024/real-time-analytics-kafka-clickhouse-integration-small-cover.png.webp" type="image/webp" data-qa="background-image-image-desktop-source-compressed"/><img alt="" src="../../../../../assets/blog/articles/2024/real-time-analytics-kafka-clickhouse-integration-small-cover.png" class="pc-storage-background-image__img"/></picture><div class="pc-storage-background-image__container"><div class="pc-card-base-block__header-content"><div class="bc-post-card__image-container" data-qa="blog-suggest-header"></div></div></div></div><div class="pc-card-base-block__body"><div class="pc-card-base-block__content"><h3 class="bc-post-card__title bc-post-card__title_size_s"><span><span id="g-uniq-277484">Clickstream analytics case study. Part I: Kafka -> Data Transfer -> ClickHouse</span></span></h3><span class="yfm yfm_blog_card bc-post-card__description" id="g-uniq-277485">Written By: Igor Mosyagin, Developer Advocate at DoubleCloud</span></div><div class="pc-card-base-block__footer"><div class="bc-post-info__container"><div class="bc-post-info__suggest-container"><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-277486">September 6, 2024</div><div class="bc-post-info__item bc-post-info__item_size_s" id="g-uniq-277488"><span class="bc-post-info__icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" class="g-icon bc-post-info__icon-color" fill="currentColor" stroke="none" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 16.004a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm3.357-3.736a1 1 0 0 0-.342-1.372L9 7.688V5.004a1 1 0 0 0-2 0v3.25a1 1 0 0 0 .486.857l2.5 1.5a1 1 0 0 0 1.371-.343Z"></path></svg></svg></span>15 mins to read</div></div></div></div></div></a></div></div></div></div></div></div><div class="pc-SliderBlock__footer"></div></div></div></div></section></div></div></div></div></div></main></div></div></div><div class="bc-prompt bc-prompt_close"><div class="bc-prompt__content"><span class="bc-prompt__text">Sign in to save this post</span><div class="bc-prompt__actions"><button class="g-button g-button_view_action g-button_size_l g-button_pin_round-round bc-prompt__action" type="button"><span class="g-button__text">Sign In</span></button></div></div></div></div><footer class="footer"><div class="pc-Grid"><div class="container-fluid "><div class="row"><div class="col  col-12 col-md-4 footer__column"><div class="link" data-link-type="router"><div class="logo footer__logo"><img alt="Logo Icon" src="../../../../../assets/logo/dc-logo-dark.svg" width="178" height="36" decoding="async" data-nimg="future" class="logo__icon" loading="lazy" style="color:transparent"/><span class="logo__text"></span></div></div></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Products</div><a aria-label="Managed Service for ClickHouse®" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/managed-clickhouse.html"><div class="navigation-item"><span class="navigation-item__text">Managed Service for ClickHouse®</span></div></a><a aria-label="Managed Service for Apache Kafka®" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/managed-kafka.html"><div class="navigation-item"><span class="navigation-item__text">Managed Service for Apache Kafka®</span></div></a><a aria-label="Managed Service for Apache Airflow®" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/managed-airflow/index.html"><div class="navigation-item"><span class="navigation-item__text">Managed Service for Apache Airflow®</span></div></a><a aria-label="Data Transfer" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/doublecloud-transfer.html"><div class="navigation-item"><span class="navigation-item__text">Data Transfer</span></div></a><a aria-label="Data Visualization" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../services/doublecloud-visualization.html"><div class="navigation-item"><span class="navigation-item__text">Data Visualization</span></div></a></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Solutions</div><a aria-label="Case studies" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../resources/case-studies/index.html"><div class="navigation-item"><span class="navigation-item__text">Case studies</span></div></a><a aria-label="Customer-facing analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../customer-facing-analytics/index.html"><div class="navigation-item"><span class="navigation-item__text">Customer-facing analytics</span></div></a><a aria-label="Real-time analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/real-time-analytics/index.html"><div class="navigation-item"><span class="navigation-item__text">Real-time analytics</span></div></a><a aria-label="Observability and monitoring" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/observability-and-monitoring/index.html"><div class="navigation-item"><span class="navigation-item__text">Observability and monitoring</span></div></a><a aria-label="AdTech and MarTech data analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/adtech.html"><div class="navigation-item"><span class="navigation-item__text">AdTech and MarTech data analytics</span></div></a><a aria-label="Analytics for mobile and gaming Apps" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/web-mobile-gaming-apps.html"><div class="navigation-item"><span class="navigation-item__text">Analytics for mobile and gaming Apps</span></div></a><a aria-label="EdTech data analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/edtech/index.html"><div class="navigation-item"><span class="navigation-item__text">EdTech data analytics</span></div></a><a aria-label="FinTech data analytics" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../solutions/fintech-real-time-analytics/index.html"><div class="navigation-item"><span class="navigation-item__text">FinTech data analytics</span></div></a></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Resources</div><a aria-label="Documentation" class="navigation-item navigation-item_type_link footer__column-link" href="../../../../../docs/index.html"><div class="navigation-item"><span class="navigation-item__text">Documentation</span></div></a><a aria-label="Webinars" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../webinars/index.html"><div class="navigation-item"><span class="navigation-item__text">Webinars</span></div></a><a aria-label="Blog" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../index.html"><div class="navigation-item navigation-item_selected"><span class="navigation-item__text">Blog</span></div></a><a aria-label="Support" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../support/index.html"><div class="navigation-item"><span class="navigation-item__text">Support</span></div></a><a href="https://status.double.cloud/" aria-label="Status updates" class="navigation-item navigation-item_type_link footer__column-link" target="_blank" rel="noopener noreferrer"><div class="navigation-item"><span class="navigation-item__text">Status updates</span></div></a><a aria-label="Product comparisons" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../comparison/index.html"><div class="navigation-item"><span class="navigation-item__text">Product comparisons</span></div></a><a aria-label="Site map" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../sitemap/index.html"><div class="navigation-item"><span class="navigation-item__text">Site map</span></div></a></div><div class="col  col-6 col-sm-3 col-md-2 footer__column"><div class="footer__column-title">Company</div><a aria-label="About DoubleCloud" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../company/about-us.html"><div class="navigation-item"><span class="navigation-item__text">About DoubleCloud</span></div></a><a aria-label="Careers" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../company/careers.html"><div class="navigation-item"><span class="navigation-item__text">Careers</span></div></a><a aria-label="AWS Partnership" class="navigation-item navigation-item_type_link footer__column-link" data-link-type="router" href="../../../../../aws-partnership/index.html"><div class="navigation-item"><span class="navigation-item__text">AWS Partnership</span></div></a></div></div><div class="row"><div class="col  col-12 footer__underline"><div class="footer__underline-links"><a href="../../../../../legal/customer_agreement/index.html" aria-label="Customer Agreement" class="navigation-item navigation-item_type_link footer__underline-link" target="_blank"><div class="navigation-item"><span class="navigation-item__text">Customer Agreement</span></div></a><a href="../../../../../legal/privacy.html" aria-label="Privacy Policy" class="navigation-item navigation-item_type_link footer__underline-link" target="_blank"><div class="navigation-item"><span class="navigation-item__text">Privacy Policy</span></div></a><a aria-label="Pricing" class="navigation-item navigation-item_type_link footer__underline-link" data-link-type="router" href="../../../../../pricing.html"><div class="navigation-item"><span class="navigation-item__text">Pricing</span></div></a><a href="../../../../../security.html" aria-label="Security" class="navigation-item navigation-item_type_link footer__underline-link" target="_blank"><div class="navigation-item"><span class="navigation-item__text">Security</span></div></a></div><div class="footer__underline-copyright">© 2024 DoubleCloud</div></div></div></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json" nonce="zpGfdl9st5PJR2ABdBTFVQ==">{"props":{"pageProps":{"data":{"status":"fulfilled","pageContent":{"page":{"id":169,"name":"blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration","createdAt":"2024-09-30T13:47:51.562Z","updatedAt":"2024-09-30T13:47:51.562Z","type":"default","isDeleted":false,"versionOnTranslationId":null,"pageId":169,"locale":"en","publishedVersionId":2319,"lastVersionId":2319,"content":{"blocks":[{"type":"blog-header-block","resetPaddings":true,"paddingBottom":"l","width":"s","verticalOffset":"l","background":{"image":{"src":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-cover.png","disableCompress":true,"fetchPriority":"high"},"color":"#000000","fullWidth":false}},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"right","resetPaddings":true,"text":"\u003cp\u003eQuick navigation:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#introduction\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#data-solution-overview\"\u003eData Solution overview\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#setup-airflow-cluster\"\u003eSetup Airflow cluster\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#aggregations\"\u003eAggregations\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#back-to-airflow\"\u003eBack to\u0026nbsp;Airflow\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#changing-dag-structure\"\u003eChanging DAG structure\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#adjusting-airflow-dag\"\u003eAdjusting Airflow DAG\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#final-result\"\u003eFinal result\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#looking-ahead-to-part-iii\"\u003eLooking ahead to\u0026nbsp;part III\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"},{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003ch2 id=\"introduction\"\u003e\u003ca href=\"#introduction\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eIntroduction\u003c/span\u003e\u003c/a\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eWelcome back to\u0026nbsp;our series on\u0026nbsp;building a\u0026nbsp;real-time analytics system. We\u0026rsquo;re exploring how to\u0026nbsp;set up\u0026nbsp;a\u0026nbsp;powerful analytics platform using DoubleCloud\u0026rsquo;s managed services. This series covers everything from getting data in, to\u0026nbsp;crunching numbers, to\u0026nbsp;creating eye-catching dashboards.\u003c/p\u003e\n\u003cp\u003eIn\u0026nbsp;this second post, we\u0026rsquo;ll show you how to\u0026nbsp;set up\u0026nbsp;an\u0026nbsp;Airflow cluster. We\u0026rsquo;ll use it\u0026nbsp;to\u0026nbsp;run a\u0026nbsp;batch job that takes the data we\u0026nbsp;loaded in\u0026nbsp;the first step and turns it\u0026nbsp;into useful summaries. This is\u0026nbsp;a\u0026nbsp;key part of\u0026nbsp;making our analytics system efficient and reliable.\u003c/p\u003e\n\u003cp\u003eIf\u0026nbsp;you missed our first post about initial setup and data loading, \u003ca href=\"https://double.cloud/blog/posts/2024/09/real-time-analytics-kafka-clickhouse-integration/\"\u003eyou can find it\u0026nbsp;here\u003c/a\u003e.\u003c/p\u003e\n\u003ch2 id=\"data-solution-overview\"\u003e\u003ca href=\"#data-solution-overview\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eData Solution overview\u003c/span\u003e\u003c/a\u003eData Solution overview\u003c/h2\u003e\n\u003cp\u003eLe\u0026rsquo;s recap our overall data platform architecture.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-1.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eIn\u0026nbsp;our previous post, we\u0026nbsp;focused on\u0026nbsp;building the ingestion side. Now, we\u0026rsquo;re moving on\u0026nbsp;to\u0026nbsp;the next crucial step: aggregations.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-2.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eWe\u0026rsquo;ve successfully set up\u0026nbsp;our data pipeline, so\u0026nbsp;our next challenge is\u0026nbsp;to\u0026nbsp;compute and automate aggregation. This is\u0026nbsp;where we\u0026nbsp;turnraw data into actionable insights.\u003c/p\u003e\n\u003ch3 id=\"a-quick-note-on-batch-processing\"\u003e\u003ca href=\"#a-quick-note-on-batch-processing\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eA\u0026nbsp;quick note on\u0026nbsp;batch processing\u003c/span\u003e\u003c/a\u003eA\u0026nbsp;quick note on\u0026nbsp;batch processing\u003c/h3\u003e\n\u003cp\u003eYou might be\u0026nbsp;wondering: \u0026ldquo;Wait, isn\u0026rsquo;t this series about real-time analytics? Why are we\u0026nbsp;talking about batch processing?\u0026rdquo;\u003c/p\u003e\n\u003cp\u003eGreat question! While our end goal is\u0026nbsp;real-time analytics, it\u0026rsquo;s important to\u0026nbsp;remember that a\u0026nbsp;robust data platform often combines both real-time and batch processing. Batch processing is\u0026nbsp;crucial for handling large volumes of\u0026nbsp;historical data, performing complex analyses, and creating aggregated views that complement our real-time insights.\u003c/p\u003e\n\u003cp\u003eIn\u0026nbsp;many real-world scenarios, you\u0026rsquo;ll need both approaches to\u0026nbsp;get a\u0026nbsp;complete picture of\u0026nbsp;your data. The common knowledge is\u0026nbsp;that real time processing gives you immediate insights, while batch processing allows for more in-depth, comprehensive analysis. By\u0026nbsp;covering batch processing in\u0026nbsp;this post, we\u0026rsquo;re making sure that we\u0026rsquo;re building a\u0026nbsp;well-rounded platform that can handle various analytical needs.\u003c/p\u003e\n\u003ch2 id=\"setup-airflow-cluster\"\u003e\u003ca href=\"#setup-airflow-cluster\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eSetup Airflow cluster\u003c/span\u003e\u003c/a\u003eSetup Airflow cluster\u003c/h2\u003e\n\u003cp\u003eLet\u0026rsquo;s start by\u0026nbsp;creating our Airflow cluster. This process takes a\u0026nbsp;bit of\u0026nbsp;time, so\u0026nbsp;it\u0026rsquo;s a\u0026nbsp;good idea to\u0026nbsp;get it\u0026nbsp;started first and then move on\u0026nbsp;to\u0026nbsp;other tasks while it\u0026nbsp;sets\u0026nbsp;up. The new Airflow cluster can be\u0026nbsp;created from a\u0026nbsp;cluster tab in\u0026nbsp;the DoubleCloud console. I\u0026rsquo;ll use a\u0026nbsp;small production environment configuration for this example.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-3.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eI\u0026rsquo;m using the latest available version 2.10.0 which comes with a\u0026nbsp;sleek dark theme and some handy features. We\u0026nbsp;usually try to\u0026nbsp;make sure new Airflow versions are available in\u0026nbsp;a\u0026nbsp;few days after they get released by\u0026nbsp;the Airflow community. Remember, our platform allows you to\u0026nbsp;create custom images if\u0026nbsp;you need more specific setups. The default DoubleCloud Airflow comes with the ClickHouse plugin pre-installed, so\u0026nbsp;you\u0026rsquo;re all set to\u0026nbsp;work with your ClickHouse cluster.\u003c/p\u003e\n\u003cp\u003eFor this demo, I\u0026nbsp;continue using \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/\"\u003ethe same repository\u003c/a\u003e. If\u0026nbsp;you\u0026rsquo;re planning to\u0026nbsp;use yours, make sure:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eYou can access it\u0026nbsp;with the provided credentials or\u0026nbsp;it\u0026rsquo;s publicly accessible\u003c/li\u003e\n\u003cli\u003eYou\u0026rsquo;re using the correct branch\u003c/li\u003e\n\u003cli\u003eYou\u0026rsquo;ve specified the right path to\u0026nbsp;the DAG folder\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere\u0026rsquo;s my\u0026nbsp;setup: I\u0026rsquo;m using the \u003ccode\u003etrunk\u003c/code\u003e branch, and my\u0026nbsp;DAGs are in\u0026nbsp;the \u003ccode\u003edags\u003c/code\u003e folder at\u0026nbsp;the root of\u0026nbsp;my\u0026nbsp;repo.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-4.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eIf\u0026nbsp;repository is\u0026nbsp;private, you\u0026rsquo;ll need to\u0026nbsp;provide a\u0026nbsp;username and a\u0026nbsp;password or\u0026nbsp;Personal Access Token (PAT). Check your version control system\u0026rsquo;s documentation for details on\u0026nbsp;setting this up.\u003c/p\u003e\n\u003cp\u003eThe DAG folder will be\u0026nbsp;mounted using git-sync. This means you can update your DAGs by\u0026nbsp;simply pushing changes to\u0026nbsp;your git branch\u0026nbsp;\u0026mdash; no\u0026nbsp;need to\u0026nbsp;update the cluster itself.\u003c/p\u003e\n\u003cp\u003eFor now, I\u0026rsquo;ll keep all other settings at\u0026nbsp;their defaults and hit \u0026ldquo;Submit\u0026rdquo; to\u0026nbsp;start provisioning. While my\u0026nbsp;cluster is\u0026nbsp;spinning up, let\u0026rsquo;s make good use of\u0026nbsp;this time and do\u0026nbsp;some exploratory data analysis. This will help understand our data better nad help structure our Airflow-enhanced queries.\u003c/p\u003e\n\u003ch2 id=\"aggregations\"\u003e\u003ca href=\"#aggregations\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eAggregations\u003c/span\u003e\u003c/a\u003eAggregations\u003c/h2\u003e\n\u003cp\u003eOur data consists of\u0026nbsp;events from various parties, and our goal is\u0026nbsp;to\u0026nbsp;group them effectively. Let\u0026rsquo;s start with some EDA on\u0026nbsp;our sample of\u0026nbsp;1,000 events using WebSQL. This will help understand what aggregations we\u0026nbsp;can compute.\u003c/p\u003e\n\u003ch3 id=\"exploring-sample-clickstream-data\"\u003e\u003ca href=\"#exploring-sample-clickstream-data\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eExploring sample clickstream data\u003c/span\u003e\u003c/a\u003eExploring sample clickstream data\u003c/h3\u003e\n\u003cp\u003eFirst, let\u0026rsquo;s remind ourselves about the table columns and their types. In\u0026nbsp;ClickHouse, we\u0026nbsp;can do\u0026nbsp;this using the \u003ca href=\"https://clickhouse.com/docs/ru/sql-reference/statements/describe-table\"\u003eDESCRIBE \u003ccode\u003e\u0026lt;tablename\u0026gt;\u003c/code\u003e command\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s how it\u0026nbsp;looks in\u0026nbsp;WebSQL query editor:\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-5.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eOur landing table is\u0026nbsp;quite extensive, but the xey fields for our analysis are:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003epartyId\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esessionId\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eItem_price\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eeventType\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edetectedDuplicate\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edetectedCorruption\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emy_ts\u003c/code\u003e (containing the adjusted timestamp)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eNow\u0026rsquo; let\u0026rsquo;s check for duplicates and corruption in\u0026nbsp;our data:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e eventType, detectedDuplicate, detectedCorruption, \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e events_webshop \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"43\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-43\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-43\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-43.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-7.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eInterestingly, our sample doesn\u0026rsquo;t show any detected duplicates, but there are some events marked as\u0026nbsp;corrupted. Given our small sample size of\u0026nbsp;1,000 events, we\u0026nbsp;won\u0026rsquo;t focus too much on\u0026nbsp;duplicates now, but it\u0026rsquo;s something to\u0026nbsp;keep in\u0026nbsp;mind for larger samples.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s move on\u0026nbsp;to\u0026nbsp;some more useful aggregations. We\u0026rsquo;ll compute how many visitors we\u0026nbsp;had each hour in\u0026nbsp;our dataset. ClickHouse offers \u003ca href=\"https://clickhouse.com/docs/en/sql-reference/functions/date-time-functions\"\u003emany functions\u003c/a\u003e for working with datetime data, all expecting DateTime64 format.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;ll cast the values on\u0026nbsp;the fly:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n        toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e visitors,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e total_events,\n        \u003cspan class=\"hljs-built_in\"\u003eMIN\u003c/span\u003e(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e mnts,\n        \u003cspan class=\"hljs-built_in\"\u003eMAX\u003c/span\u003e(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e mxts\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e events_webshop \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"9\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-9\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-9\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-9.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-8.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eFrom these results, we\u0026nbsp;can see that our 1,000-event sample spans 5\u0026nbsp;hours, with a\u0026nbsp;fairly even distribution of\u0026nbsp;events across each hour. The events are clustered at\u0026nbsp;the start and end of\u0026nbsp;each hour. We\u0026nbsp;also notice that our visitor count is\u0026nbsp;quite low, but it\u0026rsquo;s sufficient for building our initial pipeline.\u003c/p\u003e\n\u003ch3 id=\"performance-metrics-for-sample-data\"\u003e\u003ca href=\"#performance-metrics-for-sample-data\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003ePerformance metrics for sample data\u003c/span\u003e\u003c/a\u003ePerformance metrics for sample data\u003c/h3\u003e\n\u003cp\u003eOur dataset includes two event types: \u003ccode\u003eitemBuyEvent\u003c/code\u003e and \u003ccode\u003eitemViewEvent\u003c/code\u003e. We\u0026rsquo;ve already counted visitors, but now let\u0026rsquo;s focus on\u0026nbsp;purchases and revenue metrics, grouped by\u0026nbsp;hour:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eTotal revenue:\u003c/strong\u003e sum of\u0026nbsp;all \u003ccode\u003eitem_price\u003c/code\u003e fields for events with \u003ccode\u003eeventType = itemBuyEvent\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eNumber of\u0026nbsp;buyers:\u003c/strong\u003e count of\u0026nbsp;distinct \u003ccode\u003epartyId\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eTotal purchases:\u003c/strong\u003e count of\u0026nbsp;distinct \u003ccode\u003esessionId\u003c/code\u003e per hour\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eAverage revenue per purchase:\u003c/strong\u003e total revenue divided by\u0026nbsp;number of\u0026nbsp;purchases\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere\u0026rsquo;s the SQL query to\u0026nbsp;calculate these metrics:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n    \u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(item_price) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e total_revenue,\n    \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_buyers,\n    \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e sessionId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_purchases,\n    round(total_revenue \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e num_purchases, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e average_revenue_per_purchase\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e events_webshop \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e eventType\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e'itemBuyEvent'\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"34\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-34\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-34\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-34.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-9.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003ch3 id=\"putting-it-all-together\"\u003e\u003ca href=\"#putting-it-all-together\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003ePutting it\u0026nbsp;all together\u003c/span\u003e\u003c/a\u003ePutting it\u0026nbsp;all together\u003c/h3\u003e\n\u003cp\u003eNow that we\u0026nbsp;have our performance metrics, let\u0026rsquo;s combine them with our visitor data and apply our filtering criteria for duplicates and corruption. I\u0026nbsp;will use Common Tabls Experssions (CTEs) to\u0026nbsp;organize the resulting query:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eWITH\u003c/span\u003e good_data \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e webshop.events_webshop\n    \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e detectedDuplicate\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e detectedCorruption\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n), visitors \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n        toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e visitors\n    \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e good_data\n    \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n), performance \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n        toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n        \u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(item_price) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e total_revenue,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_buyers,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e sessionId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_purchases\n        round(total_revenue \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e num_purchases, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e average_revenue_per_purchase\n    \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e good_data\n    \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e eventType\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e'itemBuyEvent'\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n) \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    v.hour,\n    v.visitors,\n    p.num_buyers,\n    p.num_purchases,\n    p.total_revenue,\n    p.average_revenue_per_purchase\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e visitors v \u003cspan class=\"hljs-keyword\"\u003eJOIN\u003c/span\u003e performance p \u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e v.hour \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e p.hour \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"6\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-6\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-6\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-6.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e"}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eYou can find the full query \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/sql/compute_full_aggs.sql\"\u003eat\u0026nbsp;github here\u003c/a\u003e.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-10.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eThis query combines all the metrics we\u0026nbsp;need for our analysis. It\u0026nbsp;filters out duplicates and corrupted data, calculates visitor and performance metrics, and joins them together for a\u0026nbsp;comprehensive hourly view of\u0026nbsp;our webshop\u0026rsquo;s performance.\u003c/p\u003e\n\u003cp\u003eNow that we\u0026nbsp;have our final query, let\u0026rsquo;s move on\u0026nbsp;to\u0026nbsp;automating this process with Airflow.\u003c/p\u003e\n\u003ch2 id=\"back-to-airflow\"\u003e\u003ca href=\"#back-to-airflow\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eBack to\u0026nbsp;Airflow\u003c/span\u003e\u003c/a\u003eBack to\u0026nbsp;Airflow\u003c/h2\u003e\n\u003cp\u003eOnce the cluster is\u0026nbsp;up\u0026nbsp;and running, you can access the Web UI\u0026nbsp;from the Cluster panel via the Web Server Connection link.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-11.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003e\u003cstrong\u003eAllowlist reminder:\u003c/strong\u003e DoubleCloud automatically adds your IP\u0026nbsp;address to\u0026nbsp;the ALLOWLIST in\u0026nbsp;the cluster settings. Keep this in\u0026nbsp;mind if\u0026nbsp;you frequently change networks, like switching Wi-Fi on\u0026nbsp;your laptop. If\u0026nbsp;the Web Server connection link doesn\u0026rsquo;t open, make sure your IP\u0026nbsp;is\u0026nbsp;in\u0026nbsp;the list.\u003c/p\u003e\n\u003cp\u003eInitially, your new cluster will have no\u0026nbsp;enabled DAGs, presenting an\u0026nbsp;empty dashboard. This is\u0026nbsp;normal for a\u0026nbsp;fresh setup.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-12.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eLet\u0026rsquo;s start by\u0026nbsp;enabling and triggering the roll_d20 DAG (\u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/roll_d20.py\"\u003esrc here\u003c/a\u003e). This simple two-task DAG isn\u0026rsquo;t connecting to\u0026nbsp;any external system,\u0026nbsp;\u0026mdash; it\u0026rsquo;s just to\u0026nbsp;verify that our Airflow setup is\u0026nbsp;complete and workers are functioning. trigger it, and watch it\u0026nbsp;being executed (you can actually just trigger disabled dag and it\u0026nbsp;will be\u0026nbsp;enabled automatically).\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-13.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eYou can access the logs for each task through the Logs tab when you select a\u0026nbsp;DAG run and a\u0026nbsp;task:\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-14.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eLooks like I\u0026nbsp;got lucky\u0026nbsp;\u0026mdash; my\u0026nbsp;DAG run rolled a\u0026nbsp;13!\u003c/p\u003e\n\u003cp\u003eNow, if\u0026nbsp;we\u0026nbsp;try running our \u003ccode\u003ecompute_full_perf_metrics\u003c/code\u003e, DAG (\u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/compute_full_perf_metrics.py\"\u003esrc here\u003c/a\u003e), it\u0026nbsp;will fail:\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-15.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eThis is\u0026nbsp;expected, because our newly created cluster doesn\u0026rsquo;t know about our ClickHouse server\u0026nbsp;yet. The logs confirm this:\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-16.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eIt\u0026nbsp;all can be\u0026nbsp;fixed by\u0026nbsp;creating a\u0026nbsp;connection. Go\u0026nbsp;to\u0026nbsp;Admin-\u0026gt;Connections and add a\u0026nbsp;Generic connection using credentials for your ClickHouse server:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eConnection id: \u003ccode\u003ech_default\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eConnection type: \u003ccode\u003eGeneric\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSet host, port, and login/password accordingly\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSpecify schema: \u003ccode\u003ewebshop\u003c/code\u003e (this will be\u0026nbsp;used as\u0026nbsp;our database)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAdd {\u0026rdquo;\u003ccode\u003esecure\u003c/code\u003e\u0026rdquo;: true} to\u0026nbsp;extra settings. This is\u0026nbsp;required for DoubleCloud because your data is\u0026nbsp;always secure with us\u0026nbsp;\u0026mdash; we\u0026nbsp;just need to\u0026nbsp;tell Airflow about it!\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-17.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eNow, triggering our ClickHouse DAG again should result in\u0026nbsp;a\u0026nbsp;successful\u0026nbsp;run. The log will show you the executed query:\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-18.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eThe query result is\u0026nbsp;saved in\u0026nbsp;the XCom\u0026nbsp;tab. I\u0026rsquo;ve collapsed a\u0026nbsp;few rows, but it\u0026rsquo;s semantically the same result as\u0026nbsp;in\u0026nbsp;the WebSQL:\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-19.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eThis confirms that our Airflow cluster can now interact with the ClickHouse cluster and compute the necessary metrics. However, this setup isn\u0026rsquo;t ideal yet:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e The DAG is\u0026nbsp;not idempotent (we\u0026rsquo;ll address this in\u0026nbsp;the next part of\u0026nbsp;the series).\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e The results are only saved in\u0026nbsp;the Airflow metadata, not a\u0026nbsp;persistent location, not in\u0026nbsp;ClickHouse, hard to\u0026nbsp;access, etc\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s address the second point by\u0026nbsp;modifying our DAG structure to\u0026nbsp;save results in\u0026nbsp;a\u0026nbsp;table.\u003c/p\u003e\n\u003ch2 id=\"changing-dag-structure\"\u003e\u003ca href=\"#changing-dag-structure\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eChanging DAG structure\u003c/span\u003e\u003c/a\u003eChanging DAG structure\u003c/h2\u003e\n\u003cp\u003eLet\u0026rsquo;s modify the pipeline structure to\u0026nbsp;address the issue of\u0026nbsp;result persistence:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e First, the pipeline will check if\u0026nbsp;the target aggregation table exists\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e If\u0026nbsp;it\u0026nbsp;doesn\u0026rsquo;t exist, the pipeline should create the table and compute aggregations on\u0026nbsp;all available data\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e3.\u003c/em\u003e If\u0026nbsp;the table exists, the pipeline will truncate it\u0026nbsp;and insert new data\u003c/p\u003e\n\u003cp\u003eThis pipeline isn\u0026rsquo;t ideal for production use as\u0026nbsp;it\u0026nbsp;has a\u0026nbsp;few obvious drawbacks, but it\u0026nbsp;demonstrates how to\u0026nbsp;write an\u0026nbsp;Airflow pipeline with additional SQL-based checks. I\u0026rsquo;ll discuss pipeline improvements and query performance in\u0026nbsp;the next part of\u0026nbsp;this series.\u003c/p\u003e\n\u003ch3 id=\"additional-table\"\u003e\u003ca href=\"#additional-table\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eAdditional table\u003c/span\u003e\u003c/a\u003eAdditional table\u003c/h3\u003e\n\u003cp\u003eFor our aggregates data mart, let\u0026rsquo;s use the following structure:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e IF \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eEXISTS\u003c/span\u003e performance_aggregates (\n    ts_start DateTime,\n    ts_end DateTime,\n    visitors \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    num_buyers \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    num_purchases \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    total_revenue \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    average_revenue_per_purchase Float32\n) ENGINE \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e MergeTree() \u003cspan class=\"hljs-keyword\"\u003ePRIMARY\u003c/span\u003e KEY ts_start\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"36\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-36\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-36\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-36.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e"}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eThis structure is\u0026nbsp;similar to\u0026nbsp;what we\u0026rsquo;ve used before, with an\u0026nbsp;additional column for the end of\u0026nbsp;the interval. The MergeTree engine is\u0026nbsp;suitable for our test sample, but for production use, you should always first check if\u0026nbsp;you can use \u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines#mergetree\"\u003emore specific\u003c/a\u003e engine type.\u003c/p\u003e\n\u003cp\u003eTo\u0026nbsp;insert data into this table, I\u0026nbsp;will slightly modify me\u0026nbsp;existing query by\u0026nbsp;adding an\u0026nbsp;INSERT INTO statement:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e webshop.performance_aggregates\n  (ts_start, ts_end, total_revenue, num_buyers, visitors, total_revenue, average_revenue_per_purchase)\n\u003cspan class=\"hljs-keyword\"\u003eWITH\u003c/span\u003e good_data \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n  …\n\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"6\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-6\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-6\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-6.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e"}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eFull query code \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/sql/compute_insert_aggs.sql\"\u003ecan be\u0026nbsp;found here\u003c/a\u003e. It\u0026rsquo;s worth noting that this approach has some limitations and wouldn\u0026rsquo;t be\u0026nbsp;ideal for a\u0026nbsp;production environment. However, for our current goal of\u0026nbsp;getting all the components working together, it\u0026rsquo;s sufficient.\u003c/p\u003e\n\u003cp\u003eIn\u0026nbsp;the next part of\u0026nbsp;this series, we\u0026rsquo;ll address these limitations and discuss how to\u0026nbsp;make the pipeline more robust and suitable for production use.\u003c/p\u003e\n\u003ch2 id=\"adjusting-airflow-dag\"\u003e\u003ca href=\"#adjusting-airflow-dag\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eAdjusting Airflow DAG\u003c/span\u003e\u003c/a\u003eAdjusting Airflow DAG\u003c/h2\u003e\n\u003cp\u003eHere\u0026rsquo;s my\u0026nbsp;resulting pipeline structure:\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-20.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eYou can see the complete code \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/compute_full_perf_metrics_save_to_table.py\"\u003ein\u0026nbsp;our repository\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;d like to\u0026nbsp;highlight some key points about this new DAG:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eThis DAG has \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L32\"\u003eno\u0026nbsp;schedule\u003c/a\u003e. Since it\u0026nbsp;computes across the whole table, it\u0026rsquo;s designed more for per-trigger use rather than scheduled runs.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWhile the DAG might seem verbose with some tasks that could be\u0026nbsp;combined, this structure showcases how to\u0026nbsp;author more complex DAGs. Tip: Airflow has a\u0026nbsp;lesser-known feature that allows you to\u0026nbsp;add text on\u0026nbsp;top of\u0026nbsp;edges, making complicated DAGs look cleaner. \u003ca href=\"https://airflow.apache.org/docs/apache-airflow/2.10.0/_modules/airflow/example_dags/example_branch_labels.html\"\u003eSee here\u003c/a\u003e.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eGiven the nature of\u0026nbsp;the overall process, I\u0026rsquo;ve \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L38\"\u003elimited\u003c/a\u003e the number of\u0026nbsp;max active runs allowed for the\u0026nbsp;DAG. This can be\u0026nbsp;useful in\u0026nbsp;certain scenarios when you expect multiple DAG runs triggered in\u0026nbsp;a\u0026nbsp;short period of\u0026nbsp;time.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWhen implementing branching in\u0026nbsp;Airflow, remember to\u0026nbsp;set dependencies in\u0026nbsp;the graph and keep task_ids naming consistent. Personally, I\u0026nbsp;often start new DAGs with EmptyOperators to\u0026nbsp;get the structure right before replacing them with real tasks.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIt\u0026rsquo;s crucial to\u0026nbsp;set the proper TriggerRule for the final task to\u0026nbsp;ensure it\u0026rsquo;s not skipped when edges merge.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIn\u0026nbsp;the DAG code, I\u0026nbsp;define \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L13-L22\"\u003ea\u0026nbsp;custom ClickHouseBranchSQLOperator\u003c/a\u003e instead of\u0026nbsp;using the one provided by\u0026nbsp;the airflow-clickhouse-plugin. This is\u0026nbsp;due to\u0026nbsp;some method resolution order (MRO) issue in\u0026nbsp;Airflow versions \u0026lt; 2.9.3. You might not need this in\u0026nbsp;newer versions (see docstring for details).\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSome SQL statements could be\u0026nbsp;hardcoded/inlined instead of\u0026nbsp;reading from a\u0026nbsp;file, but I\u0026nbsp;prefer consistency and this a\u0026nbsp;nice minor side-effect as\u0026nbsp;it\u0026nbsp;makes it\u0026nbsp;easier to\u0026nbsp;get feedback from SQL experts (they can just read an\u0026nbsp;SQL file and not Python code + SQL statements).\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDepending on\u0026nbsp;your use-case, it\u0026nbsp;might make sense to\u0026nbsp;set table names as\u0026nbsp;parameters or\u0026nbsp;Airflow variables for easier modifications. I\u0026nbsp;will cover it\u0026nbsp;in\u0026nbsp;the next part, along with scheduling, idempotency, and data_interval usage.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI\u0026nbsp;want to\u0026nbsp;emphasize that we\u0026rsquo;re focusing on\u0026nbsp;using Airflow with our ClickHouse cluster data, not on\u0026nbsp;production-ready code quality. I\u0026rsquo;d caution against using this DAG directly in\u0026nbsp;production. However, it\u0026nbsp;serves as\u0026nbsp;a\u0026nbsp;good starting point for developing your own DAGs that utilize ClickHouse.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s trigger this DAG and check the results. Enabling the DAG and running it\u0026nbsp;for the first time will create the table and compute the aggregations. Subsequent runs will use the other branch.\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-21.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eIn\u0026nbsp;the next part of\u0026nbsp;this series, we\u0026rsquo;ll refine our approach and address some of\u0026nbsp;the limitations in\u0026nbsp;this initial implementation.\u003c/p\u003e\n\u003ch2 id=\"final-result\"\u003e\u003ca href=\"#final-result\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eFinal result\u003c/span\u003e\u003c/a\u003eFinal result\u003c/h2\u003e\n\u003cp\u003eSwitching to\u0026nbsp;WebSQL I\u0026nbsp;can now see my\u0026nbsp;new table and query data from it:\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-22.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eRunning the DAG again would takes a\u0026nbsp;different path in\u0026nbsp;the graph. Since we\u0026nbsp;limited the max active runs, multiple triggers won\u0026rsquo;t interfere with each other:\u003c/p\u003e"},{"type":"blog-media-block","column":"left","resetPaddings":true,"text":"","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-23.png","fullWidth":false}]},{"type":"blog-layout-block","resetPaddings":true,"mobileOrder":"reverse","children":[{"type":"blog-yfm-block","column":"left","resetPaddings":true,"text":"\u003cp\u003eEverything seems to\u0026nbsp;be\u0026nbsp;working as\u0026nbsp;expected. Let\u0026rsquo;s recap what we\u0026rsquo;ve accomplished:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e We\u0026nbsp;started by\u0026nbsp;spinning up\u0026nbsp;an\u0026nbsp;Airflow cluster. My\u0026nbsp;DAGs are stored in\u0026nbsp;separate folder \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/tree/trunk\"\u003ein\u0026nbsp;a\u0026nbsp;repository\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e I\u0026nbsp;did some Exploratory Data Analysis to\u0026nbsp;determine what we\u0026nbsp;wanted to\u0026nbsp;compute and got our first working query in\u0026nbsp;WebSQL. The fancy phrase basically means \u0026ldquo;I\u0026rsquo;ve ran some queries to\u0026nbsp;check what\u0026rsquo;s up\u0026nbsp;with my\u0026nbsp;data\u0026rdquo;. This helped me\u0026nbsp;understand my\u0026nbsp;data better and prepare for automation in\u0026nbsp;Airflow. By\u0026nbsp;saving queries as\u0026nbsp;SQL files in\u0026nbsp;my\u0026nbsp;DAGs folder, I\u0026nbsp;can later easily reuse them.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e3.\u003c/em\u003e Using ClickHouseOperator in\u0026nbsp;Airflow, I\u0026rsquo;ve set up\u0026nbsp;a\u0026nbsp;simple DAG that runs the query as-is. This helped me\u0026nbsp;ensure everything is\u0026nbsp;working fine from connectivity standpoint.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e4.\u003c/em\u003e I\u0026rsquo;ve added a\u0026nbsp;few additional steps to\u0026nbsp;my\u0026nbsp;DAG that create the aggregation table and save the result, allowing me\u0026nbsp;to\u0026nbsp;rerun it\u0026nbsp;whenever needed.\u003c/p\u003e\n\u003cp\u003eThis is\u0026nbsp;a\u0026nbsp;point in\u0026nbsp;our imaginary communication with the data client where I\u0026nbsp;can now present these results to\u0026nbsp;data analysts and gather feedback on\u0026nbsp;either the SQL queries or\u0026nbsp;the data mart structure. It\u0026rsquo;s a\u0026nbsp;good place to\u0026nbsp;wrap up\u0026nbsp;this part of\u0026nbsp;our series.\u003c/p\u003e\n\u003ch2 id=\"looking-ahead-to-part-iii\"\u003e\u003ca href=\"#looking-ahead-to-part-iii\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eLooking ahead to\u0026nbsp;part III\u003c/span\u003e\u003c/a\u003eLooking ahead to\u0026nbsp;part III\u003c/h2\u003e\n\u003cp\u003eIn\u0026nbsp;the next installment of\u0026nbsp;this series, we\u0026rsquo;re going to\u0026nbsp;take our analytics platform to\u0026nbsp;the next level:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e We\u0026rsquo;ll build an\u0026nbsp;interactive dashboard using the DoubleCloud Visualization tool, bringing our data to\u0026nbsp;life visually.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e We\u0026rsquo;ll shorten the time bucket for more granular analysis and utilize a\u0026nbsp;bigger dataset to\u0026nbsp;stress-test our system.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e3.\u003c/em\u003e We\u0026rsquo;ll refine our DAG, addressing improvements such as:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eImplementing idempotency\u003c/li\u003e\n\u003cli\u003eSetting up\u0026nbsp;proper scheduling\u003c/li\u003e\n\u003cli\u003eMaking our pipeline more robust for production use\u003c/li\u003e\n\u003cli\u003eParametrizing table names and leveraging Airflow variables for increased flexibility\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cem\u003e4.\u003c/em\u003e We\u0026rsquo;ll explore how this entire setup can be\u0026nbsp;deployed using Terraform, streamlining the infrastructure-as-code process.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e5.\u003c/em\u003e We\u0026rsquo;ll also cover different table structures and approaches for this problem and how different ClickHouse engines can be\u0026nbsp;used here, and if\u0026nbsp;we\u0026nbsp;indeed need to\u0026nbsp;use something different than the basic MergeTree for optimizing this analytics pipeline.\u003c/p\u003e\n\u003cp\u003eRemember, while our current implementation works, it\u0026rsquo;s designed as\u0026nbsp;a\u0026nbsp;learning exercise. For production environments, if\u0026nbsp;you were going with self-hosted solutions, you\u0026rsquo;d need to\u0026nbsp;implement additional error handling, logging, and performance optimizations. However, with DoubleCloud, many of\u0026nbsp;these issues are solved for you, allowing you to\u0026nbsp;focus on\u0026nbsp;your data processing needs instead.\u003c/p\u003e\n\u003cp\u003eThanks for joining us\u0026nbsp;on\u0026nbsp;this journey so\u0026nbsp;far. Stay tuned for part III, where we\u0026rsquo;ll bring all these pieces together into a\u0026nbsp;comprehensive, production-grade analytics solution! If\u0026nbsp;you have any questions or\u0026nbsp;would like to\u0026nbsp;discuss this series further, feel free to\u0026nbsp;reach out on\u0026nbsp;Slack. DoubleCloud is\u0026nbsp;always here to\u0026nbsp;help you make the most of\u0026nbsp;your data!\u003c/p\u003e"}]},{"type":"content-layout-block","background":{"src":"/assets/doublecloud/doublecloud-cover-5.png","style":{"backgroundColor":"#CA1551"}},"centered":true,"textContent":{"title":"Get started with DoubleCloud","buttons":[{"text":"Start free trial","size":"promo","theme":"accent","url":"https://auth.double.cloud/s/signup"},{"text":"Contact us","theme":"pseudo","url":"#contact-us-form"}]}},{"type":"blog-suggest-block","resetPaddings":true,"fullWidth":false}]},"title":"Clickstream analytics case study. Part II: ClickHouse \u003c-\u003e Airflow","noIndex":false,"shareTitle":"Clickstream analytics case study. Part II: ClickHouse \u003c-\u003e Airflow","shareDescription":"In this second post, we’ll show you how to set up an Airflow cluster. We’ll use it to run a batch job that takes the data we loaded in the first step and turns it into useful summaries. This is a key part of making our analytics system efficient and reliable.","shareImage":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-sharing.png","pageLocaleId":338,"author":"unknown","metaDescription":"In this second post, we’ll show you how to set up an Airflow cluster. We’ll use it to run a batch job that takes the data we loaded in the first step and turns it into useful summaries. This is a key part of making our analytics system efficient and reliable.","keywords":[],"shareGenTitle":null,"canonicalLink":null,"sharingType":"custom","sharingTheme":"light","comment":".","shareImageUrl":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-sharing.png","pageRegionId":null,"service":null,"solution":null,"locales":[{"locale":"ru","publishedVersionId":null},{"locale":"en","publishedVersionId":2319}],"regions":[],"pageRegions":[{"id":8,"pageId":169,"regionCode":"en","createdAt":"2024-09-23T16:18:56.815Z","updatedAt":"2024-09-23T16:18:56.857Z","publishedVersionId":null,"lastVersionId":2299}]},"post":{"url":"","id":169,"name":"real-time-analytics-airflow-clickhouse-integration","isPinned":false,"blogPostId":169,"image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-small-cover.png","readingTime":15,"date":"2024-09-23T00:00:00Z","likes":0,"hasUserLike":false,"services":[],"slug":"","authors":[],"locale":{"lang":"en"},"textTitle":"Clickstream analytics case study. Part II: ClickHouse \u0026lt;→ Airflow","htmlTitle":"Clickstream analytics case study. Part II: ClickHouse \u0026lt;-\u0026gt; Airflow","title":"Clickstream analytics case study. Part II: ClickHouse \u003c-\u003e Airflow","tags":[{"icon":null,"slug":"insights","name":"Insights","createdAt":"","updatedAt":"","count":0},{"icon":null,"slug":"ClickHouse","name":"ClickHouse","createdAt":"","updatedAt":"","count":0},{"icon":null,"slug":"Airflow","name":"Airflow","createdAt":"","updatedAt":"","count":0}],"metaTitle":"Clickstream analytics case study. Part II: ClickHouse \u003c-\u003e Airflow","description":"\u003cp\u003eWritten By: Igor Mosyagin, Developer Advocate at\u0026nbsp;DoubleCloud\u003c/p\u003e","content":"\u003cp\u003eQuick navigation:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#introduction\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#data-solution-overview\"\u003eData Solution overview\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#setup-airflow-cluster\"\u003eSetup Airflow cluster\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#aggregations\"\u003eAggregations\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#back-to-airflow\"\u003eBack to\u0026nbsp;Airflow\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#changing-dag-structure\"\u003eChanging DAG structure\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#adjusting-airflow-dag\"\u003eAdjusting Airflow DAG\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#final-result\"\u003eFinal result\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#looking-ahead-to-part-iii\"\u003eLooking ahead to\u0026nbsp;part III\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"introduction\"\u003e\u003ca href=\"#introduction\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eIntroduction\u003c/span\u003e\u003c/a\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eWelcome back to\u0026nbsp;our series on\u0026nbsp;building a\u0026nbsp;real-time analytics system. We\u0026rsquo;re exploring how to\u0026nbsp;set up\u0026nbsp;a\u0026nbsp;powerful analytics platform using DoubleCloud\u0026rsquo;s managed services. This series covers everything from getting data in, to\u0026nbsp;crunching numbers, to\u0026nbsp;creating eye-catching dashboards.\u003c/p\u003e\n\u003cp\u003eIn\u0026nbsp;this second post, we\u0026rsquo;ll show you how to\u0026nbsp;set up\u0026nbsp;an\u0026nbsp;Airflow cluster. We\u0026rsquo;ll use it\u0026nbsp;to\u0026nbsp;run a\u0026nbsp;batch job that takes the data we\u0026nbsp;loaded in\u0026nbsp;the first step and turns it\u0026nbsp;into useful summaries. This is\u0026nbsp;a\u0026nbsp;key part of\u0026nbsp;making our analytics system efficient and reliable.\u003c/p\u003e\n\u003cp\u003eIf\u0026nbsp;you missed our first post about initial setup and data loading, \u003ca href=\"https://double.cloud/blog/posts/2024/09/real-time-analytics-kafka-clickhouse-integration/\"\u003eyou can find it\u0026nbsp;here\u003c/a\u003e.\u003c/p\u003e\n\u003ch2 id=\"data-solution-overview\"\u003e\u003ca href=\"#data-solution-overview\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eData Solution overview\u003c/span\u003e\u003c/a\u003eData Solution overview\u003c/h2\u003e\n\u003cp\u003eLe\u0026rsquo;s recap our overall data platform architecture.\u003c/p\u003e\n\n\u003cp\u003eIn\u0026nbsp;our previous post, we\u0026nbsp;focused on\u0026nbsp;building the ingestion side. Now, we\u0026rsquo;re moving on\u0026nbsp;to\u0026nbsp;the next crucial step: aggregations.\u003c/p\u003e\n\n\u003cp\u003eWe\u0026rsquo;ve successfully set up\u0026nbsp;our data pipeline, so\u0026nbsp;our next challenge is\u0026nbsp;to\u0026nbsp;compute and automate aggregation. This is\u0026nbsp;where we\u0026nbsp;turnraw data into actionable insights.\u003c/p\u003e\n\u003ch3 id=\"a-quick-note-on-batch-processing\"\u003e\u003ca href=\"#a-quick-note-on-batch-processing\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eA\u0026nbsp;quick note on\u0026nbsp;batch processing\u003c/span\u003e\u003c/a\u003eA\u0026nbsp;quick note on\u0026nbsp;batch processing\u003c/h3\u003e\n\u003cp\u003eYou might be\u0026nbsp;wondering: \u0026ldquo;Wait, isn\u0026rsquo;t this series about real-time analytics? Why are we\u0026nbsp;talking about batch processing?\u0026rdquo;\u003c/p\u003e\n\u003cp\u003eGreat question! While our end goal is\u0026nbsp;real-time analytics, it\u0026rsquo;s important to\u0026nbsp;remember that a\u0026nbsp;robust data platform often combines both real-time and batch processing. Batch processing is\u0026nbsp;crucial for handling large volumes of\u0026nbsp;historical data, performing complex analyses, and creating aggregated views that complement our real-time insights.\u003c/p\u003e\n\u003cp\u003eIn\u0026nbsp;many real-world scenarios, you\u0026rsquo;ll need both approaches to\u0026nbsp;get a\u0026nbsp;complete picture of\u0026nbsp;your data. The common knowledge is\u0026nbsp;that real time processing gives you immediate insights, while batch processing allows for more in-depth, comprehensive analysis. By\u0026nbsp;covering batch processing in\u0026nbsp;this post, we\u0026rsquo;re making sure that we\u0026rsquo;re building a\u0026nbsp;well-rounded platform that can handle various analytical needs.\u003c/p\u003e\n\u003ch2 id=\"setup-airflow-cluster\"\u003e\u003ca href=\"#setup-airflow-cluster\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eSetup Airflow cluster\u003c/span\u003e\u003c/a\u003eSetup Airflow cluster\u003c/h2\u003e\n\u003cp\u003eLet\u0026rsquo;s start by\u0026nbsp;creating our Airflow cluster. This process takes a\u0026nbsp;bit of\u0026nbsp;time, so\u0026nbsp;it\u0026rsquo;s a\u0026nbsp;good idea to\u0026nbsp;get it\u0026nbsp;started first and then move on\u0026nbsp;to\u0026nbsp;other tasks while it\u0026nbsp;sets\u0026nbsp;up. The new Airflow cluster can be\u0026nbsp;created from a\u0026nbsp;cluster tab in\u0026nbsp;the DoubleCloud console. I\u0026rsquo;ll use a\u0026nbsp;small production environment configuration for this example.\u003c/p\u003e\n\n\u003cp\u003eI\u0026rsquo;m using the latest available version 2.10.0 which comes with a\u0026nbsp;sleek dark theme and some handy features. We\u0026nbsp;usually try to\u0026nbsp;make sure new Airflow versions are available in\u0026nbsp;a\u0026nbsp;few days after they get released by\u0026nbsp;the Airflow community. Remember, our platform allows you to\u0026nbsp;create custom images if\u0026nbsp;you need more specific setups. The default DoubleCloud Airflow comes with the ClickHouse plugin pre-installed, so\u0026nbsp;you\u0026rsquo;re all set to\u0026nbsp;work with your ClickHouse cluster.\u003c/p\u003e\n\u003cp\u003eFor this demo, I\u0026nbsp;continue using \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/\"\u003ethe same repository\u003c/a\u003e. If\u0026nbsp;you\u0026rsquo;re planning to\u0026nbsp;use yours, make sure:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eYou can access it\u0026nbsp;with the provided credentials or\u0026nbsp;it\u0026rsquo;s publicly accessible\u003c/li\u003e\n\u003cli\u003eYou\u0026rsquo;re using the correct branch\u003c/li\u003e\n\u003cli\u003eYou\u0026rsquo;ve specified the right path to\u0026nbsp;the DAG folder\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere\u0026rsquo;s my\u0026nbsp;setup: I\u0026rsquo;m using the \u003ccode\u003etrunk\u003c/code\u003e branch, and my\u0026nbsp;DAGs are in\u0026nbsp;the \u003ccode\u003edags\u003c/code\u003e folder at\u0026nbsp;the root of\u0026nbsp;my\u0026nbsp;repo.\u003c/p\u003e\n\n\u003cp\u003eIf\u0026nbsp;repository is\u0026nbsp;private, you\u0026rsquo;ll need to\u0026nbsp;provide a\u0026nbsp;username and a\u0026nbsp;password or\u0026nbsp;Personal Access Token (PAT). Check your version control system\u0026rsquo;s documentation for details on\u0026nbsp;setting this up.\u003c/p\u003e\n\u003cp\u003eThe DAG folder will be\u0026nbsp;mounted using git-sync. This means you can update your DAGs by\u0026nbsp;simply pushing changes to\u0026nbsp;your git branch\u0026nbsp;\u0026mdash; no\u0026nbsp;need to\u0026nbsp;update the cluster itself.\u003c/p\u003e\n\u003cp\u003eFor now, I\u0026rsquo;ll keep all other settings at\u0026nbsp;their defaults and hit \u0026ldquo;Submit\u0026rdquo; to\u0026nbsp;start provisioning. While my\u0026nbsp;cluster is\u0026nbsp;spinning up, let\u0026rsquo;s make good use of\u0026nbsp;this time and do\u0026nbsp;some exploratory data analysis. This will help understand our data better nad help structure our Airflow-enhanced queries.\u003c/p\u003e\n\u003ch2 id=\"aggregations\"\u003e\u003ca href=\"#aggregations\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eAggregations\u003c/span\u003e\u003c/a\u003eAggregations\u003c/h2\u003e\n\u003cp\u003eOur data consists of\u0026nbsp;events from various parties, and our goal is\u0026nbsp;to\u0026nbsp;group them effectively. Let\u0026rsquo;s start with some EDA on\u0026nbsp;our sample of\u0026nbsp;1,000 events using WebSQL. This will help understand what aggregations we\u0026nbsp;can compute.\u003c/p\u003e\n\u003ch3 id=\"exploring-sample-clickstream-data\"\u003e\u003ca href=\"#exploring-sample-clickstream-data\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eExploring sample clickstream data\u003c/span\u003e\u003c/a\u003eExploring sample clickstream data\u003c/h3\u003e\n\u003cp\u003eFirst, let\u0026rsquo;s remind ourselves about the table columns and their types. In\u0026nbsp;ClickHouse, we\u0026nbsp;can do\u0026nbsp;this using the \u003ca href=\"https://clickhouse.com/docs/ru/sql-reference/statements/describe-table\"\u003eDESCRIBE \u003ccode\u003e\u0026lt;tablename\u0026gt;\u003c/code\u003e command\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s how it\u0026nbsp;looks in\u0026nbsp;WebSQL query editor:\u003c/p\u003e\n\n\u003cp\u003eOur landing table is\u0026nbsp;quite extensive, but the xey fields for our analysis are:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003epartyId\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esessionId\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eItem_price\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eeventType\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edetectedDuplicate\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edetectedCorruption\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emy_ts\u003c/code\u003e (containing the adjusted timestamp)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eNow\u0026rsquo; let\u0026rsquo;s check for duplicates and corruption in\u0026nbsp;our data:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e eventType, detectedDuplicate, detectedCorruption, \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e events_webshop \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"43\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-43\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-43\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-43.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n\u003cp\u003eInterestingly, our sample doesn\u0026rsquo;t show any detected duplicates, but there are some events marked as\u0026nbsp;corrupted. Given our small sample size of\u0026nbsp;1,000 events, we\u0026nbsp;won\u0026rsquo;t focus too much on\u0026nbsp;duplicates now, but it\u0026rsquo;s something to\u0026nbsp;keep in\u0026nbsp;mind for larger samples.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s move on\u0026nbsp;to\u0026nbsp;some more useful aggregations. We\u0026rsquo;ll compute how many visitors we\u0026nbsp;had each hour in\u0026nbsp;our dataset. ClickHouse offers \u003ca href=\"https://clickhouse.com/docs/en/sql-reference/functions/date-time-functions\"\u003emany functions\u003c/a\u003e for working with datetime data, all expecting DateTime64 format.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;ll cast the values on\u0026nbsp;the fly:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n        toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e visitors,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e total_events,\n        \u003cspan class=\"hljs-built_in\"\u003eMIN\u003c/span\u003e(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e mnts,\n        \u003cspan class=\"hljs-built_in\"\u003eMAX\u003c/span\u003e(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e mxts\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e events_webshop \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"9\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-9\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-9\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-9.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n\u003cp\u003eFrom these results, we\u0026nbsp;can see that our 1,000-event sample spans 5\u0026nbsp;hours, with a\u0026nbsp;fairly even distribution of\u0026nbsp;events across each hour. The events are clustered at\u0026nbsp;the start and end of\u0026nbsp;each hour. We\u0026nbsp;also notice that our visitor count is\u0026nbsp;quite low, but it\u0026rsquo;s sufficient for building our initial pipeline.\u003c/p\u003e\n\u003ch3 id=\"performance-metrics-for-sample-data\"\u003e\u003ca href=\"#performance-metrics-for-sample-data\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003ePerformance metrics for sample data\u003c/span\u003e\u003c/a\u003ePerformance metrics for sample data\u003c/h3\u003e\n\u003cp\u003eOur dataset includes two event types: \u003ccode\u003eitemBuyEvent\u003c/code\u003e and \u003ccode\u003eitemViewEvent\u003c/code\u003e. We\u0026rsquo;ve already counted visitors, but now let\u0026rsquo;s focus on\u0026nbsp;purchases and revenue metrics, grouped by\u0026nbsp;hour:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eTotal revenue:\u003c/strong\u003e sum of\u0026nbsp;all \u003ccode\u003eitem_price\u003c/code\u003e fields for events with \u003ccode\u003eeventType = itemBuyEvent\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eNumber of\u0026nbsp;buyers:\u003c/strong\u003e count of\u0026nbsp;distinct \u003ccode\u003epartyId\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eTotal purchases:\u003c/strong\u003e count of\u0026nbsp;distinct \u003ccode\u003esessionId\u003c/code\u003e per hour\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eAverage revenue per purchase:\u003c/strong\u003e total revenue divided by\u0026nbsp;number of\u0026nbsp;purchases\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere\u0026rsquo;s the SQL query to\u0026nbsp;calculate these metrics:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n    \u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(item_price) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e total_revenue,\n    \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_buyers,\n    \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e sessionId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_purchases,\n    round(total_revenue \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e num_purchases, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e average_revenue_per_purchase\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e events_webshop \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e eventType\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e'itemBuyEvent'\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"34\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-34\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-34\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-34.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n\u003ch3 id=\"putting-it-all-together\"\u003e\u003ca href=\"#putting-it-all-together\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003ePutting it\u0026nbsp;all together\u003c/span\u003e\u003c/a\u003ePutting it\u0026nbsp;all together\u003c/h3\u003e\n\u003cp\u003eNow that we\u0026nbsp;have our performance metrics, let\u0026rsquo;s combine them with our visitor data and apply our filtering criteria for duplicates and corruption. I\u0026nbsp;will use Common Tabls Experssions (CTEs) to\u0026nbsp;organize the resulting query:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eWITH\u003c/span\u003e good_data \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e webshop.events_webshop\n    \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e detectedDuplicate\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e detectedCorruption\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n), visitors \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n        toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e visitors\n    \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e good_data\n    \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n), performance \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n        toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n        \u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(item_price) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e total_revenue,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_buyers,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e sessionId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_purchases\n        round(total_revenue \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e num_purchases, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e average_revenue_per_purchase\n    \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e good_data\n    \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e eventType\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e'itemBuyEvent'\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n) \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    v.hour,\n    v.visitors,\n    p.num_buyers,\n    p.num_purchases,\n    p.total_revenue,\n    p.average_revenue_per_purchase\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e visitors v \u003cspan class=\"hljs-keyword\"\u003eJOIN\u003c/span\u003e performance p \u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e v.hour \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e p.hour \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"6\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-6\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-6\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-6.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eYou can find the full query \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/sql/compute_full_aggs.sql\"\u003eat\u0026nbsp;github here\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eThis query combines all the metrics we\u0026nbsp;need for our analysis. It\u0026nbsp;filters out duplicates and corrupted data, calculates visitor and performance metrics, and joins them together for a\u0026nbsp;comprehensive hourly view of\u0026nbsp;our webshop\u0026rsquo;s performance.\u003c/p\u003e\n\u003cp\u003eNow that we\u0026nbsp;have our final query, let\u0026rsquo;s move on\u0026nbsp;to\u0026nbsp;automating this process with Airflow.\u003c/p\u003e\n\u003ch2 id=\"back-to-airflow\"\u003e\u003ca href=\"#back-to-airflow\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eBack to\u0026nbsp;Airflow\u003c/span\u003e\u003c/a\u003eBack to\u0026nbsp;Airflow\u003c/h2\u003e\n\u003cp\u003eOnce the cluster is\u0026nbsp;up\u0026nbsp;and running, you can access the Web UI\u0026nbsp;from the Cluster panel via the Web Server Connection link.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eAllowlist reminder:\u003c/strong\u003e DoubleCloud automatically adds your IP\u0026nbsp;address to\u0026nbsp;the ALLOWLIST in\u0026nbsp;the cluster settings. Keep this in\u0026nbsp;mind if\u0026nbsp;you frequently change networks, like switching Wi-Fi on\u0026nbsp;your laptop. If\u0026nbsp;the Web Server connection link doesn\u0026rsquo;t open, make sure your IP\u0026nbsp;is\u0026nbsp;in\u0026nbsp;the list.\u003c/p\u003e\n\u003cp\u003eInitially, your new cluster will have no\u0026nbsp;enabled DAGs, presenting an\u0026nbsp;empty dashboard. This is\u0026nbsp;normal for a\u0026nbsp;fresh setup.\u003c/p\u003e\n\n\u003cp\u003eLet\u0026rsquo;s start by\u0026nbsp;enabling and triggering the roll_d20 DAG (\u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/roll_d20.py\"\u003esrc here\u003c/a\u003e). This simple two-task DAG isn\u0026rsquo;t connecting to\u0026nbsp;any external system,\u0026nbsp;\u0026mdash; it\u0026rsquo;s just to\u0026nbsp;verify that our Airflow setup is\u0026nbsp;complete and workers are functioning. trigger it, and watch it\u0026nbsp;being executed (you can actually just trigger disabled dag and it\u0026nbsp;will be\u0026nbsp;enabled automatically).\u003c/p\u003e\n\n\u003cp\u003eYou can access the logs for each task through the Logs tab when you select a\u0026nbsp;DAG run and a\u0026nbsp;task:\u003c/p\u003e\n\n\u003cp\u003eLooks like I\u0026nbsp;got lucky\u0026nbsp;\u0026mdash; my\u0026nbsp;DAG run rolled a\u0026nbsp;13!\u003c/p\u003e\n\u003cp\u003eNow, if\u0026nbsp;we\u0026nbsp;try running our \u003ccode\u003ecompute_full_perf_metrics\u003c/code\u003e, DAG (\u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/compute_full_perf_metrics.py\"\u003esrc here\u003c/a\u003e), it\u0026nbsp;will fail:\u003c/p\u003e\n\n\u003cp\u003eThis is\u0026nbsp;expected, because our newly created cluster doesn\u0026rsquo;t know about our ClickHouse server\u0026nbsp;yet. The logs confirm this:\u003c/p\u003e\n\n\u003cp\u003eIt\u0026nbsp;all can be\u0026nbsp;fixed by\u0026nbsp;creating a\u0026nbsp;connection. Go\u0026nbsp;to\u0026nbsp;Admin-\u0026gt;Connections and add a\u0026nbsp;Generic connection using credentials for your ClickHouse server:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eConnection id: \u003ccode\u003ech_default\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eConnection type: \u003ccode\u003eGeneric\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSet host, port, and login/password accordingly\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSpecify schema: \u003ccode\u003ewebshop\u003c/code\u003e (this will be\u0026nbsp;used as\u0026nbsp;our database)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAdd {\u0026rdquo;\u003ccode\u003esecure\u003c/code\u003e\u0026rdquo;: true} to\u0026nbsp;extra settings. This is\u0026nbsp;required for DoubleCloud because your data is\u0026nbsp;always secure with us\u0026nbsp;\u0026mdash; we\u0026nbsp;just need to\u0026nbsp;tell Airflow about it!\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eNow, triggering our ClickHouse DAG again should result in\u0026nbsp;a\u0026nbsp;successful\u0026nbsp;run. The log will show you the executed query:\u003c/p\u003e\n\n\u003cp\u003eThe query result is\u0026nbsp;saved in\u0026nbsp;the XCom\u0026nbsp;tab. I\u0026rsquo;ve collapsed a\u0026nbsp;few rows, but it\u0026rsquo;s semantically the same result as\u0026nbsp;in\u0026nbsp;the WebSQL:\u003c/p\u003e\n\n\u003cp\u003eThis confirms that our Airflow cluster can now interact with the ClickHouse cluster and compute the necessary metrics. However, this setup isn\u0026rsquo;t ideal yet:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e The DAG is\u0026nbsp;not idempotent (we\u0026rsquo;ll address this in\u0026nbsp;the next part of\u0026nbsp;the series).\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e The results are only saved in\u0026nbsp;the Airflow metadata, not a\u0026nbsp;persistent location, not in\u0026nbsp;ClickHouse, hard to\u0026nbsp;access, etc\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s address the second point by\u0026nbsp;modifying our DAG structure to\u0026nbsp;save results in\u0026nbsp;a\u0026nbsp;table.\u003c/p\u003e\n\u003ch2 id=\"changing-dag-structure\"\u003e\u003ca href=\"#changing-dag-structure\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eChanging DAG structure\u003c/span\u003e\u003c/a\u003eChanging DAG structure\u003c/h2\u003e\n\u003cp\u003eLet\u0026rsquo;s modify the pipeline structure to\u0026nbsp;address the issue of\u0026nbsp;result persistence:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e First, the pipeline will check if\u0026nbsp;the target aggregation table exists\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e If\u0026nbsp;it\u0026nbsp;doesn\u0026rsquo;t exist, the pipeline should create the table and compute aggregations on\u0026nbsp;all available data\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e3.\u003c/em\u003e If\u0026nbsp;the table exists, the pipeline will truncate it\u0026nbsp;and insert new data\u003c/p\u003e\n\u003cp\u003eThis pipeline isn\u0026rsquo;t ideal for production use as\u0026nbsp;it\u0026nbsp;has a\u0026nbsp;few obvious drawbacks, but it\u0026nbsp;demonstrates how to\u0026nbsp;write an\u0026nbsp;Airflow pipeline with additional SQL-based checks. I\u0026rsquo;ll discuss pipeline improvements and query performance in\u0026nbsp;the next part of\u0026nbsp;this series.\u003c/p\u003e\n\u003ch3 id=\"additional-table\"\u003e\u003ca href=\"#additional-table\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eAdditional table\u003c/span\u003e\u003c/a\u003eAdditional table\u003c/h3\u003e\n\u003cp\u003eFor our aggregates data mart, let\u0026rsquo;s use the following structure:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e IF \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eEXISTS\u003c/span\u003e performance_aggregates (\n    ts_start DateTime,\n    ts_end DateTime,\n    visitors \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    num_buyers \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    num_purchases \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    total_revenue \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    average_revenue_per_purchase Float32\n) ENGINE \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e MergeTree() \u003cspan class=\"hljs-keyword\"\u003ePRIMARY\u003c/span\u003e KEY ts_start\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"36\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-36\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-36\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-36.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eThis structure is\u0026nbsp;similar to\u0026nbsp;what we\u0026rsquo;ve used before, with an\u0026nbsp;additional column for the end of\u0026nbsp;the interval. The MergeTree engine is\u0026nbsp;suitable for our test sample, but for production use, you should always first check if\u0026nbsp;you can use \u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines#mergetree\"\u003emore specific\u003c/a\u003e engine type.\u003c/p\u003e\n\u003cp\u003eTo\u0026nbsp;insert data into this table, I\u0026nbsp;will slightly modify me\u0026nbsp;existing query by\u0026nbsp;adding an\u0026nbsp;INSERT INTO statement:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e webshop.performance_aggregates\n  (ts_start, ts_end, total_revenue, num_buyers, visitors, total_revenue, average_revenue_per_purchase)\n\u003cspan class=\"hljs-keyword\"\u003eWITH\u003c/span\u003e good_data \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n  …\n\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"6\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-6\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-6\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-6.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eFull query code \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/sql/compute_insert_aggs.sql\"\u003ecan be\u0026nbsp;found here\u003c/a\u003e. It\u0026rsquo;s worth noting that this approach has some limitations and wouldn\u0026rsquo;t be\u0026nbsp;ideal for a\u0026nbsp;production environment. However, for our current goal of\u0026nbsp;getting all the components working together, it\u0026rsquo;s sufficient.\u003c/p\u003e\n\u003cp\u003eIn\u0026nbsp;the next part of\u0026nbsp;this series, we\u0026rsquo;ll address these limitations and discuss how to\u0026nbsp;make the pipeline more robust and suitable for production use.\u003c/p\u003e\n\u003ch2 id=\"adjusting-airflow-dag\"\u003e\u003ca href=\"#adjusting-airflow-dag\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eAdjusting Airflow DAG\u003c/span\u003e\u003c/a\u003eAdjusting Airflow DAG\u003c/h2\u003e\n\u003cp\u003eHere\u0026rsquo;s my\u0026nbsp;resulting pipeline structure:\u003c/p\u003e\n\n\u003cp\u003eYou can see the complete code \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/compute_full_perf_metrics_save_to_table.py\"\u003ein\u0026nbsp;our repository\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;d like to\u0026nbsp;highlight some key points about this new DAG:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eThis DAG has \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L32\"\u003eno\u0026nbsp;schedule\u003c/a\u003e. Since it\u0026nbsp;computes across the whole table, it\u0026rsquo;s designed more for per-trigger use rather than scheduled runs.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWhile the DAG might seem verbose with some tasks that could be\u0026nbsp;combined, this structure showcases how to\u0026nbsp;author more complex DAGs. Tip: Airflow has a\u0026nbsp;lesser-known feature that allows you to\u0026nbsp;add text on\u0026nbsp;top of\u0026nbsp;edges, making complicated DAGs look cleaner. \u003ca href=\"https://airflow.apache.org/docs/apache-airflow/2.10.0/_modules/airflow/example_dags/example_branch_labels.html\"\u003eSee here\u003c/a\u003e.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eGiven the nature of\u0026nbsp;the overall process, I\u0026rsquo;ve \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L38\"\u003elimited\u003c/a\u003e the number of\u0026nbsp;max active runs allowed for the\u0026nbsp;DAG. This can be\u0026nbsp;useful in\u0026nbsp;certain scenarios when you expect multiple DAG runs triggered in\u0026nbsp;a\u0026nbsp;short period of\u0026nbsp;time.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWhen implementing branching in\u0026nbsp;Airflow, remember to\u0026nbsp;set dependencies in\u0026nbsp;the graph and keep task_ids naming consistent. Personally, I\u0026nbsp;often start new DAGs with EmptyOperators to\u0026nbsp;get the structure right before replacing them with real tasks.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIt\u0026rsquo;s crucial to\u0026nbsp;set the proper TriggerRule for the final task to\u0026nbsp;ensure it\u0026rsquo;s not skipped when edges merge.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIn\u0026nbsp;the DAG code, I\u0026nbsp;define \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L13-L22\"\u003ea\u0026nbsp;custom ClickHouseBranchSQLOperator\u003c/a\u003e instead of\u0026nbsp;using the one provided by\u0026nbsp;the airflow-clickhouse-plugin. This is\u0026nbsp;due to\u0026nbsp;some method resolution order (MRO) issue in\u0026nbsp;Airflow versions \u0026lt; 2.9.3. You might not need this in\u0026nbsp;newer versions (see docstring for details).\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSome SQL statements could be\u0026nbsp;hardcoded/inlined instead of\u0026nbsp;reading from a\u0026nbsp;file, but I\u0026nbsp;prefer consistency and this a\u0026nbsp;nice minor side-effect as\u0026nbsp;it\u0026nbsp;makes it\u0026nbsp;easier to\u0026nbsp;get feedback from SQL experts (they can just read an\u0026nbsp;SQL file and not Python code + SQL statements).\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDepending on\u0026nbsp;your use-case, it\u0026nbsp;might make sense to\u0026nbsp;set table names as\u0026nbsp;parameters or\u0026nbsp;Airflow variables for easier modifications. I\u0026nbsp;will cover it\u0026nbsp;in\u0026nbsp;the next part, along with scheduling, idempotency, and data_interval usage.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI\u0026nbsp;want to\u0026nbsp;emphasize that we\u0026rsquo;re focusing on\u0026nbsp;using Airflow with our ClickHouse cluster data, not on\u0026nbsp;production-ready code quality. I\u0026rsquo;d caution against using this DAG directly in\u0026nbsp;production. However, it\u0026nbsp;serves as\u0026nbsp;a\u0026nbsp;good starting point for developing your own DAGs that utilize ClickHouse.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s trigger this DAG and check the results. Enabling the DAG and running it\u0026nbsp;for the first time will create the table and compute the aggregations. Subsequent runs will use the other branch.\u003c/p\u003e\n\n\u003cp\u003eIn\u0026nbsp;the next part of\u0026nbsp;this series, we\u0026rsquo;ll refine our approach and address some of\u0026nbsp;the limitations in\u0026nbsp;this initial implementation.\u003c/p\u003e\n\u003ch2 id=\"final-result\"\u003e\u003ca href=\"#final-result\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eFinal result\u003c/span\u003e\u003c/a\u003eFinal result\u003c/h2\u003e\n\u003cp\u003eSwitching to\u0026nbsp;WebSQL I\u0026nbsp;can now see my\u0026nbsp;new table and query data from it:\u003c/p\u003e\n\n\u003cp\u003eRunning the DAG again would takes a\u0026nbsp;different path in\u0026nbsp;the graph. Since we\u0026nbsp;limited the max active runs, multiple triggers won\u0026rsquo;t interfere with each other:\u003c/p\u003e\n\n\u003cp\u003eEverything seems to\u0026nbsp;be\u0026nbsp;working as\u0026nbsp;expected. Let\u0026rsquo;s recap what we\u0026rsquo;ve accomplished:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e We\u0026nbsp;started by\u0026nbsp;spinning up\u0026nbsp;an\u0026nbsp;Airflow cluster. My\u0026nbsp;DAGs are stored in\u0026nbsp;separate folder \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/tree/trunk\"\u003ein\u0026nbsp;a\u0026nbsp;repository\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e I\u0026nbsp;did some Exploratory Data Analysis to\u0026nbsp;determine what we\u0026nbsp;wanted to\u0026nbsp;compute and got our first working query in\u0026nbsp;WebSQL. The fancy phrase basically means \u0026ldquo;I\u0026rsquo;ve ran some queries to\u0026nbsp;check what\u0026rsquo;s up\u0026nbsp;with my\u0026nbsp;data\u0026rdquo;. This helped me\u0026nbsp;understand my\u0026nbsp;data better and prepare for automation in\u0026nbsp;Airflow. By\u0026nbsp;saving queries as\u0026nbsp;SQL files in\u0026nbsp;my\u0026nbsp;DAGs folder, I\u0026nbsp;can later easily reuse them.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e3.\u003c/em\u003e Using ClickHouseOperator in\u0026nbsp;Airflow, I\u0026rsquo;ve set up\u0026nbsp;a\u0026nbsp;simple DAG that runs the query as-is. This helped me\u0026nbsp;ensure everything is\u0026nbsp;working fine from connectivity standpoint.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e4.\u003c/em\u003e I\u0026rsquo;ve added a\u0026nbsp;few additional steps to\u0026nbsp;my\u0026nbsp;DAG that create the aggregation table and save the result, allowing me\u0026nbsp;to\u0026nbsp;rerun it\u0026nbsp;whenever needed.\u003c/p\u003e\n\u003cp\u003eThis is\u0026nbsp;a\u0026nbsp;point in\u0026nbsp;our imaginary communication with the data client where I\u0026nbsp;can now present these results to\u0026nbsp;data analysts and gather feedback on\u0026nbsp;either the SQL queries or\u0026nbsp;the data mart structure. It\u0026rsquo;s a\u0026nbsp;good place to\u0026nbsp;wrap up\u0026nbsp;this part of\u0026nbsp;our series.\u003c/p\u003e\n\u003ch2 id=\"looking-ahead-to-part-iii\"\u003e\u003ca href=\"#looking-ahead-to-part-iii\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eLooking ahead to\u0026nbsp;part III\u003c/span\u003e\u003c/a\u003eLooking ahead to\u0026nbsp;part III\u003c/h2\u003e\n\u003cp\u003eIn\u0026nbsp;the next installment of\u0026nbsp;this series, we\u0026rsquo;re going to\u0026nbsp;take our analytics platform to\u0026nbsp;the next level:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e We\u0026rsquo;ll build an\u0026nbsp;interactive dashboard using the DoubleCloud Visualization tool, bringing our data to\u0026nbsp;life visually.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e We\u0026rsquo;ll shorten the time bucket for more granular analysis and utilize a\u0026nbsp;bigger dataset to\u0026nbsp;stress-test our system.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e3.\u003c/em\u003e We\u0026rsquo;ll refine our DAG, addressing improvements such as:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eImplementing idempotency\u003c/li\u003e\n\u003cli\u003eSetting up\u0026nbsp;proper scheduling\u003c/li\u003e\n\u003cli\u003eMaking our pipeline more robust for production use\u003c/li\u003e\n\u003cli\u003eParametrizing table names and leveraging Airflow variables for increased flexibility\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cem\u003e4.\u003c/em\u003e We\u0026rsquo;ll explore how this entire setup can be\u0026nbsp;deployed using Terraform, streamlining the infrastructure-as-code process.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e5.\u003c/em\u003e We\u0026rsquo;ll also cover different table structures and approaches for this problem and how different ClickHouse engines can be\u0026nbsp;used here, and if\u0026nbsp;we\u0026nbsp;indeed need to\u0026nbsp;use something different than the basic MergeTree for optimizing this analytics pipeline.\u003c/p\u003e\n\u003cp\u003eRemember, while our current implementation works, it\u0026rsquo;s designed as\u0026nbsp;a\u0026nbsp;learning exercise. For production environments, if\u0026nbsp;you were going with self-hosted solutions, you\u0026rsquo;d need to\u0026nbsp;implement additional error handling, logging, and performance optimizations. However, with DoubleCloud, many of\u0026nbsp;these issues are solved for you, allowing you to\u0026nbsp;focus on\u0026nbsp;your data processing needs instead.\u003c/p\u003e\n\u003cp\u003eThanks for joining us\u0026nbsp;on\u0026nbsp;this journey so\u0026nbsp;far. Stay tuned for part III, where we\u0026rsquo;ll bring all these pieces together into a\u0026nbsp;comprehensive, production-grade analytics solution! If\u0026nbsp;you have any questions or\u0026nbsp;would like to\u0026nbsp;discuss this series further, feel free to\u0026nbsp;reach out on\u0026nbsp;Slack. DoubleCloud is\u0026nbsp;always here to\u0026nbsp;help you make the most of\u0026nbsp;your data!\u003c/p\u003e\n"},"suggestedPosts":[{"url":"/blog/posts/2023/10/introducing-the-preview-launch-of-doublecloud-managed-apache-airflow","id":142,"name":"introducing-the-preview-launch-of-doublecloud-managed-apache-airflow","date":"2023-10-25T00:00:00Z","description":"","readingTime":15,"image":"/assets/blog/articles/introducing-the-preview-launch-of-doublecloud-managed-apache-airflow-small-cover-2.webp","blogPostId":142,"likes":0,"hasUserLike":false,"slug":"","title":"Introducing the preview launch of DoubleCloud Managed Apache Airflow","authors":[],"tags":[],"locale":{"lang":"en"},"textTitle":"Introducing the preview launch of DoubleCloud Managed Apache Airflow","htmlTitle":"Introducing the preview launch of DoubleCloud Managed Apache Airflow"},{"url":"/blog/posts/2024/08/data-transformation-best-practices","id":166,"name":"data-transformation-best-practices","date":"2024-08-20T00:00:00Z","description":"","readingTime":15,"image":"/assets/blog/articles/2024/best-practices-for-data-transformation-as-pipeline-complexity-grows-small-cover.png","blogPostId":166,"likes":0,"hasUserLike":false,"slug":"","title":"Best practices for data transformation as pipeline complexity grows","authors":[],"tags":[],"locale":{"lang":"en"},"textTitle":"Best practices for data transformation as pipeline complexity grows","htmlTitle":"Best practices for data transformation as pipeline complexity grows"},{"url":"/blog/posts/2024/09/real-time-analytics-kafka-clickhouse-integration","id":168,"name":"real-time-analytics-kafka-clickhouse-integration","date":"2024-09-06T00:00:00Z","description":"Written By: Igor Mosyagin, Developer Advocate at DoubleCloud","readingTime":15,"image":"/assets/blog/articles/2024/real-time-analytics-kafka-clickhouse-integration-small-cover.png","blogPostId":168,"likes":0,"hasUserLike":false,"slug":"","title":"Clickstream analytics case study. Part I: Kafka -\u003e Data Transfer -\u003e ClickHouse","authors":[],"tags":[],"locale":{"lang":"en"},"textTitle":"Clickstream analytics case study. Part I: Kafka -\u003e Data Transfer -\u003e ClickHouse","htmlTitle":"Clickstream analytics case study. Part I: Kafka -\u003e Data Transfer -\u003e ClickHouse"}]}},"navigationData":{"newMenu":true,"header":{"leftItems":[{"text":"Why DoubleCloud","type":"dc-dropdown","data":{"view":"list","groups":[{"items":[{"text":"Performance","url":"/performance-boost/","description":"Get the best performance with the highest ROI"},{"text":"Security","url":"/security/","description":"Keep your data protected and maintain compliance"},{"text":"DoubleCloud vs. other solutions","url":"/comparison/","description":"Learn how DoubleCloud’s products compare to other solutions"},{"text":"Customer stories","url":"/resources/case-studies/","description":"See our solutions in action"}]},{"image":{"src":"/assets/doublecloud/menu-bar/menu-banner-dc-results.png.webp","style":{"width":300,"height":300}},"text":"\u003ca href='/performance-boost/' target='_self'\u003eGet more and spend less with DoubleCloud  →\u003c/a\u003e"}]}},{"text":"Products","type":"dc-dropdown","metaSchema":{"@graph":[{"@type":"SoftwareApplication","sameAs":["https://twitter.com/getdoublecloud","https://www.youtube.com/@doublecloud2499","https://www.linkedin.com/company/doublecloudplatform/","https://www.facebook.com/GetDoubleCloud/"]},{"@context":"https://schema.org","@type":"Organization","foundingDate":2022,"contactPoint":{"@type":"ContactPoint","contactType":"customer support","telephone":"+1 302-658-7581","email":"info@double.cloud"},"sameAs":["https://twitter.com/getdoublecloud","https://www.youtube.com/@doublecloud2499","https://www.linkedin.com/company/doublecloudplatform/","https://www.facebook.com/GetDoubleCloud/"]}]},"data":{"items":[{"text":"Managed Service for ClickHouse®","url":"/services/managed-clickhouse/","icon":"/assets/icons/dc-clickhouse.svg","description":"The fastest, most resource-efficient OLAP database for real-time analytics"},{"text":"Managed Service for Apache Kafka®","url":"/services/managed-kafka/","icon":"/assets/icons/dc-kafka.svg","description":"A leading data streaming technology for large-scale, data-intensive applications"},{"text":"Managed Service for Apache Airflow®","url":"/services/managed-airflow/","icon":"/assets/icons/dc-airflow.svg","description":"Open-source tool to orchestrate and monitor workflows"},{"text":"Data Transfer","url":"/services/doublecloud-transfer/","icon":"/assets/icons/dc-transfer.svg","description":"No-code ELT tool for aggregating, collecting, and migrating data"},{"text":"Data Visualization","url":"/services/doublecloud-visualization/","icon":"/assets/icons/dc-data-vis.svg","description":"Free tool to create, modify, and share dashboards and charts"}]}},{"text":"Solutions","type":"dc-dropdown","data":{"view":"list","groups":[{"title":"By use case","items":[{"text":"Customer-facing analytics","url":"/solutions/customer-facing-analytics/","description":"Provide business insights for your clients or partners"},{"text":"Real-time analytics","url":"/solutions/real-time-analytics/","description":"Build a data infrastructure to collect, process, and analyze data in real time"},{"text":"Observability and monitoring","url":"/solutions/observability-and-monitoring/","description":"Analyze terabytes of your logs, events, and traces with ease"}]},{"title":"By industry","items":[{"text":"AdTech and MarTech data analytics","url":"/solutions/adtech/","description":"Extract and analyze data from Meta ads, Google ads, LinkedIn ads, and others"},{"text":"Analytics for mobile and gaming apps","url":"/solutions/web-mobile-gaming-apps/","description":"Optimize and scale your mobile and gaming app analytics"},{"text":"EdTech data analytics","url":"/solutions/edtech/","description":"Improve online learning and identify new sales opportunities"},{"text":"FinTech data analytics","url":"/solutions/fintech-real-time-analytics/","description":"Manage and process large amounts of financial data efficiently"}]}]}},{"text":"Resources","type":"dc-dropdown","data":{"view":"list","groups":[{"title":"Using DoubleCloud","items":[{"text":"DoubleCloud API","url":"/docs/en/public-api/","description":"Read up on API tutorials and instructions","target":"_self"},{"text":"Terraform","url":"/docs/en/developer-resources/terraform/create-resources","description":"Deploy and manage cloud resources with the infrastructure-as-code approach"},{"text":"Status updates","url":"https://status.double.cloud/","description":"Check the current operational status of our services"},{"text":"Support","url":"/support/","description":"Learn more about our support tiers"}]},{"title":"Discover","items":[{"text":"Webinars","url":"/webinars/","description":"Sign up for the next webinar or watch previous ones"},{"text":"Blog","url":"/blog/","description":"Get insights from our team and the latest news"}]},{"image":{"src":"/assets/doublecloud/menu-bar/menu-banners-dc-ebook.png.webp","style":{"width":300,"height":300}},"text":"\u003ca href='/resources/clickhouse-ebook/' target='_self'\u003eGrab your ebook  →\u003c/a\u003e"}]}},{"text":"Company","type":"dc-dropdown","data":{"items":[{"text":"About DoubleCloud","url":"/company/about-us/"},{"text":"Careers","url":"/company/careers/"},{"text":"Contact us","url":"/company/contact-us/"}]}},{"text":"Pricing","url":"/pricing/"},{"text":"Documentation","url":"/docs/en/","target":"_self"}]},"logo":{"icon":"/assets/logo/dc-logo-dark.svg","text":""},"footer":{"underline":{"links":[{"text":"Customer Agreement","url":"/legal/en/customer_agreement/","target":"_blank"},{"text":"Privacy Policy","url":"/legal/en/privacy/","target":"_blank"},{"text":"Pricing","url":"/pricing/"},{"text":"Security","url":"/security/","target":"_blank"}],"copyright":"© 2024 DoubleCloud"},"columns":[{"title":"Products","links":[{"text":"Managed Service for ClickHouse®","url":"/services/managed-clickhouse/"},{"text":"Managed Service for Apache Kafka®","url":"/services/managed-kafka/"},{"text":"Managed Service for Apache Airflow®","url":"/services/managed-airflow"},{"text":"Data Transfer","url":"/services/doublecloud-transfer/"},{"text":"Data Visualization","url":"/services/doublecloud-visualization"}]},{"title":"Solutions","links":[{"text":"Case studies","url":"/resources/case-studies/"},{"text":"Customer-facing analytics","url":"/solutions/customer-facing-analytics/"},{"text":"Real-time analytics","url":"/solutions/real-time-analytics/"},{"text":"Observability and monitoring","url":"/solutions/observability-and-monitoring/"},{"text":"AdTech and MarTech data analytics","url":"/solutions/adtech/"},{"text":"Analytics for mobile and gaming Apps","url":"/solutions/web-mobile-gaming-apps/"},{"text":"EdTech data analytics","url":"/solutions/edtech/"},{"text":"FinTech data analytics","url":"/solutions/fintech-real-time-analytics/"}]},{"title":"Resources","links":[{"text":"Documentation","url":"/docs/en/"},{"text":"Webinars","url":"/webinars/"},{"text":"Blog","url":"/blog/"},{"text":"Support","url":"/support/"},{"text":"Status updates","url":"https://status.double.cloud/"},{"text":"Product comparisons","url":"/comparison/"},{"text":"Site map","url":"/sitemap/"}]},{"title":"Company","links":[{"text":"About DoubleCloud","url":"/company/about-us/"},{"text":"Careers","url":"/company/careers"},{"text":"AWS Partnership","url":"/aws-partnership/"}]}]},"forms":{"contact":"11819433.daba96b39df83b7903708cc4842e9dbb9c944cce"},"favicon":{"folder":"/assets/favicon"},"analytics":{"id":"GTM-5M39N8J","ignore":true,"popup":{"text":"\u003cp\u003eBy\u0026nbsp;clicking \u0026ldquo;Accept\u0026rdquo;, you agree to\u0026nbsp;the storing of\u0026nbsp;cookies on\u0026nbsp;your device to\u0026nbsp;help us\u0026nbsp;analyze site usage and assist in\u0026nbsp;our marketing efforts. However, you may \u0026ldquo;Decline\u0026rdquo; that. More details here in\u0026nbsp;\u003ca href=\"/legal/en/privacy/\"\u003ePrivacy Policy\u003c/a\u003e\u003c/p\u003e","buttons":{"accept":{"size":"xl","text":"Accept"},"decline":{"size":"xl","text":"Decline"}}}},"announcement":{"name":"webinar_announcement","url":"https://doublecloud-archive.github.io/blog/posts/2024/10/doublecloud-final-update/","conditions":{"date":{"start":"2000-01-01T00:00:00Z","end":"2099-12-31T00:00:00Z"}},"text":"\u003cp\u003e\u003cb\u003eDoubleCloud has wound down operations\u003c/b\u003e | This is\u0026nbsp;an\u0026nbsp;archived version of\u0026nbsp;the site. \u003cb\u003eLearn more \u0026rarr; \u003c/b\u003e\u003c/p\u003e"}},"meta":{"title":"Clickstream analytics case study. Part II: ClickHouse \u003c-\u003e Airflow | DoubleCloud","date":"2024-09-23T00:00:00Z","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-sharing.png","canonicalUrl":"","organization":{"appTitle":"DoubleCloud","legalName":"DoubleCloud Inc","supportEmail":"","url":"https://double.cloud"},"description":"In this second post, we’ll show you how to set up an Airflow cluster. We’ll use it to run a batch job that takes the data we loaded in the first step and turns it into useful summaries. This is a key part of making our analytics system efficient and reliable.","content":"\u003cp\u003eQuick navigation:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#introduction\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#data-solution-overview\"\u003eData Solution overview\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#setup-airflow-cluster\"\u003eSetup Airflow cluster\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#aggregations\"\u003eAggregations\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#back-to-airflow\"\u003eBack to\u0026nbsp;Airflow\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#changing-dag-structure\"\u003eChanging DAG structure\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#adjusting-airflow-dag\"\u003eAdjusting Airflow DAG\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#final-result\"\u003eFinal result\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#looking-ahead-to-part-iii\"\u003eLooking ahead to\u0026nbsp;part III\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"introduction\"\u003e\u003ca href=\"#introduction\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eIntroduction\u003c/span\u003e\u003c/a\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eWelcome back to\u0026nbsp;our series on\u0026nbsp;building a\u0026nbsp;real-time analytics system. We\u0026rsquo;re exploring how to\u0026nbsp;set up\u0026nbsp;a\u0026nbsp;powerful analytics platform using DoubleCloud\u0026rsquo;s managed services. This series covers everything from getting data in, to\u0026nbsp;crunching numbers, to\u0026nbsp;creating eye-catching dashboards.\u003c/p\u003e\n\u003cp\u003eIn\u0026nbsp;this second post, we\u0026rsquo;ll show you how to\u0026nbsp;set up\u0026nbsp;an\u0026nbsp;Airflow cluster. We\u0026rsquo;ll use it\u0026nbsp;to\u0026nbsp;run a\u0026nbsp;batch job that takes the data we\u0026nbsp;loaded in\u0026nbsp;the first step and turns it\u0026nbsp;into useful summaries. This is\u0026nbsp;a\u0026nbsp;key part of\u0026nbsp;making our analytics system efficient and reliable.\u003c/p\u003e\n\u003cp\u003eIf\u0026nbsp;you missed our first post about initial setup and data loading, \u003ca href=\"https://double.cloud/blog/posts/2024/09/real-time-analytics-kafka-clickhouse-integration/\"\u003eyou can find it\u0026nbsp;here\u003c/a\u003e.\u003c/p\u003e\n\u003ch2 id=\"data-solution-overview\"\u003e\u003ca href=\"#data-solution-overview\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eData Solution overview\u003c/span\u003e\u003c/a\u003eData Solution overview\u003c/h2\u003e\n\u003cp\u003eLe\u0026rsquo;s recap our overall data platform architecture.\u003c/p\u003e\n\n\u003cp\u003eIn\u0026nbsp;our previous post, we\u0026nbsp;focused on\u0026nbsp;building the ingestion side. Now, we\u0026rsquo;re moving on\u0026nbsp;to\u0026nbsp;the next crucial step: aggregations.\u003c/p\u003e\n\n\u003cp\u003eWe\u0026rsquo;ve successfully set up\u0026nbsp;our data pipeline, so\u0026nbsp;our next challenge is\u0026nbsp;to\u0026nbsp;compute and automate aggregation. This is\u0026nbsp;where we\u0026nbsp;turnraw data into actionable insights.\u003c/p\u003e\n\u003ch3 id=\"a-quick-note-on-batch-processing\"\u003e\u003ca href=\"#a-quick-note-on-batch-processing\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eA\u0026nbsp;quick note on\u0026nbsp;batch processing\u003c/span\u003e\u003c/a\u003eA\u0026nbsp;quick note on\u0026nbsp;batch processing\u003c/h3\u003e\n\u003cp\u003eYou might be\u0026nbsp;wondering: \u0026ldquo;Wait, isn\u0026rsquo;t this series about real-time analytics? Why are we\u0026nbsp;talking about batch processing?\u0026rdquo;\u003c/p\u003e\n\u003cp\u003eGreat question! While our end goal is\u0026nbsp;real-time analytics, it\u0026rsquo;s important to\u0026nbsp;remember that a\u0026nbsp;robust data platform often combines both real-time and batch processing. Batch processing is\u0026nbsp;crucial for handling large volumes of\u0026nbsp;historical data, performing complex analyses, and creating aggregated views that complement our real-time insights.\u003c/p\u003e\n\u003cp\u003eIn\u0026nbsp;many real-world scenarios, you\u0026rsquo;ll need both approaches to\u0026nbsp;get a\u0026nbsp;complete picture of\u0026nbsp;your data. The common knowledge is\u0026nbsp;that real time processing gives you immediate insights, while batch processing allows for more in-depth, comprehensive analysis. By\u0026nbsp;covering batch processing in\u0026nbsp;this post, we\u0026rsquo;re making sure that we\u0026rsquo;re building a\u0026nbsp;well-rounded platform that can handle various analytical needs.\u003c/p\u003e\n\u003ch2 id=\"setup-airflow-cluster\"\u003e\u003ca href=\"#setup-airflow-cluster\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eSetup Airflow cluster\u003c/span\u003e\u003c/a\u003eSetup Airflow cluster\u003c/h2\u003e\n\u003cp\u003eLet\u0026rsquo;s start by\u0026nbsp;creating our Airflow cluster. This process takes a\u0026nbsp;bit of\u0026nbsp;time, so\u0026nbsp;it\u0026rsquo;s a\u0026nbsp;good idea to\u0026nbsp;get it\u0026nbsp;started first and then move on\u0026nbsp;to\u0026nbsp;other tasks while it\u0026nbsp;sets\u0026nbsp;up. The new Airflow cluster can be\u0026nbsp;created from a\u0026nbsp;cluster tab in\u0026nbsp;the DoubleCloud console. I\u0026rsquo;ll use a\u0026nbsp;small production environment configuration for this example.\u003c/p\u003e\n\n\u003cp\u003eI\u0026rsquo;m using the latest available version 2.10.0 which comes with a\u0026nbsp;sleek dark theme and some handy features. We\u0026nbsp;usually try to\u0026nbsp;make sure new Airflow versions are available in\u0026nbsp;a\u0026nbsp;few days after they get released by\u0026nbsp;the Airflow community. Remember, our platform allows you to\u0026nbsp;create custom images if\u0026nbsp;you need more specific setups. The default DoubleCloud Airflow comes with the ClickHouse plugin pre-installed, so\u0026nbsp;you\u0026rsquo;re all set to\u0026nbsp;work with your ClickHouse cluster.\u003c/p\u003e\n\u003cp\u003eFor this demo, I\u0026nbsp;continue using \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/\"\u003ethe same repository\u003c/a\u003e. If\u0026nbsp;you\u0026rsquo;re planning to\u0026nbsp;use yours, make sure:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eYou can access it\u0026nbsp;with the provided credentials or\u0026nbsp;it\u0026rsquo;s publicly accessible\u003c/li\u003e\n\u003cli\u003eYou\u0026rsquo;re using the correct branch\u003c/li\u003e\n\u003cli\u003eYou\u0026rsquo;ve specified the right path to\u0026nbsp;the DAG folder\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere\u0026rsquo;s my\u0026nbsp;setup: I\u0026rsquo;m using the \u003ccode\u003etrunk\u003c/code\u003e branch, and my\u0026nbsp;DAGs are in\u0026nbsp;the \u003ccode\u003edags\u003c/code\u003e folder at\u0026nbsp;the root of\u0026nbsp;my\u0026nbsp;repo.\u003c/p\u003e\n\n\u003cp\u003eIf\u0026nbsp;repository is\u0026nbsp;private, you\u0026rsquo;ll need to\u0026nbsp;provide a\u0026nbsp;username and a\u0026nbsp;password or\u0026nbsp;Personal Access Token (PAT). Check your version control system\u0026rsquo;s documentation for details on\u0026nbsp;setting this up.\u003c/p\u003e\n\u003cp\u003eThe DAG folder will be\u0026nbsp;mounted using git-sync. This means you can update your DAGs by\u0026nbsp;simply pushing changes to\u0026nbsp;your git branch\u0026nbsp;\u0026mdash; no\u0026nbsp;need to\u0026nbsp;update the cluster itself.\u003c/p\u003e\n\u003cp\u003eFor now, I\u0026rsquo;ll keep all other settings at\u0026nbsp;their defaults and hit \u0026ldquo;Submit\u0026rdquo; to\u0026nbsp;start provisioning. While my\u0026nbsp;cluster is\u0026nbsp;spinning up, let\u0026rsquo;s make good use of\u0026nbsp;this time and do\u0026nbsp;some exploratory data analysis. This will help understand our data better nad help structure our Airflow-enhanced queries.\u003c/p\u003e\n\u003ch2 id=\"aggregations\"\u003e\u003ca href=\"#aggregations\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eAggregations\u003c/span\u003e\u003c/a\u003eAggregations\u003c/h2\u003e\n\u003cp\u003eOur data consists of\u0026nbsp;events from various parties, and our goal is\u0026nbsp;to\u0026nbsp;group them effectively. Let\u0026rsquo;s start with some EDA on\u0026nbsp;our sample of\u0026nbsp;1,000 events using WebSQL. This will help understand what aggregations we\u0026nbsp;can compute.\u003c/p\u003e\n\u003ch3 id=\"exploring-sample-clickstream-data\"\u003e\u003ca href=\"#exploring-sample-clickstream-data\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eExploring sample clickstream data\u003c/span\u003e\u003c/a\u003eExploring sample clickstream data\u003c/h3\u003e\n\u003cp\u003eFirst, let\u0026rsquo;s remind ourselves about the table columns and their types. In\u0026nbsp;ClickHouse, we\u0026nbsp;can do\u0026nbsp;this using the \u003ca href=\"https://clickhouse.com/docs/ru/sql-reference/statements/describe-table\"\u003eDESCRIBE \u003ccode\u003e\u0026lt;tablename\u0026gt;\u003c/code\u003e command\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s how it\u0026nbsp;looks in\u0026nbsp;WebSQL query editor:\u003c/p\u003e\n\n\u003cp\u003eOur landing table is\u0026nbsp;quite extensive, but the xey fields for our analysis are:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003epartyId\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esessionId\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eItem_price\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eeventType\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edetectedDuplicate\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edetectedCorruption\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emy_ts\u003c/code\u003e (containing the adjusted timestamp)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eNow\u0026rsquo; let\u0026rsquo;s check for duplicates and corruption in\u0026nbsp;our data:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e eventType, detectedDuplicate, detectedCorruption, \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e events_webshop \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"43\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-43\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-43\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-43.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n\u003cp\u003eInterestingly, our sample doesn\u0026rsquo;t show any detected duplicates, but there are some events marked as\u0026nbsp;corrupted. Given our small sample size of\u0026nbsp;1,000 events, we\u0026nbsp;won\u0026rsquo;t focus too much on\u0026nbsp;duplicates now, but it\u0026rsquo;s something to\u0026nbsp;keep in\u0026nbsp;mind for larger samples.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s move on\u0026nbsp;to\u0026nbsp;some more useful aggregations. We\u0026rsquo;ll compute how many visitors we\u0026nbsp;had each hour in\u0026nbsp;our dataset. ClickHouse offers \u003ca href=\"https://clickhouse.com/docs/en/sql-reference/functions/date-time-functions\"\u003emany functions\u003c/a\u003e for working with datetime data, all expecting DateTime64 format.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;ll cast the values on\u0026nbsp;the fly:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n        toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e visitors,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e total_events,\n        \u003cspan class=\"hljs-built_in\"\u003eMIN\u003c/span\u003e(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e mnts,\n        \u003cspan class=\"hljs-built_in\"\u003eMAX\u003c/span\u003e(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e mxts\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e events_webshop \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"9\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-9\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-9\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-9.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n\u003cp\u003eFrom these results, we\u0026nbsp;can see that our 1,000-event sample spans 5\u0026nbsp;hours, with a\u0026nbsp;fairly even distribution of\u0026nbsp;events across each hour. The events are clustered at\u0026nbsp;the start and end of\u0026nbsp;each hour. We\u0026nbsp;also notice that our visitor count is\u0026nbsp;quite low, but it\u0026rsquo;s sufficient for building our initial pipeline.\u003c/p\u003e\n\u003ch3 id=\"performance-metrics-for-sample-data\"\u003e\u003ca href=\"#performance-metrics-for-sample-data\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003ePerformance metrics for sample data\u003c/span\u003e\u003c/a\u003ePerformance metrics for sample data\u003c/h3\u003e\n\u003cp\u003eOur dataset includes two event types: \u003ccode\u003eitemBuyEvent\u003c/code\u003e and \u003ccode\u003eitemViewEvent\u003c/code\u003e. We\u0026rsquo;ve already counted visitors, but now let\u0026rsquo;s focus on\u0026nbsp;purchases and revenue metrics, grouped by\u0026nbsp;hour:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eTotal revenue:\u003c/strong\u003e sum of\u0026nbsp;all \u003ccode\u003eitem_price\u003c/code\u003e fields for events with \u003ccode\u003eeventType = itemBuyEvent\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eNumber of\u0026nbsp;buyers:\u003c/strong\u003e count of\u0026nbsp;distinct \u003ccode\u003epartyId\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eTotal purchases:\u003c/strong\u003e count of\u0026nbsp;distinct \u003ccode\u003esessionId\u003c/code\u003e per hour\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eAverage revenue per purchase:\u003c/strong\u003e total revenue divided by\u0026nbsp;number of\u0026nbsp;purchases\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere\u0026rsquo;s the SQL query to\u0026nbsp;calculate these metrics:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n    \u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(item_price) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e total_revenue,\n    \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_buyers,\n    \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e sessionId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_purchases,\n    round(total_revenue \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e num_purchases, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e average_revenue_per_purchase\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e events_webshop \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e eventType\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e'itemBuyEvent'\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"34\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-34\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-34\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-34.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\n\u003ch3 id=\"putting-it-all-together\"\u003e\u003ca href=\"#putting-it-all-together\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003ePutting it\u0026nbsp;all together\u003c/span\u003e\u003c/a\u003ePutting it\u0026nbsp;all together\u003c/h3\u003e\n\u003cp\u003eNow that we\u0026nbsp;have our performance metrics, let\u0026rsquo;s combine them with our visitor data and apply our filtering criteria for duplicates and corruption. I\u0026nbsp;will use Common Tabls Experssions (CTEs) to\u0026nbsp;organize the resulting query:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eWITH\u003c/span\u003e good_data \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e webshop.events_webshop\n    \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e detectedDuplicate\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e detectedCorruption\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n), visitors \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n        toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e visitors\n    \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e good_data\n    \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n), performance \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n    \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n        toStartOfHour(my_ts::DateTime64) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e,\n        \u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(item_price) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e total_revenue,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e partyId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_buyers,\n        \u003cspan class=\"hljs-built_in\"\u003eCOUNT\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e sessionId) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e num_purchases\n        round(total_revenue \u003cspan class=\"hljs-operator\"\u003e/\u003c/span\u003e num_purchases, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e average_revenue_per_purchase\n    \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e good_data\n    \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e eventType\u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e'itemBuyEvent'\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n) \u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    v.hour,\n    v.visitors,\n    p.num_buyers,\n    p.num_purchases,\n    p.total_revenue,\n    p.average_revenue_per_purchase\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e visitors v \u003cspan class=\"hljs-keyword\"\u003eJOIN\u003c/span\u003e performance p \u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e v.hour \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e p.hour \u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ehour\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"6\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-6\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-6\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-6.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eYou can find the full query \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/sql/compute_full_aggs.sql\"\u003eat\u0026nbsp;github here\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eThis query combines all the metrics we\u0026nbsp;need for our analysis. It\u0026nbsp;filters out duplicates and corrupted data, calculates visitor and performance metrics, and joins them together for a\u0026nbsp;comprehensive hourly view of\u0026nbsp;our webshop\u0026rsquo;s performance.\u003c/p\u003e\n\u003cp\u003eNow that we\u0026nbsp;have our final query, let\u0026rsquo;s move on\u0026nbsp;to\u0026nbsp;automating this process with Airflow.\u003c/p\u003e\n\u003ch2 id=\"back-to-airflow\"\u003e\u003ca href=\"#back-to-airflow\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eBack to\u0026nbsp;Airflow\u003c/span\u003e\u003c/a\u003eBack to\u0026nbsp;Airflow\u003c/h2\u003e\n\u003cp\u003eOnce the cluster is\u0026nbsp;up\u0026nbsp;and running, you can access the Web UI\u0026nbsp;from the Cluster panel via the Web Server Connection link.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eAllowlist reminder:\u003c/strong\u003e DoubleCloud automatically adds your IP\u0026nbsp;address to\u0026nbsp;the ALLOWLIST in\u0026nbsp;the cluster settings. Keep this in\u0026nbsp;mind if\u0026nbsp;you frequently change networks, like switching Wi-Fi on\u0026nbsp;your laptop. If\u0026nbsp;the Web Server connection link doesn\u0026rsquo;t open, make sure your IP\u0026nbsp;is\u0026nbsp;in\u0026nbsp;the list.\u003c/p\u003e\n\u003cp\u003eInitially, your new cluster will have no\u0026nbsp;enabled DAGs, presenting an\u0026nbsp;empty dashboard. This is\u0026nbsp;normal for a\u0026nbsp;fresh setup.\u003c/p\u003e\n\n\u003cp\u003eLet\u0026rsquo;s start by\u0026nbsp;enabling and triggering the roll_d20 DAG (\u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/roll_d20.py\"\u003esrc here\u003c/a\u003e). This simple two-task DAG isn\u0026rsquo;t connecting to\u0026nbsp;any external system,\u0026nbsp;\u0026mdash; it\u0026rsquo;s just to\u0026nbsp;verify that our Airflow setup is\u0026nbsp;complete and workers are functioning. trigger it, and watch it\u0026nbsp;being executed (you can actually just trigger disabled dag and it\u0026nbsp;will be\u0026nbsp;enabled automatically).\u003c/p\u003e\n\n\u003cp\u003eYou can access the logs for each task through the Logs tab when you select a\u0026nbsp;DAG run and a\u0026nbsp;task:\u003c/p\u003e\n\n\u003cp\u003eLooks like I\u0026nbsp;got lucky\u0026nbsp;\u0026mdash; my\u0026nbsp;DAG run rolled a\u0026nbsp;13!\u003c/p\u003e\n\u003cp\u003eNow, if\u0026nbsp;we\u0026nbsp;try running our \u003ccode\u003ecompute_full_perf_metrics\u003c/code\u003e, DAG (\u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/compute_full_perf_metrics.py\"\u003esrc here\u003c/a\u003e), it\u0026nbsp;will fail:\u003c/p\u003e\n\n\u003cp\u003eThis is\u0026nbsp;expected, because our newly created cluster doesn\u0026rsquo;t know about our ClickHouse server\u0026nbsp;yet. The logs confirm this:\u003c/p\u003e\n\n\u003cp\u003eIt\u0026nbsp;all can be\u0026nbsp;fixed by\u0026nbsp;creating a\u0026nbsp;connection. Go\u0026nbsp;to\u0026nbsp;Admin-\u0026gt;Connections and add a\u0026nbsp;Generic connection using credentials for your ClickHouse server:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eConnection id: \u003ccode\u003ech_default\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eConnection type: \u003ccode\u003eGeneric\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSet host, port, and login/password accordingly\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSpecify schema: \u003ccode\u003ewebshop\u003c/code\u003e (this will be\u0026nbsp;used as\u0026nbsp;our database)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAdd {\u0026rdquo;\u003ccode\u003esecure\u003c/code\u003e\u0026rdquo;: true} to\u0026nbsp;extra settings. This is\u0026nbsp;required for DoubleCloud because your data is\u0026nbsp;always secure with us\u0026nbsp;\u0026mdash; we\u0026nbsp;just need to\u0026nbsp;tell Airflow about it!\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eNow, triggering our ClickHouse DAG again should result in\u0026nbsp;a\u0026nbsp;successful\u0026nbsp;run. The log will show you the executed query:\u003c/p\u003e\n\n\u003cp\u003eThe query result is\u0026nbsp;saved in\u0026nbsp;the XCom\u0026nbsp;tab. I\u0026rsquo;ve collapsed a\u0026nbsp;few rows, but it\u0026rsquo;s semantically the same result as\u0026nbsp;in\u0026nbsp;the WebSQL:\u003c/p\u003e\n\n\u003cp\u003eThis confirms that our Airflow cluster can now interact with the ClickHouse cluster and compute the necessary metrics. However, this setup isn\u0026rsquo;t ideal yet:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e The DAG is\u0026nbsp;not idempotent (we\u0026rsquo;ll address this in\u0026nbsp;the next part of\u0026nbsp;the series).\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e The results are only saved in\u0026nbsp;the Airflow metadata, not a\u0026nbsp;persistent location, not in\u0026nbsp;ClickHouse, hard to\u0026nbsp;access, etc\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s address the second point by\u0026nbsp;modifying our DAG structure to\u0026nbsp;save results in\u0026nbsp;a\u0026nbsp;table.\u003c/p\u003e\n\u003ch2 id=\"changing-dag-structure\"\u003e\u003ca href=\"#changing-dag-structure\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eChanging DAG structure\u003c/span\u003e\u003c/a\u003eChanging DAG structure\u003c/h2\u003e\n\u003cp\u003eLet\u0026rsquo;s modify the pipeline structure to\u0026nbsp;address the issue of\u0026nbsp;result persistence:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e First, the pipeline will check if\u0026nbsp;the target aggregation table exists\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e If\u0026nbsp;it\u0026nbsp;doesn\u0026rsquo;t exist, the pipeline should create the table and compute aggregations on\u0026nbsp;all available data\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e3.\u003c/em\u003e If\u0026nbsp;the table exists, the pipeline will truncate it\u0026nbsp;and insert new data\u003c/p\u003e\n\u003cp\u003eThis pipeline isn\u0026rsquo;t ideal for production use as\u0026nbsp;it\u0026nbsp;has a\u0026nbsp;few obvious drawbacks, but it\u0026nbsp;demonstrates how to\u0026nbsp;write an\u0026nbsp;Airflow pipeline with additional SQL-based checks. I\u0026rsquo;ll discuss pipeline improvements and query performance in\u0026nbsp;the next part of\u0026nbsp;this series.\u003c/p\u003e\n\u003ch3 id=\"additional-table\"\u003e\u003ca href=\"#additional-table\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eAdditional table\u003c/span\u003e\u003c/a\u003eAdditional table\u003c/h3\u003e\n\u003cp\u003eFor our aggregates data mart, let\u0026rsquo;s use the following structure:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e IF \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eEXISTS\u003c/span\u003e performance_aggregates (\n    ts_start DateTime,\n    ts_end DateTime,\n    visitors \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    num_buyers \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    num_purchases \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    total_revenue \u003cspan class=\"hljs-type\"\u003eInteger\u003c/span\u003e,\n    average_revenue_per_purchase Float32\n) ENGINE \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e MergeTree() \u003cspan class=\"hljs-keyword\"\u003ePRIMARY\u003c/span\u003e KEY ts_start\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"36\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-36\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-36\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-36.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eThis structure is\u0026nbsp;similar to\u0026nbsp;what we\u0026rsquo;ve used before, with an\u0026nbsp;additional column for the end of\u0026nbsp;the interval. The MergeTree engine is\u0026nbsp;suitable for our test sample, but for production use, you should always first check if\u0026nbsp;you can use \u003ca href=\"https://clickhouse.com/docs/en/engines/table-engines#mergetree\"\u003emore specific\u003c/a\u003e engine type.\u003c/p\u003e\n\u003cp\u003eTo\u0026nbsp;insert data into this table, I\u0026nbsp;will slightly modify me\u0026nbsp;existing query by\u0026nbsp;adding an\u0026nbsp;INSERT INTO statement:\u003c/p\u003e\n\n    \u003cdiv class=\"yfm-clipboard\"\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e webshop.performance_aggregates\n  (ts_start, ts_end, total_revenue, num_buyers, visitors, total_revenue, average_revenue_per_purchase)\n\u003cspan class=\"hljs-keyword\"\u003eWITH\u003c/span\u003e good_data \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e (\n  …\n\n\u003c/code\u003e\u003c/pre\u003e\n\n    \u003csvg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" class=\"yfm-clipboard-button\" data-animation=\"6\"\u003e\n        \u003cpath fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"\u003e\u003c/path\u003e\n        \u003cpath stroke=\"currentColor\" fill=\"transparent\" stroke-width=\"1.5\" d=\"M9.5 13l3 3l5 -5\" visibility=\"hidden\"\u003e\n            \u003canimate id=\"visibileAnimation-6\" attributeName=\"visibility\" from=\"hidden\" to=\"visible\" dur=\"0.2s\" fill=\"freeze\" begin\u003e\u003c/animate\u003e\n            \u003canimate id=\"hideAnimation-6\" attributeName=\"visibility\" from=\"visible\" to=\"hidden\" dur=\"1s\" begin=\"visibileAnimation-6.end+1\" fill=\"freeze\"\u003e\u003c/animate\u003e\n        \u003c/path\u003e\n    \u003c/svg\u003e\n    \u003c/div\u003e\n\u003cp\u003eFull query code \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/sql/compute_insert_aggs.sql\"\u003ecan be\u0026nbsp;found here\u003c/a\u003e. It\u0026rsquo;s worth noting that this approach has some limitations and wouldn\u0026rsquo;t be\u0026nbsp;ideal for a\u0026nbsp;production environment. However, for our current goal of\u0026nbsp;getting all the components working together, it\u0026rsquo;s sufficient.\u003c/p\u003e\n\u003cp\u003eIn\u0026nbsp;the next part of\u0026nbsp;this series, we\u0026rsquo;ll address these limitations and discuss how to\u0026nbsp;make the pipeline more robust and suitable for production use.\u003c/p\u003e\n\u003ch2 id=\"adjusting-airflow-dag\"\u003e\u003ca href=\"#adjusting-airflow-dag\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eAdjusting Airflow DAG\u003c/span\u003e\u003c/a\u003eAdjusting Airflow DAG\u003c/h2\u003e\n\u003cp\u003eHere\u0026rsquo;s my\u0026nbsp;resulting pipeline structure:\u003c/p\u003e\n\n\u003cp\u003eYou can see the complete code \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/trunk/dags/compute_full_perf_metrics_save_to_table.py\"\u003ein\u0026nbsp;our repository\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;d like to\u0026nbsp;highlight some key points about this new DAG:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eThis DAG has \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L32\"\u003eno\u0026nbsp;schedule\u003c/a\u003e. Since it\u0026nbsp;computes across the whole table, it\u0026rsquo;s designed more for per-trigger use rather than scheduled runs.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWhile the DAG might seem verbose with some tasks that could be\u0026nbsp;combined, this structure showcases how to\u0026nbsp;author more complex DAGs. Tip: Airflow has a\u0026nbsp;lesser-known feature that allows you to\u0026nbsp;add text on\u0026nbsp;top of\u0026nbsp;edges, making complicated DAGs look cleaner. \u003ca href=\"https://airflow.apache.org/docs/apache-airflow/2.10.0/_modules/airflow/example_dags/example_branch_labels.html\"\u003eSee here\u003c/a\u003e.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eGiven the nature of\u0026nbsp;the overall process, I\u0026rsquo;ve \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L38\"\u003elimited\u003c/a\u003e the number of\u0026nbsp;max active runs allowed for the\u0026nbsp;DAG. This can be\u0026nbsp;useful in\u0026nbsp;certain scenarios when you expect multiple DAG runs triggered in\u0026nbsp;a\u0026nbsp;short period of\u0026nbsp;time.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWhen implementing branching in\u0026nbsp;Airflow, remember to\u0026nbsp;set dependencies in\u0026nbsp;the graph and keep task_ids naming consistent. Personally, I\u0026nbsp;often start new DAGs with EmptyOperators to\u0026nbsp;get the structure right before replacing them with real tasks.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIt\u0026rsquo;s crucial to\u0026nbsp;set the proper TriggerRule for the final task to\u0026nbsp;ensure it\u0026rsquo;s not skipped when edges merge.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIn\u0026nbsp;the DAG code, I\u0026nbsp;define \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/blob/f891543a20a8d8f6938b4ec68b2ce7488970ee8e/dags/compute_full_perf_metrics_save_to_table.py#L13-L22\"\u003ea\u0026nbsp;custom ClickHouseBranchSQLOperator\u003c/a\u003e instead of\u0026nbsp;using the one provided by\u0026nbsp;the airflow-clickhouse-plugin. This is\u0026nbsp;due to\u0026nbsp;some method resolution order (MRO) issue in\u0026nbsp;Airflow versions \u0026lt; 2.9.3. You might not need this in\u0026nbsp;newer versions (see docstring for details).\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSome SQL statements could be\u0026nbsp;hardcoded/inlined instead of\u0026nbsp;reading from a\u0026nbsp;file, but I\u0026nbsp;prefer consistency and this a\u0026nbsp;nice minor side-effect as\u0026nbsp;it\u0026nbsp;makes it\u0026nbsp;easier to\u0026nbsp;get feedback from SQL experts (they can just read an\u0026nbsp;SQL file and not Python code + SQL statements).\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDepending on\u0026nbsp;your use-case, it\u0026nbsp;might make sense to\u0026nbsp;set table names as\u0026nbsp;parameters or\u0026nbsp;Airflow variables for easier modifications. I\u0026nbsp;will cover it\u0026nbsp;in\u0026nbsp;the next part, along with scheduling, idempotency, and data_interval usage.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI\u0026nbsp;want to\u0026nbsp;emphasize that we\u0026rsquo;re focusing on\u0026nbsp;using Airflow with our ClickHouse cluster data, not on\u0026nbsp;production-ready code quality. I\u0026rsquo;d caution against using this DAG directly in\u0026nbsp;production. However, it\u0026nbsp;serves as\u0026nbsp;a\u0026nbsp;good starting point for developing your own DAGs that utilize ClickHouse.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s trigger this DAG and check the results. Enabling the DAG and running it\u0026nbsp;for the first time will create the table and compute the aggregations. Subsequent runs will use the other branch.\u003c/p\u003e\n\n\u003cp\u003eIn\u0026nbsp;the next part of\u0026nbsp;this series, we\u0026rsquo;ll refine our approach and address some of\u0026nbsp;the limitations in\u0026nbsp;this initial implementation.\u003c/p\u003e\n\u003ch2 id=\"final-result\"\u003e\u003ca href=\"#final-result\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eFinal result\u003c/span\u003e\u003c/a\u003eFinal result\u003c/h2\u003e\n\u003cp\u003eSwitching to\u0026nbsp;WebSQL I\u0026nbsp;can now see my\u0026nbsp;new table and query data from it:\u003c/p\u003e\n\n\u003cp\u003eRunning the DAG again would takes a\u0026nbsp;different path in\u0026nbsp;the graph. Since we\u0026nbsp;limited the max active runs, multiple triggers won\u0026rsquo;t interfere with each other:\u003c/p\u003e\n\n\u003cp\u003eEverything seems to\u0026nbsp;be\u0026nbsp;working as\u0026nbsp;expected. Let\u0026rsquo;s recap what we\u0026rsquo;ve accomplished:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e We\u0026nbsp;started by\u0026nbsp;spinning up\u0026nbsp;an\u0026nbsp;Airflow cluster. My\u0026nbsp;DAGs are stored in\u0026nbsp;separate folder \u003ca href=\"https://github.com/doublecloud/showcase-webshop-clickstream-aggregation/tree/trunk\"\u003ein\u0026nbsp;a\u0026nbsp;repository\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e I\u0026nbsp;did some Exploratory Data Analysis to\u0026nbsp;determine what we\u0026nbsp;wanted to\u0026nbsp;compute and got our first working query in\u0026nbsp;WebSQL. The fancy phrase basically means \u0026ldquo;I\u0026rsquo;ve ran some queries to\u0026nbsp;check what\u0026rsquo;s up\u0026nbsp;with my\u0026nbsp;data\u0026rdquo;. This helped me\u0026nbsp;understand my\u0026nbsp;data better and prepare for automation in\u0026nbsp;Airflow. By\u0026nbsp;saving queries as\u0026nbsp;SQL files in\u0026nbsp;my\u0026nbsp;DAGs folder, I\u0026nbsp;can later easily reuse them.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e3.\u003c/em\u003e Using ClickHouseOperator in\u0026nbsp;Airflow, I\u0026rsquo;ve set up\u0026nbsp;a\u0026nbsp;simple DAG that runs the query as-is. This helped me\u0026nbsp;ensure everything is\u0026nbsp;working fine from connectivity standpoint.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e4.\u003c/em\u003e I\u0026rsquo;ve added a\u0026nbsp;few additional steps to\u0026nbsp;my\u0026nbsp;DAG that create the aggregation table and save the result, allowing me\u0026nbsp;to\u0026nbsp;rerun it\u0026nbsp;whenever needed.\u003c/p\u003e\n\u003cp\u003eThis is\u0026nbsp;a\u0026nbsp;point in\u0026nbsp;our imaginary communication with the data client where I\u0026nbsp;can now present these results to\u0026nbsp;data analysts and gather feedback on\u0026nbsp;either the SQL queries or\u0026nbsp;the data mart structure. It\u0026rsquo;s a\u0026nbsp;good place to\u0026nbsp;wrap up\u0026nbsp;this part of\u0026nbsp;our series.\u003c/p\u003e\n\u003ch2 id=\"looking-ahead-to-part-iii\"\u003e\u003ca href=\"#looking-ahead-to-part-iii\" class=\"yfm-anchor\" aria-hidden=\"true\"\u003e\u003cspan class=\"visually-hidden\"\u003eLooking ahead to\u0026nbsp;part III\u003c/span\u003e\u003c/a\u003eLooking ahead to\u0026nbsp;part III\u003c/h2\u003e\n\u003cp\u003eIn\u0026nbsp;the next installment of\u0026nbsp;this series, we\u0026rsquo;re going to\u0026nbsp;take our analytics platform to\u0026nbsp;the next level:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e1.\u003c/em\u003e We\u0026rsquo;ll build an\u0026nbsp;interactive dashboard using the DoubleCloud Visualization tool, bringing our data to\u0026nbsp;life visually.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e2.\u003c/em\u003e We\u0026rsquo;ll shorten the time bucket for more granular analysis and utilize a\u0026nbsp;bigger dataset to\u0026nbsp;stress-test our system.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e3.\u003c/em\u003e We\u0026rsquo;ll refine our DAG, addressing improvements such as:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eImplementing idempotency\u003c/li\u003e\n\u003cli\u003eSetting up\u0026nbsp;proper scheduling\u003c/li\u003e\n\u003cli\u003eMaking our pipeline more robust for production use\u003c/li\u003e\n\u003cli\u003eParametrizing table names and leveraging Airflow variables for increased flexibility\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cem\u003e4.\u003c/em\u003e We\u0026rsquo;ll explore how this entire setup can be\u0026nbsp;deployed using Terraform, streamlining the infrastructure-as-code process.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e5.\u003c/em\u003e We\u0026rsquo;ll also cover different table structures and approaches for this problem and how different ClickHouse engines can be\u0026nbsp;used here, and if\u0026nbsp;we\u0026nbsp;indeed need to\u0026nbsp;use something different than the basic MergeTree for optimizing this analytics pipeline.\u003c/p\u003e\n\u003cp\u003eRemember, while our current implementation works, it\u0026rsquo;s designed as\u0026nbsp;a\u0026nbsp;learning exercise. For production environments, if\u0026nbsp;you were going with self-hosted solutions, you\u0026rsquo;d need to\u0026nbsp;implement additional error handling, logging, and performance optimizations. However, with DoubleCloud, many of\u0026nbsp;these issues are solved for you, allowing you to\u0026nbsp;focus on\u0026nbsp;your data processing needs instead.\u003c/p\u003e\n\u003cp\u003eThanks for joining us\u0026nbsp;on\u0026nbsp;this journey so\u0026nbsp;far. Stay tuned for part III, where we\u0026rsquo;ll bring all these pieces together into a\u0026nbsp;comprehensive, production-grade analytics solution! If\u0026nbsp;you have any questions or\u0026nbsp;would like to\u0026nbsp;discuss this series further, feel free to\u0026nbsp;reach out on\u0026nbsp;Slack. DoubleCloud is\u0026nbsp;always here to\u0026nbsp;help you make the most of\u0026nbsp;your data!\u003c/p\u003e\n","sharing":{"title":"Clickstream analytics case study. Part II: ClickHouse \u003c-\u003e Airflow","description":"In this second post, we’ll show you how to set up an Airflow cluster. We’ll use it to run a batch job that takes the data we loaded in the first step and turns it into useful summaries. This is a key part of making our analytics system efficient and reliable.","image":"/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-sharing.png","shareGenImage":"","shareGenTitle":"Clickstream analytics case study. Part II: ClickHouse \u003c-\u003e Airflow"},"keywords":[],"noIndex":false,"authors":[],"tags":[{"icon":null,"slug":"insights","name":"Insights","createdAt":"","updatedAt":"","count":0},{"icon":null,"slug":"ClickHouse","name":"ClickHouse","createdAt":"","updatedAt":"","count":0},{"icon":null,"slug":"Airflow","name":"Airflow","createdAt":"","updatedAt":"","count":0}],"metaSchema":{"@context":"https://schema.org","@graph":[{"@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"insights","name":"Insights"}},{"@type":"ListItem","position":2,"item":{"@id":"ClickHouse","name":"ClickHouse"}},{"@type":"ListItem","position":3,"item":{"@id":"Airflow","name":"Airflow"}}]},{"@type":"BlogPosting","@id":"https://double.cloud/blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration/","url":"https://double.cloud/blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration/","name":"Clickstream analytics case study. Part II: ClickHouse \u0026lt;→ Airflow","headline":"Clickstream analytics case study. Part II: ClickHouse \u0026lt;→ Airflow","abstract":"\u003cp\u003eWritten By: Igor Mosyagin, Developer Advocate at\u0026nbsp;DoubleCloud\u003c/p\u003e","description":"\u003cp\u003eWritten By: Igor Mosyagin, Developer Advocate at\u0026nbsp;DoubleCloud\u003c/p\u003e","dateCreated":"2024-09-23T00:00:00Z","datePublished":"2024-09-23T00:00:00Z","dateModified":"2024-09-23T00:00:00Z","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"creator":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"publisher":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightHolder":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}},"copyrightYear":2025,"mainEntityOfPage":{"@type":"WebPage","@id":"https://double.cloud/blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration/"},"inLanguage":{"@type":"Language","name":"English","alternateName":"en"},"keywords":["Insights","ClickHouse","Airflow"],"image":"https://double.cloud/assets/blog/articles/2024/real-time-analytics-airflow-clickhouse-integration-small-cover.png","sharedContent":{"@type":"WebPage","headline":"Clickstream analytics case study. Part II: ClickHouse \u0026lt;→ Airflow","url":"https://double.cloud/blog/posts/2024/09/real-time-analytics-airflow-clickhouse-integration/","author":{"@type":"Organization","name":"DoubleCloud","legalName":"DoubleCloud Inc","url":"https://double.cloud/","logo":{"@type":"ImageObject","url":"","width":32,"height":32}}},"wordCount":"","articleBody":""}]}},"routingData":{"hostname":"double.cloud"},"deviceData":{"isRobot":true,"isMobile":false,"isTablet":false},"csrfToken":"AATbWwzC-vH_u0k7kKZTawUtRTEvQsrmes6w","clientConfig":{"appTitle":"DoubleCloud","legalName":"DoubleCloud Inc","supportEmail":"","hosts":{"site":"https://double.cloud","console":"https://app.double.cloud"}},"ignoreConsent":false,"noNextImg":false,"noSnippet":null},"__N_SSP":true},"page":"/blog/posts/[...slug]","query":{"slug":["2024","09","real-time-analytics-airflow-clickhouse-integration"]},"buildId":"HkxA3M0ES7gp3V0n_0ecw","isFallback":false,"gssp":true,"locale":"en","locales":["en"],"defaultLocale":"en","scriptLoader":[]}</script></body></html>